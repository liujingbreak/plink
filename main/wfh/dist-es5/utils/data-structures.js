"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RedBlackTree = void 0;
/**
 * According to the book << Introduction to Algorithms, Third Edition >>
 * include features: Dynamic order statistics, range tree
 */
var RedBlackTree = /** @class */ (function () {
    function RedBlackTree(comparator) {
        this.comparator = comparator;
        this.root = null;
        if (comparator == null) {
            this.comparator = function (a, b) {
                return a < b ? -1 :
                    a > b ? 1 : 0;
            };
        }
    }
    /**
     *
     * @param key
     * @returns null if key duplicates with existing tree node
     */
    RedBlackTree.prototype.insert = function (key) {
        var y = null;
        var x = this.root;
        var cmp;
        while (x) {
            y = x;
            cmp = this.comparator(key, x.key);
            if (cmp < 0) {
                x = x.left;
            }
            else if (cmp > 0) {
                x = x.right;
            }
            else {
                return null; // duplicate key found
            }
        }
        var z = {
            isRed: true,
            key: key,
            p: y,
            left: null,
            right: null,
            size: 0
        };
        if (y == null) {
            this.root = z;
            // z.isRed = false;
        }
        else if (cmp < 0) {
            y.left = z;
        }
        else if (cmp > 0) {
            y.right = z;
        }
        this.redBlackInsertFixUp(z);
        return z;
    };
    RedBlackTree.prototype.delete = function (key) {
        var node = this.search(key);
        if (node == null) {
            return false;
        }
        this.deleteNode(node);
        return true;
    };
    RedBlackTree.prototype.isRed = function (node) {
        return node != null && node.isRed;
    };
    RedBlackTree.prototype.isBlack = function (node) {
        return node == null || !node.isRed;
    };
    RedBlackTree.prototype.deleteNode = function (z) {
        var y = z;
        var origIsRed = this.isRed(y);
        var x = null;
        if (z.left == null) {
            x = z.right;
            this.transplant(z, z.right);
        }
        else if (z.right == null) {
            x = z.left;
            this.transplant(z, z.left);
        }
        else {
            // both left and right child are not empty
            y = this.minimumOf(z.right);
            if (y == null)
                return false;
            origIsRed = this.isRed(y);
            x = y.right;
            if (y.p === z) {
                if (x)
                    x.p = y;
            }
            else {
                this.transplant(y, y.right);
                y.right = z.right;
                y.right.p = y;
            }
            this.transplant(z, y);
            y.left = z.left;
            y.left.p = y;
            y.isRed = this.isRed(z);
        }
        if (!origIsRed && x) {
            // console.log('delete fixup', x.key);
            this.deleteFixup(x);
        }
        return true;
    };
    RedBlackTree.prototype.deleteFixup = function (x) {
        while (x !== this.root && this.isBlack(x)) {
            if (x.p && x === x.p.left) {
                var w = x.p.right; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.leftRotate(x.p);
                    w = x.p.right;
                }
                if (w) {
                    if (this.isBlack(w.left) && this.isBlack(w.right)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.right)) {
                            if (w.left)
                                w.left.isRed = false;
                            w.isRed = true;
                            this.rightRotate(w);
                            w = x.p.right;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.right)
                            w.right.isRed = false;
                        this.leftRotate(x.p);
                        x = this.root;
                    }
                }
            }
            else if (x.p && x === x.p.right) {
                var w = x.p.left; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.rightRotate(x.p);
                    w = x.p.left;
                }
                if (w) {
                    if (this.isBlack(w.right) && this.isBlack(w.left)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.left)) {
                            if (w.right)
                                w.right.isRed = false;
                            w.isRed = true;
                            this.leftRotate(w);
                            w = x.p.left;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.left)
                            w.left.isRed = false;
                        this.rightRotate(x.p);
                        x = this.root;
                    }
                }
            }
        }
        x.isRed = false;
    };
    RedBlackTree.prototype.minimumOf = function (node) {
        if (node === void 0) { node = this.root; }
        // let min: RbTreeNode<T> | null = null;
        while (node === null || node === void 0 ? void 0 : node.left) {
            // min = node;
            node = node.left;
        }
        return node ? node : null;
    };
    // maximumOf(node: RbTreeNode<T> = this.root) {
    //   while (this.isNotNil(node))
    //     node = node.right;
    //   return node;
    // }
    RedBlackTree.prototype.transplant = function (replaceNode, withNode) {
        if (withNode === void 0) { withNode = null; }
        if (replaceNode.p == null) {
            this.root = withNode;
        }
        else if (replaceNode === replaceNode.p.left) {
            replaceNode.p.left = withNode;
        }
        else {
            replaceNode.p.right = withNode;
        }
        if (withNode)
            withNode.p = replaceNode.p;
    };
    RedBlackTree.prototype.search = function (key) {
        var node = this.root;
        while (node) {
            var cmp = this.comparator(key, node.key);
            if (cmp === 0)
                return node;
            if (cmp < 0) {
                node = node.left;
            }
            else {
                node = node.right;
            }
        }
        return null;
    };
    RedBlackTree.prototype.redBlackInsertFixUp = function (z) {
        var _a, _b;
        while (this.isRed(z.p)) {
            if (((_a = z.p) === null || _a === void 0 ? void 0 : _a.p) && z.p === z.p.p.left) {
                var uncle = z.p.p.right;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.right) {
                        // if is right child tree
                        z = z.p;
                        this.leftRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.rightRotate(z.p.p);
                        }
                    }
                }
            }
            else if (((_b = z.p) === null || _b === void 0 ? void 0 : _b.p) && z.p === z.p.p.right) {
                var uncle = z.p.p.left;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.left) {
                        // if is right child tree
                        z = z.p;
                        this.rightRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.leftRotate(z.p.p);
                        }
                    }
                }
            }
        }
        if (this.root)
            this.root.isRed = false;
    };
    RedBlackTree.prototype.leftRotate = function (x) {
        // console.log('leftRotate', x.key);
        var y = x.right;
        if (y == null)
            return;
        x.right = y.left;
        if (y.left) {
            y.left.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.left)
            x.p.left = y;
        else
            x.p.right = y;
        y.left = x;
        x.p = y;
    };
    RedBlackTree.prototype.rightRotate = function (x) {
        var y = x.left;
        if (y == null)
            return;
        x.left = y.right;
        if (y.right) {
            y.right.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.right)
            x.p.right = y;
        else
            x.p.left = y;
        y.right = x;
        x.p = y;
    };
    return RedBlackTree;
}());
exports.RedBlackTree = RedBlackTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zdHJ1Y3R1cmVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvdXRpbHMvZGF0YS1zdHJ1Y3R1cmVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQVlBOzs7R0FHRztBQUNIO0lBR0Usc0JBQW9CLFVBQXVDO1FBQXZDLGVBQVUsR0FBVixVQUFVLENBQTZCO1FBRjNELFNBQUksR0FBcUMsSUFBSSxDQUFDO1FBRzVDLElBQUksVUFBVSxJQUFJLElBQUksRUFBRTtZQUN0QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQUMsQ0FBQyxFQUFFLENBQUM7Z0JBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDakIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEIsQ0FBQyxDQUFDO1NBQ0g7SUFDSCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILDZCQUFNLEdBQU4sVUFBTyxHQUFNO1FBQ1gsSUFBSSxDQUFDLEdBQXlCLElBQUksQ0FBQztRQUNuQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ2xCLElBQUksR0FBVyxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsQ0FBQyxHQUFHLENBQUMsQ0FBRTtZQUNQLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO2dCQUNYLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2FBQ1o7aUJBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO2dCQUNsQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUNiO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDLENBQUMsc0JBQXNCO2FBQ3BDO1NBQ0Y7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QUMsR0FBRyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRU8sa0NBQVcsR0FBbkIsVUFBb0IsQ0FBZ0I7UUFDbEMsSUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxJQUFJO1lBQ1gsT0FBTztRQUNULENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNqQixJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUU7WUFDWCxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDZjtRQUNELENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNWLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJO1lBQ2IsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7YUFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7WUFDdEIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDOztZQUVkLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNmLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ1osQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDVixDQUFDO0lBQ0gsbUJBQUM7QUFBRCxDQUFDLEFBN1NELElBNlNDO0FBN1NZLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBVbmZpbmlzaGVkLCBUT0RPOiBkZWxldGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJiVHJlZU5vZGU8VD4ge1xuICBrZXk6IFQ7XG4gIHA6IFJiVHJlZU5vZGU8VD4gfCBudWxsO1xuICBsZWZ0OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbDtcbiAgcmlnaHQ6IFJiVHJlZU5vZGU8VD4gfCBudWxsO1xuICBpc1JlZDogYm9vbGVhbjtcbiAgc2l6ZTogbnVtYmVyO1xufVxuXG4vKipcbiAqIEFjY29yZGluZyB0byB0aGUgYm9vayA8PCBJbnRyb2R1Y3Rpb24gdG8gQWxnb3JpdGhtcywgVGhpcmQgRWRpdGlvbiA+PlxuICogaW5jbHVkZSBmZWF0dXJlczogRHluYW1pYyBvcmRlciBzdGF0aXN0aWNzLCByYW5nZSB0cmVlXG4gKi9cbmV4cG9ydCBjbGFzcyBSZWRCbGFja1RyZWU8VD4ge1xuICByb290OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb21wYXJhdG9yPzogKGE6IFQsIGI6IFQpID0+IC0xIHwgMCB8IDEpIHtcbiAgICBpZiAoY29tcGFyYXRvciA9PSBudWxsKSB7XG4gICAgICB0aGlzLmNvbXBhcmF0b3IgPSAoYSwgYikgPT4ge1xuICAgICAgICByZXR1cm4gYSA8IGIgPyAtMSA6XG4gICAgICAgICAgYSA+IGIgPyAxIDogMDtcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0ga2V5XG4gICAqIEByZXR1cm5zIG51bGwgaWYga2V5IGR1cGxpY2F0ZXMgd2l0aCBleGlzdGluZyB0cmVlIG5vZGVcbiAgICovXG4gIGluc2VydChrZXk6IFQpOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB7XG4gICAgbGV0IHk6IFJiVHJlZU5vZGU8VD4gfCBudWxsID0gbnVsbDtcbiAgICBsZXQgeCA9IHRoaXMucm9vdDtcbiAgICBsZXQgY21wOiBudW1iZXI7XG4gICAgd2hpbGUgKHgpIHtcbiAgICAgIHkgPSB4IDtcbiAgICAgIGNtcCA9IHRoaXMuY29tcGFyYXRvciEoa2V5LCB4LmtleSk7XG4gICAgICBpZiAoY21wIDwgMCkge1xuICAgICAgICB4ID0geC5sZWZ0O1xuICAgICAgfSBlbHNlIGlmIChjbXAgPiAwKSB7XG4gICAgICAgIHggPSB4LnJpZ2h0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG51bGw7IC8vIGR1cGxpY2F0ZSBrZXkgZm91bmRcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgejogUmJUcmVlTm9kZTxUPiA9IHtcbiAgICAgIGlzUmVkOiB0cnVlLFxuICAgICAga2V5LFxuICAgICAgcDogeSxcbiAgICAgIGxlZnQ6IG51bGwsXG4gICAgICByaWdodDogbnVsbCxcbiAgICAgIHNpemU6IDBcbiAgICB9O1xuICAgIGlmICh5ID09IG51bGwpIHtcbiAgICAgIHRoaXMucm9vdCA9IHo7XG4gICAgICAvLyB6LmlzUmVkID0gZmFsc2U7XG4gICAgfSBlbHNlIGlmIChjbXAhIDwgMCApIHtcbiAgICAgIHkubGVmdCA9IHo7XG4gICAgfSBlbHNlIGlmIChjbXAhID4gMCApIHtcbiAgICAgIHkucmlnaHQgPSB6O1xuICAgIH1cbiAgICB0aGlzLnJlZEJsYWNrSW5zZXJ0Rml4VXAoeik7XG4gICAgcmV0dXJuIHo7XG4gIH1cblxuICBkZWxldGUoa2V5OiBUKSB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuc2VhcmNoKGtleSk7XG4gICAgaWYgKG5vZGUgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLmRlbGV0ZU5vZGUobm9kZSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpc1JlZChub2RlOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBub2RlICE9IG51bGwgJiYgbm9kZS5pc1JlZDtcbiAgfVxuXG4gIGlzQmxhY2sobm9kZTogUmJUcmVlTm9kZTxUPiB8IG51bGwgfCB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gbm9kZSA9PSBudWxsIHx8ICFub2RlLmlzUmVkO1xuICB9XG5cbiAgcHJvdGVjdGVkIGRlbGV0ZU5vZGUoejogUmJUcmVlTm9kZTxUPikge1xuICAgIGxldCB5OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCAgPSB6O1xuICAgIGxldCBvcmlnSXNSZWQgPSB0aGlzLmlzUmVkKHkpO1xuICAgIGxldCB4OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgaWYgKHoubGVmdCA9PSBudWxsKSB7XG4gICAgICB4ID0gei5yaWdodDtcbiAgICAgIHRoaXMudHJhbnNwbGFudCh6LCB6LnJpZ2h0KTtcbiAgICB9IGVsc2UgaWYgKHoucmlnaHQgPT0gbnVsbCkge1xuICAgICAgeCA9IHoubGVmdDtcbiAgICAgIHRoaXMudHJhbnNwbGFudCh6LCB6LmxlZnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBib3RoIGxlZnQgYW5kIHJpZ2h0IGNoaWxkIGFyZSBub3QgZW1wdHlcbiAgICAgIHkgPSB0aGlzLm1pbmltdW1PZih6LnJpZ2h0KTtcbiAgICAgIGlmICh5ID09IG51bGwpXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIG9yaWdJc1JlZCA9IHRoaXMuaXNSZWQoeSk7XG4gICAgICB4ID0geS5yaWdodDtcbiAgICAgIGlmICh5LnAgPT09IHopIHtcbiAgICAgICAgaWYgKHgpIHgucCA9IHk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRyYW5zcGxhbnQoeSwgeS5yaWdodCk7XG4gICAgICAgIHkucmlnaHQgPSB6LnJpZ2h0O1xuICAgICAgICB5LnJpZ2h0LnAgPSB5O1xuICAgICAgfVxuICAgICAgdGhpcy50cmFuc3BsYW50KHosIHkpO1xuICAgICAgeS5sZWZ0ID0gei5sZWZ0O1xuICAgICAgeS5sZWZ0LnAgPSB5O1xuICAgICAgeS5pc1JlZCA9IHRoaXMuaXNSZWQoeik7XG4gICAgfVxuICAgIGlmICghb3JpZ0lzUmVkICYmIHgpIHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdkZWxldGUgZml4dXAnLCB4LmtleSk7XG4gICAgICB0aGlzLmRlbGV0ZUZpeHVwKHgpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlRml4dXAoeDogUmJUcmVlTm9kZTxUPikge1xuICAgIHdoaWxlICh4ICE9PSB0aGlzLnJvb3QgJiYgdGhpcy5pc0JsYWNrKHgpKSB7XG4gICAgICBpZiAoeC5wICYmIHggPT09IHgucC5sZWZ0KSB7XG4gICAgICAgIGxldCB3ID0geC5wLnJpZ2h0OyAvLyB3IGlzIHgncyBzaWJsaW5nXG4gICAgICAgIGlmICh0aGlzLmlzUmVkKHcpKSB7XG4gICAgICAgICAgdyEuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB4LnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMubGVmdFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICB3ID0geC5wLnJpZ2h0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh3KSB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNCbGFjayh3LmxlZnQpICYmIHRoaXMuaXNCbGFjayh3LnJpZ2h0KSkge1xuICAgICAgICAgICAgdy5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICB4ID0geC5wIDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNCbGFjayh3LnJpZ2h0KSkge1xuICAgICAgICAgICAgICBpZiAody5sZWZ0KVxuICAgICAgICAgICAgICAgIHcubGVmdC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICB3LmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh3KTtcbiAgICAgICAgICAgICAgdyA9IHgucC5yaWdodDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh3KSB3LmlzUmVkID0gdGhpcy5pc1JlZCh4LnApO1xuICAgICAgICAgICAgeC5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAodz8ucmlnaHQpIHcucmlnaHQuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMubGVmdFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICAgIHggPSB0aGlzLnJvb3QhO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh4LnAgJiYgeCA9PT0geC5wLnJpZ2h0KSB7XG4gICAgICAgIGxldCB3ID0geC5wLmxlZnQ7IC8vIHcgaXMgeCdzIHNpYmxpbmdcbiAgICAgICAgaWYgKHRoaXMuaXNSZWQodykpIHtcbiAgICAgICAgICB3IS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHgucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICB3ID0geC5wLmxlZnQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHcpIHtcbiAgICAgICAgICBpZiAodGhpcy5pc0JsYWNrKHcucmlnaHQpICYmIHRoaXMuaXNCbGFjayh3LmxlZnQpKSB7XG4gICAgICAgICAgICB3LmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHggPSB4LnAgO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pc0JsYWNrKHcubGVmdCkpIHtcbiAgICAgICAgICAgICAgaWYgKHcucmlnaHQpXG4gICAgICAgICAgICAgICAgdy5yaWdodC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICB3LmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHcpO1xuICAgICAgICAgICAgICB3ID0geC5wLmxlZnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodykgdy5pc1JlZCA9IHRoaXMuaXNSZWQoeC5wKTtcbiAgICAgICAgICAgIHgucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHc/LmxlZnQpIHcubGVmdC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICAgIHggPSB0aGlzLnJvb3QhO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB4LmlzUmVkID0gZmFsc2U7XG4gIH1cblxuICBtaW5pbXVtT2Yobm9kZTogUmJUcmVlTm9kZTxUPiB8IG51bGwgfCB1bmRlZmluZWQgPSB0aGlzLnJvb3QpIHtcbiAgICAvLyBsZXQgbWluOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgd2hpbGUgKG5vZGU/LmxlZnQpIHtcbiAgICAgIC8vIG1pbiA9IG5vZGU7XG4gICAgICBub2RlID0gbm9kZS5sZWZ0O1xuICAgIH1cbiAgICByZXR1cm4gbm9kZSA/IG5vZGUgOiBudWxsO1xuICB9XG5cbiAgLy8gbWF4aW11bU9mKG5vZGU6IFJiVHJlZU5vZGU8VD4gPSB0aGlzLnJvb3QpIHtcblxuICAvLyAgIHdoaWxlICh0aGlzLmlzTm90TmlsKG5vZGUpKVxuICAvLyAgICAgbm9kZSA9IG5vZGUucmlnaHQ7XG4gIC8vICAgcmV0dXJuIG5vZGU7XG4gIC8vIH1cblxuICBwcml2YXRlIHRyYW5zcGxhbnQocmVwbGFjZU5vZGU6IFJiVHJlZU5vZGU8VD4sIHdpdGhOb2RlOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCA9IG51bGwpIHtcbiAgICBpZiAocmVwbGFjZU5vZGUucCA9PSBudWxsKSB7XG4gICAgICB0aGlzLnJvb3QgPSB3aXRoTm9kZTtcbiAgICB9IGVsc2UgaWYgKHJlcGxhY2VOb2RlID09PSByZXBsYWNlTm9kZS5wLmxlZnQpIHtcbiAgICAgIHJlcGxhY2VOb2RlLnAubGVmdCA9IHdpdGhOb2RlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXBsYWNlTm9kZS5wLnJpZ2h0ID0gd2l0aE5vZGU7XG4gICAgfVxuICAgIGlmICh3aXRoTm9kZSlcbiAgICAgIHdpdGhOb2RlLnAgPSByZXBsYWNlTm9kZS5wO1xuICB9XG5cbiAgc2VhcmNoKGtleTogVCk6IFJiVHJlZU5vZGU8VD4gfCBudWxsIHtcbiAgICBsZXQgbm9kZSA9IHRoaXMucm9vdDtcbiAgICB3aGlsZSAobm9kZSkge1xuICAgICAgY29uc3QgY21wID0gdGhpcy5jb21wYXJhdG9yIShrZXksIG5vZGUua2V5KTtcbiAgICAgIGlmIChjbXAgPT09IDApXG4gICAgICAgIHJldHVybiBub2RlO1xuICAgICAgaWYgKGNtcCA8IDApIHtcbiAgICAgICAgbm9kZSA9IG5vZGUubGVmdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5vZGUgPSBub2RlLnJpZ2h0O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByb3RlY3RlZCByZWRCbGFja0luc2VydEZpeFVwKHo6IFJiVHJlZU5vZGU8VD4pIHtcbiAgICB3aGlsZSAodGhpcy5pc1JlZCh6LnApKSB7XG4gICAgICBpZiAoei5wPy5wICYmIHoucCA9PT0gei5wLnAubGVmdCkge1xuICAgICAgICBjb25zdCB1bmNsZSA9IHoucC5wLnJpZ2h0O1xuICAgICAgICBpZiAodGhpcy5pc1JlZCh1bmNsZSkpIHtcbiAgICAgICAgICAvLyBtYXJrIHBhcmVudCBhbmQgdW5jbGUgdG8gYmxhY2ssIGdyYW5kcGEgdG8gcmVkLCBjb250aW51ZSB0byBnbyB1cCB0byBncmFuZHBhIGxldmVsXG4gICAgICAgICAgei5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgaWYgKHVuY2xlKSB1bmNsZS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB6ID0gei5wLnA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gdW5jbGUgaXMgYmxhY2tcbiAgICAgICAgICBpZiAoeiA9PT0gei5wLnJpZ2h0KSB7XG4gICAgICAgICAgICAvLyBpZiBpcyByaWdodCBjaGlsZCB0cmVlXG4gICAgICAgICAgICB6ID0gei5wO1xuICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHopO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoei5wKSB7XG4gICAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICh6LnAucCkge1xuICAgICAgICAgICAgICB6LnAucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoei5wLnApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh6LnA/LnAgJiYgei5wID09PSB6LnAucC5yaWdodCkge1xuICAgICAgICBjb25zdCB1bmNsZSA9IHoucC5wLmxlZnQ7XG4gICAgICAgIGlmICh0aGlzLmlzUmVkKHVuY2xlKSkge1xuICAgICAgICAgIC8vIG1hcmsgcGFyZW50IGFuZCB1bmNsZSB0byBibGFjaywgZ3JhbmRwYSB0byByZWQsIGNvbnRpbnVlIHRvIGdvIHVwIHRvIGdyYW5kcGEgbGV2ZWxcbiAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICBpZiAodW5jbGUpIHVuY2xlLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHogPSB6LnAucDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB1bmNsZSBpcyBibGFja1xuICAgICAgICAgIGlmICh6ID09PSB6LnAubGVmdCkge1xuICAgICAgICAgICAgLy8gaWYgaXMgcmlnaHQgY2hpbGQgdHJlZVxuICAgICAgICAgICAgeiA9IHoucDtcbiAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoeik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh6LnApIHtcbiAgICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHoucC5wKSB7XG4gICAgICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHoucC5wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMucm9vdClcbiAgICAgIHRoaXMucm9vdC5pc1JlZCA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBsZWZ0Um90YXRlKHg6IFJiVHJlZU5vZGU8VD4pIHtcbiAgICAvLyBjb25zb2xlLmxvZygnbGVmdFJvdGF0ZScsIHgua2V5KTtcbiAgICBjb25zdCB5ID0geC5yaWdodDtcbiAgICBpZiAoeSA9PSBudWxsKVxuICAgICAgcmV0dXJuO1xuICAgIHgucmlnaHQgPSB5LmxlZnQ7XG4gICAgaWYgKHkubGVmdCkge1xuICAgICAgeS5sZWZ0LnAgPSB4O1xuICAgIH1cbiAgICB5LnAgPSB4LnA7XG4gICAgaWYgKHgucCA9PSBudWxsKVxuICAgICAgdGhpcy5yb290ID0geTtcbiAgICBlbHNlIGlmICh4ID09PSB4LnAubGVmdClcbiAgICAgIHgucC5sZWZ0ID0geTtcbiAgICBlbHNlXG4gICAgICB4LnAucmlnaHQgPSB5O1xuICAgIHkubGVmdCA9IHg7XG4gICAgeC5wID0geTtcbiAgfVxuXG4gIHByaXZhdGUgcmlnaHRSb3RhdGUoeDogUmJUcmVlTm9kZTxUPikge1xuICAgIGNvbnN0IHkgPSB4LmxlZnQ7XG4gICAgaWYgKHkgPT0gbnVsbClcbiAgICAgIHJldHVybjtcbiAgICB4LmxlZnQgPSB5LnJpZ2h0O1xuICAgIGlmICh5LnJpZ2h0KSB7XG4gICAgICB5LnJpZ2h0LnAgPSB4O1xuICAgIH1cbiAgICB5LnAgPSB4LnA7XG4gICAgaWYgKHgucCA9PSBudWxsKVxuICAgICAgdGhpcy5yb290ID0geTtcbiAgICBlbHNlIGlmICh4ID09PSB4LnAucmlnaHQpXG4gICAgICB4LnAucmlnaHQgPSB5O1xuICAgIGVsc2VcbiAgICAgIHgucC5sZWZ0ID0geTtcbiAgICB5LnJpZ2h0ID0geDtcbiAgICB4LnAgPSB5O1xuICB9XG59XG5cbiJdfQ==