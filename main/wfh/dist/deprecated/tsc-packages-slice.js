"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getStore = exports.getState = exports.tscActionDispatcher = exports.tscSlice = void 0;
const store_1 = require("../store");
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const operators_1 = require("rxjs/operators");
const rxjs_1 = require("rxjs");
const package_mgr_1 = require("../package-mgr");
const initialState = {
    configs: new Map()
};
exports.tscSlice = store_1.stateFactory.newSlice({
    name: 'tsc',
    initialState,
    reducers: {
        // normalizePackageJsonTscProperty(d, action: PayloadAction) {},
        putConfig(draft, { payload }) {
            for (const { pkg, items } of payload)
                draft.configs.set(pkg, items);
        }
    }
});
exports.tscActionDispatcher = store_1.stateFactory.bindActionCreators(exports.tscSlice);
const releaseEpic = store_1.stateFactory.addEpic((action$) => {
    return (0, rxjs_1.merge)((0, package_mgr_1.getStore)().pipe((0, operators_1.map)(s => s.srcPackages), (0, operators_1.distinctUntilChanged)(), (0, operators_1.skip)(1), (0, operators_1.debounceTime)(500), (0, operators_1.mergeMap)(pkgMap => {
        return (0, rxjs_1.merge)(...Array.from(pkgMap.values())
            .map(pkg => normalizePackageJsonTscProperty$(pkg)))
            .pipe((0, operators_1.reduce)((all, configs) => {
            all.push(configs);
            return all;
        }, []));
    }), (0, operators_1.map)(configs => exports.tscActionDispatcher.putConfig(configs)))).pipe((0, operators_1.catchError)(ex => {
        // eslint-disable-next-line no-console
        console.error(ex);
        return (0, rxjs_1.of)();
    }), (0, operators_1.ignoreElements)());
});
function getState() {
    return store_1.stateFactory.sliceState(exports.tscSlice);
}
exports.getState = getState;
function getStore() {
    return store_1.stateFactory.sliceStore(exports.tscSlice);
}
exports.getStore = getStore;
function normalizePackageJsonTscProperty$(pkg) {
    const dr = pkg.json.dr;
    let rawConfigs;
    if (dr && dr.tsc) {
        const items = Array.isArray(dr.tsc) ? dr.tsc : [dr.tsc];
        rawConfigs = (0, rxjs_1.from)(items);
    }
    else {
        const rawConfigs2 = new rxjs_1.ReplaySubject();
        rawConfigs = rawConfigs2;
        fs_1.default.exists(path_1.default.resolve(pkg.realPath, 'isom'), exists => {
            if (exists) {
                const temp = { rootDir: 'isom', outDir: 'isom' };
                rawConfigs2.next(temp);
            }
            const temp = {
                rootDir: 'ts',
                outDir: 'dist'
            };
            rawConfigs2.next(temp);
            rawConfigs2.complete();
        });
    }
    return rawConfigs.pipe((0, operators_1.reduce)((all, item) => {
        all.push(item);
        return all;
    }, []), (0, operators_1.map)(items => {
        return { pkg: pkg.name, items };
    }));
}
if (module.hot) {
    module.hot.dispose(data => {
        store_1.stateFactory.removeSlice(exports.tscSlice);
        releaseEpic();
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHNjLXBhY2thZ2VzLXNsaWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvZGVwcmVjYXRlZC90c2MtcGFja2FnZXMtc2xpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0Esb0NBQXdDO0FBQ3hDLDRDQUFvQjtBQUNwQixnREFBd0I7QUFDeEIsOENBRXdCO0FBQ3hCLCtCQUFnRTtBQUNoRSxnREFBb0U7QUFvQnBFLE1BQU0sWUFBWSxHQUFhO0lBQzdCLE9BQU8sRUFBRSxJQUFJLEdBQUcsRUFBRTtDQUNuQixDQUFDO0FBRVcsUUFBQSxRQUFRLEdBQUcsb0JBQVksQ0FBQyxRQUFRLENBQUM7SUFDNUMsSUFBSSxFQUFFLEtBQUs7SUFDWCxZQUFZO0lBQ1osUUFBUSxFQUFFO1FBQ1IsZ0VBQWdFO1FBQ2hFLFNBQVMsQ0FBQyxLQUFLLEVBQUUsRUFBQyxPQUFPLEVBQXNFO1lBQzdGLEtBQUssTUFBTSxFQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUMsSUFBSSxPQUFPO2dCQUNoQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEMsQ0FBQztLQUNGO0NBQ0YsQ0FBQyxDQUFDO0FBRVUsUUFBQSxtQkFBbUIsR0FBRyxvQkFBWSxDQUFDLGtCQUFrQixDQUFDLGdCQUFRLENBQUMsQ0FBQztBQUU3RSxNQUFNLFdBQVcsR0FBRyxvQkFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO0lBQ25ELE9BQU8sSUFBQSxZQUFLLEVBQ1YsSUFBQSxzQkFBVyxHQUFFLENBQUMsSUFBSSxDQUNoQixJQUFBLGVBQUcsRUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsRUFDdkIsSUFBQSxnQ0FBb0IsR0FBRSxFQUN0QixJQUFBLGdCQUFJLEVBQUMsQ0FBQyxDQUFDLEVBQ1AsSUFBQSx3QkFBWSxFQUFDLEdBQUcsQ0FBQyxFQUNqQixJQUFBLG9CQUFRLEVBQUMsTUFBTSxDQUFDLEVBQUU7UUFDaEIsT0FBTyxJQUFBLFlBQUssRUFBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO2FBQ3hDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLGdDQUFnQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDbEQsSUFBSSxDQUNILElBQUEsa0JBQU0sRUFBcUIsQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDMUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNsQixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FDUCxDQUFDO0lBQ04sQ0FBQyxDQUFDLEVBQ0YsSUFBQSxlQUFHLEVBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQywyQkFBbUIsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FDdkQsQ0FDRixDQUFDLElBQUksQ0FDSixJQUFBLHNCQUFVLEVBQUMsRUFBRSxDQUFDLEVBQUU7UUFDZCxzQ0FBc0M7UUFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixPQUFPLElBQUEsU0FBRSxHQUFpQixDQUFDO0lBQzdCLENBQUMsQ0FBQyxFQUNGLElBQUEsMEJBQWMsR0FBRSxDQUNqQixDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFnQixRQUFRO0lBQ3RCLE9BQU8sb0JBQVksQ0FBQyxVQUFVLENBQUMsZ0JBQVEsQ0FBQyxDQUFDO0FBQzNDLENBQUM7QUFGRCw0QkFFQztBQUVELFNBQWdCLFFBQVE7SUFDdEIsT0FBTyxvQkFBWSxDQUFDLFVBQVUsQ0FBQyxnQkFBUSxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUZELDRCQUVDO0FBRUQsU0FBUyxnQ0FBZ0MsQ0FBQyxHQUFnQjtJQUV4RCxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUN2QixJQUFJLFVBQWtELENBQUM7SUFFdkQsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsRUFBRTtRQUNoQixNQUFNLEtBQUssR0FBaUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RGLFVBQVUsR0FBRyxJQUFBLFdBQUksRUFBK0IsS0FBSyxDQUFDLENBQUM7S0FDeEQ7U0FBTTtRQUNMLE1BQU0sV0FBVyxHQUFHLElBQUksb0JBQWEsRUFBOEIsQ0FBQztRQUNwRSxVQUFVLEdBQUcsV0FBVyxDQUFDO1FBQ3pCLFlBQUUsQ0FBQyxNQUFNLENBQUMsY0FBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ3JELElBQUksTUFBTSxFQUFFO2dCQUNWLE1BQU0sSUFBSSxHQUErQixFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBQyxDQUFDO2dCQUMzRSxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3hCO1lBQ0QsTUFBTSxJQUFJLEdBQStCO2dCQUN2QyxPQUFPLEVBQUUsSUFBSTtnQkFDYixNQUFNLEVBQUUsTUFBTTthQUNmLENBQUM7WUFDRixXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZCLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztLQUNKO0lBQ0QsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUNwQixJQUFBLGtCQUFNLEVBQTZCLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQy9DLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDZixPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUMsRUFBRSxFQUFFLENBQUMsRUFDTixJQUFBLGVBQUcsRUFBQyxLQUFLLENBQUMsRUFBRTtRQUNWLE9BQU8sRUFBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUMsQ0FDSCxDQUFDO0FBQ0osQ0FBQztBQUVELElBQUksTUFBTSxDQUFDLEdBQUcsRUFBRTtJQUNkLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3hCLG9CQUFZLENBQUMsV0FBVyxDQUFDLGdCQUFRLENBQUMsQ0FBQztRQUNuQyxXQUFXLEVBQUUsQ0FBQztJQUNoQixDQUFDLENBQUMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGF5bG9hZEFjdGlvbiB9IGZyb20gJ0ByZWR1eGpzL3Rvb2xraXQnO1xuaW1wb3J0IHsgc3RhdGVGYWN0b3J5IH0gZnJvbSAnLi4vc3RvcmUnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHttYXAsIG1lcmdlTWFwLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgY2F0Y2hFcnJvciwgaWdub3JlRWxlbWVudHMsIGRlYm91bmNlVGltZSwgcmVkdWNlLFxuICBza2lwXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7b2YsIGZyb20sIG1lcmdlLCBSZXBsYXlTdWJqZWN0LCBPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7Z2V0U3RvcmUgYXMgZ2V0UGtnU3RvcmUsIFBhY2thZ2VJbmZvfSBmcm9tICcuLi9wYWNrYWdlLW1ncic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFja2FnZUpzb25Uc2NQcm9wZXJ0eUl0ZW0ge1xuICByb290RGlyOiBzdHJpbmc7XG4gIG91dERpcjogc3RyaW5nO1xuICBmaWxlcz86IHN0cmluZ1tdO1xuICAvKiogXCJyZWZlcmVuY2VzXCIgaW4gdHNjb25maWcgaHR0cHM6Ly93d3cudHlwZXNjcmlwdGxhbmcub3JnL2RvY3MvaGFuZGJvb2svcHJvamVjdC1yZWZlcmVuY2VzLmh0bWwgKi9cbiAgcmVmZXJlbmNlcz86IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgQ29uZmlnSXRlbVdpdGhOYW1lIHtcbiAgcGtnOiBzdHJpbmc7XG4gIGl0ZW1zOiBQYWNrYWdlSnNvblRzY1Byb3BlcnR5SXRlbVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRzY1N0YXRlIHtcbiAgLyoqIGtleSBpcyBwYWNrYWdlIG5hbWUgKi9cbiAgY29uZmlnczogTWFwPHN0cmluZywgUGFja2FnZUpzb25Uc2NQcm9wZXJ0eUl0ZW1bXT47XG59XG5cbmNvbnN0IGluaXRpYWxTdGF0ZTogVHNjU3RhdGUgPSB7XG4gIGNvbmZpZ3M6IG5ldyBNYXAoKVxufTtcblxuZXhwb3J0IGNvbnN0IHRzY1NsaWNlID0gc3RhdGVGYWN0b3J5Lm5ld1NsaWNlKHtcbiAgbmFtZTogJ3RzYycsXG4gIGluaXRpYWxTdGF0ZSxcbiAgcmVkdWNlcnM6IHtcbiAgICAvLyBub3JtYWxpemVQYWNrYWdlSnNvblRzY1Byb3BlcnR5KGQsIGFjdGlvbjogUGF5bG9hZEFjdGlvbikge30sXG4gICAgcHV0Q29uZmlnKGRyYWZ0LCB7cGF5bG9hZH06IFBheWxvYWRBY3Rpb248e3BrZzogc3RyaW5nLCBpdGVtczogUGFja2FnZUpzb25Uc2NQcm9wZXJ0eUl0ZW1bXX1bXT4pIHtcbiAgICAgIGZvciAoY29uc3Qge3BrZywgaXRlbXN9IG9mIHBheWxvYWQpXG4gICAgICAgIGRyYWZ0LmNvbmZpZ3Muc2V0KHBrZywgaXRlbXMpO1xuICAgIH1cbiAgfVxufSk7XG5cbmV4cG9ydCBjb25zdCB0c2NBY3Rpb25EaXNwYXRjaGVyID0gc3RhdGVGYWN0b3J5LmJpbmRBY3Rpb25DcmVhdG9ycyh0c2NTbGljZSk7XG5cbmNvbnN0IHJlbGVhc2VFcGljID0gc3RhdGVGYWN0b3J5LmFkZEVwaWMoKGFjdGlvbiQpID0+IHtcbiAgcmV0dXJuIG1lcmdlKFxuICAgIGdldFBrZ1N0b3JlKCkucGlwZShcbiAgICAgIG1hcChzID0+IHMuc3JjUGFja2FnZXMpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIHNraXAoMSksXG4gICAgICBkZWJvdW5jZVRpbWUoNTAwKSxcbiAgICAgIG1lcmdlTWFwKHBrZ01hcCA9PiB7XG4gICAgICAgIHJldHVybiBtZXJnZSguLi5BcnJheS5mcm9tKHBrZ01hcC52YWx1ZXMoKSlcbiAgICAgICAgICAubWFwKHBrZyA9PiBub3JtYWxpemVQYWNrYWdlSnNvblRzY1Byb3BlcnR5JChwa2cpKSlcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHJlZHVjZTxDb25maWdJdGVtV2l0aE5hbWU+KChhbGwsIGNvbmZpZ3MpID0+IHtcbiAgICAgICAgICAgICAgYWxsLnB1c2goY29uZmlncyk7XG4gICAgICAgICAgICAgIHJldHVybiBhbGw7XG4gICAgICAgICAgICB9LCBbXSlcbiAgICAgICAgICApO1xuICAgICAgfSksXG4gICAgICBtYXAoY29uZmlncyA9PiB0c2NBY3Rpb25EaXNwYXRjaGVyLnB1dENvbmZpZyhjb25maWdzKSlcbiAgICApXG4gICkucGlwZShcbiAgICBjYXRjaEVycm9yKGV4ID0+IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmVycm9yKGV4KTtcbiAgICAgIHJldHVybiBvZjxQYXlsb2FkQWN0aW9uPigpO1xuICAgIH0pLFxuICAgIGlnbm9yZUVsZW1lbnRzKClcbiAgKTtcbn0pO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RhdGUoKSB7XG4gIHJldHVybiBzdGF0ZUZhY3Rvcnkuc2xpY2VTdGF0ZSh0c2NTbGljZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdG9yZSgpIHtcbiAgcmV0dXJuIHN0YXRlRmFjdG9yeS5zbGljZVN0b3JlKHRzY1NsaWNlKTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplUGFja2FnZUpzb25Uc2NQcm9wZXJ0eSQocGtnOiBQYWNrYWdlSW5mbykge1xuXG4gIGNvbnN0IGRyID0gcGtnLmpzb24uZHI7XG4gIGxldCByYXdDb25maWdzOiBPYnNlcnZhYmxlPFBhY2thZ2VKc29uVHNjUHJvcGVydHlJdGVtPjtcblxuICBpZiAoZHIgJiYgZHIudHNjKSB7XG4gICAgY29uc3QgaXRlbXM6IFBhY2thZ2VKc29uVHNjUHJvcGVydHlJdGVtW10gPSBBcnJheS5pc0FycmF5KGRyLnRzYykgPyBkci50c2MgOiBbZHIudHNjXTtcbiAgICByYXdDb25maWdzID0gZnJvbTxQYWNrYWdlSnNvblRzY1Byb3BlcnR5SXRlbVtdPihpdGVtcyk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgcmF3Q29uZmlnczIgPSBuZXcgUmVwbGF5U3ViamVjdDxQYWNrYWdlSnNvblRzY1Byb3BlcnR5SXRlbT4oKTtcbiAgICByYXdDb25maWdzID0gcmF3Q29uZmlnczI7XG4gICAgZnMuZXhpc3RzKFBhdGgucmVzb2x2ZShwa2cucmVhbFBhdGgsICdpc29tJyksIGV4aXN0cyA9PiB7XG4gICAgICBpZiAoZXhpc3RzKSB7XG4gICAgICAgIGNvbnN0IHRlbXA6IFBhY2thZ2VKc29uVHNjUHJvcGVydHlJdGVtID0ge3Jvb3REaXI6ICdpc29tJywgb3V0RGlyOiAnaXNvbSd9O1xuICAgICAgICByYXdDb25maWdzMi5uZXh0KHRlbXApO1xuICAgICAgfVxuICAgICAgY29uc3QgdGVtcDogUGFja2FnZUpzb25Uc2NQcm9wZXJ0eUl0ZW0gPSB7XG4gICAgICAgIHJvb3REaXI6ICd0cycsXG4gICAgICAgIG91dERpcjogJ2Rpc3QnXG4gICAgICB9O1xuICAgICAgcmF3Q29uZmlnczIubmV4dCh0ZW1wKTtcbiAgICAgIHJhd0NvbmZpZ3MyLmNvbXBsZXRlKCk7XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIHJhd0NvbmZpZ3MucGlwZShcbiAgICByZWR1Y2U8UGFja2FnZUpzb25Uc2NQcm9wZXJ0eUl0ZW0+KChhbGwsIGl0ZW0pID0+IHtcbiAgICAgIGFsbC5wdXNoKGl0ZW0pO1xuICAgICAgcmV0dXJuIGFsbDtcbiAgICB9LCBbXSksXG4gICAgbWFwKGl0ZW1zID0+IHtcbiAgICAgIHJldHVybiB7cGtnOiBwa2cubmFtZSwgaXRlbXN9O1xuICAgIH0pXG4gICk7XG59XG5cbmlmIChtb2R1bGUuaG90KSB7XG4gIG1vZHVsZS5ob3QuZGlzcG9zZShkYXRhID0+IHtcbiAgICBzdGF0ZUZhY3RvcnkucmVtb3ZlU2xpY2UodHNjU2xpY2UpO1xuICAgIHJlbGVhc2VFcGljKCk7XG4gIH0pO1xufVxuIl19