{"version":3,"file":"bootstrap-process.js","sourceRoot":"","sources":["../../ts/utils/bootstrap-process.ts"],"names":[],"mappings":"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","sourcesContent":["import '../node-path';\nimport log4js from 'log4js';\nimport * as rx from 'rxjs';\nimport * as op from 'rxjs/operators';\nimport config from '../config';\n// import logConfig from '../log-config';\nimport {GlobalOptions} from '../cmd/types';\nimport * as store from '../store';\n\nconst log = log4js.getLogger('plink.bootstrap-process');\n\n/** When process is on 'SIGINT' and \"beforeExit\", all functions will be executed */\nexport const exitHooks = [] as Array<() => (rx.ObservableInput<unknown> | void | number)>;\n\nprocess.on('uncaughtException', function(err) {\n  log.error('Uncaught exception: ', err);\n  throw err; // let PM2 handle exception\n});\n\nprocess.on('unhandledRejection', err => {\n  log.error('unhandledRejection', err);\n});\n/**\n * Must invoke initProcess() or initAsChildProcess() before this function.\n * If this function is called from a child process or thread worker of Plink,\n * you may pass `JSON.parse(process.env.PLINK_CLI_OPTS!)` as parameter since\n * Plink's main process save `GlobalOptions` in environment variable \"PLINK_CLI_OPTS\",\n * so that child process gets same GlobalOptions as the main process does.\n * @param options \n */\nexport function initConfig(options: GlobalOptions = {}) {\n  config.initSync(options);\n  // logConfig(config());\n  return config;\n}\n\n/**\n * - Register process event handler for SIGINT and shutdown command\n * - Initialize redux-store for Plink\n * \n * DO NOT fork a child process on this function\n * @param _onShutdownSignal \n */\nexport function initProcess(saveState: store.StoreSetting['actionOnExit'] = 'none', _onShutdownSignal?: (code: number) => void | Promise<any>, handleShutdownMsg = false) {\n  // TODO: Not working when press ctrl + c, and no async operation can be finished on \"SIGINT\" event\n  process.once('beforeExit', function(code) {\n    log.info('pid ' + process.pid + ': bye');\n    onShut(code, false);\n  });\n  process.once('SIGINT', () => {\n    log.info('pid' + process.pid + ' recieves SIGINT');\n    onShut(0, true);\n  });\n\n  if (handleShutdownMsg) {\n    // Be aware this is why \"initProcess\" can not be \"fork\"ed in a child process, it will keep alive for parent process's 'message' event\n    process.on('message', function(msg) {\n      if (msg === 'shutdown') {\n        // eslint-disable-next-line no-console\n        log.info('Recieve shutdown message from PM2, bye.');\n        onShut(0, true);\n      }\n    });\n  }\n\n  const {dispatcher, storeSavedAction$, stateFactory, startLogging} = require('../store') as typeof store;\n\n  startLogging();\n  stateFactory.configureStore();\n  dispatcher.changeActionOnExit(saveState);\n\n  function onShut(_code: number, explicitlyExit: boolean) {\n    let exitCode = 0;\n    rx.concat(\n      rx.from(exitHooks).pipe(\n        op.mergeMap(hookFn => {\n          try {\n            const ret = hookFn();\n            if (ret == null || typeof ret === 'number') {\n              return rx.of(ret);\n            } else {\n              return rx.from(ret);\n            }\n          } catch (err) {\n            log.error('Failed to execute shutdown hooks', err);\n            exitCode = 1;\n            return rx.EMPTY;\n          }\n        }),\n        op.catchError(err => {\n          log.error('Failed to execute shutdown hooks', err);\n          exitCode = 1;\n          return rx.EMPTY;\n        }),\n        op.map((ret) => {\n          if (typeof ret === 'number' && ret !== 0) {\n            exitCode = ret;\n            log.info('Exit hook returns:', exitCode);\n          }\n        })\n      ),\n      rx.merge(\n        // once \"dispatcher.processExit() is executed, storeSavedAction$ will be emtted recusively.\n        // Therefore storeSavedAction$ must be subscribed before dispatcher.processExit()\n        storeSavedAction$.pipe(op.take(1)),\n        // A defer() can make sure dispatcher.processExit() is called later than storeSavedAction$\n        // being subscribed\n        rx.defer(() => {\n          dispatcher.processExit();\n          return rx.EMPTY;\n        })\n      )\n    ).pipe(\n      op.finalize(() => {\n        if (explicitlyExit) {\n          // eslint-disable-next-line no-console\n          console.log(`Process ${process.pid} Exit with`, exitCode);\n          process.exit(exitCode);\n        } else if (exitCode !== 0) {\n          // eslint-disable-next-line no-console\n          console.log(`Process ${process.pid} Exit with`, exitCode);\n          process.exit(exitCode);\n        }\n      })\n    ).subscribe();\n  }\n  return dispatcher;\n}\n\n/**\n * Initialize redux-store for Plink.\n * \n * Use this function instead of initProcess() in case it is in a forked child process or worker thread of Plink.\n * So that plink won't listener to PM2's shutdown message in this case.\n * Be aware that Plink main process could be a child process of PM2 or any other Node.js process manager,\n * that's what initProcess() does to listener to PM2's message.\n\n * Unlink initProcess() which registers process event handler for SIGINT and shutdown command,\n * in case this is running as a forked child process, it will stand by until parent process explicitly\n *  sends a signal to exit\n * @param syncState send changed state back to main process\n */\nexport function initAsChildProcess(saveState: store.StoreSetting['actionOnExit'] = 'none', onShutdownSignal?: () => void | Promise<any>) {\n  return initProcess(saveState, onShutdownSignal, false);\n}\n"]}