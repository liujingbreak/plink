"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Token = void 0;
const async_LLn_parser_1 = require("../async-LLn-parser");
Object.defineProperty(exports, "Token", { enumerable: true, get: function () { return async_LLn_parser_1.Token; } });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
function parse(reader, onToken) {
    const input = new rxjs_1.Observable(sub => {
        reader.on('data', (buf) => sub.next(buf.split('')));
        reader.on('end', () => sub.complete());
    });
    const operators = onToken ? [(0, operators_1.tap)(onToken)] : null;
    return (0, async_LLn_parser_1.parser)('JSON', input, parseLex, operators, parseGrammar);
}
exports.default = parse;
async function parseLex(strLookAhead, tokenSub) {
    let char = await strLookAhead.la();
    while (char != null) {
        if (/[{}\[\],:]/.test(char)) {
            strLookAhead.startToken(char);
            await strLookAhead.advance();
            strLookAhead.emitToken();
        }
        else if (/\s/.test(char)) {
            do {
                await strLookAhead.advance();
                char = await strLookAhead.la();
            } while (char && /\s/.test(char));
        }
        else if (/["']/.test(char)) {
            strLookAhead.startToken('stringLiteral');
            const openChar = await strLookAhead.advance();
            while (true) {
                const la = await strLookAhead.la();
                if (la == null) {
                    return strLookAhead.throwError();
                }
                if (la === '\\') {
                    await strLookAhead.advance(2);
                }
                else if (la === openChar) {
                    await strLookAhead.advance();
                    strLookAhead.emitToken();
                    break;
                }
                else {
                    await strLookAhead.advance();
                }
            }
        }
        else {
            strLookAhead.startToken('other');
            let next;
            do {
                await strLookAhead.advance();
                next = await strLookAhead.la();
            } while (next != null && !/[{}\[\],:\s'"]/.test(next));
            strLookAhead.emitToken();
        }
        char = await strLookAhead.la();
    }
}
var AstType;
(function (AstType) {
    AstType[AstType["object"] = 0] = "object";
    AstType[AstType["array"] = 1] = "array";
    AstType[AstType["property"] = 2] = "property";
    AstType[AstType["value"] = 3] = "value";
})(AstType || (AstType = {}));
async function parseGrammar(tokenLa) {
    return doObject(tokenLa);
}
async function doObject(lexer) {
    const ast = {
        type: AstType.object,
        properties: []
    };
    await lexer.advance();
    let next = await lexer.la();
    while (next != null && next.type !== '}') {
        const propToken = await lexer.advance();
        const colon = await lexer.advance();
        if (colon.type !== ':') {
            throw new Error(`Expect ':' but recieve '${colon.text}' at ${colon.line}:${colon.col}`);
        }
        ast.properties.push({ name: propToken, value: await doValue(lexer) });
        next = await lexer.la();
        if (next && next.type === ',')
            await lexer.advance();
        next = await lexer.la();
    }
    await lexer.advance(); // }
    return ast;
}
async function doArray(lexer) {
    const ast = {
        type: AstType.array,
        items: []
    };
    await lexer.advance();
    let next = await lexer.la();
    while (next != null && next.type !== ']') {
        if (next.type !== ',') {
            ast.items.push(await doValue(lexer));
        }
        next = await lexer.la();
    }
    if (next && next.type === ']')
        await lexer.advance(); // ]
    else if (next == null)
        throw new Error('Unexpect EOF after ' + lexer.lastConsumed.text);
    else
        throw new Error(`Unexpect ${next.text} at ${next.line}:${next.col}`);
    return ast;
}
async function doValue(lexer) {
    const next = await lexer.la();
    if (next === null) {
        throw new Error('Unexpect EOF');
    }
    if (next.type === '{') {
        return doObject(lexer);
    }
    else if (next.type === '[') {
        return doArray(lexer);
    }
    else if (next.type === 'stringLiteral' || next.type === 'other') {
        return lexer.advance();
    }
    else {
        throw new Error(`Unexpect '${next.text}' at ${next.line}:${next.col}`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1wYXJzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90cy91dGlscy9qc29uLXBhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSwwREFBeUY7QUFnQmpGLHNGQWhCK0Msd0JBQUssT0FnQi9DO0FBZmIsK0JBQTRDO0FBQzVDLDhDQUFtQztBQUduQyxTQUF3QixLQUFLLENBQUMsTUFBZ0IsRUFBRSxPQUF3QztJQUN0RixNQUFNLEtBQUssR0FBRyxJQUFJLGlCQUFVLENBQVcsR0FBRyxDQUFDLEVBQUU7UUFDM0MsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFXLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUQsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDekMsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBQSxlQUFHLEVBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBRWxELE9BQU8sSUFBQSx5QkFBTSxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNsRSxDQUFDO0FBVEQsd0JBU0M7QUFJRCxLQUFLLFVBQVUsUUFBUSxDQUNyQixZQUFpRCxFQUNqRCxRQUEyQztJQUMzQyxJQUFJLElBQUksR0FBRyxNQUFNLFlBQVksQ0FBQyxFQUFFLEVBQUUsQ0FBQztJQUNuQyxPQUFPLElBQUksSUFBSSxJQUFJLEVBQUU7UUFDbkIsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLFlBQVksQ0FBQyxV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cnNlciwgTG9va0FoZWFkLCBMb29rQWhlYWRPYnNlcnZhYmxlLCBDaHVuaywgVG9rZW59IGZyb20gJy4uL2FzeW5jLUxMbi1wYXJzZXInO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJzY3JpYmVyfSBmcm9tICdyeGpzJztcbmltcG9ydCB7dGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1JlYWRhYmxlfSBmcm9tICdzdHJlYW0nO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwYXJzZShyZWFkZXI6IFJlYWRhYmxlLCBvblRva2VuPzogKHRva2VuOiBUb2tlbjxzdHJpbmc+KSA9PiB2b2lkKSB7XG4gIGNvbnN0IGlucHV0ID0gbmV3IE9ic2VydmFibGU8c3RyaW5nW10+KHN1YiA9PiB7XG4gICAgcmVhZGVyLm9uKCdkYXRhJywgKGJ1Zjogc3RyaW5nKSA9PiBzdWIubmV4dChidWYuc3BsaXQoJycpKSk7XG4gICAgcmVhZGVyLm9uKCdlbmQnLCAoKSA9PiBzdWIuY29tcGxldGUoKSk7XG4gIH0pO1xuXG4gIGNvbnN0IG9wZXJhdG9ycyA9IG9uVG9rZW4gPyBbdGFwKG9uVG9rZW4pXSA6IG51bGw7XG5cbiAgcmV0dXJuIHBhcnNlcignSlNPTicsIGlucHV0LCBwYXJzZUxleCwgb3BlcmF0b3JzLCBwYXJzZUdyYW1tYXIpO1xufVxuXG5leHBvcnQge1Rva2VufTtcblxuYXN5bmMgZnVuY3Rpb24gcGFyc2VMZXgoXG4gIHN0ckxvb2tBaGVhZDogTG9va0FoZWFkT2JzZXJ2YWJsZTxzdHJpbmcsIHN0cmluZz4sXG4gIHRva2VuU3ViOiBTdWJzY3JpYmVyPENodW5rPHN0cmluZywgc3RyaW5nPj4pIHtcbiAgbGV0IGNoYXIgPSBhd2FpdCBzdHJMb29rQWhlYWQubGEoKTtcbiAgd2hpbGUgKGNoYXIgIT0gbnVsbCkge1xuICAgIGlmICgvW3t9XFxbXFxdLDpdLy50ZXN0KGNoYXIpKSB7XG4gICAgICBzdHJMb29rQWhlYWQuc3RhcnRUb2tlbihjaGFyKTtcbiAgICAgIGF3YWl0IHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICBzdHJMb29rQWhlYWQuZW1pdFRva2VuKCk7XG4gICAgfSBlbHNlIGlmICgvXFxzLy50ZXN0KGNoYXIpKSB7XG4gICAgICBkbyB7XG4gICAgICAgIGF3YWl0IHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICAgIGNoYXIgPSBhd2FpdCBzdHJMb29rQWhlYWQubGEoKTtcbiAgICAgIH0gd2hpbGUgKGNoYXIgJiYgL1xccy8udGVzdChjaGFyKSk7XG4gICAgfSBlbHNlIGlmICgvW1wiJ10vLnRlc3QoY2hhcikpIHtcbiAgICAgIHN0ckxvb2tBaGVhZC5zdGFydFRva2VuKCdzdHJpbmdMaXRlcmFsJyk7XG4gICAgICBjb25zdCBvcGVuQ2hhciA9IGF3YWl0IHN0ckxvb2tBaGVhZC5hZHZhbmNlKCk7XG4gICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBjb25zdCBsYSA9IGF3YWl0IHN0ckxvb2tBaGVhZC5sYSgpO1xuICAgICAgICBpZiAobGEgPT0gbnVsbCkge1xuICAgICAgICAgIHJldHVybiBzdHJMb29rQWhlYWQudGhyb3dFcnJvcigpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChsYSA9PT0gJ1xcXFwnKSB7XG4gICAgICAgICAgYXdhaXQgc3RyTG9va0FoZWFkLmFkdmFuY2UoMik7XG4gICAgICAgIH0gZWxzZSBpZiAobGEgPT09IG9wZW5DaGFyKSB7XG4gICAgICAgICAgYXdhaXQgc3RyTG9va0FoZWFkLmFkdmFuY2UoKTtcbiAgICAgICAgICBzdHJMb29rQWhlYWQuZW1pdFRva2VuKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgc3RyTG9va0FoZWFkLmFkdmFuY2UoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBzdHJMb29rQWhlYWQuc3RhcnRUb2tlbignb3RoZXInKTtcbiAgICAgIGxldCBuZXh0OiBzdHJpbmcgfCBudWxsO1xuICAgICAgZG8ge1xuICAgICAgICBhd2FpdCBzdHJMb29rQWhlYWQuYWR2YW5jZSgpO1xuICAgICAgICBuZXh0ID0gYXdhaXQgc3RyTG9va0FoZWFkLmxhKCk7XG4gICAgICB9IHdoaWxlIChuZXh0ICE9IG51bGwgJiYgIS9be31cXFtcXF0sOlxccydcIl0vLnRlc3QobmV4dCkpO1xuICAgICAgc3RyTG9va0FoZWFkLmVtaXRUb2tlbigpO1xuICAgIH1cbiAgICBjaGFyID0gYXdhaXQgc3RyTG9va0FoZWFkLmxhKCk7XG4gIH1cbn1cblxudHlwZSBMZXhlciA9IExvb2tBaGVhZDxUb2tlbjxzdHJpbmc+LCBzdHJpbmc+O1xuXG5lbnVtIEFzdFR5cGUge1xuICBvYmplY3QgPSAwLFxuICBhcnJheSxcbiAgcHJvcGVydHksXG4gIHZhbHVlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXN0IHtcbiAgdHlwZTogQXN0VHlwZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPYmplY3RBc3QgZXh0ZW5kcyBBc3Qge1xuICBwcm9wZXJ0aWVzOiB7bmFtZTogVG9rZW48c3RyaW5nPjsgdmFsdWU6IEFzdHxUb2tlbjxzdHJpbmc+fVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFycmF5QXN0IGV4dGVuZHMgQXN0IHtcbiAgaXRlbXM6IEFycmF5PEFzdCB8IFRva2VuPHN0cmluZz4+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFZhbHVlQXN0IGV4dGVuZHMgQXN0IHtcbiAgdmFsdWU6IFRva2VuPHN0cmluZz47XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhcnNlR3JhbW1hcih0b2tlbkxhOiBMZXhlcikge1xuICByZXR1cm4gZG9PYmplY3QodG9rZW5MYSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvT2JqZWN0KGxleGVyOiBMZXhlcik6IFByb21pc2U8T2JqZWN0QXN0PiB7XG4gIGNvbnN0IGFzdDogT2JqZWN0QXN0ID0ge1xuICAgIHR5cGU6IEFzdFR5cGUub2JqZWN0LFxuICAgIHByb3BlcnRpZXM6IFtdXG4gIH07XG4gIGF3YWl0IGxleGVyLmFkdmFuY2UoKTtcbiAgbGV0IG5leHQgPSBhd2FpdCBsZXhlci5sYSgpO1xuICB3aGlsZSAobmV4dCAhPSBudWxsICYmIG5leHQudHlwZSAhPT0gJ30nKSB7XG4gICAgY29uc3QgcHJvcFRva2VuID0gYXdhaXQgbGV4ZXIuYWR2YW5jZSgpO1xuICAgIGNvbnN0IGNvbG9uID0gYXdhaXQgbGV4ZXIuYWR2YW5jZSgpO1xuICAgIGlmIChjb2xvbi50eXBlICE9PSAnOicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ICc6JyBidXQgcmVjaWV2ZSAnJHtjb2xvbi50ZXh0fScgYXQgJHtjb2xvbi5saW5lfToke2NvbG9uLmNvbH1gKTtcbiAgICB9XG5cbiAgICBhc3QucHJvcGVydGllcy5wdXNoKHtuYW1lOiBwcm9wVG9rZW4sIHZhbHVlOiBhd2FpdCBkb1ZhbHVlKGxleGVyKX0pO1xuICAgIG5leHQgPSBhd2FpdCBsZXhlci5sYSgpO1xuICAgIGlmIChuZXh0ICYmIG5leHQudHlwZSA9PT0gJywnKVxuICAgICAgYXdhaXQgbGV4ZXIuYWR2YW5jZSgpO1xuICAgIG5leHQgPSBhd2FpdCBsZXhlci5sYSgpO1xuICB9XG4gIGF3YWl0IGxleGVyLmFkdmFuY2UoKTsgLy8gfVxuICByZXR1cm4gYXN0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb0FycmF5KGxleGVyOiBMZXhlcik6IFByb21pc2U8QXJyYXlBc3Q+IHtcbiAgY29uc3QgYXN0OiBBcnJheUFzdCA9IHtcbiAgICB0eXBlOiBBc3RUeXBlLmFycmF5LFxuICAgIGl0ZW1zOiBbXVxuICB9O1xuICBhd2FpdCBsZXhlci5hZHZhbmNlKCk7XG4gIGxldCBuZXh0ID0gYXdhaXQgbGV4ZXIubGEoKTtcbiAgd2hpbGUgKG5leHQgIT0gbnVsbCAmJiBuZXh0LnR5cGUgIT09ICddJykge1xuICAgIGlmIChuZXh0LnR5cGUgIT09ICcsJykge1xuICAgICAgYXN0Lml0ZW1zLnB1c2goYXdhaXQgZG9WYWx1ZShsZXhlcikpO1xuICAgIH1cbiAgICBuZXh0ID0gYXdhaXQgbGV4ZXIubGEoKTtcbiAgfVxuICBpZiAobmV4dCAmJiBuZXh0LnR5cGUgPT09ICddJylcbiAgICBhd2FpdCBsZXhlci5hZHZhbmNlKCk7IC8vIF1cbiAgZWxzZSBpZiAobmV4dCA9PSBudWxsKVxuICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3QgRU9GIGFmdGVyICcgKyBsZXhlci5sYXN0Q29uc3VtZWQhLnRleHQpO1xuICBlbHNlXG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdCAke25leHQudGV4dH0gYXQgJHtuZXh0LmxpbmV9OiR7bmV4dC5jb2x9YCk7XG4gIHJldHVybiBhc3Q7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvVmFsdWUobGV4ZXI6IExleGVyKSB7XG4gIGNvbnN0IG5leHQgPSBhd2FpdCBsZXhlci5sYSgpO1xuICBpZiAobmV4dCA9PT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3QgRU9GJyk7XG4gIH1cbiAgaWYgKG5leHQudHlwZSA9PT0gJ3snKSB7XG4gICAgcmV0dXJuIGRvT2JqZWN0KGxleGVyKTtcbiAgfSBlbHNlIGlmIChuZXh0LnR5cGUgPT09ICdbJykge1xuICAgIHJldHVybiBkb0FycmF5KGxleGVyKTtcbiAgfSBlbHNlIGlmIChuZXh0LnR5cGUgPT09ICdzdHJpbmdMaXRlcmFsJyB8fCBuZXh0LnR5cGUgPT09ICdvdGhlcicpIHtcbiAgICByZXR1cm4gbGV4ZXIuYWR2YW5jZSgpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3QgJyR7bmV4dC50ZXh0fScgYXQgJHtuZXh0LmxpbmV9OiR7bmV4dC5jb2x9YCk7XG4gIH1cbn1cbiJdfQ==