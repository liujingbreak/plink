"use strict";
/**
 * According to the book << Introduction to Algorithms, Third Edition >>
 *
 * features in progress: Dynamic order statistics, range tree
 *
 * This data structure is meant for being extend, since the majority of 3rd-party red-black tree on npmjs.org is not extensible
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.DuplicateKeyTree = exports.RedBlackTree = void 0;
class RedBlackTree {
    constructor(comparator) {
        this.comparator = comparator;
        this.root = null;
        if (comparator == null) {
            this.comparator = (a, b) => {
                return a < b ? -1 :
                    a > b ? 1 : 0;
            };
        }
    }
    /**
     *
     * @param key
     * @returns null if key duplicates with existing tree node
     */
    insert(key) {
        let y = null;
        let x = this.root;
        let cmp;
        while (x) {
            y = x;
            cmp = this.comparator(key, x.key);
            if (cmp < 0) {
                x = x.left;
            }
            else if (cmp > 0) {
                x = x.right;
            }
            else {
                return null; // duplicate key found
            }
        }
        const z = {
            isRed: true,
            key,
            p: y,
            left: null,
            right: null,
            size: 0
        };
        if (y == null) {
            this.root = z;
            // z.isRed = false;
        }
        else if (cmp < 0) {
            y.left = z;
        }
        else if (cmp > 0) {
            y.right = z;
        }
        this.redBlackInsertFixUp(z);
        return z;
    }
    delete(key) {
        const node = this.search(key);
        if (node == null) {
            return false;
        }
        this.deleteNode(node);
        return true;
    }
    isRed(node) {
        return node != null && node.isRed;
    }
    isBlack(node) {
        return node == null || !node.isRed;
    }
    deleteNode(z) {
        let y = z;
        let origIsRed = this.isRed(y);
        let x = null;
        if (z.left == null) {
            x = z.right;
            this.transplant(z, z.right);
        }
        else if (z.right == null) {
            x = z.left;
            this.transplant(z, z.left);
        }
        else {
            // both left and right child are not empty
            y = this.minimumOf(z.right);
            if (y == null)
                return false;
            origIsRed = this.isRed(y);
            x = y.right;
            if (y.p === z) {
                if (x)
                    x.p = y;
            }
            else {
                this.transplant(y, y.right);
                y.right = z.right;
                y.right.p = y;
            }
            this.transplant(z, y);
            y.left = z.left;
            y.left.p = y;
            y.isRed = this.isRed(z);
        }
        if (!origIsRed && x) {
            // console.log('delete fixup', x.key);
            this.deleteFixup(x);
        }
        return true;
    }
    deleteFixup(x) {
        while (x !== this.root && this.isBlack(x)) {
            if (x.p && x === x.p.left) {
                let w = x.p.right; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.leftRotate(x.p);
                    w = x.p.right;
                }
                if (w) {
                    if (this.isBlack(w.left) && this.isBlack(w.right)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.right)) {
                            if (w.left)
                                w.left.isRed = false;
                            w.isRed = true;
                            this.rightRotate(w);
                            w = x.p.right;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.right)
                            w.right.isRed = false;
                        this.leftRotate(x.p);
                        x = this.root;
                    }
                }
            }
            else if (x.p && x === x.p.right) {
                let w = x.p.left; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.rightRotate(x.p);
                    w = x.p.left;
                }
                if (w) {
                    if (this.isBlack(w.right) && this.isBlack(w.left)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.left)) {
                            if (w.right)
                                w.right.isRed = false;
                            w.isRed = true;
                            this.leftRotate(w);
                            w = x.p.left;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.left)
                            w.left.isRed = false;
                        this.rightRotate(x.p);
                        x = this.root;
                    }
                }
            }
        }
        x.isRed = false;
    }
    minimumOf(node = this.root) {
        // let min: RbTreeNode<T> | null = null;
        while (node === null || node === void 0 ? void 0 : node.left) {
            // min = node;
            node = node.left;
        }
        return node ? node : null;
    }
    // maximumOf(node: RbTreeNode<T> = this.root) {
    //   while (this.isNotNil(node))
    //     node = node.right;
    //   return node;
    // }
    transplant(replaceNode, withNode = null) {
        if (replaceNode.p == null) {
            this.root = withNode;
        }
        else if (replaceNode === replaceNode.p.left) {
            replaceNode.p.left = withNode;
        }
        else {
            replaceNode.p.right = withNode;
        }
        if (withNode)
            withNode.p = replaceNode.p;
    }
    search(key) {
        let node = this.root;
        while (node) {
            const cmp = this.comparator(key, node.key);
            if (cmp === 0)
                return node;
            if (cmp < 0) {
                node = node.left;
            }
            else {
                node = node.right;
            }
        }
        return null;
    }
    redBlackInsertFixUp(z) {
        var _a, _b;
        while (this.isRed(z.p)) {
            if (((_a = z.p) === null || _a === void 0 ? void 0 : _a.p) && z.p === z.p.p.left) {
                const uncle = z.p.p.right;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.right) {
                        // if is right child tree
                        z = z.p;
                        this.leftRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.rightRotate(z.p.p);
                        }
                    }
                }
            }
            else if (((_b = z.p) === null || _b === void 0 ? void 0 : _b.p) && z.p === z.p.p.right) {
                const uncle = z.p.p.left;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.left) {
                        // if is right child tree
                        z = z.p;
                        this.rightRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.leftRotate(z.p.p);
                        }
                    }
                }
            }
        }
        if (this.root)
            this.root.isRed = false;
    }
    leftRotate(x) {
        // console.log('leftRotate', x.key);
        const y = x.right;
        if (y == null)
            return;
        x.right = y.left;
        if (y.left) {
            y.left.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.left)
            x.p.left = y;
        else
            x.p.right = y;
        y.left = x;
        x.p = y;
    }
    rightRotate(x) {
        const y = x.left;
        if (y == null)
            return;
        x.left = y.right;
        if (y.right) {
            y.right.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.right)
            x.p.right = y;
        else
            x.p.left = y;
        y.right = x;
        x.p = y;
    }
}
exports.RedBlackTree = RedBlackTree;
/** Allow inserting multiple items with same key in a red-black tree */
class DuplicateKeyTree extends RedBlackTree {
}
exports.DuplicateKeyTree = DuplicateKeyTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zdHJ1Y3R1cmVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvdXRpbHMvZGF0YS1zdHJ1Y3R1cmVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7OztBQVVILE1BQWEsWUFBWTtJQUd2QixZQUFvQixVQUF1QztRQUF2QyxlQUFVLEdBQVYsVUFBVSxDQUE2QjtRQUYzRCxTQUFJLEdBQXFDLElBQUksQ0FBQztRQUc1QyxJQUFJLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLEdBQU07UUFDWCxJQUFJLENBQUMsR0FBeUIsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDbEIsSUFBSSxHQUFXLENBQUM7UUFDaEIsT0FBTyxDQUFDLEVBQUU7WUFDUixDQUFDLEdBQUcsQ0FBQyxDQUFFO1lBQ1AsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7Z0JBQ1gsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDWjtpQkFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7Z0JBQ2xCLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2FBQ2I7aUJBQU07Z0JBQ0wsT0FBTyxJQUFJLENBQUMsQ0FBQyxz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QUksQ0FBQyxJQUFJLElBQUk7WUFDWCxPQUFPO1FBQ1QsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRTtZQUNYLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNmO1FBQ0QsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1YsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUk7WUFDYixJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQzthQUNYLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSztZQUN0QixDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7O1lBRWQsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDWixDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNWLENBQUM7Q0FDRjtBQTdTRCxvQ0E2U0M7QUFFRCx1RUFBdUU7QUFDdkUsTUFBYSxnQkFBb0IsU0FBUSxZQUFlO0NBRXZEO0FBRkQsNENBRUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFjY29yZGluZyB0byB0aGUgYm9vayA8PCBJbnRyb2R1Y3Rpb24gdG8gQWxnb3JpdGhtcywgVGhpcmQgRWRpdGlvbiA+PlxuICogXG4gKiBmZWF0dXJlcyBpbiBwcm9ncmVzczogRHluYW1pYyBvcmRlciBzdGF0aXN0aWNzLCByYW5nZSB0cmVlXG4gKiBcbiAqIFRoaXMgZGF0YSBzdHJ1Y3R1cmUgaXMgbWVhbnQgZm9yIGJlaW5nIGV4dGVuZCwgc2luY2UgdGhlIG1ham9yaXR5IG9mIDNyZC1wYXJ0eSByZWQtYmxhY2sgdHJlZSBvbiBucG1qcy5vcmcgaXMgbm90IGV4dGVuc2libGVcbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIFJiVHJlZU5vZGU8VD4ge1xuICBrZXk6IFQ7XG4gIHA6IFJiVHJlZU5vZGU8VD4gfCBudWxsO1xuICBsZWZ0OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbDtcbiAgcmlnaHQ6IFJiVHJlZU5vZGU8VD4gfCBudWxsO1xuICBpc1JlZDogYm9vbGVhbjtcbiAgc2l6ZTogbnVtYmVyO1xufVxuZXhwb3J0IGNsYXNzIFJlZEJsYWNrVHJlZTxUPiB7XG4gIHJvb3Q6IFJiVHJlZU5vZGU8VD4gfCBudWxsIHwgdW5kZWZpbmVkID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbXBhcmF0b3I/OiAoYTogVCwgYjogVCkgPT4gLTEgfCAwIHwgMSkge1xuICAgIGlmIChjb21wYXJhdG9yID09IG51bGwpIHtcbiAgICAgIHRoaXMuY29tcGFyYXRvciA9IChhLCBiKSA9PiB7XG4gICAgICAgIHJldHVybiBhIDwgYiA/IC0xIDpcbiAgICAgICAgICBhID4gYiA/IDEgOiAwO1xuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBrZXlcbiAgICogQHJldHVybnMgbnVsbCBpZiBrZXkgZHVwbGljYXRlcyB3aXRoIGV4aXN0aW5nIHRyZWUgbm9kZVxuICAgKi9cbiAgaW5zZXJ0KGtleTogVCk6IFJiVHJlZU5vZGU8VD4gfCBudWxsIHtcbiAgICBsZXQgeTogUmJUcmVlTm9kZTxUPiB8IG51bGwgPSBudWxsO1xuICAgIGxldCB4ID0gdGhpcy5yb290O1xuICAgIGxldCBjbXA6IG51bWJlcjtcbiAgICB3aGlsZSAoeCkge1xuICAgICAgeSA9IHggO1xuICAgICAgY21wID0gdGhpcy5jb21wYXJhdG9yIShrZXksIHgua2V5KTtcbiAgICAgIGlmIChjbXAgPCAwKSB7XG4gICAgICAgIHggPSB4LmxlZnQ7XG4gICAgICB9IGVsc2UgaWYgKGNtcCA+IDApIHtcbiAgICAgICAgeCA9IHgucmlnaHQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbnVsbDsgLy8gZHVwbGljYXRlIGtleSBmb3VuZFxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB6OiBSYlRyZWVOb2RlPFQ+ID0ge1xuICAgICAgaXNSZWQ6IHRydWUsXG4gICAgICBrZXksXG4gICAgICBwOiB5LFxuICAgICAgbGVmdDogbnVsbCxcbiAgICAgIHJpZ2h0OiBudWxsLFxuICAgICAgc2l6ZTogMFxuICAgIH07XG4gICAgaWYgKHkgPT0gbnVsbCkge1xuICAgICAgdGhpcy5yb290ID0gejtcbiAgICAgIC8vIHouaXNSZWQgPSBmYWxzZTtcbiAgICB9IGVsc2UgaWYgKGNtcCEgPCAwICkge1xuICAgICAgeS5sZWZ0ID0gejtcbiAgICB9IGVsc2UgaWYgKGNtcCEgPiAwICkge1xuICAgICAgeS5yaWdodCA9IHo7XG4gICAgfVxuICAgIHRoaXMucmVkQmxhY2tJbnNlcnRGaXhVcCh6KTtcbiAgICByZXR1cm4gejtcbiAgfVxuXG4gIGRlbGV0ZShrZXk6IFQpIHtcbiAgICBjb25zdCBub2RlID0gdGhpcy5zZWFyY2goa2V5KTtcbiAgICBpZiAobm9kZSA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuZGVsZXRlTm9kZShub2RlKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGlzUmVkKG5vZGU6IFJiVHJlZU5vZGU8VD4gfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIG5vZGUgIT0gbnVsbCAmJiBub2RlLmlzUmVkO1xuICB9XG5cbiAgaXNCbGFjayhub2RlOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBub2RlID09IG51bGwgfHwgIW5vZGUuaXNSZWQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgZGVsZXRlTm9kZSh6OiBSYlRyZWVOb2RlPFQ+KSB7XG4gICAgbGV0IHk6IFJiVHJlZU5vZGU8VD4gfCBudWxsICA9IHo7XG4gICAgbGV0IG9yaWdJc1JlZCA9IHRoaXMuaXNSZWQoeSk7XG4gICAgbGV0IHg6IFJiVHJlZU5vZGU8VD4gfCBudWxsID0gbnVsbDtcbiAgICBpZiAoei5sZWZ0ID09IG51bGwpIHtcbiAgICAgIHggPSB6LnJpZ2h0O1xuICAgICAgdGhpcy50cmFuc3BsYW50KHosIHoucmlnaHQpO1xuICAgIH0gZWxzZSBpZiAoei5yaWdodCA9PSBudWxsKSB7XG4gICAgICB4ID0gei5sZWZ0O1xuICAgICAgdGhpcy50cmFuc3BsYW50KHosIHoubGVmdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGJvdGggbGVmdCBhbmQgcmlnaHQgY2hpbGQgYXJlIG5vdCBlbXB0eVxuICAgICAgeSA9IHRoaXMubWluaW11bU9mKHoucmlnaHQpO1xuICAgICAgaWYgKHkgPT0gbnVsbClcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgb3JpZ0lzUmVkID0gdGhpcy5pc1JlZCh5KTtcbiAgICAgIHggPSB5LnJpZ2h0O1xuICAgICAgaWYgKHkucCA9PT0geikge1xuICAgICAgICBpZiAoeCkgeC5wID0geTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudHJhbnNwbGFudCh5LCB5LnJpZ2h0KTtcbiAgICAgICAgeS5yaWdodCA9IHoucmlnaHQ7XG4gICAgICAgIHkucmlnaHQucCA9IHk7XG4gICAgICB9XG4gICAgICB0aGlzLnRyYW5zcGxhbnQoeiwgeSk7XG4gICAgICB5LmxlZnQgPSB6LmxlZnQ7XG4gICAgICB5LmxlZnQucCA9IHk7XG4gICAgICB5LmlzUmVkID0gdGhpcy5pc1JlZCh6KTtcbiAgICB9XG4gICAgaWYgKCFvcmlnSXNSZWQgJiYgeCkge1xuICAgICAgLy8gY29uc29sZS5sb2coJ2RlbGV0ZSBmaXh1cCcsIHgua2V5KTtcbiAgICAgIHRoaXMuZGVsZXRlRml4dXAoeCk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBkZWxldGVGaXh1cCh4OiBSYlRyZWVOb2RlPFQ+KSB7XG4gICAgd2hpbGUgKHggIT09IHRoaXMucm9vdCAmJiB0aGlzLmlzQmxhY2soeCkpIHtcbiAgICAgIGlmICh4LnAgJiYgeCA9PT0geC5wLmxlZnQpIHtcbiAgICAgICAgbGV0IHcgPSB4LnAucmlnaHQ7IC8vIHcgaXMgeCdzIHNpYmxpbmdcbiAgICAgICAgaWYgKHRoaXMuaXNSZWQodykpIHtcbiAgICAgICAgICB3IS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHgucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHgucCApO1xuICAgICAgICAgIHcgPSB4LnAucmlnaHQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHcpIHtcbiAgICAgICAgICBpZiAodGhpcy5pc0JsYWNrKHcubGVmdCkgJiYgdGhpcy5pc0JsYWNrKHcucmlnaHQpKSB7XG4gICAgICAgICAgICB3LmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHggPSB4LnAgO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pc0JsYWNrKHcucmlnaHQpKSB7XG4gICAgICAgICAgICAgIGlmICh3LmxlZnQpXG4gICAgICAgICAgICAgICAgdy5sZWZ0LmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgIHcuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB0aGlzLnJpZ2h0Um90YXRlKHcpO1xuICAgICAgICAgICAgICB3ID0geC5wLnJpZ2h0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHcpIHcuaXNSZWQgPSB0aGlzLmlzUmVkKHgucCk7XG4gICAgICAgICAgICB4LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICh3Py5yaWdodCkgdy5yaWdodC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHgucCApO1xuICAgICAgICAgICAgeCA9IHRoaXMucm9vdCE7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHgucCAmJiB4ID09PSB4LnAucmlnaHQpIHtcbiAgICAgICAgbGV0IHcgPSB4LnAubGVmdDsgLy8gdyBpcyB4J3Mgc2libGluZ1xuICAgICAgICBpZiAodGhpcy5pc1JlZCh3KSkge1xuICAgICAgICAgIHchLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgeC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnJpZ2h0Um90YXRlKHgucCApO1xuICAgICAgICAgIHcgPSB4LnAubGVmdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodykge1xuICAgICAgICAgIGlmICh0aGlzLmlzQmxhY2sody5yaWdodCkgJiYgdGhpcy5pc0JsYWNrKHcubGVmdCkpIHtcbiAgICAgICAgICAgIHcuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgeCA9IHgucCA7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzQmxhY2sody5sZWZ0KSkge1xuICAgICAgICAgICAgICBpZiAody5yaWdodClcbiAgICAgICAgICAgICAgICB3LnJpZ2h0LmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgIHcuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUodyk7XG4gICAgICAgICAgICAgIHcgPSB4LnAubGVmdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh3KSB3LmlzUmVkID0gdGhpcy5pc1JlZCh4LnApO1xuICAgICAgICAgICAgeC5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAodz8ubGVmdCkgdy5sZWZ0LmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnJpZ2h0Um90YXRlKHgucCApO1xuICAgICAgICAgICAgeCA9IHRoaXMucm9vdCE7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHguaXNSZWQgPSBmYWxzZTtcbiAgfVxuXG4gIG1pbmltdW1PZihub2RlOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCA9IHRoaXMucm9vdCkge1xuICAgIC8vIGxldCBtaW46IFJiVHJlZU5vZGU8VD4gfCBudWxsID0gbnVsbDtcbiAgICB3aGlsZSAobm9kZT8ubGVmdCkge1xuICAgICAgLy8gbWluID0gbm9kZTtcbiAgICAgIG5vZGUgPSBub2RlLmxlZnQ7XG4gICAgfVxuICAgIHJldHVybiBub2RlID8gbm9kZSA6IG51bGw7XG4gIH1cblxuICAvLyBtYXhpbXVtT2Yobm9kZTogUmJUcmVlTm9kZTxUPiA9IHRoaXMucm9vdCkge1xuXG4gIC8vICAgd2hpbGUgKHRoaXMuaXNOb3ROaWwobm9kZSkpXG4gIC8vICAgICBub2RlID0gbm9kZS5yaWdodDtcbiAgLy8gICByZXR1cm4gbm9kZTtcbiAgLy8gfVxuXG4gIHByaXZhdGUgdHJhbnNwbGFudChyZXBsYWNlTm9kZTogUmJUcmVlTm9kZTxUPiwgd2l0aE5vZGU6IFJiVHJlZU5vZGU8VD4gfCBudWxsID0gbnVsbCkge1xuICAgIGlmIChyZXBsYWNlTm9kZS5wID09IG51bGwpIHtcbiAgICAgIHRoaXMucm9vdCA9IHdpdGhOb2RlO1xuICAgIH0gZWxzZSBpZiAocmVwbGFjZU5vZGUgPT09IHJlcGxhY2VOb2RlLnAubGVmdCkge1xuICAgICAgcmVwbGFjZU5vZGUucC5sZWZ0ID0gd2l0aE5vZGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcGxhY2VOb2RlLnAucmlnaHQgPSB3aXRoTm9kZTtcbiAgICB9XG4gICAgaWYgKHdpdGhOb2RlKVxuICAgICAgd2l0aE5vZGUucCA9IHJlcGxhY2VOb2RlLnA7XG4gIH1cblxuICBzZWFyY2goa2V5OiBUKTogUmJUcmVlTm9kZTxUPiB8IG51bGwge1xuICAgIGxldCBub2RlID0gdGhpcy5yb290O1xuICAgIHdoaWxlIChub2RlKSB7XG4gICAgICBjb25zdCBjbXAgPSB0aGlzLmNvbXBhcmF0b3IhKGtleSwgbm9kZS5rZXkpO1xuICAgICAgaWYgKGNtcCA9PT0gMClcbiAgICAgICAgcmV0dXJuIG5vZGU7XG4gICAgICBpZiAoY21wIDwgMCkge1xuICAgICAgICBub2RlID0gbm9kZS5sZWZ0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZSA9IG5vZGUucmlnaHQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJvdGVjdGVkIHJlZEJsYWNrSW5zZXJ0Rml4VXAoejogUmJUcmVlTm9kZTxUPikge1xuICAgIHdoaWxlICh0aGlzLmlzUmVkKHoucCkpIHtcbiAgICAgIGlmICh6LnA/LnAgJiYgei5wID09PSB6LnAucC5sZWZ0KSB7XG4gICAgICAgIGNvbnN0IHVuY2xlID0gei5wLnAucmlnaHQ7XG4gICAgICAgIGlmICh0aGlzLmlzUmVkKHVuY2xlKSkge1xuICAgICAgICAgIC8vIG1hcmsgcGFyZW50IGFuZCB1bmNsZSB0byBibGFjaywgZ3JhbmRwYSB0byByZWQsIGNvbnRpbnVlIHRvIGdvIHVwIHRvIGdyYW5kcGEgbGV2ZWxcbiAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICBpZiAodW5jbGUpIHVuY2xlLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHogPSB6LnAucDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB1bmNsZSBpcyBibGFja1xuICAgICAgICAgIGlmICh6ID09PSB6LnAucmlnaHQpIHtcbiAgICAgICAgICAgIC8vIGlmIGlzIHJpZ2h0IGNoaWxkIHRyZWVcbiAgICAgICAgICAgIHogPSB6LnA7XG4gICAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUoeik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh6LnApIHtcbiAgICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHoucC5wKSB7XG4gICAgICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh6LnAucCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHoucD8ucCAmJiB6LnAgPT09IHoucC5wLnJpZ2h0KSB7XG4gICAgICAgIGNvbnN0IHVuY2xlID0gei5wLnAubGVmdDtcbiAgICAgICAgaWYgKHRoaXMuaXNSZWQodW5jbGUpKSB7XG4gICAgICAgICAgLy8gbWFyayBwYXJlbnQgYW5kIHVuY2xlIHRvIGJsYWNrLCBncmFuZHBhIHRvIHJlZCwgY29udGludWUgdG8gZ28gdXAgdG8gZ3JhbmRwYSBsZXZlbFxuICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIGlmICh1bmNsZSkgdW5jbGUuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB6LnAucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgeiA9IHoucC5wO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIHVuY2xlIGlzIGJsYWNrXG4gICAgICAgICAgaWYgKHogPT09IHoucC5sZWZ0KSB7XG4gICAgICAgICAgICAvLyBpZiBpcyByaWdodCBjaGlsZCB0cmVlXG4gICAgICAgICAgICB6ID0gei5wO1xuICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh6KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHoucCkge1xuICAgICAgICAgICAgei5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoei5wLnApIHtcbiAgICAgICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUoei5wLnApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5yb290KVxuICAgICAgdGhpcy5yb290LmlzUmVkID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGxlZnRSb3RhdGUoeDogUmJUcmVlTm9kZTxUPikge1xuICAgIC8vIGNvbnNvbGUubG9nKCdsZWZ0Um90YXRlJywgeC5rZXkpO1xuICAgIGNvbnN0IHkgPSB4LnJpZ2h0O1xuICAgIGlmICh5ID09IG51bGwpXG4gICAgICByZXR1cm47XG4gICAgeC5yaWdodCA9IHkubGVmdDtcbiAgICBpZiAoeS5sZWZ0KSB7XG4gICAgICB5LmxlZnQucCA9IHg7XG4gICAgfVxuICAgIHkucCA9IHgucDtcbiAgICBpZiAoeC5wID09IG51bGwpXG4gICAgICB0aGlzLnJvb3QgPSB5O1xuICAgIGVsc2UgaWYgKHggPT09IHgucC5sZWZ0KVxuICAgICAgeC5wLmxlZnQgPSB5O1xuICAgIGVsc2VcbiAgICAgIHgucC5yaWdodCA9IHk7XG4gICAgeS5sZWZ0ID0geDtcbiAgICB4LnAgPSB5O1xuICB9XG5cbiAgcHJpdmF0ZSByaWdodFJvdGF0ZSh4OiBSYlRyZWVOb2RlPFQ+KSB7XG4gICAgY29uc3QgeSA9IHgubGVmdDtcbiAgICBpZiAoeSA9PSBudWxsKVxuICAgICAgcmV0dXJuO1xuICAgIHgubGVmdCA9IHkucmlnaHQ7XG4gICAgaWYgKHkucmlnaHQpIHtcbiAgICAgIHkucmlnaHQucCA9IHg7XG4gICAgfVxuICAgIHkucCA9IHgucDtcbiAgICBpZiAoeC5wID09IG51bGwpXG4gICAgICB0aGlzLnJvb3QgPSB5O1xuICAgIGVsc2UgaWYgKHggPT09IHgucC5yaWdodClcbiAgICAgIHgucC5yaWdodCA9IHk7XG4gICAgZWxzZVxuICAgICAgeC5wLmxlZnQgPSB5O1xuICAgIHkucmlnaHQgPSB4O1xuICAgIHgucCA9IHk7XG4gIH1cbn1cblxuLyoqIEFsbG93IGluc2VydGluZyBtdWx0aXBsZSBpdGVtcyB3aXRoIHNhbWUga2V5IGluIGEgcmVkLWJsYWNrIHRyZWUgKi9cbmV4cG9ydCBjbGFzcyBEdXBsaWNhdGVLZXlUcmVlPFQ+IGV4dGVuZHMgUmVkQmxhY2tUcmVlPFQ+IHtcblxufVxuIl19