"use strict";
/**
 * According to the book << Introduction to Algorithms, Third Edition >>
 *
 * features in progress: Dynamic order statistics, range tree
 *
 * This data structure is meant for being extend, since the majority of 3rd-party red-black tree on npmjs.org is not extensible
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.IntervalTree = exports.DuplicateKeyTree = exports.RedBlackTree = void 0;
class RedBlackTree {
    constructor(comparator) {
        this.comparator = comparator;
        this.root = null;
        if (comparator == null) {
            this.comparator = (a, b) => {
                return a < b ? -1 :
                    a > b ? 1 : 0;
            };
        }
    }
    /**
     *
     * @param key
     * @returns null if key duplicates with existing tree node
     */
    insert(key) {
        let y = null;
        let x = this.root;
        let cmp;
        while (x) {
            y = x;
            cmp = this.comparator(key, x.key);
            if (cmp < 0) {
                x = x.left;
            }
            else if (cmp > 0) {
                x = x.right;
            }
            else {
                return null; // duplicate key found
            }
        }
        const z = {
            isRed: true,
            key,
            p: y,
            left: null,
            right: null,
            size: 0
        };
        if (y == null) {
            this.root = z;
        }
        else if (cmp < 0) {
            y.left = z;
        }
        else if (cmp > 0) {
            y.right = z;
        }
        this.redBlackInsertFixUp(z);
        return z;
    }
    delete(key) {
        const node = this.search(key);
        if (node == null) {
            return false;
        }
        this.deleteNode(node);
        return true;
    }
    isRed(node) {
        return node != null && node.isRed;
    }
    isBlack(node) {
        return node == null || !node.isRed;
    }
    deleteNode(z) {
        let y = z;
        let origIsRed = this.isRed(y);
        let x = null;
        if (z.left == null) {
            x = z.right;
            this.transplant(z, z.right);
        }
        else if (z.right == null) {
            x = z.left;
            this.transplant(z, z.left);
        }
        else {
            // both left and right child are not empty
            y = this.minimumOf(z.right);
            if (y == null)
                return false;
            origIsRed = this.isRed(y);
            x = y.right;
            if (y.p === z) {
                if (x)
                    x.p = y;
            }
            else {
                this.transplant(y, y.right);
                y.right = z.right;
                y.right.p = y;
            }
            this.transplant(z, y);
            y.left = z.left;
            y.left.p = y;
            y.isRed = this.isRed(z);
        }
        if (!origIsRed && x) {
            // console.log('delete fixup', x.key);
            this.deleteFixup(x);
        }
        return true;
    }
    deleteFixup(x) {
        while (x !== this.root && this.isBlack(x)) {
            if (x.p && x === x.p.left) {
                let w = x.p.right; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.leftRotate(x.p);
                    w = x.p.right;
                }
                if (w) {
                    if (this.isBlack(w.left) && this.isBlack(w.right)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.right)) {
                            if (w.left)
                                w.left.isRed = false;
                            w.isRed = true;
                            this.rightRotate(w);
                            w = x.p.right;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.right)
                            w.right.isRed = false;
                        this.leftRotate(x.p);
                        x = this.root;
                    }
                }
            }
            else if (x.p && x === x.p.right) {
                let w = x.p.left; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.rightRotate(x.p);
                    w = x.p.left;
                }
                if (w) {
                    if (this.isBlack(w.right) && this.isBlack(w.left)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.left)) {
                            if (w.right)
                                w.right.isRed = false;
                            w.isRed = true;
                            this.leftRotate(w);
                            w = x.p.left;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.left)
                            w.left.isRed = false;
                        this.rightRotate(x.p);
                        x = this.root;
                    }
                }
            }
        }
        x.isRed = false;
    }
    minimumOf(node = this.root) {
        // let min: RbTreeNode<T> | null = null;
        while (node === null || node === void 0 ? void 0 : node.left) {
            node = node.left;
        }
        return node ? node : null;
    }
    transplant(replaceNode, withNode = null) {
        if (replaceNode.p == null) {
            this.root = withNode;
        }
        else if (replaceNode === replaceNode.p.left) {
            replaceNode.p.left = withNode;
        }
        else {
            replaceNode.p.right = withNode;
        }
        if (withNode)
            withNode.p = replaceNode.p;
    }
    search(key) {
        let node = this.root;
        while (node) {
            const cmp = this.comparator(key, node.key);
            if (cmp === 0)
                return node;
            if (cmp < 0) {
                node = node.left;
            }
            else {
                node = node.right;
            }
        }
        return null;
    }
    redBlackInsertFixUp(z) {
        var _a, _b;
        while (this.isRed(z.p)) {
            if (((_a = z.p) === null || _a === void 0 ? void 0 : _a.p) && z.p === z.p.p.left) {
                const uncle = z.p.p.right;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.right) {
                        // if is right child tree
                        z = z.p;
                        this.leftRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.rightRotate(z.p.p);
                        }
                    }
                }
            }
            else if (((_b = z.p) === null || _b === void 0 ? void 0 : _b.p) && z.p === z.p.p.right) {
                const uncle = z.p.p.left;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.left) {
                        // if is right child tree
                        z = z.p;
                        this.rightRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.leftRotate(z.p.p);
                        }
                    }
                }
            }
        }
        if (this.root)
            this.root.isRed = false;
    }
    leftRotate(x) {
        // console.log('leftRotate', x.key);
        const y = x.right;
        if (y == null)
            return;
        x.right = y.left;
        if (y.left) {
            y.left.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.left)
            x.p.left = y;
        else
            x.p.right = y;
        y.left = x;
        x.p = y;
    }
    rightRotate(x) {
        const y = x.left;
        if (y == null)
            return;
        x.left = y.right;
        if (y.right) {
            y.right.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.right)
            x.p.right = y;
        else
            x.p.left = y;
        y.right = x;
        x.p = y;
    }
}
exports.RedBlackTree = RedBlackTree;
/** Allow inserting multiple items with same key in a red-black tree */
class DuplicateKeyTree extends RedBlackTree {
}
exports.DuplicateKeyTree = DuplicateKeyTree;
function intervalComparator(k1, k2) {
    return k1.low - k2.low;
}
class IntervalTree extends RedBlackTree {
    constructor() {
        super(intervalComparator);
    }
}
exports.IntervalTree = IntervalTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zdHJ1Y3R1cmVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvdXRpbHMvZGF0YS1zdHJ1Y3R1cmVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7OztBQVVILE1BQWEsWUFBWTtJQUd2QixZQUFzQixVQUFtQztRQUFuQyxlQUFVLEdBQVYsVUFBVSxDQUF5QjtRQUZ6RCxTQUFJLEdBQXFDLElBQUksQ0FBQztRQUc1QyxJQUFJLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLEdBQU07UUFDWCxJQUFJLENBQUMsR0FBeUIsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDbEIsSUFBSSxHQUFXLENBQUM7UUFDaEIsT0FBTyxDQUFDLEVBQUU7WUFDUixDQUFDLEdBQUcsQ0FBQyxDQUFFO1lBQ1AsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7Z0JBQ1gsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDWjtpQkFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7Z0JBQ2xCLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2FBQ2I7aUJBQU07Z0JBQ0wsT0FBTyxJQUFJLENBQUMsQ0FBQyxz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Q2pCLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRTtZQUNYLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNmO1FBQ0QsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1YsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUk7WUFDYixJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQzthQUNYLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSztZQUN0QixDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7O1lBRWQsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDWixDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNWLENBQUM7Q0FDRjtBQXBTRCxvQ0FvU0M7QUFFRCx1RUFBdUU7QUFDdkUsTUFBYSxnQkFBb0IsU0FBUSxZQUFlO0NBRXZEO0FBRkQsNENBRUM7QUFJRCxTQUFTLGtCQUFrQixDQUFDLEVBQWUsRUFBRSxFQUFlO0lBQzFELE9BQU8sRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDO0FBQ3pCLENBQUM7QUFFRCxNQUFhLFlBQWEsU0FBUSxZQUF5QjtJQUN6RDtRQUNFLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQzVCLENBQUM7Q0FDRjtBQUpELG9DQUlDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBY2NvcmRpbmcgdG8gdGhlIGJvb2sgPDwgSW50cm9kdWN0aW9uIHRvIEFsZ29yaXRobXMsIFRoaXJkIEVkaXRpb24gPj5cbiAqIFxuICogZmVhdHVyZXMgaW4gcHJvZ3Jlc3M6IER5bmFtaWMgb3JkZXIgc3RhdGlzdGljcywgcmFuZ2UgdHJlZVxuICogXG4gKiBUaGlzIGRhdGEgc3RydWN0dXJlIGlzIG1lYW50IGZvciBiZWluZyBleHRlbmQsIHNpbmNlIHRoZSBtYWpvcml0eSBvZiAzcmQtcGFydHkgcmVkLWJsYWNrIHRyZWUgb24gbnBtanMub3JnIGlzIG5vdCBleHRlbnNpYmxlXG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBSYlRyZWVOb2RlPFQ+IHtcbiAga2V5OiBUO1xuICBwOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbDtcbiAgbGVmdDogUmJUcmVlTm9kZTxUPiB8IG51bGw7XG4gIHJpZ2h0OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbDtcbiAgaXNSZWQ6IGJvb2xlYW47XG4gIHNpemU6IG51bWJlcjtcbn1cbmV4cG9ydCBjbGFzcyBSZWRCbGFja1RyZWU8VD4ge1xuICByb290OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGNvbXBhcmF0b3I/OiAoYTogVCwgYjogVCkgPT4gbnVtYmVyKSB7XG4gICAgaWYgKGNvbXBhcmF0b3IgPT0gbnVsbCkge1xuICAgICAgdGhpcy5jb21wYXJhdG9yID0gKGEsIGIpID0+IHtcbiAgICAgICAgcmV0dXJuIGEgPCBiID8gLTEgOlxuICAgICAgICAgIGEgPiBiID8gMSA6IDA7XG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIGtleVxuICAgKiBAcmV0dXJucyBudWxsIGlmIGtleSBkdXBsaWNhdGVzIHdpdGggZXhpc3RpbmcgdHJlZSBub2RlXG4gICAqL1xuICBpbnNlcnQoa2V5OiBUKTogUmJUcmVlTm9kZTxUPiB8IG51bGwge1xuICAgIGxldCB5OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgbGV0IHggPSB0aGlzLnJvb3Q7XG4gICAgbGV0IGNtcDogbnVtYmVyO1xuICAgIHdoaWxlICh4KSB7XG4gICAgICB5ID0geCA7XG4gICAgICBjbXAgPSB0aGlzLmNvbXBhcmF0b3IhKGtleSwgeC5rZXkpO1xuICAgICAgaWYgKGNtcCA8IDApIHtcbiAgICAgICAgeCA9IHgubGVmdDtcbiAgICAgIH0gZWxzZSBpZiAoY21wID4gMCkge1xuICAgICAgICB4ID0geC5yaWdodDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBudWxsOyAvLyBkdXBsaWNhdGUga2V5IGZvdW5kXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHo6IFJiVHJlZU5vZGU8VD4gPSB7XG4gICAgICBpc1JlZDogdHJ1ZSxcbiAgICAgIGtleSxcbiAgICAgIHA6IHksXG4gICAgICBsZWZ0OiBudWxsLFxuICAgICAgcmlnaHQ6IG51bGwsXG4gICAgICBzaXplOiAwXG4gICAgfTtcbiAgICBpZiAoeSA9PSBudWxsKSB7XG4gICAgICB0aGlzLnJvb3QgPSB6O1xuICAgIH0gZWxzZSBpZiAoY21wISA8IDAgKSB7XG4gICAgICB5LmxlZnQgPSB6O1xuICAgIH0gZWxzZSBpZiAoY21wISA+IDAgKSB7XG4gICAgICB5LnJpZ2h0ID0gejtcbiAgICB9XG4gICAgdGhpcy5yZWRCbGFja0luc2VydEZpeFVwKHopO1xuICAgIHJldHVybiB6O1xuICB9XG5cbiAgZGVsZXRlKGtleTogVCkge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLnNlYXJjaChrZXkpO1xuICAgIGlmIChub2RlID09IG51bGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5kZWxldGVOb2RlKG5vZGUpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaXNSZWQobm9kZTogUmJUcmVlTm9kZTxUPiB8IG51bGwgfCB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gbm9kZSAhPSBudWxsICYmIG5vZGUuaXNSZWQ7XG4gIH1cblxuICBpc0JsYWNrKG5vZGU6IFJiVHJlZU5vZGU8VD4gfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIG5vZGUgPT0gbnVsbCB8fCAhbm9kZS5pc1JlZDtcbiAgfVxuXG4gIHByb3RlY3RlZCBkZWxldGVOb2RlKHo6IFJiVHJlZU5vZGU8VD4pIHtcbiAgICBsZXQgeTogUmJUcmVlTm9kZTxUPiB8IG51bGwgID0gejtcbiAgICBsZXQgb3JpZ0lzUmVkID0gdGhpcy5pc1JlZCh5KTtcbiAgICBsZXQgeDogUmJUcmVlTm9kZTxUPiB8IG51bGwgPSBudWxsO1xuICAgIGlmICh6LmxlZnQgPT0gbnVsbCkge1xuICAgICAgeCA9IHoucmlnaHQ7XG4gICAgICB0aGlzLnRyYW5zcGxhbnQoeiwgei5yaWdodCk7XG4gICAgfSBlbHNlIGlmICh6LnJpZ2h0ID09IG51bGwpIHtcbiAgICAgIHggPSB6LmxlZnQ7XG4gICAgICB0aGlzLnRyYW5zcGxhbnQoeiwgei5sZWZ0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYm90aCBsZWZ0IGFuZCByaWdodCBjaGlsZCBhcmUgbm90IGVtcHR5XG4gICAgICB5ID0gdGhpcy5taW5pbXVtT2Yoei5yaWdodCk7XG4gICAgICBpZiAoeSA9PSBudWxsKVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICBvcmlnSXNSZWQgPSB0aGlzLmlzUmVkKHkpO1xuICAgICAgeCA9IHkucmlnaHQ7XG4gICAgICBpZiAoeS5wID09PSB6KSB7XG4gICAgICAgIGlmICh4KSB4LnAgPSB5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50cmFuc3BsYW50KHksIHkucmlnaHQpO1xuICAgICAgICB5LnJpZ2h0ID0gei5yaWdodDtcbiAgICAgICAgeS5yaWdodC5wID0geTtcbiAgICAgIH1cbiAgICAgIHRoaXMudHJhbnNwbGFudCh6LCB5KTtcbiAgICAgIHkubGVmdCA9IHoubGVmdDtcbiAgICAgIHkubGVmdC5wID0geTtcbiAgICAgIHkuaXNSZWQgPSB0aGlzLmlzUmVkKHopO1xuICAgIH1cbiAgICBpZiAoIW9yaWdJc1JlZCAmJiB4KSB7XG4gICAgICAvLyBjb25zb2xlLmxvZygnZGVsZXRlIGZpeHVwJywgeC5rZXkpO1xuICAgICAgdGhpcy5kZWxldGVGaXh1cCh4KTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGRlbGV0ZUZpeHVwKHg6IFJiVHJlZU5vZGU8VD4pIHtcbiAgICB3aGlsZSAoeCAhPT0gdGhpcy5yb290ICYmIHRoaXMuaXNCbGFjayh4KSkge1xuICAgICAgaWYgKHgucCAmJiB4ID09PSB4LnAubGVmdCkge1xuICAgICAgICBsZXQgdyA9IHgucC5yaWdodDsgLy8gdyBpcyB4J3Mgc2libGluZ1xuICAgICAgICBpZiAodGhpcy5pc1JlZCh3KSkge1xuICAgICAgICAgIHchLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgeC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUoeC5wICk7XG4gICAgICAgICAgdyA9IHgucC5yaWdodDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodykge1xuICAgICAgICAgIGlmICh0aGlzLmlzQmxhY2sody5sZWZ0KSAmJiB0aGlzLmlzQmxhY2sody5yaWdodCkpIHtcbiAgICAgICAgICAgIHcuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgeCA9IHgucCA7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzQmxhY2sody5yaWdodCkpIHtcbiAgICAgICAgICAgICAgaWYgKHcubGVmdClcbiAgICAgICAgICAgICAgICB3LmxlZnQuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgdy5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUodyk7XG4gICAgICAgICAgICAgIHcgPSB4LnAucmlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodykgdy5pc1JlZCA9IHRoaXMuaXNSZWQoeC5wKTtcbiAgICAgICAgICAgIHgucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHc/LnJpZ2h0KSB3LnJpZ2h0LmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUoeC5wICk7XG4gICAgICAgICAgICB4ID0gdGhpcy5yb290ITtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoeC5wICYmIHggPT09IHgucC5yaWdodCkge1xuICAgICAgICBsZXQgdyA9IHgucC5sZWZ0OyAvLyB3IGlzIHgncyBzaWJsaW5nXG4gICAgICAgIGlmICh0aGlzLmlzUmVkKHcpKSB7XG4gICAgICAgICAgdyEuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB4LnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoeC5wICk7XG4gICAgICAgICAgdyA9IHgucC5sZWZ0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh3KSB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNCbGFjayh3LnJpZ2h0KSAmJiB0aGlzLmlzQmxhY2sody5sZWZ0KSkge1xuICAgICAgICAgICAgdy5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICB4ID0geC5wIDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNCbGFjayh3LmxlZnQpKSB7XG4gICAgICAgICAgICAgIGlmICh3LnJpZ2h0KVxuICAgICAgICAgICAgICAgIHcucmlnaHQuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgdy5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMubGVmdFJvdGF0ZSh3KTtcbiAgICAgICAgICAgICAgdyA9IHgucC5sZWZ0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHcpIHcuaXNSZWQgPSB0aGlzLmlzUmVkKHgucCk7XG4gICAgICAgICAgICB4LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICh3Py5sZWZ0KSB3LmxlZnQuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoeC5wICk7XG4gICAgICAgICAgICB4ID0gdGhpcy5yb290ITtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgeC5pc1JlZCA9IGZhbHNlO1xuICB9XG5cbiAgbWluaW11bU9mKG5vZGU6IFJiVHJlZU5vZGU8VD4gfCBudWxsIHwgdW5kZWZpbmVkID0gdGhpcy5yb290KSB7XG4gICAgLy8gbGV0IG1pbjogUmJUcmVlTm9kZTxUPiB8IG51bGwgPSBudWxsO1xuICAgIHdoaWxlIChub2RlPy5sZWZ0KSB7XG4gICAgICBub2RlID0gbm9kZS5sZWZ0O1xuICAgIH1cbiAgICByZXR1cm4gbm9kZSA/IG5vZGUgOiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFuc3BsYW50KHJlcGxhY2VOb2RlOiBSYlRyZWVOb2RlPFQ+LCB3aXRoTm9kZTogUmJUcmVlTm9kZTxUPiB8IG51bGwgPSBudWxsKSB7XG4gICAgaWYgKHJlcGxhY2VOb2RlLnAgPT0gbnVsbCkge1xuICAgICAgdGhpcy5yb290ID0gd2l0aE5vZGU7XG4gICAgfSBlbHNlIGlmIChyZXBsYWNlTm9kZSA9PT0gcmVwbGFjZU5vZGUucC5sZWZ0KSB7XG4gICAgICByZXBsYWNlTm9kZS5wLmxlZnQgPSB3aXRoTm9kZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVwbGFjZU5vZGUucC5yaWdodCA9IHdpdGhOb2RlO1xuICAgIH1cbiAgICBpZiAod2l0aE5vZGUpXG4gICAgICB3aXRoTm9kZS5wID0gcmVwbGFjZU5vZGUucDtcbiAgfVxuXG4gIHNlYXJjaChrZXk6IFQpOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLnJvb3Q7XG4gICAgd2hpbGUgKG5vZGUpIHtcbiAgICAgIGNvbnN0IGNtcCA9IHRoaXMuY29tcGFyYXRvciEoa2V5LCBub2RlLmtleSk7XG4gICAgICBpZiAoY21wID09PSAwKVxuICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgIGlmIChjbXAgPCAwKSB7XG4gICAgICAgIG5vZGUgPSBub2RlLmxlZnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBub2RlID0gbm9kZS5yaWdodDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcm90ZWN0ZWQgcmVkQmxhY2tJbnNlcnRGaXhVcCh6OiBSYlRyZWVOb2RlPFQ+KSB7XG4gICAgd2hpbGUgKHRoaXMuaXNSZWQoei5wKSkge1xuICAgICAgaWYgKHoucD8ucCAmJiB6LnAgPT09IHoucC5wLmxlZnQpIHtcbiAgICAgICAgY29uc3QgdW5jbGUgPSB6LnAucC5yaWdodDtcbiAgICAgICAgaWYgKHRoaXMuaXNSZWQodW5jbGUpKSB7XG4gICAgICAgICAgLy8gbWFyayBwYXJlbnQgYW5kIHVuY2xlIHRvIGJsYWNrLCBncmFuZHBhIHRvIHJlZCwgY29udGludWUgdG8gZ28gdXAgdG8gZ3JhbmRwYSBsZXZlbFxuICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIGlmICh1bmNsZSkgdW5jbGUuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB6LnAucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgeiA9IHoucC5wO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIHVuY2xlIGlzIGJsYWNrXG4gICAgICAgICAgaWYgKHogPT09IHoucC5yaWdodCkge1xuICAgICAgICAgICAgLy8gaWYgaXMgcmlnaHQgY2hpbGQgdHJlZVxuICAgICAgICAgICAgeiA9IHoucDtcbiAgICAgICAgICAgIHRoaXMubGVmdFJvdGF0ZSh6KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHoucCkge1xuICAgICAgICAgICAgei5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoei5wLnApIHtcbiAgICAgICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB0aGlzLnJpZ2h0Um90YXRlKHoucC5wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoei5wPy5wICYmIHoucCA9PT0gei5wLnAucmlnaHQpIHtcbiAgICAgICAgY29uc3QgdW5jbGUgPSB6LnAucC5sZWZ0O1xuICAgICAgICBpZiAodGhpcy5pc1JlZCh1bmNsZSkpIHtcbiAgICAgICAgICAvLyBtYXJrIHBhcmVudCBhbmQgdW5jbGUgdG8gYmxhY2ssIGdyYW5kcGEgdG8gcmVkLCBjb250aW51ZSB0byBnbyB1cCB0byBncmFuZHBhIGxldmVsXG4gICAgICAgICAgei5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgaWYgKHVuY2xlKSB1bmNsZS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB6ID0gei5wLnA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gdW5jbGUgaXMgYmxhY2tcbiAgICAgICAgICBpZiAoeiA9PT0gei5wLmxlZnQpIHtcbiAgICAgICAgICAgIC8vIGlmIGlzIHJpZ2h0IGNoaWxkIHRyZWVcbiAgICAgICAgICAgIHogPSB6LnA7XG4gICAgICAgICAgICB0aGlzLnJpZ2h0Um90YXRlKHopO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoei5wKSB7XG4gICAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICh6LnAucCkge1xuICAgICAgICAgICAgICB6LnAucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMubGVmdFJvdGF0ZSh6LnAucCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnJvb3QpXG4gICAgICB0aGlzLnJvb3QuaXNSZWQgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgbGVmdFJvdGF0ZSh4OiBSYlRyZWVOb2RlPFQ+KSB7XG4gICAgLy8gY29uc29sZS5sb2coJ2xlZnRSb3RhdGUnLCB4LmtleSk7XG4gICAgY29uc3QgeSA9IHgucmlnaHQ7XG4gICAgaWYgKHkgPT0gbnVsbClcbiAgICAgIHJldHVybjtcbiAgICB4LnJpZ2h0ID0geS5sZWZ0O1xuICAgIGlmICh5LmxlZnQpIHtcbiAgICAgIHkubGVmdC5wID0geDtcbiAgICB9XG4gICAgeS5wID0geC5wO1xuICAgIGlmICh4LnAgPT0gbnVsbClcbiAgICAgIHRoaXMucm9vdCA9IHk7XG4gICAgZWxzZSBpZiAoeCA9PT0geC5wLmxlZnQpXG4gICAgICB4LnAubGVmdCA9IHk7XG4gICAgZWxzZVxuICAgICAgeC5wLnJpZ2h0ID0geTtcbiAgICB5LmxlZnQgPSB4O1xuICAgIHgucCA9IHk7XG4gIH1cblxuICBwcml2YXRlIHJpZ2h0Um90YXRlKHg6IFJiVHJlZU5vZGU8VD4pIHtcbiAgICBjb25zdCB5ID0geC5sZWZ0O1xuICAgIGlmICh5ID09IG51bGwpXG4gICAgICByZXR1cm47XG4gICAgeC5sZWZ0ID0geS5yaWdodDtcbiAgICBpZiAoeS5yaWdodCkge1xuICAgICAgeS5yaWdodC5wID0geDtcbiAgICB9XG4gICAgeS5wID0geC5wO1xuICAgIGlmICh4LnAgPT0gbnVsbClcbiAgICAgIHRoaXMucm9vdCA9IHk7XG4gICAgZWxzZSBpZiAoeCA9PT0geC5wLnJpZ2h0KVxuICAgICAgeC5wLnJpZ2h0ID0geTtcbiAgICBlbHNlXG4gICAgICB4LnAubGVmdCA9IHk7XG4gICAgeS5yaWdodCA9IHg7XG4gICAgeC5wID0geTtcbiAgfVxufVxuXG4vKiogQWxsb3cgaW5zZXJ0aW5nIG11bHRpcGxlIGl0ZW1zIHdpdGggc2FtZSBrZXkgaW4gYSByZWQtYmxhY2sgdHJlZSAqL1xuZXhwb3J0IGNsYXNzIER1cGxpY2F0ZUtleVRyZWU8VD4gZXh0ZW5kcyBSZWRCbGFja1RyZWU8VD4ge1xuXG59XG5cbmV4cG9ydCB0eXBlIEludGVydmFsS2V5ID0ge2xvdzogbnVtYmVyOyBoaWdoOiBudW1iZXIsIG1heD86IG51bWJlcn07XG5cbmZ1bmN0aW9uIGludGVydmFsQ29tcGFyYXRvcihrMTogSW50ZXJ2YWxLZXksIGsyOiBJbnRlcnZhbEtleSkge1xuICByZXR1cm4gazEubG93IC0gazIubG93O1xufVxuXG5leHBvcnQgY2xhc3MgSW50ZXJ2YWxUcmVlIGV4dGVuZHMgUmVkQmxhY2tUcmVlPEludGVydmFsS2V5PiB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKGludGVydmFsQ29tcGFyYXRvcik7XG4gIH1cbn1cblxuIl19