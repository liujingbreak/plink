"use strict";
/**
 * According to the book << Introduction to Algorithms, Third Edition >>
 *
 * features in progress: Dynamic order statistics, range tree
 *
 * This data structure is meant for being extend, since the majority of 3rd-party red-black tree on npmjs.org is not extensible
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.DuplicateKeyTree = exports.RedBlackTree = void 0;
class RedBlackTree {
    constructor(comparator) {
        this.comparator = comparator;
        this.root = null;
        if (comparator == null) {
            this.comparator = (a, b) => {
                return a < b ? -1 :
                    a > b ? 1 : 0;
            };
        }
    }
    /**
     *
     * @param key
     * @returns null if key duplicates with existing tree node
     */
    insert(key) {
        let y = null;
        let x = this.root;
        let cmp;
        while (x) {
            y = x;
            cmp = this.comparator(key, x.key);
            if (cmp < 0) {
                x = x.left;
            }
            else if (cmp > 0) {
                x = x.right;
            }
            else {
                return null; // duplicate key found
            }
        }
        const z = {
            isRed: true,
            key,
            p: y,
            left: null,
            right: null,
            size: 0
        };
        if (y == null) {
            this.root = z;
            // z.isRed = false;
        }
        else if (cmp < 0) {
            y.left = z;
        }
        else if (cmp > 0) {
            y.right = z;
        }
        this.redBlackInsertFixUp(z);
        return z;
    }
    delete(key) {
        const node = this.search(key);
        if (node == null) {
            return false;
        }
        this.deleteNode(node);
        return true;
    }
    isRed(node) {
        return node != null && node.isRed;
    }
    isBlack(node) {
        return node == null || !node.isRed;
    }
    deleteNode(z) {
        let y = z;
        let origIsRed = this.isRed(y);
        let x = null;
        if (z.left == null) {
            x = z.right;
            this.transplant(z, z.right);
        }
        else if (z.right == null) {
            x = z.left;
            this.transplant(z, z.left);
        }
        else {
            // both left and right child are not empty
            y = this.minimumOf(z.right);
            if (y == null)
                return false;
            origIsRed = this.isRed(y);
            x = y.right;
            if (y.p === z) {
                if (x)
                    x.p = y;
            }
            else {
                this.transplant(y, y.right);
                y.right = z.right;
                y.right.p = y;
            }
            this.transplant(z, y);
            y.left = z.left;
            y.left.p = y;
            y.isRed = this.isRed(z);
        }
        if (!origIsRed && x) {
            // console.log('delete fixup', x.key);
            this.deleteFixup(x);
        }
        return true;
    }
    deleteFixup(x) {
        while (x !== this.root && this.isBlack(x)) {
            if (x.p && x === x.p.left) {
                let w = x.p.right; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.leftRotate(x.p);
                    w = x.p.right;
                }
                if (w) {
                    if (this.isBlack(w.left) && this.isBlack(w.right)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.right)) {
                            if (w.left)
                                w.left.isRed = false;
                            w.isRed = true;
                            this.rightRotate(w);
                            w = x.p.right;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.right)
                            w.right.isRed = false;
                        this.leftRotate(x.p);
                        x = this.root;
                    }
                }
            }
            else if (x.p && x === x.p.right) {
                let w = x.p.left; // w is x's sibling
                if (this.isRed(w)) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.rightRotate(x.p);
                    w = x.p.left;
                }
                if (w) {
                    if (this.isBlack(w.right) && this.isBlack(w.left)) {
                        w.isRed = true;
                        x = x.p;
                    }
                    else {
                        if (this.isBlack(w.left)) {
                            if (w.right)
                                w.right.isRed = false;
                            w.isRed = true;
                            this.leftRotate(w);
                            w = x.p.left;
                        }
                        if (w)
                            w.isRed = this.isRed(x.p);
                        x.p.isRed = false;
                        if (w === null || w === void 0 ? void 0 : w.left)
                            w.left.isRed = false;
                        this.rightRotate(x.p);
                        x = this.root;
                    }
                }
            }
        }
        x.isRed = false;
    }
    minimumOf(node = this.root) {
        // let min: RbTreeNode<T> | null = null;
        while (node === null || node === void 0 ? void 0 : node.left) {
            // min = node;
            node = node.left;
        }
        return node ? node : null;
    }
    // maximumOf(node: RbTreeNode<T> = this.root) {
    //   while (this.isNotNil(node))
    //     node = node.right;
    //   return node;
    // }
    transplant(replaceNode, withNode = null) {
        if (replaceNode.p == null) {
            this.root = withNode;
        }
        else if (replaceNode === replaceNode.p.left) {
            replaceNode.p.left = withNode;
        }
        else {
            replaceNode.p.right = withNode;
        }
        if (withNode)
            withNode.p = replaceNode.p;
    }
    search(key) {
        let node = this.root;
        while (node) {
            const cmp = this.comparator(key, node.key);
            if (cmp === 0)
                return node;
            if (cmp < 0) {
                node = node.left;
            }
            else {
                node = node.right;
            }
        }
        return null;
    }
    redBlackInsertFixUp(z) {
        var _a, _b;
        while (this.isRed(z.p)) {
            if (((_a = z.p) === null || _a === void 0 ? void 0 : _a.p) && z.p === z.p.p.left) {
                const uncle = z.p.p.right;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.right) {
                        // if is right child tree
                        z = z.p;
                        this.leftRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.rightRotate(z.p.p);
                        }
                    }
                }
            }
            else if (((_b = z.p) === null || _b === void 0 ? void 0 : _b.p) && z.p === z.p.p.right) {
                const uncle = z.p.p.left;
                if (this.isRed(uncle)) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    if (uncle)
                        uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.left) {
                        // if is right child tree
                        z = z.p;
                        this.rightRotate(z);
                    }
                    if (z.p) {
                        z.p.isRed = false;
                        if (z.p.p) {
                            z.p.p.isRed = true;
                            this.leftRotate(z.p.p);
                        }
                    }
                }
            }
        }
        if (this.root)
            this.root.isRed = false;
    }
    leftRotate(x) {
        // console.log('leftRotate', x.key);
        const y = x.right;
        if (y == null)
            return;
        x.right = y.left;
        if (y.left) {
            y.left.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.left)
            x.p.left = y;
        else
            x.p.right = y;
        y.left = x;
        x.p = y;
    }
    rightRotate(x) {
        const y = x.left;
        if (y == null)
            return;
        x.left = y.right;
        if (y.right) {
            y.right.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.right)
            x.p.right = y;
        else
            x.p.left = y;
        y.right = x;
        x.p = y;
    }
}
exports.RedBlackTree = RedBlackTree;
/** Allow inserting multiple items with same key in a red-black tree */
class DuplicateKeyTree extends RedBlackTree {
}
exports.DuplicateKeyTree = DuplicateKeyTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zdHJ1Y3R1cmVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvdXRpbHMvZGF0YS1zdHJ1Y3R1cmVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7OztBQVVILE1BQWEsWUFBWTtJQUd2QixZQUFvQixVQUF1QztRQUF2QyxlQUFVLEdBQVYsVUFBVSxDQUE2QjtRQUYzRCxTQUFJLEdBQXFDLElBQUksQ0FBQztRQUc1QyxJQUFJLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLEdBQU07UUFDWCxJQUFJLENBQUMsR0FBeUIsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDbEIsSUFBSSxHQUFXLENBQUM7UUFDaEIsT0FBTyxDQUFDLEVBQUU7WUFDUixDQUFDLEdBQUcsQ0FBQyxDQUFFO1lBQ1AsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7Z0JBQ1gsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDWjtpQkFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7Z0JBQ2xCLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2FBQ2I7aUJBQU07Z0JBQ0wsT0FBTyxJQUFJLENBQUMsQ0FBQyxz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QztRQUNqQixJQUFJLENBQUMsSUFBSSxJQUFJO1lBQ1gsT0FBTztRQUNULENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNqQixJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUU7WUFDWCxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDZjtRQUNELENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNWLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJO1lBQ2IsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7YUFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7WUFDdEIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDOztZQUVkLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNmLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ1osQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDVixDQUFDO0NBQ0Y7QUE3U0Qsb0NBNlNDO0FBRUQsdUVBQXVFO0FBQ3ZFLE1BQWEsZ0JBQW9CLFNBQVEsWUFBZTtDQUV2RDtBQUZELDRDQUVDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBY2NvcmRpbmcgdG8gdGhlIGJvb2sgPDwgSW50cm9kdWN0aW9uIHRvIEFsZ29yaXRobXMsIFRoaXJkIEVkaXRpb24gPj5cbiAqIFxuICogZmVhdHVyZXMgaW4gcHJvZ3Jlc3M6IER5bmFtaWMgb3JkZXIgc3RhdGlzdGljcywgcmFuZ2UgdHJlZVxuICogXG4gKiBUaGlzIGRhdGEgc3RydWN0dXJlIGlzIG1lYW50IGZvciBiZWluZyBleHRlbmQsIHNpbmNlIHRoZSBtYWpvcml0eSBvZiAzcmQtcGFydHkgcmVkLWJsYWNrIHRyZWUgb24gbnBtanMub3JnIGlzIG5vdCBleHRlbnNpYmxlXG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBSYlRyZWVOb2RlPFQ+IHtcbiAga2V5OiBUO1xuICBwOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbDtcbiAgbGVmdDogUmJUcmVlTm9kZTxUPiB8IG51bGw7XG4gIHJpZ2h0OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbDtcbiAgaXNSZWQ6IGJvb2xlYW47XG4gIHNpemU6IG51bWJlcjtcbn1cbmV4cG9ydCBjbGFzcyBSZWRCbGFja1RyZWU8VD4ge1xuICByb290OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb21wYXJhdG9yPzogKGE6IFQsIGI6IFQpID0+IC0xIHwgMCB8IDEpIHtcbiAgICBpZiAoY29tcGFyYXRvciA9PSBudWxsKSB7XG4gICAgICB0aGlzLmNvbXBhcmF0b3IgPSAoYSwgYikgPT4ge1xuICAgICAgICByZXR1cm4gYSA8IGIgPyAtMSA6XG4gICAgICAgICAgYSA+IGIgPyAxIDogMDtcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0ga2V5XG4gICAqIEByZXR1cm5zIG51bGwgaWYga2V5IGR1cGxpY2F0ZXMgd2l0aCBleGlzdGluZyB0cmVlIG5vZGVcbiAgICovXG4gIGluc2VydChrZXk6IFQpOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB7XG4gICAgbGV0IHk6IFJiVHJlZU5vZGU8VD4gfCBudWxsID0gbnVsbDtcbiAgICBsZXQgeCA9IHRoaXMucm9vdDtcbiAgICBsZXQgY21wOiBudW1iZXI7XG4gICAgd2hpbGUgKHgpIHtcbiAgICAgIHkgPSB4IDtcbiAgICAgIGNtcCA9IHRoaXMuY29tcGFyYXRvciEoa2V5LCB4LmtleSk7XG4gICAgICBpZiAoY21wIDwgMCkge1xuICAgICAgICB4ID0geC5sZWZ0O1xuICAgICAgfSBlbHNlIGlmIChjbXAgPiAwKSB7XG4gICAgICAgIHggPSB4LnJpZ2h0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG51bGw7IC8vIGR1cGxpY2F0ZSBrZXkgZm91bmRcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgejogUmJUcmVlTm9kZTxUPiA9IHtcbiAgICAgIGlzUmVkOiB0cnVlLFxuICAgICAga2V5LFxuICAgICAgcDogeSxcbiAgICAgIGxlZnQ6IG51bGwsXG4gICAgICByaWdodDogbnVsbCxcbiAgICAgIHNpemU6IDBcbiAgICB9O1xuICAgIGlmICh5ID09IG51bGwpIHtcbiAgICAgIHRoaXMucm9vdCA9IHo7XG4gICAgICAvLyB6LmlzUmVkID0gZmFsc2U7XG4gICAgfSBlbHNlIGlmIChjbXAhIDwgMCApIHtcbiAgICAgIHkubGVmdCA9IHo7XG4gICAgfSBlbHNlIGlmIChjbXAhID4gMCApIHtcbiAgICAgIHkucmlnaHQgPSB6O1xuICAgIH1cbiAgICB0aGlzLnJlZEJsYWNrSW5zZXJ0Rml4VXAoeik7XG4gICAgcmV0dXJuIHo7XG4gIH1cblxuICBkZWxldGUoa2V5OiBUKSB7XG4gICAgY29uc3Qgbm9kZSA9IHRoaXMuc2VhcmNoKGtleSk7XG4gICAgaWYgKG5vZGUgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLmRlbGV0ZU5vZGUobm9kZSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpc1JlZChub2RlOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBub2RlICE9IG51bGwgJiYgbm9kZS5pc1JlZDtcbiAgfVxuXG4gIGlzQmxhY2sobm9kZTogUmJUcmVlTm9kZTxUPiB8IG51bGwgfCB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gbm9kZSA9PSBudWxsIHx8ICFub2RlLmlzUmVkO1xuICB9XG5cbiAgcHJvdGVjdGVkIGRlbGV0ZU5vZGUoejogUmJUcmVlTm9kZTxUPikge1xuICAgIGxldCB5OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCAgPSB6O1xuICAgIGxldCBvcmlnSXNSZWQgPSB0aGlzLmlzUmVkKHkpO1xuICAgIGxldCB4OiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgaWYgKHoubGVmdCA9PSBudWxsKSB7XG4gICAgICB4ID0gei5yaWdodDtcbiAgICAgIHRoaXMudHJhbnNwbGFudCh6LCB6LnJpZ2h0KTtcbiAgICB9IGVsc2UgaWYgKHoucmlnaHQgPT0gbnVsbCkge1xuICAgICAgeCA9IHoubGVmdDtcbiAgICAgIHRoaXMudHJhbnNwbGFudCh6LCB6LmxlZnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBib3RoIGxlZnQgYW5kIHJpZ2h0IGNoaWxkIGFyZSBub3QgZW1wdHlcbiAgICAgIHkgPSB0aGlzLm1pbmltdW1PZih6LnJpZ2h0KTtcbiAgICAgIGlmICh5ID09IG51bGwpXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIG9yaWdJc1JlZCA9IHRoaXMuaXNSZWQoeSk7XG4gICAgICB4ID0geS5yaWdodDtcbiAgICAgIGlmICh5LnAgPT09IHopIHtcbiAgICAgICAgaWYgKHgpIHgucCA9IHk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRyYW5zcGxhbnQoeSwgeS5yaWdodCk7XG4gICAgICAgIHkucmlnaHQgPSB6LnJpZ2h0O1xuICAgICAgICB5LnJpZ2h0LnAgPSB5O1xuICAgICAgfVxuICAgICAgdGhpcy50cmFuc3BsYW50KHosIHkpO1xuICAgICAgeS5sZWZ0ID0gei5sZWZ0O1xuICAgICAgeS5sZWZ0LnAgPSB5O1xuICAgICAgeS5pc1JlZCA9IHRoaXMuaXNSZWQoeik7XG4gICAgfVxuICAgIGlmICghb3JpZ0lzUmVkICYmIHgpIHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdkZWxldGUgZml4dXAnLCB4LmtleSk7XG4gICAgICB0aGlzLmRlbGV0ZUZpeHVwKHgpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlRml4dXAoeDogUmJUcmVlTm9kZTxUPikge1xuICAgIHdoaWxlICh4ICE9PSB0aGlzLnJvb3QgJiYgdGhpcy5pc0JsYWNrKHgpKSB7XG4gICAgICBpZiAoeC5wICYmIHggPT09IHgucC5sZWZ0KSB7XG4gICAgICAgIGxldCB3ID0geC5wLnJpZ2h0OyAvLyB3IGlzIHgncyBzaWJsaW5nXG4gICAgICAgIGlmICh0aGlzLmlzUmVkKHcpKSB7XG4gICAgICAgICAgdyEuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB4LnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMubGVmdFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICB3ID0geC5wLnJpZ2h0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh3KSB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNCbGFjayh3LmxlZnQpICYmIHRoaXMuaXNCbGFjayh3LnJpZ2h0KSkge1xuICAgICAgICAgICAgdy5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICB4ID0geC5wIDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNCbGFjayh3LnJpZ2h0KSkge1xuICAgICAgICAgICAgICBpZiAody5sZWZ0KVxuICAgICAgICAgICAgICAgIHcubGVmdC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICB3LmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh3KTtcbiAgICAgICAgICAgICAgdyA9IHgucC5yaWdodDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh3KSB3LmlzUmVkID0gdGhpcy5pc1JlZCh4LnApO1xuICAgICAgICAgICAgeC5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAodz8ucmlnaHQpIHcucmlnaHQuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMubGVmdFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICAgIHggPSB0aGlzLnJvb3QhO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh4LnAgJiYgeCA9PT0geC5wLnJpZ2h0KSB7XG4gICAgICAgIGxldCB3ID0geC5wLmxlZnQ7IC8vIHcgaXMgeCdzIHNpYmxpbmdcbiAgICAgICAgaWYgKHRoaXMuaXNSZWQodykpIHtcbiAgICAgICAgICB3IS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHgucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICB3ID0geC5wLmxlZnQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHcpIHtcbiAgICAgICAgICBpZiAodGhpcy5pc0JsYWNrKHcucmlnaHQpICYmIHRoaXMuaXNCbGFjayh3LmxlZnQpKSB7XG4gICAgICAgICAgICB3LmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHggPSB4LnAgO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pc0JsYWNrKHcubGVmdCkpIHtcbiAgICAgICAgICAgICAgaWYgKHcucmlnaHQpXG4gICAgICAgICAgICAgICAgdy5yaWdodC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICB3LmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHcpO1xuICAgICAgICAgICAgICB3ID0geC5wLmxlZnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodykgdy5pc1JlZCA9IHRoaXMuaXNSZWQoeC5wKTtcbiAgICAgICAgICAgIHgucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHc/LmxlZnQpIHcubGVmdC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh4LnAgKTtcbiAgICAgICAgICAgIHggPSB0aGlzLnJvb3QhO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB4LmlzUmVkID0gZmFsc2U7XG4gIH1cblxuICBtaW5pbXVtT2Yobm9kZTogUmJUcmVlTm9kZTxUPiB8IG51bGwgfCB1bmRlZmluZWQgPSB0aGlzLnJvb3QpIHtcbiAgICAvLyBsZXQgbWluOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgd2hpbGUgKG5vZGU/LmxlZnQpIHtcbiAgICAgIC8vIG1pbiA9IG5vZGU7XG4gICAgICBub2RlID0gbm9kZS5sZWZ0O1xuICAgIH1cbiAgICByZXR1cm4gbm9kZSA/IG5vZGUgOiBudWxsO1xuICB9XG5cbiAgLy8gbWF4aW11bU9mKG5vZGU6IFJiVHJlZU5vZGU8VD4gPSB0aGlzLnJvb3QpIHtcblxuICAvLyAgIHdoaWxlICh0aGlzLmlzTm90TmlsKG5vZGUpKVxuICAvLyAgICAgbm9kZSA9IG5vZGUucmlnaHQ7XG4gIC8vICAgcmV0dXJuIG5vZGU7XG4gIC8vIH1cblxuICBwcml2YXRlIHRyYW5zcGxhbnQocmVwbGFjZU5vZGU6IFJiVHJlZU5vZGU8VD4sIHdpdGhOb2RlOiBSYlRyZWVOb2RlPFQ+IHwgbnVsbCA9IG51bGwpIHtcbiAgICBpZiAocmVwbGFjZU5vZGUucCA9PSBudWxsKSB7XG4gICAgICB0aGlzLnJvb3QgPSB3aXRoTm9kZTtcbiAgICB9IGVsc2UgaWYgKHJlcGxhY2VOb2RlID09PSByZXBsYWNlTm9kZS5wLmxlZnQpIHtcbiAgICAgIHJlcGxhY2VOb2RlLnAubGVmdCA9IHdpdGhOb2RlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXBsYWNlTm9kZS5wLnJpZ2h0ID0gd2l0aE5vZGU7XG4gICAgfVxuICAgIGlmICh3aXRoTm9kZSlcbiAgICAgIHdpdGhOb2RlLnAgPSByZXBsYWNlTm9kZS5wO1xuICB9XG5cbiAgc2VhcmNoKGtleTogVCk6IFJiVHJlZU5vZGU8VD4gfCBudWxsIHtcbiAgICBsZXQgbm9kZSA9IHRoaXMucm9vdDtcbiAgICB3aGlsZSAobm9kZSkge1xuICAgICAgY29uc3QgY21wID0gdGhpcy5jb21wYXJhdG9yIShrZXksIG5vZGUua2V5KTtcbiAgICAgIGlmIChjbXAgPT09IDApXG4gICAgICAgIHJldHVybiBub2RlO1xuICAgICAgaWYgKGNtcCA8IDApIHtcbiAgICAgICAgbm9kZSA9IG5vZGUubGVmdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5vZGUgPSBub2RlLnJpZ2h0O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByb3RlY3RlZCByZWRCbGFja0luc2VydEZpeFVwKHo6IFJiVHJlZU5vZGU8VD4pIHtcbiAgICB3aGlsZSAodGhpcy5pc1JlZCh6LnApKSB7XG4gICAgICBpZiAoei5wPy5wICYmIHoucCA9PT0gei5wLnAubGVmdCkge1xuICAgICAgICBjb25zdCB1bmNsZSA9IHoucC5wLnJpZ2h0O1xuICAgICAgICBpZiAodGhpcy5pc1JlZCh1bmNsZSkpIHtcbiAgICAgICAgICAvLyBtYXJrIHBhcmVudCBhbmQgdW5jbGUgdG8gYmxhY2ssIGdyYW5kcGEgdG8gcmVkLCBjb250aW51ZSB0byBnbyB1cCB0byBncmFuZHBhIGxldmVsXG4gICAgICAgICAgei5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgaWYgKHVuY2xlKSB1bmNsZS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB6ID0gei5wLnA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gdW5jbGUgaXMgYmxhY2tcbiAgICAgICAgICBpZiAoeiA9PT0gei5wLnJpZ2h0KSB7XG4gICAgICAgICAgICAvLyBpZiBpcyByaWdodCBjaGlsZCB0cmVlXG4gICAgICAgICAgICB6ID0gei5wO1xuICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHopO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoei5wKSB7XG4gICAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICh6LnAucCkge1xuICAgICAgICAgICAgICB6LnAucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoei5wLnApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh6LnA/LnAgJiYgei5wID09PSB6LnAucC5yaWdodCkge1xuICAgICAgICBjb25zdCB1bmNsZSA9IHoucC5wLmxlZnQ7XG4gICAgICAgIGlmICh0aGlzLmlzUmVkKHVuY2xlKSkge1xuICAgICAgICAgIC8vIG1hcmsgcGFyZW50IGFuZCB1bmNsZSB0byBibGFjaywgZ3JhbmRwYSB0byByZWQsIGNvbnRpbnVlIHRvIGdvIHVwIHRvIGdyYW5kcGEgbGV2ZWxcbiAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICBpZiAodW5jbGUpIHVuY2xlLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHogPSB6LnAucDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB1bmNsZSBpcyBibGFja1xuICAgICAgICAgIGlmICh6ID09PSB6LnAubGVmdCkge1xuICAgICAgICAgICAgLy8gaWYgaXMgcmlnaHQgY2hpbGQgdHJlZVxuICAgICAgICAgICAgeiA9IHoucDtcbiAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoeik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh6LnApIHtcbiAgICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHoucC5wKSB7XG4gICAgICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHoucC5wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMucm9vdClcbiAgICAgIHRoaXMucm9vdC5pc1JlZCA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBsZWZ0Um90YXRlKHg6IFJiVHJlZU5vZGU8VD4pIHtcbiAgICAvLyBjb25zb2xlLmxvZygnbGVmdFJvdGF0ZScsIHgua2V5KTtcbiAgICBjb25zdCB5ID0geC5yaWdodDtcbiAgICBpZiAoeSA9PSBudWxsKVxuICAgICAgcmV0dXJuO1xuICAgIHgucmlnaHQgPSB5LmxlZnQ7XG4gICAgaWYgKHkubGVmdCkge1xuICAgICAgeS5sZWZ0LnAgPSB4O1xuICAgIH1cbiAgICB5LnAgPSB4LnA7XG4gICAgaWYgKHgucCA9PSBudWxsKVxuICAgICAgdGhpcy5yb290ID0geTtcbiAgICBlbHNlIGlmICh4ID09PSB4LnAubGVmdClcbiAgICAgIHgucC5sZWZ0ID0geTtcbiAgICBlbHNlXG4gICAgICB4LnAucmlnaHQgPSB5O1xuICAgIHkubGVmdCA9IHg7XG4gICAgeC5wID0geTtcbiAgfVxuXG4gIHByaXZhdGUgcmlnaHRSb3RhdGUoeDogUmJUcmVlTm9kZTxUPikge1xuICAgIGNvbnN0IHkgPSB4LmxlZnQ7XG4gICAgaWYgKHkgPT0gbnVsbClcbiAgICAgIHJldHVybjtcbiAgICB4LmxlZnQgPSB5LnJpZ2h0O1xuICAgIGlmICh5LnJpZ2h0KSB7XG4gICAgICB5LnJpZ2h0LnAgPSB4O1xuICAgIH1cbiAgICB5LnAgPSB4LnA7XG4gICAgaWYgKHgucCA9PSBudWxsKVxuICAgICAgdGhpcy5yb290ID0geTtcbiAgICBlbHNlIGlmICh4ID09PSB4LnAucmlnaHQpXG4gICAgICB4LnAucmlnaHQgPSB5O1xuICAgIGVsc2VcbiAgICAgIHgucC5sZWZ0ID0geTtcbiAgICB5LnJpZ2h0ID0geDtcbiAgICB4LnAgPSB5O1xuICB9XG59XG5cbi8qKiBBbGxvdyBpbnNlcnRpbmcgbXVsdGlwbGUgaXRlbXMgd2l0aCBzYW1lIGtleSBpbiBhIHJlZC1ibGFjayB0cmVlICovXG5leHBvcnQgY2xhc3MgRHVwbGljYXRlS2V5VHJlZTxUPiBleHRlbmRzIFJlZEJsYWNrVHJlZTxUPiB7XG5cbn1cbiJdfQ==