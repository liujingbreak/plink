"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RedBlackTree = void 0;
/**
 * According to the book << Introduction to Algorithms, Third Edition >>
 * include features: Dynamic order statistics, range tree
 */
class RedBlackTree {
    constructor(comparator) {
        this.comparator = comparator;
        if (comparator == null) {
            this.comparator = (a, b) => {
                return a < b ? -1 :
                    a > b ? 1 : 0;
            };
        }
    }
    /**
     *
     * @param key
     * @returns null if key duplicates with existing tree node
     */
    insert(key) {
        let y;
        let x = this.root;
        let cmp;
        while (x != null) {
            y = x;
            cmp = this.comparator(key, x.key);
            if (cmp < 0) {
                x = x.left;
            }
            else if (cmp > 0) {
                x = x.right;
            }
            else {
                return null; // duplicate key found
            }
        }
        const z = {
            isRed: true,
            key,
            p: y,
            size: 0
        };
        if (y == null) {
            this.root = z;
            z.isRed = false;
        }
        else if (cmp < 0) {
            y.left = z;
        }
        else if (cmp > 0) {
            y.right = z;
        }
        this.redBlackInsertFixUp(z);
        return z;
    }
    delete(key) {
        const node = this.search(key);
        if (node == null) {
            return false;
        }
        this.deleteNode(node);
        return true;
    }
    deleteNode(node) {
        let origIsRed = node.isRed;
        let x;
        if (node.left == null) {
            x = node.right;
            this.transplant(node, node.right);
        }
        else if (node.right == null) {
            x = node.left;
            this.transplant(node, node.left);
        }
        else {
            // both left and right child are not empty
            const rightMin = this.minimumOf(node.right);
            origIsRed = rightMin.isRed;
            x = rightMin.right;
            if (rightMin.p !== node) {
                this.transplant(rightMin, rightMin.right);
                rightMin.right = node.right;
                rightMin.right.p = rightMin;
            }
            else {
                this.transplant(node, rightMin);
            }
            rightMin.left = node.left;
            rightMin.left.p = rightMin;
            rightMin.isRed = node.isRed;
        }
        if (!origIsRed && x) {
            console.log('fixup', x.key);
            this.deleteFixup(x);
        }
    }
    deleteFixup(x) {
        while (x.p && x !== this.root && !x.isRed) {
            if (x === x.p.left && x.p.right) {
                let w = x.p.right; // w is x's sibling
                if (w.isRed) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.leftRotate(x.p);
                    w = x.p.right;
                }
                if (w.left && !w.left.isRed && w.right && !w.right.isRed) {
                    w.isRed = true;
                    x = x.p;
                }
                else {
                    if (w.right && !w.right.isRed && w.left) {
                        w.left.isRed = false;
                        w.isRed = true;
                        this.rightRotate(w);
                        w = x.p.right;
                    }
                    w.isRed = x.p.isRed;
                    x.p.isRed = false;
                    if (w.right)
                        w.right.isRed = false;
                    this.leftRotate(x.p);
                    x = this.root;
                }
            }
            else if (x === x.p.right && x.p.left) {
                let w = x.p.left; // w is x's sibling
                if (w.isRed) {
                    w.isRed = false;
                    x.p.isRed = true;
                    this.rightRotate(x.p);
                    w = x.p.left;
                }
                if (w.right && !w.right.isRed && w.left && !w.left.isRed) {
                    w.isRed = true;
                    x = x.p;
                }
                else {
                    if (w.left && !w.left.isRed && w.right) {
                        w.right.isRed = false;
                        w.isRed = true;
                        this.leftRotate(w);
                        w = x.p.left;
                    }
                    w.isRed = x.p.isRed;
                    x.p.isRed = false;
                    if (w.left)
                        w.left.isRed = false;
                    this.rightRotate(x.p);
                    x = this.root;
                }
            }
        }
        x.isRed = false;
    }
    minimumOf(node = this.root) {
        while (node.left) {
            node = node.left;
        }
        return node;
    }
    maximumOf(node = this.root) {
        while (node.right)
            node = node.right;
        return node;
    }
    transplant(replaceNode, withNode) {
        if (replaceNode.p == null) {
            this.root = withNode;
        }
        else if (replaceNode === replaceNode.p.left) {
            replaceNode.p.left = withNode;
        }
        else {
            replaceNode.p.right = withNode;
        }
        if (withNode)
            withNode.p = replaceNode.p;
    }
    search(key) {
        let node = this.root;
        while (node != null) {
            const cmp = this.comparator(key, node.key);
            if (cmp === 0)
                return node;
            if (cmp < 0) {
                node = node.left;
            }
            else {
                node = node.right;
            }
        }
        return null;
    }
    redBlackInsertFixUp(z) {
        var _a, _b, _c, _d;
        while (z.p && z.p.isRed) {
            if (z.p === ((_a = z.p.p) === null || _a === void 0 ? void 0 : _a.left)) {
                const uncle = z.p.p.right;
                if (uncle === null || uncle === void 0 ? void 0 : uncle.isRed) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.right) {
                        // if is right child tree
                        z = z.p;
                        this.leftRotate(z);
                    }
                    if ((_b = z.p) === null || _b === void 0 ? void 0 : _b.p) {
                        z.p.isRed = false;
                        z.p.p.isRed = true;
                        this.rightRotate(z.p.p);
                    }
                }
            }
            else if (z.p === ((_c = z.p.p) === null || _c === void 0 ? void 0 : _c.right)) {
                const uncle = z.p.p.left;
                if (uncle === null || uncle === void 0 ? void 0 : uncle.isRed) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    if (z === z.p.left) {
                        // if is right child tree
                        z = z.p;
                        this.rightRotate(z);
                    }
                    if ((_d = z.p) === null || _d === void 0 ? void 0 : _d.p) {
                        z.p.isRed = false;
                        z.p.p.isRed = true;
                        this.leftRotate(z.p.p);
                    }
                }
            }
        }
        this.root.isRed = false;
    }
    leftRotate(x) {
        const y = x.right;
        x.right = y.left;
        if (y.left) {
            y.left.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.left)
            x.p.left = y;
        else
            x.p.right = y;
        y.left = x;
        x.p = y;
    }
    rightRotate(x) {
        const y = x.left;
        x.left = y.right;
        if (y.right) {
            y.right.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.right)
            x.p.right = y;
        else
            x.p.left = y;
        y.right = x;
        x.p = y;
    }
}
exports.RedBlackTree = RedBlackTree;
RedBlackTree.nil = {
    isRed: false,
    size: 0
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zdHJ1Y3R1cmVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvdXRpbHMvZGF0YS1zdHJ1Y3R1cmVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQVlBOzs7R0FHRztBQUNILE1BQWEsWUFBWTtJQU92QixZQUFvQixVQUF1QztRQUF2QyxlQUFVLEdBQVYsVUFBVSxDQUE2QjtRQUN6RCxJQUFJLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLEdBQU07UUFDWCxJQUFJLENBQWtDLENBQUM7UUFDdkMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNsQixJQUFJLEdBQVcsQ0FBQztRQUNoQixPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUU7WUFDaEIsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNOLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO2dCQUNYLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2FBQ1o7aUJBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO2dCQUNsQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUNiO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDLENBQUMsc0JBQXNCO2FBQ3BDO1NBQ0Y7UUFDRCxNQUFNLENB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Q0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ1gsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRU8sV0FBVyxDQUFDLENBQXNCO1FBQ3hDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFLLENBQUM7UUFDbEIsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRTtZQUNYLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNmO1FBQ0QsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1YsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUk7WUFDYixJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQzthQUNYLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSztZQUN0QixDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7O1lBRWQsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDWixDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNWLENBQUM7O0FBL1FILG9DQWdSQztBQS9RUSxnQkFBRyxHQUFHO0lBQ1gsS0FBSyxFQUFFLEtBQUs7SUFDWixJQUFJLEVBQUUsQ0FBQztDQUNSLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFVuZmluaXNoZWQsIFRPRE86IGRlbGV0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUmVkQmxhY2tUcmVlTm9kZTxUPiB7XG4gIGlzUmVkOiBib29sZWFuO1xuICBrZXk6IFQ7XG4gIHA/OiBSZWRCbGFja1RyZWVOb2RlPFQ+O1xuICBsZWZ0PzogUmVkQmxhY2tUcmVlTm9kZTxUPjtcbiAgcmlnaHQ/OiBSZWRCbGFja1RyZWVOb2RlPFQ+O1xuICBzaXplOiBudW1iZXI7XG59XG5cbi8qKlxuICogQWNjb3JkaW5nIHRvIHRoZSBib29rIDw8IEludHJvZHVjdGlvbiB0byBBbGdvcml0aG1zLCBUaGlyZCBFZGl0aW9uID4+XG4gKiBpbmNsdWRlIGZlYXR1cmVzOiBEeW5hbWljIG9yZGVyIHN0YXRpc3RpY3MsIHJhbmdlIHRyZWVcbiAqL1xuZXhwb3J0IGNsYXNzIFJlZEJsYWNrVHJlZTxUPiB7XG4gIHN0YXRpYyBuaWwgPSB7XG4gICAgaXNSZWQ6IGZhbHNlLFxuICAgIHNpemU6IDBcbiAgfTtcbiAgcm9vdDogUmVkQmxhY2tUcmVlTm9kZTxUPiB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbXBhcmF0b3I/OiAoYTogVCwgYjogVCkgPT4gLTEgfCAwIHwgMSkge1xuICAgIGlmIChjb21wYXJhdG9yID09IG51bGwpIHtcbiAgICAgIHRoaXMuY29tcGFyYXRvciA9IChhLCBiKSA9PiB7XG4gICAgICAgIHJldHVybiBhIDwgYiA/IC0xIDpcbiAgICAgICAgICBhID4gYiA/IDEgOiAwO1xuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBrZXlcbiAgICogQHJldHVybnMgbnVsbCBpZiBrZXkgZHVwbGljYXRlcyB3aXRoIGV4aXN0aW5nIHRyZWUgbm9kZVxuICAgKi9cbiAgaW5zZXJ0KGtleTogVCk6IFJlZEJsYWNrVHJlZU5vZGU8VD4gfCBudWxsIHtcbiAgICBsZXQgeTogUmVkQmxhY2tUcmVlTm9kZTxUPiB8IHVuZGVmaW5lZDtcbiAgICBsZXQgeCA9IHRoaXMucm9vdDtcbiAgICBsZXQgY21wOiBudW1iZXI7XG4gICAgd2hpbGUgKHggIT0gbnVsbCkge1xuICAgICAgeSA9IHg7XG4gICAgICBjbXAgPSB0aGlzLmNvbXBhcmF0b3IhKGtleSwgeC5rZXkpO1xuICAgICAgaWYgKGNtcCA8IDApIHtcbiAgICAgICAgeCA9IHgubGVmdDtcbiAgICAgIH0gZWxzZSBpZiAoY21wID4gMCkge1xuICAgICAgICB4ID0geC5yaWdodDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBudWxsOyAvLyBkdXBsaWNhdGUga2V5IGZvdW5kXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHo6IFJlZEJsYWNrVHJlZU5vZGU8VD4gPSB7XG4gICAgICBpc1JlZDogdHJ1ZSxcbiAgICAgIGtleSxcbiAgICAgIHA6IHksXG4gICAgICBzaXplOiAwXG4gICAgfTtcbiAgICBpZiAoeSA9PSBudWxsKSB7XG4gICAgICB0aGlzLnJvb3QgPSB6O1xuICAgICAgei5pc1JlZCA9IGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoY21wISA8IDAgKSB7XG4gICAgICB5LmxlZnQgPSB6O1xuICAgIH0gZWxzZSBpZiAoY21wISA+IDAgKSB7XG4gICAgICB5LnJpZ2h0ID0gejtcbiAgICB9XG4gICAgdGhpcy5yZWRCbGFja0luc2VydEZpeFVwKHopO1xuICAgIHJldHVybiB6O1xuICB9XG5cbiAgZGVsZXRlKGtleTogVCkge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLnNlYXJjaChrZXkpO1xuICAgIGlmIChub2RlID09IG51bGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5kZWxldGVOb2RlKG5vZGUpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGRlbGV0ZU5vZGUobm9kZTogUmVkQmxhY2tUcmVlTm9kZTxUPikge1xuICAgIGxldCBvcmlnSXNSZWQgPSBub2RlLmlzUmVkO1xuICAgIGxldCB4OiBSZWRCbGFja1RyZWVOb2RlPFQ+IHwgdW5kZWZpbmVkO1xuICAgIGlmIChub2RlLmxlZnQgPT0gbnVsbCkge1xuICAgICAgeCA9IG5vZGUucmlnaHQ7XG4gICAgICB0aGlzLnRyYW5zcGxhbnQobm9kZSwgbm9kZS5yaWdodCk7XG4gICAgfSBlbHNlIGlmIChub2RlLnJpZ2h0ID09IG51bGwpIHtcbiAgICAgIHggPSBub2RlLmxlZnQ7XG4gICAgICB0aGlzLnRyYW5zcGxhbnQobm9kZSwgbm9kZS5sZWZ0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYm90aCBsZWZ0IGFuZCByaWdodCBjaGlsZCBhcmUgbm90IGVtcHR5XG4gICAgICBjb25zdCByaWdodE1pbiA9IHRoaXMubWluaW11bU9mKG5vZGUucmlnaHQpO1xuICAgICAgb3JpZ0lzUmVkID0gcmlnaHRNaW4uaXNSZWQ7XG4gICAgICB4ID0gcmlnaHRNaW4ucmlnaHQ7XG4gICAgICBpZiAocmlnaHRNaW4ucCAhPT0gbm9kZSkge1xuICAgICAgICB0aGlzLnRyYW5zcGxhbnQocmlnaHRNaW4sIHJpZ2h0TWluLnJpZ2h0KTtcbiAgICAgICAgcmlnaHRNaW4ucmlnaHQgPSBub2RlLnJpZ2h0O1xuICAgICAgICByaWdodE1pbi5yaWdodC5wID0gcmlnaHRNaW47XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRyYW5zcGxhbnQobm9kZSwgcmlnaHRNaW4pO1xuICAgICAgfVxuICAgICAgcmlnaHRNaW4ubGVmdCA9IG5vZGUubGVmdDtcbiAgICAgIHJpZ2h0TWluLmxlZnQucCA9IHJpZ2h0TWluO1xuICAgICAgcmlnaHRNaW4uaXNSZWQgPSBub2RlLmlzUmVkO1xuICAgIH1cbiAgICBpZiAoIW9yaWdJc1JlZCAmJiB4KSB7XG4gICAgICBjb25zb2xlLmxvZygnZml4dXAnLCB4LmtleSk7XG4gICAgICB0aGlzLmRlbGV0ZUZpeHVwKHgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlRml4dXAoeDogUmVkQmxhY2tUcmVlTm9kZTxUPikge1xuICAgIHdoaWxlICh4LnAgJiYgeCAhPT0gdGhpcy5yb290ICYmICF4LmlzUmVkKSB7XG4gICAgICBpZiAoeCA9PT0geC5wLmxlZnQgJiYgeC5wLnJpZ2h0KSB7XG4gICAgICAgIGxldCB3ID0geC5wLnJpZ2h0OyAvLyB3IGlzIHgncyBzaWJsaW5nXG4gICAgICAgIGlmICh3LmlzUmVkKSB7XG4gICAgICAgICAgdy5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHgucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHgucCk7XG4gICAgICAgICAgdyA9IHgucC5yaWdodDtcbiAgICAgICAgfVxuICAgICAgICBpZiAody5sZWZ0ICYmICF3LmxlZnQuaXNSZWQgJiYgdy5yaWdodCAmJiAhdy5yaWdodC5pc1JlZCkge1xuICAgICAgICAgIHcuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHggPSB4LnA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHcucmlnaHQgJiYgIXcucmlnaHQuaXNSZWQgJiYgdy5sZWZ0KSB7XG4gICAgICAgICAgICB3LmxlZnQuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHcuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh3KTtcbiAgICAgICAgICAgIHcgPSB4LnAucmlnaHQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIHcuaXNSZWQgPSB4LnAuaXNSZWQ7XG4gICAgICAgICAgeC5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgaWYgKHcucmlnaHQpXG4gICAgICAgICAgICB3LnJpZ2h0LmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHgucCk7XG4gICAgICAgICAgeCA9IHRoaXMucm9vdCE7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoeCA9PT0geC5wLnJpZ2h0ICYmIHgucC5sZWZ0KSB7XG4gICAgICAgIGxldCB3ID0geC5wLmxlZnQ7IC8vIHcgaXMgeCdzIHNpYmxpbmdcbiAgICAgICAgaWYgKHcuaXNSZWQpIHtcbiAgICAgICAgICB3LmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgeC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnJpZ2h0Um90YXRlKHgucCk7XG4gICAgICAgICAgdyA9IHgucC5sZWZ0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh3LnJpZ2h0ICYmICF3LnJpZ2h0LmlzUmVkICYmIHcubGVmdCAmJiAhdy5sZWZ0LmlzUmVkKSB7XG4gICAgICAgICAgdy5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgeCA9IHgucDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAody5sZWZ0ICYmICF3LmxlZnQuaXNSZWQgJiYgdy5yaWdodCkge1xuICAgICAgICAgICAgdy5yaWdodC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdy5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUodyk7XG4gICAgICAgICAgICB3ID0geC5wLmxlZnQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIHcuaXNSZWQgPSB4LnAuaXNSZWQ7XG4gICAgICAgICAgeC5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgaWYgKHcubGVmdClcbiAgICAgICAgICAgIHcubGVmdC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoeC5wKTtcbiAgICAgICAgICB4ID0gdGhpcy5yb290ITtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB4LmlzUmVkID0gZmFsc2U7XG4gIH1cblxuICBtaW5pbXVtT2Yobm9kZTogUmVkQmxhY2tUcmVlTm9kZTxUPiA9IHRoaXMucm9vdCEpIHtcbiAgICB3aGlsZSAobm9kZS5sZWZ0KSB7XG4gICAgICBub2RlID0gbm9kZS5sZWZ0O1xuICAgIH1cbiAgICByZXR1cm4gbm9kZTtcbiAgfVxuXG4gIG1heGltdW1PZihub2RlOiBSZWRCbGFja1RyZWVOb2RlPFQ+ID0gdGhpcy5yb290ISkge1xuICAgIHdoaWxlIChub2RlLnJpZ2h0KVxuICAgICAgbm9kZSA9IG5vZGUucmlnaHQ7XG4gICAgcmV0dXJuIG5vZGU7XG4gIH1cblxuICBwcml2YXRlIHRyYW5zcGxhbnQocmVwbGFjZU5vZGU6IFJlZEJsYWNrVHJlZU5vZGU8VD4sIHdpdGhOb2RlPzogUmVkQmxhY2tUcmVlTm9kZTxUPikge1xuICAgIGlmIChyZXBsYWNlTm9kZS5wID09IG51bGwpIHtcbiAgICAgIHRoaXMucm9vdCA9IHdpdGhOb2RlO1xuICAgIH0gZWxzZSBpZiAocmVwbGFjZU5vZGUgPT09IHJlcGxhY2VOb2RlLnAubGVmdCkge1xuICAgICAgcmVwbGFjZU5vZGUucC5sZWZ0ID0gd2l0aE5vZGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcGxhY2VOb2RlLnAucmlnaHQgPSB3aXRoTm9kZTtcbiAgICB9XG4gICAgaWYgKHdpdGhOb2RlKVxuICAgICAgd2l0aE5vZGUucCA9IHJlcGxhY2VOb2RlLnA7XG4gIH1cblxuICBzZWFyY2goa2V5OiBUKTogUmVkQmxhY2tUcmVlTm9kZTxUPiB8IG51bGwge1xuICAgIGxldCBub2RlID0gdGhpcy5yb290O1xuICAgIHdoaWxlIChub2RlICE9IG51bGwpIHtcbiAgICAgIGNvbnN0IGNtcCA9IHRoaXMuY29tcGFyYXRvciEoa2V5LCBub2RlLmtleSk7XG4gICAgICBpZiAoY21wID09PSAwKVxuICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgIGlmIChjbXAgPCAwKSB7XG4gICAgICAgIG5vZGUgPSBub2RlLmxlZnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBub2RlID0gbm9kZS5yaWdodDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICByZWRCbGFja0luc2VydEZpeFVwKHo6IFJlZEJsYWNrVHJlZU5vZGU8VD4pIHtcbiAgICB3aGlsZSAoei5wICYmIHoucC5pc1JlZCkge1xuICAgICAgaWYgKHoucCA9PT0gei5wLnA/LmxlZnQpIHtcbiAgICAgICAgY29uc3QgdW5jbGUgPSB6LnAucC5yaWdodDtcbiAgICAgICAgaWYgKHVuY2xlPy5pc1JlZCkge1xuICAgICAgICAgIC8vIG1hcmsgcGFyZW50IGFuZCB1bmNsZSB0byBibGFjaywgZ3JhbmRwYSB0byByZWQsIGNvbnRpbnVlIHRvIGdvIHVwIHRvIGdyYW5kcGEgbGV2ZWxcbiAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB1bmNsZS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB6ID0gei5wLnA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gdW5jbGUgaXMgYmxhY2tcbiAgICAgICAgICBpZiAoeiA9PT0gei5wLnJpZ2h0KSB7XG4gICAgICAgICAgICAvLyBpZiBpcyByaWdodCBjaGlsZCB0cmVlXG4gICAgICAgICAgICB6ID0gei5wO1xuICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHopO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoei5wPy5wKSB7XG4gICAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoei5wLnApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh6LnAgPT09IHoucC5wPy5yaWdodCkge1xuICAgICAgICBjb25zdCB1bmNsZSA9IHoucC5wLmxlZnQ7XG4gICAgICAgIGlmICh1bmNsZT8uaXNSZWQpIHtcbiAgICAgICAgICAvLyBtYXJrIHBhcmVudCBhbmQgdW5jbGUgdG8gYmxhY2ssIGdyYW5kcGEgdG8gcmVkLCBjb250aW51ZSB0byBnbyB1cCB0byBncmFuZHBhIGxldmVsXG4gICAgICAgICAgei5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgdW5jbGUuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB6LnAucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgeiA9IHoucC5wO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICh6ID09PSB6LnAubGVmdCkge1xuICAgICAgICAgICAgLy8gaWYgaXMgcmlnaHQgY2hpbGQgdHJlZVxuICAgICAgICAgICAgeiA9IHoucDtcbiAgICAgICAgICAgIHRoaXMucmlnaHRSb3RhdGUoeik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh6LnA/LnApIHtcbiAgICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5sZWZ0Um90YXRlKHoucC5wKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5yb290IS5pc1JlZCA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBsZWZ0Um90YXRlKHg6IFJlZEJsYWNrVHJlZU5vZGU8VD4pIHtcbiAgICBjb25zdCB5ID0geC5yaWdodCE7XG4gICAgeC5yaWdodCA9IHkubGVmdDtcbiAgICBpZiAoeS5sZWZ0KSB7XG4gICAgICB5LmxlZnQucCA9IHg7XG4gICAgfVxuICAgIHkucCA9IHgucDtcbiAgICBpZiAoeC5wID09IG51bGwpXG4gICAgICB0aGlzLnJvb3QgPSB5O1xuICAgIGVsc2UgaWYgKHggPT09IHgucC5sZWZ0KVxuICAgICAgeC5wLmxlZnQgPSB5O1xuICAgIGVsc2VcbiAgICAgIHgucC5yaWdodCA9IHk7XG4gICAgeS5sZWZ0ID0geDtcbiAgICB4LnAgPSB5O1xuICB9XG5cbiAgcHJpdmF0ZSByaWdodFJvdGF0ZSh4OiBSZWRCbGFja1RyZWVOb2RlPFQ+KSB7XG4gICAgY29uc3QgeSA9IHgubGVmdCE7XG4gICAgeC5sZWZ0ID0geS5yaWdodDtcbiAgICBpZiAoeS5yaWdodCkge1xuICAgICAgeS5yaWdodC5wID0geDtcbiAgICB9XG4gICAgeS5wID0geC5wO1xuICAgIGlmICh4LnAgPT0gbnVsbClcbiAgICAgIHRoaXMucm9vdCA9IHk7XG4gICAgZWxzZSBpZiAoeCA9PT0geC5wLnJpZ2h0KVxuICAgICAgeC5wLnJpZ2h0ID0geTtcbiAgICBlbHNlXG4gICAgICB4LnAubGVmdCA9IHk7XG4gICAgeS5yaWdodCA9IHg7XG4gICAgeC5wID0geTtcbiAgfVxufVxuIl19