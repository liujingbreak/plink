"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RedBlackTree = void 0;
/**
 * According to the book << Introduction to Algorithms, Third Edition >>
 * include features: Dynamic order statistics, range tree
 */
class RedBlackTree {
    constructor(comparator) {
        this.comparator = comparator;
        if (comparator == null) {
            this.comparator = (a, b) => {
                return a < b ? -1 :
                    a > b ? 1 : 0;
            };
        }
    }
    /**
     *
     * @param key
     * @returns null if key duplicates with existing tree node
     */
    insert(key) {
        let y;
        let x = this.root;
        let cmp;
        while (x != null) {
            y = x;
            cmp = this.comparator(key, x.key);
            if (cmp < 0) {
                x = x.left;
            }
            else if (cmp > 0) {
                x = x.right;
            }
            else {
                return null; // duplicate key found
            }
        }
        const z = {
            isRed: true,
            key,
            p: y,
            size: 0
        };
        if (y == null) {
            this.root = z;
            z.isRed = false;
        }
        else if (cmp < 0) {
            y.left = z;
        }
        else if (cmp > 0) {
            y.right = z;
        }
        this.redBlackInsertFixUp(z);
        return z;
    }
    delete(key) {
        const node = this.search(key);
        if (node == null) {
            return false;
        }
        if (node.left == null) {
            this.transplant(node, node.right);
        }
        else if (node.right == null) {
            this.transplant(node, node.left);
        }
        else {
            // both left and right child are not empty
            const rightMin = this.minimumOf(node.right);
            if (rightMin.p !== node) {
                this.transplant(rightMin, rightMin.right);
                rightMin.right = node.right;
                rightMin.right.p = rightMin;
            }
            else {
                this.transplant(node, rightMin);
            }
            rightMin.left = node.left;
            rightMin.left.p = rightMin;
        }
    }
    minimumOf(node = this.root) {
        while (node.left) {
            node = node.left;
        }
        return node;
    }
    maximumOf(node = this.root) {
        while (node.right)
            node = node.right;
        return node;
    }
    transplant(replaceNode, withNode) {
        if (replaceNode.p == null) {
            this.root = withNode;
        }
        else if (replaceNode === replaceNode.p.left) {
            replaceNode.p.left = withNode;
        }
        else {
            replaceNode.p.right = withNode;
        }
        if (withNode)
            withNode.p = replaceNode.p;
    }
    search(key) {
        let node = this.root;
        while (node != null) {
            const cmp = this.comparator(key, node.key);
            if (cmp === 0)
                return node;
            if (cmp < 0) {
                node = node.left;
            }
            else {
                node = node.right;
            }
        }
        return null;
    }
    redBlackInsertFixUp(z) {
        var _a, _b, _c, _d;
        while (z.p && z.p.isRed) {
            if (z.p === ((_a = z.p.p) === null || _a === void 0 ? void 0 : _a.left)) {
                const uncle = z.p.p.right;
                if (uncle === null || uncle === void 0 ? void 0 : uncle.isRed) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    // uncle is black
                    if (z === z.p.right) {
                        // if is right child tree
                        z = z.p;
                        this.leftRotate(z);
                    }
                    if ((_b = z.p) === null || _b === void 0 ? void 0 : _b.p) {
                        z.p.isRed = false;
                        z.p.p.isRed = true;
                        this.rightRotate(z.p.p);
                    }
                }
            }
            else if (z.p === ((_c = z.p.p) === null || _c === void 0 ? void 0 : _c.right)) {
                const uncle = z.p.p.left;
                if (uncle === null || uncle === void 0 ? void 0 : uncle.isRed) {
                    // mark parent and uncle to black, grandpa to red, continue to go up to grandpa level
                    z.p.isRed = false;
                    uncle.isRed = false;
                    z.p.p.isRed = true;
                    z = z.p.p;
                }
                else {
                    if (z === z.p.left) {
                        // if is right child tree
                        z = z.p;
                        this.rightRotate(z);
                    }
                    if ((_d = z.p) === null || _d === void 0 ? void 0 : _d.p) {
                        z.p.isRed = false;
                        z.p.p.isRed = true;
                        this.leftRotate(z.p.p);
                    }
                }
            }
        }
        this.root.isRed = false;
    }
    leftRotate(x) {
        const y = x.right;
        x.right = y.left;
        if (y.left) {
            y.left.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.left)
            x.p.left = y;
        else
            x.p.right = y;
        y.left = x;
        x.p = y;
    }
    rightRotate(x) {
        const y = x.left;
        x.left = y.right;
        if (y.right) {
            y.right.p = x;
        }
        y.p = x.p;
        if (x.p == null)
            this.root = y;
        else if (x === x.p.right)
            x.p.right = y;
        else
            x.p.left = y;
        y.right = x;
        x.p = y;
    }
}
exports.RedBlackTree = RedBlackTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1zdHJ1Y3R1cmVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvdXRpbHMvZGF0YS1zdHJ1Y3R1cmVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQVlBOzs7R0FHRztBQUNILE1BQWEsWUFBWTtJQUd2QixZQUFvQixVQUF1QztRQUF2QyxlQUFVLEdBQVYsVUFBVSxDQUE2QjtRQUN6RCxJQUFJLFVBQVUsSUFBSSxJQUFJLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLEdBQU07UUFDWCxJQUFJLENBQWtDLENBQUM7UUFDdkMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNsQixJQUFJLEdBQVcsQ0FBQztRQUNoQixPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUU7WUFDaEIsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNOLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbkMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO2dCQUNYLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2FBQ1o7aUJBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxFQUFFO2dCQUNsQixDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUNiO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDLENBQUMsc0JBQXNCO2FBQ3BDO1NBQ0Y7UUFDRCxNQUFNLENB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QUNsQixDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDakIsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFO1lBQ1gsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2Y7UUFDRCxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDVixJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSTtZQUNiLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO2FBQ1gsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLO1lBQ3RCLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQzs7WUFFZCxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7UUFDZixDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ1YsQ0FBQztDQUNGO0FBbk1ELG9DQW1NQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVW5maW5pc2hlZCwgVE9ETzogZGVsZXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWRCbGFja1RyZWVOb2RlPFQ+IHtcbiAgaXNSZWQ6IGJvb2xlYW47XG4gIGtleTogVDtcbiAgcD86IFJlZEJsYWNrVHJlZU5vZGU8VD47XG4gIGxlZnQ/OiBSZWRCbGFja1RyZWVOb2RlPFQ+O1xuICByaWdodD86IFJlZEJsYWNrVHJlZU5vZGU8VD47XG4gIHNpemU6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBBY2NvcmRpbmcgdG8gdGhlIGJvb2sgPDwgSW50cm9kdWN0aW9uIHRvIEFsZ29yaXRobXMsIFRoaXJkIEVkaXRpb24gPj5cbiAqIGluY2x1ZGUgZmVhdHVyZXM6IER5bmFtaWMgb3JkZXIgc3RhdGlzdGljcywgcmFuZ2UgdHJlZVxuICovXG5leHBvcnQgY2xhc3MgUmVkQmxhY2tUcmVlPFQ+IHtcbiAgcm9vdDogUmVkQmxhY2tUcmVlTm9kZTxUPiB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbXBhcmF0b3I/OiAoYTogVCwgYjogVCkgPT4gLTEgfCAwIHwgMSkge1xuICAgIGlmIChjb21wYXJhdG9yID09IG51bGwpIHtcbiAgICAgIHRoaXMuY29tcGFyYXRvciA9IChhLCBiKSA9PiB7XG4gICAgICAgIHJldHVybiBhIDwgYiA/IC0xIDpcbiAgICAgICAgICBhID4gYiA/IDEgOiAwO1xuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBrZXlcbiAgICogQHJldHVybnMgbnVsbCBpZiBrZXkgZHVwbGljYXRlcyB3aXRoIGV4aXN0aW5nIHRyZWUgbm9kZVxuICAgKi9cbiAgaW5zZXJ0KGtleTogVCk6IFJlZEJsYWNrVHJlZU5vZGU8VD4gfCBudWxsIHtcbiAgICBsZXQgeTogUmVkQmxhY2tUcmVlTm9kZTxUPiB8IHVuZGVmaW5lZDtcbiAgICBsZXQgeCA9IHRoaXMucm9vdDtcbiAgICBsZXQgY21wOiBudW1iZXI7XG4gICAgd2hpbGUgKHggIT0gbnVsbCkge1xuICAgICAgeSA9IHg7XG4gICAgICBjbXAgPSB0aGlzLmNvbXBhcmF0b3IhKGtleSwgeC5rZXkpO1xuICAgICAgaWYgKGNtcCA8IDApIHtcbiAgICAgICAgeCA9IHgubGVmdDtcbiAgICAgIH0gZWxzZSBpZiAoY21wID4gMCkge1xuICAgICAgICB4ID0geC5yaWdodDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBudWxsOyAvLyBkdXBsaWNhdGUga2V5IGZvdW5kXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHo6IFJlZEJsYWNrVHJlZU5vZGU8VD4gPSB7XG4gICAgICBpc1JlZDogdHJ1ZSxcbiAgICAgIGtleSxcbiAgICAgIHA6IHksXG4gICAgICBzaXplOiAwXG4gICAgfTtcbiAgICBpZiAoeSA9PSBudWxsKSB7XG4gICAgICB0aGlzLnJvb3QgPSB6O1xuICAgICAgei5pc1JlZCA9IGZhbHNlO1xuICAgIH0gZWxzZSBpZiAoY21wISA8IDAgKSB7XG4gICAgICB5LmxlZnQgPSB6O1xuICAgIH0gZWxzZSBpZiAoY21wISA+IDAgKSB7XG4gICAgICB5LnJpZ2h0ID0gejtcbiAgICB9XG4gICAgdGhpcy5yZWRCbGFja0luc2VydEZpeFVwKHopO1xuICAgIHJldHVybiB6O1xuICB9XG5cbiAgZGVsZXRlKGtleTogVCkge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLnNlYXJjaChrZXkpO1xuICAgIGlmIChub2RlID09IG51bGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKG5vZGUubGVmdCA9PSBudWxsKSB7XG4gICAgICB0aGlzLnRyYW5zcGxhbnQobm9kZSwgbm9kZS5yaWdodCk7XG4gICAgfSBlbHNlIGlmIChub2RlLnJpZ2h0ID09IG51bGwpIHtcbiAgICAgIHRoaXMudHJhbnNwbGFudChub2RlLCBub2RlLmxlZnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBib3RoIGxlZnQgYW5kIHJpZ2h0IGNoaWxkIGFyZSBub3QgZW1wdHlcbiAgICAgIGNvbnN0IHJpZ2h0TWluID0gdGhpcy5taW5pbXVtT2Yobm9kZS5yaWdodCk7XG4gICAgICBpZiAocmlnaHRNaW4ucCAhPT0gbm9kZSkge1xuICAgICAgICB0aGlzLnRyYW5zcGxhbnQocmlnaHRNaW4sIHJpZ2h0TWluLnJpZ2h0KTtcbiAgICAgICAgcmlnaHRNaW4ucmlnaHQgPSBub2RlLnJpZ2h0O1xuICAgICAgICByaWdodE1pbi5yaWdodC5wID0gcmlnaHRNaW47XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRyYW5zcGxhbnQobm9kZSwgcmlnaHRNaW4pO1xuICAgICAgfVxuICAgICAgcmlnaHRNaW4ubGVmdCA9IG5vZGUubGVmdDtcbiAgICAgIHJpZ2h0TWluLmxlZnQucCA9IHJpZ2h0TWluO1xuICAgIH1cbiAgfVxuXG4gIG1pbmltdW1PZihub2RlOiBSZWRCbGFja1RyZWVOb2RlPFQ+ID0gdGhpcy5yb290ISkge1xuICAgIHdoaWxlIChub2RlLmxlZnQpIHtcbiAgICAgIG5vZGUgPSBub2RlLmxlZnQ7XG4gICAgfVxuICAgIHJldHVybiBub2RlO1xuICB9XG5cbiAgbWF4aW11bU9mKG5vZGU6IFJlZEJsYWNrVHJlZU5vZGU8VD4gPSB0aGlzLnJvb3QhKSB7XG4gICAgd2hpbGUgKG5vZGUucmlnaHQpXG4gICAgICBub2RlID0gbm9kZS5yaWdodDtcbiAgICByZXR1cm4gbm9kZTtcbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNwbGFudChyZXBsYWNlTm9kZTogUmVkQmxhY2tUcmVlTm9kZTxUPiwgd2l0aE5vZGU/OiBSZWRCbGFja1RyZWVOb2RlPFQ+KSB7XG4gICAgaWYgKHJlcGxhY2VOb2RlLnAgPT0gbnVsbCkge1xuICAgICAgdGhpcy5yb290ID0gd2l0aE5vZGU7XG4gICAgfSBlbHNlIGlmIChyZXBsYWNlTm9kZSA9PT0gcmVwbGFjZU5vZGUucC5sZWZ0KSB7XG4gICAgICByZXBsYWNlTm9kZS5wLmxlZnQgPSB3aXRoTm9kZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVwbGFjZU5vZGUucC5yaWdodCA9IHdpdGhOb2RlO1xuICAgIH1cbiAgICBpZiAod2l0aE5vZGUpXG4gICAgICB3aXRoTm9kZS5wID0gcmVwbGFjZU5vZGUucDtcbiAgfVxuXG4gIHNlYXJjaChrZXk6IFQpOiBSZWRCbGFja1RyZWVOb2RlPFQ+IHwgbnVsbCB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLnJvb3Q7XG4gICAgd2hpbGUgKG5vZGUgIT0gbnVsbCkge1xuICAgICAgY29uc3QgY21wID0gdGhpcy5jb21wYXJhdG9yIShrZXksIG5vZGUua2V5KTtcbiAgICAgIGlmIChjbXAgPT09IDApXG4gICAgICAgIHJldHVybiBub2RlO1xuICAgICAgaWYgKGNtcCA8IDApIHtcbiAgICAgICAgbm9kZSA9IG5vZGUubGVmdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5vZGUgPSBub2RlLnJpZ2h0O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHJlZEJsYWNrSW5zZXJ0Rml4VXAoejogUmVkQmxhY2tUcmVlTm9kZTxUPikge1xuICAgIHdoaWxlICh6LnAgJiYgei5wLmlzUmVkKSB7XG4gICAgICBpZiAoei5wID09PSB6LnAucD8ubGVmdCkge1xuICAgICAgICBjb25zdCB1bmNsZSA9IHoucC5wLnJpZ2h0O1xuICAgICAgICBpZiAodW5jbGU/LmlzUmVkKSB7XG4gICAgICAgICAgLy8gbWFyayBwYXJlbnQgYW5kIHVuY2xlIHRvIGJsYWNrLCBncmFuZHBhIHRvIHJlZCwgY29udGludWUgdG8gZ28gdXAgdG8gZ3JhbmRwYSBsZXZlbFxuICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHVuY2xlLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgIHogPSB6LnAucDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB1bmNsZSBpcyBibGFja1xuICAgICAgICAgIGlmICh6ID09PSB6LnAucmlnaHQpIHtcbiAgICAgICAgICAgIC8vIGlmIGlzIHJpZ2h0IGNoaWxkIHRyZWVcbiAgICAgICAgICAgIHogPSB6LnA7XG4gICAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUoeik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh6LnA/LnApIHtcbiAgICAgICAgICAgIHoucC5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgICAgei5wLnAuaXNSZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh6LnAucCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHoucCA9PT0gei5wLnA/LnJpZ2h0KSB7XG4gICAgICAgIGNvbnN0IHVuY2xlID0gei5wLnAubGVmdDtcbiAgICAgICAgaWYgKHVuY2xlPy5pc1JlZCkge1xuICAgICAgICAgIC8vIG1hcmsgcGFyZW50IGFuZCB1bmNsZSB0byBibGFjaywgZ3JhbmRwYSB0byByZWQsIGNvbnRpbnVlIHRvIGdvIHVwIHRvIGdyYW5kcGEgbGV2ZWxcbiAgICAgICAgICB6LnAuaXNSZWQgPSBmYWxzZTtcbiAgICAgICAgICB1bmNsZS5pc1JlZCA9IGZhbHNlO1xuICAgICAgICAgIHoucC5wLmlzUmVkID0gdHJ1ZTtcbiAgICAgICAgICB6ID0gei5wLnA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHogPT09IHoucC5sZWZ0KSB7XG4gICAgICAgICAgICAvLyBpZiBpcyByaWdodCBjaGlsZCB0cmVlXG4gICAgICAgICAgICB6ID0gei5wO1xuICAgICAgICAgICAgdGhpcy5yaWdodFJvdGF0ZSh6KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHoucD8ucCkge1xuICAgICAgICAgICAgei5wLmlzUmVkID0gZmFsc2U7XG4gICAgICAgICAgICB6LnAucC5pc1JlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxlZnRSb3RhdGUoei5wLnApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJvb3QhLmlzUmVkID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGxlZnRSb3RhdGUoeDogUmVkQmxhY2tUcmVlTm9kZTxUPikge1xuICAgIGNvbnN0IHkgPSB4LnJpZ2h0ITtcbiAgICB4LnJpZ2h0ID0geS5sZWZ0O1xuICAgIGlmICh5LmxlZnQpIHtcbiAgICAgIHkubGVmdC5wID0geDtcbiAgICB9XG4gICAgeS5wID0geC5wO1xuICAgIGlmICh4LnAgPT0gbnVsbClcbiAgICAgIHRoaXMucm9vdCA9IHk7XG4gICAgZWxzZSBpZiAoeCA9PT0geC5wLmxlZnQpXG4gICAgICB4LnAubGVmdCA9IHk7XG4gICAgZWxzZVxuICAgICAgeC5wLnJpZ2h0ID0geTtcbiAgICB5LmxlZnQgPSB4O1xuICAgIHgucCA9IHk7XG4gIH1cblxuICBwcml2YXRlIHJpZ2h0Um90YXRlKHg6IFJlZEJsYWNrVHJlZU5vZGU8VD4pIHtcbiAgICBjb25zdCB5ID0geC5sZWZ0ITtcbiAgICB4LmxlZnQgPSB5LnJpZ2h0O1xuICAgIGlmICh5LnJpZ2h0KSB7XG4gICAgICB5LnJpZ2h0LnAgPSB4O1xuICAgIH1cbiAgICB5LnAgPSB4LnA7XG4gICAgaWYgKHgucCA9PSBudWxsKVxuICAgICAgdGhpcy5yb290ID0geTtcbiAgICBlbHNlIGlmICh4ID09PSB4LnAucmlnaHQpXG4gICAgICB4LnAucmlnaHQgPSB5O1xuICAgIGVsc2VcbiAgICAgIHgucC5sZWZ0ID0geTtcbiAgICB5LnJpZ2h0ID0geDtcbiAgICB4LnAgPSB5O1xuICB9XG59XG4iXX0=