{"version":3,"file":"find-package.js","sourceRoot":"","sources":["../../src/package-mgr/find-package.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAyB;AACzB,2CAA6B;AAC7B,+BAAmD;AACnD,mCAAiC;AACjC,MAAM,GAAG,GAAG,IAAA,kBAAS,EAAC,gCAAgC,CAAC,CAAC;AACxD;;GAEG;AACH,SAAwB,eAAe,CAAC,SAA4B,EAAE,eAAwB;IAC5F,IAAI,QAAkB,CAAC;IACvB,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC;QAC3B,QAAQ,GAAG,CAAC,SAAS,CAAC,CAAC;;QAEvB,QAAQ,GAAG,SAAS,CAAC;IACvB,OAAO,IAAA,YAAK,EAAC,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,aAAa,CAAC,CAAC,CAAC,CAAC,mBAAmB,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;AAChG,CAAC;AAPD,kCAOC;AAED,MAAM,aAAa;IAIjB,YAAY,OAAe;QACzB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;IACvC,CAAC;IAED,mBAAmB,CAAC,eAAwB;QAC1C,OAAO,IAAI,iBAAU,CAAS,GAAG,CAAC,EAAE;YAClC,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;YACf,IAAI,eAAe;gBACjB,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;;gBAEnC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACjC,GAAG,CAAC,QAAQ,EAAE,CAAC;QACjB,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,eAAe,CAAC,SAAiB;QACvC,MAAM,OAAO,GAAG,EAAE,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC;QAC1C,KAAK,MAAM,IAAI,IAAI,OAAO,EAAE;YAC1B,IAAI;gBACF,IAAI,IAAI,KAAK,cAAc,EAAE;oBAC3B,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,cAAc,CAAC,CAAC;oBACxD,IAAI,EAAE,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,cAAc,EAAE,EAAE;wBAC1C,sCAAsC;wBACtC,GAAG,CAAC,KAAK,CAAC,sCAAsC,EAAE,OAAO,CAAC,CAAC;qBAC5D;oBACD,SAAS;iBACV;gBACD,MAAM,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;gBACvC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;aACvB;YAAC,OAAO,EAAE,EAAE;gBACX,OAAO,CAAC,KAAK,CAAC,EAAE,EAAE,EAAE,CAAC,CAAC;aACvB;SACF;IACH,CAAC;IAEO,WAAW,CAAC,GAAW;QAC7B,IAAI,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,WAAW,EAAE,EAAE;YACxD,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,cAAc,CAAC,CAAC;YAClD,IAAI,EAAE,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE;gBAC7B,IAAI,CAAC,GAAI,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;aAC5B;iBAAM;gBACL,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC;aAC3B;SACF;IACH,CAAC;CACF","sourcesContent":["import * as fs from 'fs';\nimport * as Path from 'path';\nimport {Subscriber, Observable, merge} from 'rxjs';\nimport {getLogger} from 'log4js';\nconst log = getLogger('plink.package-mgr.find-package');\n/**\n * Recursively lookup `fromDir` folder for private module's package.json file\n */\nexport default function findPackageJson(_fromDirs: string[] | string, startFromSubDir: boolean) {\n  let fromDirs: string[];\n  if (!Array.isArray(_fromDirs))\n    fromDirs = [_fromDirs];\n  else\n    fromDirs = _fromDirs;\n  return merge(...fromDirs.map(d => new FolderScanner(d).getPackageJsonFiles(startFromSubDir)));\n}\n\nclass FolderScanner {\n  fromDir: string;\n  private out: Subscriber<string> | undefined;\n\n  constructor(fromDir: string) {\n    this.fromDir = Path.resolve(fromDir);\n  }\n\n  getPackageJsonFiles(startFromSubDir: boolean): Observable<string> {\n    return new Observable<string>(sub => {\n      this.out = sub;\n      if (startFromSubDir)\n        this.checkSubFolders(this.fromDir);\n      else\n        this.checkFolder(this.fromDir);\n      sub.complete();\n    });\n  }\n\n  private checkSubFolders(parentDir: string) {\n    const folders = fs.readdirSync(parentDir);\n    for (const name of folders) {\n      try {\n        if (name === 'node_modules') {\n          const testDir = Path.resolve(parentDir, 'node_modules');\n          if (fs.lstatSync(testDir).isSymbolicLink()) {\n            // eslint-disable-next-line no-console\n            log.debug('Found existing symlink node_modules:', testDir);\n          }\n          continue;\n        }\n        const dir = Path.join(parentDir, name);\n        this.checkFolder(dir);\n      } catch (er) {\n        console.error('', er);\n      }\n    }\n  }\n\n  private checkFolder(dir: string) {\n    if (fs.existsSync(dir) && fs.statSync(dir).isDirectory()) {\n      const pkJsonPath = Path.join(dir, 'package.json');\n      if (fs.existsSync(pkJsonPath)) {\n        this.out!.next(pkJsonPath);\n      } else {\n        this.checkSubFolders(dir);\n      }\n    }\n  }\n}\n\n"]}