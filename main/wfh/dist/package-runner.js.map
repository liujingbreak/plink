{"version":3,"file":"package-runner.js","sourceRoot":"","sources":["../ts/package-runner.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n/* eslint-disable  max-len */\nimport Path from 'path';\nimport * as _ from 'lodash';\nimport log4js from 'log4js';\nimport chalk from 'chalk';\nimport * as op from 'rxjs/operators';\nimport * as rx from 'rxjs';\nimport {PackageInfo, packageOfFileFactory, walkPackages} from './package-mgr/package-info-gathering';\nimport { nodeInjector, webInjector } from './injector-factory';\nimport _NodeApi from './package-mgr/node-package-api';\nimport PackageInstance from './packageNodeInstance';\nimport { orderPackages } from './package-priority-helper';\nimport NodePackage from './packageNodeInstance';\nimport type {default as ExtensionContext} from './package-mgr/node-package-api';\nimport {createLazyPackageFileFinder, packages4Workspace} from './package-utils';\nimport {isCwdWorkspace, getState, workspaceKey, PackageInfo as PackageState} from './package-mgr';\nimport {packages4WorkspaceKey} from './package-mgr/package-list-helper';\n\nimport {getWorkDir} from './utils/misc';\n\nconst log = log4js.getLogger('plink.package-runner');\n\nexport interface ServerRunnerEvent {\n  file: string;\n  functionName: string;\n}\n\ninterface ExtensionExport {\n  activate?(ctx: ExtensionContext): void | Promise<void>;\n  deactivate?(): any;\n}\n\nexport function isServerPackage(pkg: PackageState) {\n  const plinkProp = pkg.json.plink || pkg.json.dr;\n  return plinkProp && (plinkProp.type === 'server' || (Array.isArray(plinkProp.type) && plinkProp.type.includes('server')));\n}\n\nexport function readPriorityProperty(json: any) {\n  return _.get(json, 'plink.serverPriority', _.get(json, 'dr.serverPriority'));\n}\n\nexport function runServer(): {\n  started: Promise<{name: string; exp:  ExtensionExport}[]>;\n  shutdown(): Promise<void>\n} {\n  let wsKey: string | null | undefined = workspaceKey(getWorkDir());\n  wsKey = getState().workspaces.has(wsKey) ? wsKey : getState().currWorkspace;\n  if (wsKey == null) {\n    throw new Error('Current directory is not a workspace directory');\n  }\n  const pkgs = Array.from(packages4WorkspaceKey(wsKey, true))\n    .filter(isServerPackage);\n\n  const pkgNames = pkgs.map(item => item.name);\n  const pkgEntryMap = new Map<string, [file: string | undefined, func: string]>(pkgs.map(item => {\n    const info = item.json.plink || item.json.dr!;\n    let mainFile = info.serverEntry || item.json.main as string | undefined;\n    let funcName = 'activate';\n    if (mainFile) {\n      const tmp = mainFile.split('#');\n      mainFile = tmp[0];\n      if (tmp[1])\n        funcName = tmp[1];\n    }\n\n    return [item.name, [mainFile, funcName]];\n  }));\n\n  const started = _runPackages(pkgNames, pkgName => pkgEntryMap.get(pkgName))\n    .then(reverseOrderPkgExports => {\n      return new Promise<typeof reverseOrderPkgExports>(resolve => setTimeout(() => {\n        resolve(reverseOrderPkgExports);\n      }, 500));\n    });\n\n  // const reverseOrderPkgExports = await runPackages('#activate', pkgs);\n\n  // await new Promise(resolve => setTimeout(resolve, 500));\n  return {\n    started,\n    async shutdown() {\n      const reverseOrderPkgExports = await started;\n      log.info('Shutting down');\n      await rx.from(reverseOrderPkgExports).pipe(\n        op.concatMap(({name, exp}) => {\n          log.info('deactivate', name);\n          if (_.isFunction(exp.deactivate)) {\n            return rx.from(Promise.resolve(exp.deactivate())).pipe(\n              op.timeoutWith(5000, rx.of(`deactivate ${name} timeout`)),\n              op.catchError(err => {\n                log.warn(err);\n                return rx.EMPTY;\n              })\n            );\n          }\n          return rx.EMPTY;\n        })\n      ).toPromise();\n      log.info('Shutdown completed');\n    }\n  };\n}\n\nconst apiCache: Record<string, _NodeApi> = {};\n// const packageTree = new DirTree<PackageInstance>();\n\n/**\n * Lazily init injector for packages and run specific package only,\n * no fully scanning or ordering on all packages\n */\nexport async function runSinglePackage({target, args}: {target: string; args: string[]}) {\n  if (!isCwdWorkspace()) {\n    return Promise.reject(new Error('Current directory is not a workspace directory'));\n  }\n  const [pkgInfo] = initInjectorForNodePackages();\n\n  const [file, func] = target.split('#');\n  const pkgNameMatch = /((?:@[^/]+\\/)?[a-zA-Z0-9_-]+)\\/$/.exec(file);\n  let moduleName = Path.resolve(file);\n  if (pkgNameMatch?.[1] && _.has(pkgInfo.moduleMap, pkgNameMatch[1])) {\n    moduleName = file;\n  }\n  const _exports = require(Path.resolve(getWorkDir(), 'node_modules', moduleName));\n  if (func) {\n    if (!_.has(_exports, func)) {\n      log.error(`There is no export function: ${func}, existing export members are:\\n` +\n      `${Object.keys(_exports).filter(name => typeof (_exports[name]) === 'function').map(name => name + '()').join('\\n')}`);\n      return;\n    }\n\n    await Promise.resolve(_exports[func].apply(global, args || []));\n  }\n}\n\nexport function runPackages(target: string, includePackages: Iterable<string>): Promise<{name: string; exp:  ExtensionExport}[]> {\n\n  return _runPackages(includePackages, () => target.split('#') as [string, string]);\n}\n\nasync function _runPackages(includePackages: Iterable<string>,\n  targetOfPkg: (pkg: string) => [fileToRun: string | undefined, funcToRun: string] | undefined | null\n): Promise<{name: string; exp: ExtensionExport}[]> {\n  const includeNameSet = new Set<string>(includePackages);\n  const pkgExportsInDescendOrder: {name: string; exp: ExtensionExport}[] = [];\n\n  const [packageInfo, proto] = initInjectorForNodePackages();\n  const components = packageInfo.allModules.filter(pk => {\n    const target = targetOfPkg(pk.name);\n    if (target == null)\n      return false;\n    const [fileToRun] = target;\n    // setupRequireInjects(pk, NodeApi); // All component package should be able to access '__api', even they are not included\n    if ((includeNameSet.size === 0 || includeNameSet.has(pk.longName) || includeNameSet.has(pk.shortName))) {\n      try {\n        if (fileToRun)\n          require.resolve(Path.resolve(getWorkDir(), 'node_modules', pk.longName, fileToRun));\n        else\n          require.resolve(Path.resolve(getWorkDir(), 'node_modules', pk.longName));\n        return true;\n      } catch (err) {\n        return false;\n      }\n    }\n    return false;\n  });\n\n  const packageNamesInOrder: string[] = [];\n  const NodeApi: typeof _NodeApi = require('./package-mgr/node-package-api').default;\n\n\n  await orderPackages(components.map(item => ({\n    name: item.longName,\n    priority: _.get(item.json, 'plink.serverPriority', _.get(item.json, 'dr.serverPriority'))\n  })),\n  pkInstance  => {\n    const [fileToRun, funcToRun] = targetOfPkg(pkInstance.name)!;\n    packageNamesInOrder.push(pkInstance.name);\n    const mod = pkInstance.name + ( fileToRun ? '/' + fileToRun : '');\n    log.debug('require(%sf)', JSON.stringify(mod));\n    const fileExports = require(Path.resolve(getWorkDir(), 'node_modules', mod));\n    pkgExportsInDescendOrder.unshift({name: pkInstance.name, exp: fileExports});\n    if (_.isFunction(fileExports[funcToRun])) {\n      log.info(funcToRun + ` ${chalk.cyan(mod)}`);\n      return fileExports[funcToRun](getApiForPackage(packageInfo.moduleMap[pkInstance.name], NodeApi));\n    }\n  });\n  (proto.eventBus!).emit('done', {});\n  NodeApi.prototype.eventBus!.emit('packagesActivated', includeNameSet);\n  return pkgExportsInDescendOrder;\n}\n\n/**\n * So that we can use `import api from '__plink'` anywhere in our package\n */\nexport function initInjectorForNodePackages(): [PackageInfo, _NodeApi] {\n  const {getPkgOfFile, packageInfo} = packageOfFileFactory();\n  // const packageInfo: PackageInfo = walkPackages();\n  const NodeApi = require('./package-mgr/node-package-api').default as typeof _NodeApi;\n  const proto = NodeApi.prototype;\n  proto.argv = {};\n  proto.packageInfo = packageInfo;\n\n  proto.findPackageByFile = getPkgOfFile;\n  proto.getNodeApiForPackage = function(packageInstance: PackageInstance) {\n    return getApiForPackage(packageInstance, NodeApi);\n  };\n  proto.browserInjector = webInjector;\n  packageInfo.allModules.forEach(pk => {\n    setupRequireInjects(pk, NodeApi); // All component package should be able to access '__api', even they are not included\n  });\n  nodeInjector.readInjectFile();\n  webInjector.readInjectFile('module-resolve.browser');\n  return [packageInfo, proto];\n}\n\n/**\n * @deprecated\n * Support `import api from '__api';`\n * @param argv \n */\nexport function prepareLazyNodeInjector(argv?: {[key: string]: any}) {\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n  const NodeApi: typeof _NodeApi = require('./package-mgr/node-package-api').default;\n  const proto = NodeApi.prototype;\n  proto.argv = argv || {};\n  let packageInfo: PackageInfo;\n\n  Object.defineProperty(proto, 'packageInfo', {\n    get() {\n      if (packageInfo == null)\n        packageInfo = walkPackages();\n      return packageInfo;\n    }\n  });\n  proto.findPackageByFile = createLazyPackageFileFinder();\n  proto.getNodeApiForPackage = function(packageInstance: NodePackage) {\n    return getApiForPackage(packageInstance, NodeApi);\n  };\n  nodeInjector.fromRoot()\n  // .alias('log4js', Path.resolve(config().rootPath, 'node_modules/log4js'))\n    .value('__injector', nodeInjector)\n    .factory('__api', (sourceFilePath: string) => {\n      const packageInstance = proto.findPackageByFile(sourceFilePath);\n      if (packageInstance)\n        return getApiForPackage(packageInstance, NodeApi);\n      return null;\n    });\n}\n\nexport function mapPackagesByType(types: string[], onEachPackage: (nodePackage: NodePackage) => void) {\n  const packagesMap: {[type: string]: NodePackage[]} = {};\n  types.forEach(type => {\n    packagesMap[type] = [];\n  });\n\n  for (const pkg of packages4Workspace()) {\n    const name = pkg.name;\n    const pkInstance = new NodePackage({\n      moduleName: name,\n      shortName: pkg.shortName,\n      name,\n      longName: name,\n      scope: pkg.scope,\n      path: Path.resolve(getWorkDir(), pkg.path),\n      json: pkg.json,\n      realPath: pkg.realPath\n    });\n    const drTypes = ([] as string[]).concat(_.get(pkg.json, 'plink.type', _.get(pkg.json, 'dr.type')));\n    for (const type of types) {\n      if (!_.includes(drTypes, type))\n        continue;\n      packagesMap[type].push(pkInstance);\n    }\n    if (onEachPackage) {\n      onEachPackage(pkInstance);\n    }\n  }\n  return packagesMap;\n}\n\nfunction setupRequireInjects(pkInstance: PackageInstance, NodeApi: typeof _NodeApi ) {\n  function apiFactory() {\n    return getApiForPackage(pkInstance, NodeApi) as unknown;\n  }\n  nodeInjector.addPackage(pkInstance.longName, pkInstance.realPath,\n    pkInstance.path === pkInstance.realPath ? undefined : pkInstance.path);\n  nodeInjector.fromDir(pkInstance.realPath)\n    .value('__injector', nodeInjector)\n    .factory('__api', apiFactory)\n    .factory('__plink', apiFactory);\n\n  // webInjector.fromDir(pkInstance.realPath)\n  // .replaceCode('__api', '__api');\n  // .substitute(/^([^{]*)\\{locale\\}(.*)$/,\n  //   (_filePath: string, match: RegExpExecArray) => match[1] + apiPrototype.getBuildLocale() + match[2]);\n  const symlinkDir = pkInstance.path !== pkInstance.realPath ? pkInstance.path : null;\n  if (symlinkDir) {\n    nodeInjector.fromDir(symlinkDir)\n      .value('__injector', nodeInjector)\n      .factory('__plink', apiFactory);\n\n    // webInjector.fromDir(symlinkDir)\n    // .replaceCode('__api', '__api');\n  }\n}\n\nfunction getApiForPackage(pkInstance: NodePackage, NodeApi: typeof _NodeApi) {\n  if (_.has(apiCache, pkInstance.longName)) {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n    return apiCache[pkInstance.longName];\n  }\n\n  const api = new NodeApi(pkInstance.longName, pkInstance);\n  apiCache[pkInstance.longName] = api;\n  api.default = api; // For ES6 import syntax\n  return api;\n}\n"]}