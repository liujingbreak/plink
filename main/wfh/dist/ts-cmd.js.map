{"version":3,"file":"ts-cmd.js","sourceRoot":"","sources":["../ts/ts-cmd.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable max-len */\nimport Path, {resolve, join, relative, sep} from 'path';\nimport * as fs from 'fs';\nimport chalk from 'chalk';\nimport * as rx from 'rxjs';\nimport * as op from 'rxjs/operators';\nimport * as fse from 'fs-extra';\nimport _ from 'lodash';\nimport glob from 'glob';\nimport {default as _ts} from 'typescript';\nimport {DirTree} from 'require-injector/dist/dir-tree';\nimport log4js from 'log4js';\nimport {getTscConfigOfPkg, PackageTsDirs, plinkEnv} from './utils/misc';\nimport {setTsCompilerOptForNodePath, CompilerOptions as RequiredCompilerOptions, allPackages} from './package-mgr/package-list-helper';\nimport {findPackagesByNames} from './cmd/utils';\nimport {getState, workspaceKey, PackageInfo} from './package-mgr';\nimport * as packageUtils from './package-utils';\nimport {mergeBaseUrlAndPaths} from './ts-cmd-util';\nimport {webInjector} from './injector-factory';\nimport {analyseFiles} from './cmd/cli-analyze';\nimport {languageServices} from './utils/tsc-util';\nimport {exitHooks} from './utils/bootstrap-process';\nexport {RequiredCompilerOptions};\n\nconst {symlinkDirName} = plinkEnv;\nconst log = log4js.getLogger('plink.ts-cmd');\nexport interface TscCmdParam {\n  package?: string[];\n  project?: string[];\n  watch?: boolean;\n  poll?: boolean;\n  sourceMap?: string;\n  jsx?: boolean;\n  ed?: boolean;\n  /** merge compilerOptions \"baseUrl\" and \"paths\" from specified tsconfig file */\n  mergeTsconfig?: string;\n  /** JSON string, to be merged to compilerOptions \"paths\",\n   * be aware that \"paths\" should be relative to \"baseUrl\" which is relative to `PlinkEnv.workDir`\n   * */\n  pathsJsons?: Array<string> | {[path: string]: string[]};\n  /**\n   * Partial compiler options to be merged, except \"baseUrl\".\n   * \"paths\" should be relative to `plinkEnv.workDir`\n   */\n  compilerOptions?: any;\n  overridePackgeDirs?: {[pkgName: string]: PackageTsDirs};\n}\n\ninterface PackageDirInfo extends PackageTsDirs {\n  pkgDir: string;\n  symlinkDir: string;\n}\n\nexport async function tsc(argv: TscCmdParam, ts: typeof _ts = _ts ): Promise<string[]> {\n  const rootFiles: string[] = [];\n  const watchDirs: string[] = [];\n  const includePatterns: string[] = [];\n\n  const compDirInfo: Map<string, PackageDirInfo> = new Map(); // {[name: string]: {srcDir: string, destDir: string}}\n\n  const packageDirTree = new DirTree<PackageDirInfo>();\n  const workDir = plinkEnv.workDir;\n  // const commonRootDir = plinkEnv.rootDir;\n\n  let countPkg = 0;\n  let pkgInfos: PackageInfo[] | undefined;\n  if (argv.package && argv.package.length > 0)\n    pkgInfos = Array.from(findPackagesByNames(argv.package)).filter(pkg => pkg != null) as PackageInfo[];\n  else if (argv.project && argv.project.length > 0) {\n    pkgInfos = Array.from(allPackages('*', 'src', argv.project));\n  } else {\n    pkgInfos = Array.from(packageUtils.packages4Workspace(plinkEnv.workDir, false));\n  }\n  // const commonRootDir = closestCommonParentDir(pkgInfos.map(pkg => pkg.realPath));\n  await Promise.all(pkgInfos.map(pkg => onComponent(pkg.name, pkg.path, null, pkg.json, pkg.realPath)));\n  for (const info of compDirInfo.values()) {\n    const treePath = relative(workDir, info.pkgDir);\n    log.debug('treePath', treePath);\n    packageDirTree.putData(treePath, info);\n  }\n\n  if (countPkg === 0) {\n    throw new Error('No available source package found in current workspace');\n  }\n\n  // const destDir = Path.relative(process.cwd(), commonRootDir).replace(/\\\\/g, '/');\n\n  /** set compGlobs */\n  async function onComponent(name: string, _packagePath: string, _parsedName: any, json: any, realPath: string) {\n    countPkg++;\n    const tscCfg = argv.overridePackgeDirs && _.has(argv.overridePackgeDirs, name) ?\n      argv.overridePackgeDirs[name]\n      : getTscConfigOfPkg(json);\n    // For workaround https://github.com/microsoft/TypeScript/issues/37960\n    // Use a symlink path instead of a real path, so that Typescript compiler will not\n    // recognize them as from somewhere with \"node_modules\", the symlink must be reside\n    // in directory which does not contain \"node_modules\" as part of absolute path.\n    const symlinkDir = resolve(plinkEnv.workDir, symlinkDirName, name);\n    compDirInfo.set(name, {...tscCfg, pkgDir: realPath, symlinkDir});\n\n    const srcDirs = [tscCfg.srcDir, tscCfg.isomDir].filter(srcDir => {\n      if (srcDir == null)\n        return false;\n      try {\n        return fs.statSync(join(realPath, srcDir)).isDirectory();\n      } catch (e) {\n        return false;\n      }\n    });\n\n    if (srcDirs.length === 0) {\n      if (!fs.existsSync(symlinkDir)) {\n        log.error(`There is no existing directory ${chalk.red(symlinkDir)},` +\n        ` it is possible that package ${name} is yet not added to current worktree space's package.json file,` +\n        ' current worktree space is not synced yet, try \"sync\"/\"init\" command please');\n      } else {\n        log.error(`There is no existing ts source directory found for package ${chalk.red(name)}:` +\n          ` ${[tscCfg.srcDir, tscCfg.isomDir].filter(item => item != null).join(', ')}`);\n      }\n    }\n\n    if (tscCfg.files) {\n      const files = ([] as string[]).concat(tscCfg.files);\n      const aRes = await analyseFiles(files.map(file => resolve(symlinkDir, file)), argv.mergeTsconfig, []);\n      log.debug('analyzed files:', aRes);\n      if (aRes) {\n        rootFiles.push(...(aRes.files.filter(file => file.startsWith(symlinkDir + sep) && !/\\.(?:jsx?|d\\.ts)$/.test(file))\n          .map(file => file.replace(/\\\\/g, '/')))\n        );\n      }\n    }\n    if (tscCfg.include) {\n      const patterns = ([] as string[]).concat(tscCfg.include);\n      for (const pattern of patterns) {\n        const globPattern = resolve(symlinkDir, pattern).replace(/\\\\/g, '/');\n        includePatterns.push(globPattern);\n        // glob.sync(globPattern).filter(file => !file.endsWith('.d.ts')).forEach(file => rootFiles.push(file));\n      }\n    }\n    if (tscCfg.files == null && tscCfg.include == null) {\n      for (const srcDir of srcDirs) {\n        const relPath = resolve(realPath, srcDir!).replace(/\\\\/g, '/');\n        watchDirs.push(relPath);\n      }\n    }\n  }\n\n  const {action$, ofType, dispatcher} = languageServices(ts, {\n    transformSourceFile(file, content) {\n      const changed = webInjector.injectToFile(file, content);\n      if (changed !== content) {\n        log.info(Path.relative(cwd, file) + ' is patched');\n      }\n      return changed;\n    },\n    tscOpts: {\n      jsx: argv.jsx,\n      inlineSourceMap: false,\n      emitDeclarationOnly: argv.ed,\n      basePath: workDir,\n      tsBuildInfoFile: Path.resolve(workDir, 'plink.tsBuildInfo.json'),\n      changeCompilerOptions(co) {\n        setupCompilerOptionsWithPackages(co as RequiredCompilerOptions, workDir.replace(/\\\\/g, '/'), argv, ts);\n      }\n    },\n    watcher: argv.poll ?\n      {\n        usePolling: true,\n        interval: 1000,\n        binaryInterval: 2000\n      } :\n      undefined\n  });\n\n  const cwd = process.cwd();\n\n  const writtenFile$ = new rx.Subject<string>();\n  const emitFailedFile$ = new rx.Subject<string>();\n\n  function dealCommonJob() {\n    return rx.merge(\n      action$.pipe(\n        ofType('onCompilerOptions'),\n        op.take(1),\n        op.map(({payload: compilerOptions}) => {\n          log.info('typescript compilerOptions:', compilerOptions);\n        })\n      ),\n      action$.pipe(\n        ofType('emitFile'),\n        op.map(async ({payload: [file, content]}) => {\n          const destFile = realPathOf(file, workDir, packageDirTree, false);\n          if (destFile == null)\n            return;\n          writtenFile$.next(destFile);\n          log.info('emit file', Path.relative(cwd, destFile));\n          await fse.mkdirp(Path.dirname(destFile));\n          void fs.promises.writeFile(destFile, content);\n        })\n      ),\n      action$.pipe(\n        ofType('onEmitFailure'),\n        op.map(({payload: [file, msg, type]}) => {\n          emitFailedFile$.next(file);\n          log.error(`[${type}] ` + msg);\n        })\n      ),\n      action$.pipe(\n        ofType('onSuggest'),\n        op.map(({payload: [_fileName, msg]}) => {\n          log.warn(msg);\n        })\n      )\n    );\n  }\n\n  if (argv.watch) {\n    log.info('Watch mode');\n\n    rx.merge(\n      dealCommonJob()\n    ).subscribe();\n    exitHooks.push(() => dispatcher.stop());\n    dispatcher.watch([...watchDirs, ...includePatterns]);\n    // watch(rootFiles, compilerOptions, commonRootDir, packageDirTree, ts);\n    return [];\n  } else {\n    const emitted = [] as string[];\n    const failedFiles = [] as string[];\n    rx.merge(\n      dealCommonJob(),\n      writtenFile$.pipe(\n        op.map(file => emitted.push(file))\n      ),\n      emitFailedFile$.pipe(op.map(file => failedFiles.push(file)))\n    ).subscribe();\n\n    for (const dir of watchDirs) {\n      rootFiles.push(...glob.sync(dir + '/**/*.?([cm])ts'));\n      if (argv.jsx) {\n        rootFiles.push(...glob.sync(dir + '/**/*.?([cm])tsx'));\n      }\n    }\n    for (const pat of includePatterns) {\n      rootFiles.push(...pat);\n      if (argv.jsx) {\n        rootFiles.push(...pat);\n      }\n    }\n    for (const file of rootFiles) {\n      dispatcher.addSourceFile(file, true);\n    }\n    writtenFile$.complete();\n    emitFailedFile$.complete();\n    // const emitted = compile(rootFiles, compilerOptions, commonRootDir, packageDirTree, ts);\n    if (process.send)\n      process.send('plink-tsc compiled');\n    if (failedFiles.length > 0) {\n      throw new Error(`Failed to compile following files:\\n${failedFiles.join(',\\n')}`);\n    }\n    return emitted;\n  }\n}\n\nconst COMPILER_OPTIONS_MERGE_EXCLUDE = new Set(['baseUrl', 'typeRoots', 'paths', 'rootDir']);\n\nfunction setupCompilerOptionsWithPackages(compilerOptions: RequiredCompilerOptions, basePath: string, opts?: TscCmdParam, ts: typeof _ts = _ts): void {\n  let wsKey: string | null | undefined = workspaceKey(plinkEnv.workDir);\n  if (!getState().workspaces.has(wsKey))\n    wsKey = getState().currWorkspace;\n  if (wsKey == null) {\n    throw new Error(`Current directory \"${plinkEnv.workDir}\" is not a work space`);\n  }\n\n  if (opts?.mergeTsconfig) {\n    const json = mergeBaseUrlAndPaths(ts, opts.mergeTsconfig, basePath, compilerOptions);\n    for (const [key, value] of Object.entries(json.compilerOptions)) {\n      if (!COMPILER_OPTIONS_MERGE_EXCLUDE.has(key)) {\n        compilerOptions[key] = value;\n        log.debug('merge compiler options', key, value);\n      }\n    }\n  }\n\n  // appendTypeRoots([], cwd, compilerOptions, {});\n  setTsCompilerOptForNodePath(basePath, './', compilerOptions, {\n    enableTypeRoots: true,\n    workspaceDir: plinkEnv.workDir,\n    realPackagePaths: true\n  });\n\n  if (opts?.pathsJsons) {\n    if (Array.isArray(opts.pathsJsons)) {\n      compilerOptions.paths = opts.pathsJsons.reduce((pathMap, jsonStr) => {\n        Object.assign(pathMap, JSON.parse(jsonStr));\n        return pathMap;\n      }, compilerOptions.paths ?? {});\n    } else {\n      Object.assign(compilerOptions.paths!, opts.pathsJsons);\n    }\n  }\n\n  // if (compilerOptions.paths == null)\n  //   compilerOptions.paths = {};\n  // compilerOptions.paths['*'] = ['node_modules/*'];\n\n  if (opts?.compilerOptions) {\n    for (const [prop, value] of Object.entries(opts.compilerOptions)) {\n      if (prop === 'baseUrl') {\n        continue;\n      }\n      if (prop === 'paths') {\n        if (compilerOptions.paths)\n          Object.assign(compilerOptions.paths, value);\n        else\n          compilerOptions.paths = value as any;\n      } else {\n        compilerOptions[prop] = value as any;\n      }\n    }\n  }\n}\n\n/**\n * Return real path of targeting file, return null if targeting file is not in our compiliation scope\n * @param fileName \n * @param commonRootDir \n * @param packageDirTree \n */\nfunction realPathOf(fileName: string, commonRootDir: string, packageDirTree: DirTree<PackageDirInfo>, isSrcFile = false): string | null {\n  const treePath = relative(commonRootDir, fileName);\n  const _originPath = fileName; // absolute path\n  const foundPkgInfo = packageDirTree.getAllData(treePath).pop();\n  if (foundPkgInfo == null) {\n    // this file is not part of source package.\n    // log.info('Not part of entry files', fileName);\n    return null;\n  }\n  const {srcDir, destDir, pkgDir, isomDir} = foundPkgInfo;\n\n  const pathWithinPkg = relative(pkgDir, _originPath);\n\n  if (srcDir === '.' || srcDir.length === 0) {\n    fileName = join(pkgDir, isSrcFile ? srcDir : destDir, pathWithinPkg);\n  } else if (pathWithinPkg.startsWith(srcDir + sep)) {\n    fileName = join(pkgDir, isSrcFile ? srcDir : destDir, pathWithinPkg.slice(srcDir.length + 1));\n  } else if (isomDir && pathWithinPkg.startsWith(isomDir + sep)) {\n    fileName = join(pkgDir, isomDir, pathWithinPkg.slice(isomDir.length + 1));\n  }\n  return fileName;\n}\n"]}