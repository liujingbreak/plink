"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.printWorkspaceHoistedDeps = exports.printWorkspaces = void 0;
/* eslint-disable no-console, max-len */
const path_1 = __importDefault(require("path"));
const chalk_1 = __importDefault(require("chalk"));
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const lodash_1 = __importDefault(require("lodash"));
const package_mgr_1 = require("../package-mgr");
const store_1 = require("../store");
const misc_1 = require("../utils/misc");
const package_utils_1 = require("../package-utils");
const cli_ls_1 = require("./cli-ls");
require("../editor-helper");
// import { getRootDir } from '../utils/misc';
const cli_project_1 = require("./cli-project");
function default_1(opt, workspace) {
    store_1.dispatcher.changeActionOnExit('save');
    (0, package_mgr_1.getStore)().pipe((0, operators_1.distinctUntilChanged)((s1, s2) => s1.packagesUpdateChecksum === s2.packagesUpdateChecksum), (0, operators_1.skip)(1), (0, operators_1.map)(s => {
        console.log((0, cli_ls_1.listPackagesByProjects)(s));
        printWorkspaces();
    })).subscribe();
    const existingWsKeys = (0, package_mgr_1.getState)().workspaces;
    // print newly added workspace hoisted dependency information
    (0, package_mgr_1.getStore)().pipe((0, operators_1.map)(s => s.lastCreatedWorkspace), (0, operators_1.distinctUntilChanged)(), (0, operators_1.scan)((prev, curr) => {
        if (curr && !existingWsKeys.has(curr)) {
            printWorkspaceHoistedDeps((0, package_mgr_1.getState)().workspaces.get(curr));
        }
        return curr;
    })).subscribe();
    // print existing workspace CHANGED hoisted dependency information
    (0, rxjs_1.merge)(...Array.from((0, package_mgr_1.getState)().workspaces.keys()).map(wsKey => (0, package_mgr_1.getStore)().pipe((0, operators_1.map)(s => s.workspaces), (0, operators_1.distinctUntilChanged)(), (0, operators_1.map)(s => s.get(wsKey)), (0, operators_1.distinctUntilChanged)((s1, s2) => s1.hoistInfo === s2.hoistInfo && s1.hoistPeerDepInfo === s2.hoistPeerDepInfo), (0, operators_1.scan)((wsOld, wsNew) => {
        // console.log('*****************', wsKey);
        printWorkspaceHoistedDeps(wsNew);
        return wsNew;
    })))).subscribe();
    if (workspace) {
        package_mgr_1.actionDispatcher.updateWorkspace({ dir: workspace, isForce: opt.force, useYarn: opt.useYarn,
            cache: opt.cache, useNpmCi: opt.useCi });
    }
    else {
        package_mgr_1.actionDispatcher.initRootDir({ isForce: opt.force,
            useYarn: opt.useYarn, cache: opt.cache, useNpmCi: opt.useCi });
        setImmediate(() => (0, cli_project_1.listProject)());
    }
    // setImmediate(() => printWorkspaces());
}
exports.default = default_1;
function printWorkspaces() {
    const table = (0, misc_1.createCliTable)({
        horizontalLines: false,
        colAligns: ['right', 'right']
    });
    const sep = ['--------------', '------------------', '------------', '----------', '-----'].map(item => chalk_1.default.gray(item));
    table.push([{ colSpan: 5, content: chalk_1.default.underline('Worktree Space and linked dependencies\n'), hAlign: 'center' }], ['WORKTREE SPACE', 'DEPENDENCY PACKAGE', 'EXPECTED VERSION', 'ACTUAL VERSION', 'SRC DIR'].map(item => chalk_1.default.gray(item)), sep);
    let wsIdx = 0;
    const srcPkgs = (0, package_mgr_1.getState)().srcPackages;
    for (const reldir of (0, package_mgr_1.getState)().workspaces.keys()) {
        if (wsIdx > 0) {
            table.push(sep);
        }
        let i = 0;
        const pkJson = (0, package_mgr_1.getState)().workspaces.get(reldir).originInstallJson;
        // console.log(pkJson);
        let workspaceLabel = reldir ? `  ${reldir}` : '  (root directory)';
        if ((0, package_mgr_1.getState)().currWorkspace === reldir) {
            workspaceLabel = chalk_1.default.inverse(workspaceLabel);
        }
        else {
            workspaceLabel = chalk_1.default.gray(workspaceLabel);
        }
        for (const { name: dep, json: { version: ver }, isInstalled } of (0, package_utils_1.packages4WorkspaceKey)(reldir)) {
            const expectedVer = convertVersion(pkJson, dep);
            const same = expectedVer === ver;
            table.push([
                i === 0 ? workspaceLabel : '',
                same || !isInstalled ? dep : `${chalk_1.default.red('*')} ${dep}`,
                same ? expectedVer : chalk_1.default.yellow(expectedVer),
                ver,
                isInstalled ? chalk_1.default.gray('(installed)') : path_1.default.relative(misc_1.plinkEnv.rootDir, srcPkgs.get(dep).realPath)
            ]);
            i++;
        }
        if (i === 0) {
            table.push([workspaceLabel]);
        }
        wsIdx++;
    }
    console.log(table.toString());
}
exports.printWorkspaces = printWorkspaces;
function convertVersion(pkgJson, depName) {
    let ver = pkgJson.dependencies ? pkgJson.dependencies[depName] : null;
    if (ver == null && pkgJson.devDependencies) {
        ver = pkgJson.devDependencies[depName];
    }
    if (ver == null) {
        return '';
    }
    if (ver.startsWith('.') || ver.startsWith('file:')) {
        const m = /\-(\d+(?:\.\d+){1,2}(?:-[^-]+)?)\.tgz$/.exec(ver);
        if (m) {
            return m[1];
        }
    }
    return ver;
}
function printWorkspaceHoistedDeps(workspace) {
    console.log(chalk_1.default.bold(`\nHoisted Transitive Dependency & Dependents (${workspace.id || '<root directory>'})`));
    const table = createTable();
    table.push(['DEPENDENCY', 'DEPENDENT'].map(item => chalk_1.default.gray(item)), ['---', '---'].map(item => chalk_1.default.gray(item)));
    for (const [dep, dependents] of workspace.hoistInfo.entries()) {
        table.push(renderHoistDepInfo(dep, dependents));
    }
    console.log(table.toString());
    if (workspace.hoistDevInfo.size > 0) {
        const table = createTable();
        table.push(['DEPENDENCY', 'DEPENDENT'].map(item => chalk_1.default.gray(item)), ['---', '---'].map(item => chalk_1.default.gray(item)));
        console.log(chalk_1.default.bold(`\nHoisted Transitive (dev) Dependency & Dependents (${workspace.id || '<root directory>'})`));
        for (const [dep, dependents] of workspace.hoistDevInfo.entries()) {
            table.push(renderHoistDepInfo(dep, dependents));
        }
        console.log(table.toString());
    }
    if (workspace.hoistPeerDepInfo.size > 0) {
        console.log(chalk_1.default.bold(`Hoisted Transitive Peer Dependencies (${workspace.id || '<root directory>'})`));
        const table = createTable();
        table.push(['DEPENDENCY', 'DEPENDENT'].map(item => chalk_1.default.gray(item)), ['---', '---'].map(item => chalk_1.default.gray(item)));
        for (const [dep, dependents] of workspace.hoistPeerDepInfo.entries()) {
            table.push(renderHoistPeerDepInfo(dep, dependents));
        }
        console.log(table.toString());
    }
    if (workspace.hoistDevPeerDepInfo.size > 0) {
        console.log(chalk_1.default.yellowBright(`\nHoisted Transitive Peer Dependencies (dev) (${workspace.id || '<root directory>'})`));
        const table = createTable();
        table.push(['DEPENDENCY', 'DEPENDENT'].map(item => chalk_1.default.gray(item)), ['---', '---'].map(item => chalk_1.default.gray(item)));
        for (const [dep, dependents] of workspace.hoistDevPeerDepInfo.entries()) {
            table.push(renderHoistPeerDepInfo(dep, dependents));
        }
        console.log(table.toString());
    }
    printColorExplaination(workspace);
}
exports.printWorkspaceHoistedDeps = printWorkspaceHoistedDeps;
function createTable() {
    const table = (0, misc_1.createCliTable)({
        horizontalLines: false,
        // style: {head: []},
        colAligns: ['right', 'left']
    });
    return table;
}
function renderHoistDepInfo(dep, dependents) {
    return [
        dependents.sameVer ? dep : dependents.direct ? chalk_1.default.yellow(dep) : chalk_1.default.bgRed(dep),
        dependents.by.map((item, idx) => `${dependents.direct && idx === 0 ? chalk_1.default.green(item.ver) : idx > 0 ? chalk_1.default.gray(item.ver) : chalk_1.default.cyan(item.ver)}: ${chalk_1.default.grey(item.name)}`).join('\n')
    ];
}
function renderHoistPeerDepInfo(dep, dependents) {
    return [
        dependents.missing ? chalk_1.default.bgYellow(dep) : (dependents.duplicatePeer ? dep : chalk_1.default.green(dep)),
        dependents.by.map((item, idx) => `${dependents.direct && idx === 0 ? chalk_1.default.green(item.ver) : idx > 0 ? item.ver : chalk_1.default.cyan(item.ver)}: ${chalk_1.default.grey(item.name)}`).join('\n')
    ];
}
function printColorExplaination(workspace) {
    const summary = workspace.hoistInfoSummary;
    if (summary == null)
        return;
    if (summary.conflictDeps.length > 0) {
        console.log(`Above listed transitive dependencies: "${chalk_1.default.red(summary.conflictDeps.join(', '))}" have ` +
            'conflict dependency version, resolve them by choosing a version and add them to worktree space.\n');
    }
    if (lodash_1.default.size(summary.missingDeps) > 0) {
        console.log(`Above listed transitive peer dependencies in ${chalk_1.default.bgYellow('yellow')} should be added to worktree space as "dependencies":\n` +
            chalk_1.default.yellow(JSON.stringify(summary.missingDeps, null, '  ').replace(/^([^])/mg, (m, p1) => '  ' + p1) + '\n'));
    }
    if (lodash_1.default.size(summary.missingDevDeps) > 0) {
        console.log('Above listed transitive peer dependencies might should be added to worktree space as "devDependencies":\n' +
            chalk_1.default.yellow(JSON.stringify(summary.missingDevDeps, null, '  ').replace(/^([^])/mg, (m, p1) => '  ' + p1)) + '\n');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLWluaXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90cy9jbWQvY2xpLWluaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsd0NBQXdDO0FBQ3hDLGdEQUF3QjtBQUN4QixrREFBMEI7QUFDMUIsK0JBQTJCO0FBQzNCLDhDQUF1RTtBQUN2RSxvREFBdUI7QUFDdkIsZ0RBQWdHO0FBQ2hHLG9DQUE4RDtBQUM5RCx3Q0FBdUQ7QUFDdkQsb0RBQXlEO0FBQ3pELHFDQUFnRDtBQUNoRCw0QkFBMEI7QUFDMUIsOENBQThDO0FBQzlDLCtDQUE0QztBQUc1QyxtQkFBd0IsR0FBa0QsRUFBRSxTQUFrQjtJQUM1RixrQkFBc0IsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsRCxJQUFBLHNCQUFRLEdBQUUsQ0FBQyxJQUFJLENBQ2IsSUFBQSxnQ0FBb0IsRUFBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxzQkFBc0IsS0FBSyxFQUFFLENBQUMsc0JBQXNCLENBQUMsRUFDekYsSUFBQSxnQkFBSSxFQUFDLENBQUMsQ0FBQyxFQUNQLElBQUEsZUFBRyxFQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFBLCtCQUFzQixFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsZUFBZSxFQUFFLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUVkLE1BQU0sY0FBYyxHQUFHLElBQUEsc0JBQVEsR0FBRSxDQUFDLFVBQVUsQ0FBQztJQUU3Qyw2REFBNkQ7SUFDN0QsSUFBQSxzQkFBUSxHQUFFLENBQUMsSUFBSSxDQUFDLElBQUEsZUFBRyxFQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEVBQzlDLElBQUEsZ0NBQW9CLEdBQUUsRUFDdEIsSUFBQSxnQkFBSSxFQUFD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bkMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsZUFBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTO1lBQ3ZHLG1HQUFtRyxDQUFDLENBQUM7S0FDeEc7SUFDRCxJQUFJLGdCQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnREFBZ0QsZUFBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMseURBQXlEO1lBQzNJLGVBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7S0FDbkg7SUFDRCxJQUFJLGdCQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQywyR0FBMkc7WUFDckgsZUFBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztLQUN0SDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlLCBtYXgtbGVuICovXG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQge21lcmdlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHNraXAsIHNjYW4gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgYWN0aW9uRGlzcGF0Y2hlciBhcyBhY3Rpb25zLCBnZXRTdGF0ZSwgZ2V0U3RvcmUsIFdvcmtzcGFjZVN0YXRlfSBmcm9tICcuLi9wYWNrYWdlLW1ncic7XG5pbXBvcnQge2Rpc3BhdGNoZXIgYXMgc3RvcmVTZXR0aW5nRGlzcGF0Y2hlcn0gZnJvbSAnLi4vc3RvcmUnO1xuaW1wb3J0IHtjcmVhdGVDbGlUYWJsZSwgcGxpbmtFbnZ9IGZyb20gJy4uL3V0aWxzL21pc2MnO1xuaW1wb3J0IHsgcGFja2FnZXM0V29ya3NwYWNlS2V5IH0gZnJvbSAnLi4vcGFja2FnZS11dGlscyc7XG5pbXBvcnQge2xpc3RQYWNrYWdlc0J5UHJvamVjdHN9IGZyb20gJy4vY2xpLWxzJztcbmltcG9ydCAnLi4vZWRpdG9yLWhlbHBlcic7XG4vLyBpbXBvcnQgeyBnZXRSb290RGlyIH0gZnJvbSAnLi4vdXRpbHMvbWlzYyc7XG5pbXBvcnQgeyBsaXN0UHJvamVjdCB9IGZyb20gJy4vY2xpLXByb2plY3QnO1xuaW1wb3J0ICogYXMgb3B0aW9ucyBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24ob3B0OiBvcHRpb25zLkluaXRDbWRPcHRpb25zICYgb3B0aW9ucy5OcG1DbGlPcHRpb24sIHdvcmtzcGFjZT86IHN0cmluZykge1xuICBzdG9yZVNldHRpbmdEaXNwYXRjaGVyLmNoYW5nZUFjdGlvbk9uRXhpdCgnc2F2ZScpO1xuICBnZXRTdG9yZSgpLnBpcGUoXG4gICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKHMxLCBzMikgPT4gczEucGFja2FnZXNVcGRhdGVDaGVja3N1bSA9PT0gczIucGFja2FnZXNVcGRhdGVDaGVja3N1bSksXG4gICAgc2tpcCgxKSxcbiAgICBtYXAocyA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhsaXN0UGFja2FnZXNCeVByb2plY3RzKHMpKTtcbiAgICAgIHByaW50V29ya3NwYWNlcygpO1xuICAgIH0pXG4gICkuc3Vic2NyaWJlKCk7XG5cbiAgY29uc3QgZXhpc3RpbmdXc0tleXMgPSBnZXRTdGF0ZSgpLndvcmtzcGFjZXM7XG5cbiAgLy8gcHJpbnQgbmV3bHkgYWRkZWQgd29ya3NwYWNlIGhvaXN0ZWQgZGVwZW5kZW5jeSBpbmZvcm1hdGlvblxuICBnZXRTdG9yZSgpLnBpcGUobWFwKHMgPT4gcy5sYXN0Q3JlYXRlZFdvcmtzcGFjZSksXG4gICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICBzY2FuKChwcmV2LCBjdXJyKSA9PiB7XG4gICAgICBpZiAoY3VyciAmJiAhZXhpc3RpbmdXc0tleXMuaGFzKGN1cnIpKSB7XG4gICAgICAgIHByaW50V29ya3NwYWNlSG9pc3RlZERlcHMoZ2V0U3RhdGUoKS53b3Jrc3BhY2VzLmdldChjdXJyKSEpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGN1cnI7XG4gICAgfSlcbiAgKS5zdWJzY3JpYmUoKTtcblxuICAvLyBwcmludCBleGlzdGluZyB3b3Jrc3BhY2UgQ0hBTkdFRCBob2lzdGVkIGRlcGVuZGVuY3kgaW5mb3JtYXRpb25cbiAgbWVyZ2UoLi4uQXJyYXkuZnJvbShnZXRTdGF0ZSgpLndvcmtzcGFjZXMua2V5cygpKS5tYXAod3NLZXkgPT4gZ2V0U3RvcmUoKS5waXBlKFxuICAgIG1hcChzID0+IHMud29ya3NwYWNlcyksXG4gICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICBtYXAocyA9PiBzLmdldCh3c0tleSkpLFxuICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKChzMSwgczIpID0+IHMxIS5ob2lzdEluZm8gPT09IHMyIS5ob2lzdEluZm8gJiYgczEhLmhvaXN0UGVlckRlcEluZm8gPT09IHMyIS5ob2lzdFBlZXJEZXBJbmZvKSxcbiAgICBzY2FuKCh3c09sZCwgd3NOZXcpID0+IHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCcqKioqKioqKioqKioqKioqKicsIHdzS2V5KTtcbiAgICAgIHByaW50V29ya3NwYWNlSG9pc3RlZERlcHMod3NOZXchKTtcbiAgICAgIHJldHVybiB3c05ldztcbiAgICB9KVxuICApKSkuc3Vic2NyaWJlKCk7XG5cbiAgaWYgKHdvcmtzcGFjZSkge1xuICAgIGFjdGlvbnMudXBkYXRlV29ya3NwYWNlKHtkaXI6IHdvcmtzcGFjZSwgaXNGb3JjZTogb3B0LmZvcmNlLCB1c2VZYXJuOiBvcHQudXNlWWFybixcbiAgICAgIGNhY2hlOiBvcHQuY2FjaGUsIHVzZU5wbUNpOiBvcHQudXNlQ2l9KTtcbn0gZWxzZSB7XG4gIGFjdGlvbnMuaW5pdFJvb3REaXIoe2lzRm9yY2U6IG9wdC5mb3JjZSxcbiAgICB1c2VZYXJuOiBvcHQudXNlWWFybiwgY2FjaGU6IG9wdC5jYWNoZSwgdXNlTnBtQ2k6IG9wdC51c2VDaX0pO1xuICBzZXRJbW1lZGlhdGUoKCkgPT4gbGlzdFByb2plY3QoKSk7XG59XG4gIC8vIHNldEltbWVkaWF0ZSgoKSA9PiBwcmludFdvcmtzcGFjZXMoKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmludFdvcmtzcGFjZXMoKSB7XG4gIGNvbnN0IHRhYmxlID0gY3JlYXRlQ2xpVGFibGUoe1xuICAgIGhvcml6b250YWxMaW5lczogZmFsc2UsXG4gICAgY29sQWxpZ25zOiBbJ3JpZ2h0JywgJ3JpZ2h0J11cbiAgfSk7XG4gIGNvbnN0IHNlcCA9IFsnLS0tLS0tLS0tLS0tLS0nLCAnLS0tLS0tLS0tLS0tLS0tLS0tJywgJy0tLS0tLS0tLS0tLScsICctLS0tLS0tLS0tJywgJy0tLS0tJ10ubWFwKGl0ZW0gPT4gY2hhbGsuZ3JheShpdGVtKSk7XG4gIHRhYmxlLnB1c2goW3tjb2xTcGFuOiA1LCBjb250ZW50OiBjaGFsay51bmRlcmxpbmUoJ1dvcmt0cmVlIFNwYWNlIGFuZCBsaW5rZWQgZGVwZW5kZW5jaWVzXFxuJyksIGhBbGlnbjogJ2NlbnRlcid9XSxcbiAgICBbJ1dPUktUUkVFIFNQQUNFJywgJ0RFUEVOREVOQ1kgUEFDS0FHRScsICdFWFBFQ1RFRCBWRVJTSU9OJywgJ0FDVFVBTCBWRVJTSU9OJywgJ1NSQyBESVInXS5tYXAoaXRlbSA9PiBjaGFsay5ncmF5KGl0ZW0pKSxcbiAgICBzZXApO1xuXG4gIGxldCB3c0lkeCA9IDA7XG4gIGNvbnN0IHNyY1BrZ3MgPSBnZXRTdGF0ZSgpLnNyY1BhY2thZ2VzO1xuICBmb3IgKGNvbnN0IHJlbGRpciBvZiBnZXRTdGF0ZSgpLndvcmtzcGFjZXMua2V5cygpKSB7XG4gICAgaWYgKHdzSWR4ID4gMCkge1xuICAgICAgdGFibGUucHVzaChzZXApO1xuICAgIH1cblxuICAgIGxldCBpID0gMDtcbiAgICBjb25zdCBwa0pzb24gPSBnZXRTdGF0ZSgpLndvcmtzcGFjZXMuZ2V0KHJlbGRpcikhLm9yaWdpbkluc3RhbGxKc29uO1xuICAgIC8vIGNvbnNvbGUubG9nKHBrSnNvbik7XG4gICAgbGV0IHdvcmtzcGFjZUxhYmVsID0gcmVsZGlyID8gYCAgJHtyZWxkaXJ9YCA6ICcgIChyb290IGRpcmVjdG9yeSknO1xuICAgIGlmIChnZXRTdGF0ZSgpLmN1cnJXb3Jrc3BhY2UgPT09IHJlbGRpcikge1xuICAgICAgd29ya3NwYWNlTGFiZWwgPSBjaGFsay5pbnZlcnNlKHdvcmtzcGFjZUxhYmVsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgd29ya3NwYWNlTGFiZWwgPSBjaGFsay5ncmF5KHdvcmtzcGFjZUxhYmVsKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHtuYW1lOiBkZXAsIGpzb246IHt2ZXJzaW9uOiB2ZXJ9LCBpc0luc3RhbGxlZH0gb2YgcGFja2FnZXM0V29ya3NwYWNlS2V5KHJlbGRpcikpIHtcbiAgICAgIGNvbnN0IGV4cGVjdGVkVmVyID0gY29udmVydFZlcnNpb24ocGtKc29uLCBkZXApO1xuICAgICAgY29uc3Qgc2FtZSA9IGV4cGVjdGVkVmVyID09PSB2ZXI7XG4gICAgICB0YWJsZS5wdXNoKFtcbiAgICAgICAgaSA9PT0gMCA/IHdvcmtzcGFjZUxhYmVsIDogJycsXG4gICAgICAgIHNhbWUgfHwgIWlzSW5zdGFsbGVkID8gZGVwIDogYCR7Y2hhbGsucmVkKCcqJyl9ICR7ZGVwfWAsXG4gICAgICAgIHNhbWUgPyBleHBlY3RlZFZlciA6IGNoYWxrLnllbGxvdyhleHBlY3RlZFZlciksXG4gICAgICAgIHZlcixcbiAgICAgICAgaXNJbnN0YWxsZWQgPyBjaGFsay5ncmF5KCcoaW5zdGFsbGVkKScpIDogUGF0aC5yZWxhdGl2ZShwbGlua0Vudi5yb290RGlyLCBzcmNQa2dzLmdldChkZXApIS5yZWFsUGF0aClcbiAgICAgIF0pO1xuICAgICAgaSsrO1xuICAgIH1cbiAgICBpZiAoaSA9PT0gMCkge1xuICAgICAgdGFibGUucHVzaChbd29ya3NwYWNlTGFiZWxdKTtcbiAgICB9XG4gICAgd3NJZHgrKztcbiAgfVxuXG4gIGNvbnNvbGUubG9nKHRhYmxlLnRvU3RyaW5nKCkpO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0VmVyc2lvbihwa2dKc29uOiB7XG4gIGRlcGVuZGVuY2llcz86IHtbazogc3RyaW5nXTogc3RyaW5nfTtcbiAgZGV2RGVwZW5kZW5jaWVzPzoge1trOiBzdHJpbmddOiBzdHJpbmd9O1xufSwgZGVwTmFtZTogc3RyaW5nKSB7XG4gIGxldCB2ZXIgPSBwa2dKc29uLmRlcGVuZGVuY2llcyA/IHBrZ0pzb24uZGVwZW5kZW5jaWVzW2RlcE5hbWVdIDogbnVsbDtcbiAgaWYgKHZlciA9PSBudWxsICYmIHBrZ0pzb24uZGV2RGVwZW5kZW5jaWVzKSB7XG4gICAgdmVyID0gcGtnSnNvbi5kZXZEZXBlbmRlbmNpZXNbZGVwTmFtZV07XG4gIH1cbiAgaWYgKHZlciA9PSBudWxsKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIGlmICh2ZXIuc3RhcnRzV2l0aCgnLicpIHx8IHZlci5zdGFydHNXaXRoKCdmaWxlOicpKSB7XG4gICAgY29uc3QgbSA9IC9cXC0oXFxkKyg/OlxcLlxcZCspezEsMn0oPzotW14tXSspPylcXC50Z3okLy5leGVjKHZlcik7XG4gICAgaWYgKG0pIHtcbiAgICAgIHJldHVybiBtWzFdO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdmVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJpbnRXb3Jrc3BhY2VIb2lzdGVkRGVwcyh3b3Jrc3BhY2U6IFdvcmtzcGFjZVN0YXRlKSB7XG4gIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQoYFxcbkhvaXN0ZWQgVHJhbnNpdGl2ZSBEZXBlbmRlbmN5ICYgRGVwZW5kZW50cyAoJHt3b3Jrc3BhY2UuaWQgfHwgJzxyb290IGRpcmVjdG9yeT4nfSlgKSk7XG4gIGNvbnN0IHRhYmxlID0gY3JlYXRlVGFibGUoKTtcbiAgdGFibGUucHVzaChbJ0RFUEVOREVOQ1knLCAnREVQRU5ERU5UJ10ubWFwKGl0ZW0gPT4gY2hhbGsuZ3JheShpdGVtKSksXG4gICAgWyctLS0nLCAnLS0tJ10ubWFwKGl0ZW0gPT4gY2hhbGsuZ3JheShpdGVtKSkpO1xuICBmb3IgKGNvbnN0IFtkZXAsIGRlcGVuZGVudHNdIG9mIHdvcmtzcGFjZS5ob2lzdEluZm8uZW50cmllcygpKSB7XG4gICAgdGFibGUucHVzaChyZW5kZXJIb2lzdERlcEluZm8oZGVwLCBkZXBlbmRlbnRzKSk7XG4gIH1cbiAgY29uc29sZS5sb2codGFibGUudG9TdHJpbmcoKSk7XG4gIGlmICh3b3Jrc3BhY2UuaG9pc3REZXZJbmZvLnNpemUgPiAwKSB7XG4gICAgY29uc3QgdGFibGUgPSBjcmVhdGVUYWJsZSgpO1xuICAgIHRhYmxlLnB1c2goWydERVBFTkRFTkNZJywgJ0RFUEVOREVOVCddLm1hcChpdGVtID0+IGNoYWxrLmdyYXkoaXRlbSkpLFxuICAgIFsnLS0tJywgJy0tLSddLm1hcChpdGVtID0+IGNoYWxrLmdyYXkoaXRlbSkpKTtcbiAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKGBcXG5Ib2lzdGVkIFRyYW5zaXRpdmUgKGRldikgRGVwZW5kZW5jeSAmIERlcGVuZGVudHMgKCR7d29ya3NwYWNlLmlkIHx8ICc8cm9vdCBkaXJlY3Rvcnk+J30pYCkpO1xuICAgIGZvciAoY29uc3QgW2RlcCwgZGVwZW5kZW50c10gb2Ygd29ya3NwYWNlLmhvaXN0RGV2SW5mby5lbnRyaWVzKCkpIHtcbiAgICAgIHRhYmxlLnB1c2gocmVuZGVySG9pc3REZXBJbmZvKGRlcCwgZGVwZW5kZW50cykpO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyh0YWJsZS50b1N0cmluZygpKTtcbiAgfVxuICBpZiAod29ya3NwYWNlLmhvaXN0UGVlckRlcEluZm8uc2l6ZSA+IDApIHtcbiAgICBjb25zb2xlLmxvZyhjaGFsay5ib2xkKGBIb2lzdGVkIFRyYW5zaXRpdmUgUGVlciBEZXBlbmRlbmNpZXMgKCR7d29ya3NwYWNlLmlkIHx8ICc8cm9vdCBkaXJlY3Rvcnk+J30pYCkpO1xuICAgIGNvbnN0IHRhYmxlID0gY3JlYXRlVGFibGUoKTtcbiAgICB0YWJsZS5wdXNoKFsnREVQRU5ERU5DWScsICdERVBFTkRFTlQnXS5tYXAoaXRlbSA9PiBjaGFsay5ncmF5KGl0ZW0pKSxcbiAgICBbJy0tLScsICctLS0nXS5tYXAoaXRlbSA9PiBjaGFsay5ncmF5KGl0ZW0pKSk7XG4gICAgZm9yIChjb25zdCBbZGVwLCBkZXBlbmRlbnRzXSBvZiB3b3Jrc3BhY2UuaG9pc3RQZWVyRGVwSW5mby5lbnRyaWVzKCkpIHtcbiAgICAgIHRhYmxlLnB1c2gocmVuZGVySG9pc3RQZWVyRGVwSW5mbyhkZXAsIGRlcGVuZGVudHMpKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2codGFibGUudG9TdHJpbmcoKSk7XG4gIH1cbiAgaWYgKHdvcmtzcGFjZS5ob2lzdERldlBlZXJEZXBJbmZvLnNpemUgPiAwKSB7XG4gICAgY29uc29sZS5sb2coY2hhbGsueWVsbG93QnJpZ2h0KGBcXG5Ib2lzdGVkIFRyYW5zaXRpdmUgUGVlciBEZXBlbmRlbmNpZXMgKGRldikgKCR7d29ya3NwYWNlLmlkIHx8ICc8cm9vdCBkaXJlY3Rvcnk+J30pYCkpO1xuICAgIGNvbnN0IHRhYmxlID0gY3JlYXRlVGFibGUoKTtcbiAgICB0YWJsZS5wdXNoKFsnREVQRU5ERU5DWScsICdERVBFTkRFTlQnXS5tYXAoaXRlbSA9PiBjaGFsay5ncmF5KGl0ZW0pKSxcbiAgICBbJy0tLScsICctLS0nXS5tYXAoaXRlbSA9PiBjaGFsay5ncmF5KGl0ZW0pKSk7XG4gICAgZm9yIChjb25zdCBbZGVwLCBkZXBlbmRlbnRzXSBvZiB3b3Jrc3BhY2UuaG9pc3REZXZQZWVyRGVwSW5mby5lbnRyaWVzKCkpIHtcbiAgICAgIHRhYmxlLnB1c2gocmVuZGVySG9pc3RQZWVyRGVwSW5mbyhkZXAsIGRlcGVuZGVudHMpKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2codGFibGUudG9TdHJpbmcoKSk7XG4gIH1cbiAgcHJpbnRDb2xvckV4cGxhaW5hdGlvbih3b3Jrc3BhY2UpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVUYWJsZSgpIHtcbiAgY29uc3QgdGFibGUgPSBjcmVhdGVDbGlUYWJsZSh7XG4gICAgaG9yaXpvbnRhbExpbmVzOiBmYWxzZSxcbiAgICAvLyBzdHlsZToge2hlYWQ6IFtdfSxcbiAgICBjb2xBbGlnbnM6IFsncmlnaHQnLCAnbGVmdCddXG4gIH0pO1xuICByZXR1cm4gdGFibGU7XG59XG5cbnR5cGUgRGVwZW5kZW50SW5mbyA9IFdvcmtzcGFjZVN0YXRlWydob2lzdEluZm8nXSBleHRlbmRzIE1hcDxzdHJpbmcsIGluZmVyIFQ+ID8gVCA6IHVua25vd247XG5cbmZ1bmN0aW9uIHJlbmRlckhvaXN0RGVwSW5mbyhkZXA6IHN0cmluZywgZGVwZW5kZW50czogRGVwZW5kZW50SW5mbyk6IFtkZXA6IHN0cmluZywgdmVyOiBzdHJpbmddIHtcbiAgcmV0dXJuIFtcbiAgICBkZXBlbmRlbnRzLnNhbWVWZXIgPyBkZXAgOiBkZXBlbmRlbnRzLmRpcmVjdCA/IGNoYWxrLnllbGxvdyhkZXApIDogY2hhbGsuYmdSZWQoZGVwKSxcbiAgICBkZXBlbmRlbnRzLmJ5Lm1hcCgoaXRlbSwgaWR4KSA9PlxuICAgICAgYCR7ZGVwZW5kZW50cy5kaXJlY3QgJiYgaWR4ID09PSAwID8gY2hhbGsuZ3JlZW4oaXRlbS52ZXIpIDogaWR4ID4gMCA/IGNoYWxrLmdyYXkoaXRlbS52ZXIpIDogY2hhbGsuY3lhbihpdGVtLnZlcil9OiAke2NoYWxrLmdyZXkoaXRlbS5uYW1lKX1gXG4gICAgKS5qb2luKCdcXG4nKVxuICBdO1xufVxuZnVuY3Rpb24gcmVuZGVySG9pc3RQZWVyRGVwSW5mbyhkZXA6IHN0cmluZywgZGVwZW5kZW50czogRGVwZW5kZW50SW5mbyk6IFtkZXA6IHN0cmluZywgdmVyOiBzdHJpbmddIHtcbiAgcmV0dXJuIFtcbiAgICBkZXBlbmRlbnRzLm1pc3NpbmcgPyBjaGFsay5iZ1llbGxvdyhkZXApIDogKGRlcGVuZGVudHMuZHVwbGljYXRlUGVlciA/IGRlcCA6IGNoYWxrLmdyZWVuKGRlcCkpLFxuICAgIGRlcGVuZGVudHMuYnkubWFwKChpdGVtLCBpZHgpID0+XG4gICAgICBgJHtkZXBlbmRlbnRzLmRpcmVjdCAmJiBpZHggPT09IDAgPyBjaGFsay5ncmVlbihpdGVtLnZlcikgOiBpZHggPiAwID8gaXRlbS52ZXIgOiBjaGFsay5jeWFuKGl0ZW0udmVyKX06ICR7Y2hhbGsuZ3JleShpdGVtLm5hbWUpfWBcbiAgICApLmpvaW4oJ1xcbicpXG4gIF07XG59XG5cbmZ1bmN0aW9uIHByaW50Q29sb3JFeHBsYWluYXRpb24od29ya3NwYWNlOiBXb3Jrc3BhY2VTdGF0ZSkge1xuICBjb25zdCBzdW1tYXJ5ID0gd29ya3NwYWNlLmhvaXN0SW5mb1N1bW1hcnk7XG4gIGlmIChzdW1tYXJ5ID09IG51bGwpXG4gICAgcmV0dXJuO1xuICBpZiAoc3VtbWFyeS5jb25mbGljdERlcHMubGVuZ3RoID4gMCkge1xuICAgIGNvbnNvbGUubG9nKGBBYm92ZSBsaXN0ZWQgdHJhbnNpdGl2ZSBkZXBlbmRlbmNpZXM6IFwiJHtjaGFsay5yZWQoc3VtbWFyeS5jb25mbGljdERlcHMuam9pbignLCAnKSl9XCIgaGF2ZSBgICtcbiAgICAgICdjb25mbGljdCBkZXBlbmRlbmN5IHZlcnNpb24sIHJlc29sdmUgdGhlbSBieSBjaG9vc2luZyBhIHZlcnNpb24gYW5kIGFkZCB0aGVtIHRvIHdvcmt0cmVlIHNwYWNlLlxcbicpO1xuICB9XG4gIGlmIChfLnNpemUoc3VtbWFyeS5taXNzaW5nRGVwcykgPiAwKSB7XG4gICAgY29uc29sZS5sb2coYEFib3ZlIGxpc3RlZCB0cmFuc2l0aXZlIHBlZXIgZGVwZW5kZW5jaWVzIGluICR7Y2hhbGsuYmdZZWxsb3coJ3llbGxvdycpfSBzaG91bGQgYmUgYWRkZWQgdG8gd29ya3RyZWUgc3BhY2UgYXMgXCJkZXBlbmRlbmNpZXNcIjpcXG5gICtcbiAgICAgIGNoYWxrLnllbGxvdyhKU09OLnN0cmluZ2lmeShzdW1tYXJ5Lm1pc3NpbmdEZXBzLCBudWxsLCAnICAnKS5yZXBsYWNlKC9eKFteXSkvbWcsIChtLCBwMSkgPT4gJyAgJyArIHAxKSArICdcXG4nKSk7XG4gIH1cbiAgaWYgKF8uc2l6ZShzdW1tYXJ5Lm1pc3NpbmdEZXZEZXBzKSA+IDApIHtcbiAgICBjb25zb2xlLmxvZygnQWJvdmUgbGlzdGVkIHRyYW5zaXRpdmUgcGVlciBkZXBlbmRlbmNpZXMgbWlnaHQgc2hvdWxkIGJlIGFkZGVkIHRvIHdvcmt0cmVlIHNwYWNlIGFzIFwiZGV2RGVwZW5kZW5jaWVzXCI6XFxuJyArXG4gICAgICBjaGFsay55ZWxsb3coSlNPTi5zdHJpbmdpZnkoc3VtbWFyeS5taXNzaW5nRGV2RGVwcywgbnVsbCwgJyAgJykucmVwbGFjZSgvXihbXl0pL21nLCAobSwgcDEpID0+ICcgICcgKyBwMSkpICsgJ1xcbicpO1xuICB9XG59XG4iXX0=