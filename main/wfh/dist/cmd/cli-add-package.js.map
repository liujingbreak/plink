{"version":3,"file":"cli-add-package.js","sourceRoot":"","sources":["../../ts/cmd/cli-add-package.ts"],"names":[],"mappings":"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","sourcesContent":["import parse, {ObjectAst} from '../utils/json-sync-parser';\nimport {findPackagesByNames} from './utils';\nimport replaceText, {ReplacementInf} from '../utils/patch-text';\nimport {exe} from '../process-utils';\nimport fs from 'fs';\nimport Path from 'path';\nimport {getLogger} from 'log4js';\nimport _ from 'lodash';\nimport chalk from 'chalk';\nimport stripAnsi from 'strip-ansi';\nimport {plinkEnv} from '../utils/misc';\nimport {workspacesOfDependencies} from '../package-mgr/package-list-helper';\nimport {actionDispatcher as pkgDispater, isCwdWorkspace, getState, workspaceDir, workspaceKey} from '../package-mgr/index';\nimport '../editor-helper';\nimport {dispatcher as storeSettingDispatcher} from '../store';\n\nconst log = getLogger('plink.cli-add-package');\n\nexport async function addDependencyTo(packages: string[], to?: string, dev = false) {\n  if (packages.length === 0) {\n    throw new Error('At least specify one dependency argument');\n  }\n  storeSettingDispatcher.changeActionOnExit('save');\n  let wsDirs: string[] = [];\n  if (to == null) {\n    if (isCwdWorkspace()) {\n      to = plinkEnv.workDir;\n    } else {\n      const ws = getState().currWorkspace;\n      if (ws == null) {\n        throw new Error('No worktree space is found for current directory, and no \"--to\" option is specified.\\n' +\n          'Either execute this command with option \"--to <pkg name | pkg dir | worktree space>\"' +\n          'or in a workstree space directory.');\n      }\n      to = workspaceDir(ws);\n    }\n    wsDirs.push(to);\n  } else {\n    const tryWsKey = workspaceKey(to);\n    if (getState().workspaces.has(tryWsKey)) {\n      wsDirs.push(Path.resolve(to));\n    } else {\n      const [foundPkg] = findPackagesByNames([to]);\n      if (foundPkg == null) {\n        throw new Error('No matched linked package or worktree space is found for option \"--to\"');\n      }\n      to = foundPkg.realPath;\n      const rootDir = plinkEnv.rootDir;\n      wsDirs = Array.from(workspacesOfDependencies(foundPkg.name))\n        .map(ws => Path.resolve(rootDir, ws));\n    }\n  }\n  await add(packages, to, dev);\n  setImmediate(() => {\n    for (const wsDir of wsDirs) {\n      pkgDispater.updateWorkspace({dir: wsDir, isForce: false});\n    }\n  });\n}\n\nasync function add(packages: string[], toDir: string, dev = false) {\n  const targetJsonFile = Path.resolve(toDir, 'package.json');\n  const pkgJsonStr = fs.readFileSync(targetJsonFile, 'utf-8');\n  const objAst = parse(pkgJsonStr);\n  const patches: ReplacementInf[] = [];\n\n  const depsAst = dev ? objAst.properties.find(prop => prop.name.text === '\"devDependencies\"') :\n    objAst.properties.find(prop => prop.name.text === '\"dependencies\"');\n\n  const depsSet = depsAst == null ?\n    new Set<string>() :\n    new Set<string>((depsAst.value as ObjectAst).properties.map(prop => prop.name.text.slice(1, -1)));\n\n  log.debug('existing:', depsSet);\n  const input = packages.map(rawName => {\n    const m = /^((?:@[^/]+\\/)?[^/@]+)(?:@([^]+))?$/.exec(rawName);\n    if (m) {\n      return [m[1], m[2]] as [name: string, ver: string | undefined];\n    } else {\n      throw new Error(`Invalid package name: ${rawName}, valid name should be like \"<pkg name>[@<version>]\"`);\n    }\n  });\n  let i = 0;\n  let newLines = '';\n  const srcPkgs = Array.from(findPackagesByNames(input.map(item => item[0])));\n\n  await Promise.all(srcPkgs.map(async pkg => {\n    const inputItem = input[i++];\n    let version = inputItem[1];\n\n    if (pkg == null || (pkg.json.dr == null && pkg.json.plink == null)) {\n      const name = inputItem[0];\n      if (depsSet.has(name)) {\n        log.warn(`Found duplicate existing dependency ${chalk.red(name)}`);\n        return;\n      }\n      if (version == null) {\n        version = await fetchRemoteVersion(name);\n      }\n      log.info(`Package ${name}@${version} is not a linked package, add as 3rd party dependency`);\n      newLines += `    \"${name}\": \"${version}\",\\n`;\n    } else {\n      if (depsSet.has(pkg.name)) {\n        log.warn(`Duplicate with existing dependency ${chalk.red(pkg.name)}`);\n        return;\n      }\n      log.info(`Add package ${chalk.cyan(pkg.name)} ${version || ''}`);\n      newLines += `    \"${pkg.name}\": \"${version || pkg.json.version }\",\\n`;\n    }\n  }));\n  if (newLines.length > 0)\n    newLines = newLines.slice(0, newLines.length - 2); // trim last comma\n  else\n    return;\n  log.debug(newLines);\n\n  if (depsAst == null) {\n    const last = objAst.properties[objAst.properties.length - 1];\n    const pos = last.value.end;\n    patches.push({start: pos, end: pos,\n      text: `,\\n  \"${dev ? 'devDependencies' : 'dependencies'}\": {\\n${newLines}\\n  }`});\n  } else {\n    const props = (depsAst.value as ObjectAst).properties;\n    let start = 0;\n    if (props.length > 0) {\n      start = props[props.length - 1].value.end;\n      newLines = ',\\n' + newLines;\n    } else {\n      start = depsAst.value.end - 1;\n    }\n\n    patches.push({start, end: start, text: newLines});\n  }\n\n  const newJsonText = replaceText(pkgJsonStr, patches);\n  log.info(`Write file: ${targetJsonFile}:\\n` + newJsonText);\n  fs.writeFileSync(targetJsonFile, newJsonText);\n}\n\nasync function fetchRemoteVersion(pkgName: string) {\n  const text = stripAnsi(await exe('npm', 'view', pkgName, {silent: true}).promise);\n  const rPattern = _.escapeRegExp(pkgName) + '@(\\\\S*)\\\\s';\n  const pattern = new RegExp(rPattern);\n  const m = pattern.exec(text);\n  if (m) {\n    return m[1];\n  }\n  throw new Error(`Failed to fetch dependency latest version (pattern: ${rPattern}) from message:\\n ${text}`);\n}\n"]}