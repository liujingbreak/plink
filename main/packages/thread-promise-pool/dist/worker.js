"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable no-console
const worker_threads_1 = require("worker_threads");
let verbose = false;
let initialDone = Promise.resolve();
if (worker_threads_1.workerData) {
    verbose = !!worker_threads_1.workerData.verbose;
    if (worker_threads_1.workerData.initializer) {
        const { file, exportFn } = worker_threads_1.workerData.initializer;
        if (exportFn == null)
            initialDone = Promise.resolve(require(file));
        else
            initialDone = Promise.resolve(require(file)[exportFn]());
    }
    else {
        initialDone = Promise.resolve();
    }
}
if (!worker_threads_1.isMainThread) {
    // eslint-disable-next-line @typescript-eslint/no-misused-promises
    worker_threads_1.parentPort.on('message', executeOnEvent);
}
async function executeOnEvent(data) {
    if (data.exit) {
        if (verbose) {
            // eslint-disable-next-line no-console
            console.log(`[thread-pool] worker ${worker_threads_1.workerData === null || worker_threads_1.workerData === void 0 ? void 0 : worker_threads_1.workerData.id} exit`);
        }
        worker_threads_1.parentPort.off('message', executeOnEvent);
        // Don't call process.exit(0), there might be some unfinished output stream still on-going at this moment.
        return;
    }
    await initialDone;
    if (verbose) {
        // eslint-disable-next-line no-console
        console.log(`[thread-pool] worker ${worker_threads_1.workerData === null || worker_threads_1.workerData === void 0 ? void 0 : worker_threads_1.workerData.id} run`);
    }
    try {
        const result = await Promise.resolve(require(data.file)[data.exportFn](...(data.args || [])));
        if (verbose) {
            // eslint-disable-next-line no-console
            console.log(`[thread-pool] worker ${worker_threads_1.workerData === null || worker_threads_1.workerData === void 0 ? void 0 : worker_threads_1.workerData.id} wait`);
        }
        if (result != null && result.transferList) {
            const transferList = result.transferList;
            delete result.transferList;
            worker_threads_1.parentPort.postMessage({ type: 'wait', data: result }, transferList);
        }
        else {
            worker_threads_1.parentPort.postMessage({ type: 'wait', data: result });
        }
    }
    catch (ex) {
        // console.log(`[thread-pool] worker ${workerData?.id} error`, ex);
        // debugger;
        try {
            worker_threads_1.parentPort.postMessage({
                type: 'error',
                data: ex.stack
            });
        }
        catch (err) {
            worker_threads_1.parentPort.postMessage({
                type: 'error',
                data: err.stack
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHMvd29ya2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNEJBQTRCO0FBQzVCLG1EQUFtRjtBQUVuRixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDcEIsSUFBSSxXQUFXLEdBQWlCLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQXlEbEQsSUFBSSwyQkFBVSxFQUFFO0lBQ2QsT0FBTyxHQUFHLENBQUMsQ0FBRSwyQkFBNkIsQ0FBQyxPQUFPLENBQUM7SUFDbkQsSUFBSywyQkFBNkIsQ0FBQyxXQUFXLEVBQUU7UUFDOUMsTUFBTSxFQUFDLElBQUksRUFBRSxRQUFRLEVBQUMsR0FBSSwyQkFBNkIsQ0FBQyxXQUFZLENBQUM7UUFDckUsSUFBSSxRQUFRLElBQUksSUFBSTtZQUNsQixXQUFXLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzs7WUFFN0MsV0FBVyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUM1RDtTQUFNO1FBQ0wsV0FBVyxHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUNqQztDQUNGO0FBRUQsSUFBSSxDQUFDLDZCQUFZLEVBQUU7SUFDakIsa0VBQWtFO0lBQ2xFLDJCQUFXLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztDQUMzQztBQUVELEtBQUssVUFBVSxjQUFjLENBQUMsSUFBb0I7SUFDaEQsSUFBSyxJQUFnQixDQUFDLElBQUksRUFBRTtRQUMxQixJQUFJLE9BQU8sRUFBRTtZQUNYLHNDQUFzQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QiwyQkFBVSxhQUFWLDJCQUFVLHVCQUFWLDJCQUFVLENBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM1RDtRQUNELDJCQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUMzQywwR0FBMEc7UUFDMUcsT0FBTztLQUNSO0lBQ0QsTUFBTSxXQUFXLENBQUM7SUFDbEIsSUFBSSxPQUFPLEVBQUU7UUFDWCxzQ0FBc0M7UUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsMkJBQVUsYUFBViwyQkFBVSx1QkFBViwyQkFBVSxDQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDM0Q7SUFDRCxJQUFJO1FBQ0YsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBRSxJQUFhLENBQUMsSUFBSSxDQUFDLENBQUUsSUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUN4RixHQUFHLENBQUUsSUFBYSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FDN0IsQ0FBQyxDQUFDO1FBRUwsSUFBSSxPQUFPLEVBQUU7WUFDWCxzQ0FBc0M7WUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsMkJBQVUsYUFBViwyQkFBVSx1QkFBViwyQkFBVSxDQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDNUQ7UUFDRCxJQUFJLE1BQU0sSUFBSSxJQUFJLElBQUssTUFBcUIsQ0FBQyxZQUFZLEVBQUU7WUFDekQsTUFBTSxZQUFZLEdBQUksTUFBcUIsQ0FBQyxZQUFZLENBQUM7WUFDekQsT0FBTyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQzNCLDJCQUFXLENBQUMsV0FBVyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDdEU7YUFBTTtZQUNMLDJCQUFXLENBQUMsV0FBVyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztTQUN4RDtLQUVGO0lBQUMsT0FBTyxFQUFFLEVBQUU7UUFDWCxtRUFBbUU7UUFDbkUsWUFBWTtRQUNaLElBQUk7WUFDRiwyQkFBVyxDQUFDLFdBQVcsQ0FBQztnQkFDdEIsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsSUFBSSxFQUFFLEVBQUUsQ0FBQyxLQUFLO2FBQ2YsQ0FBQyxDQUFDO1NBQ0o7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLDJCQUFXLENBQUMsV0FBVyxDQUFDO2dCQUN0QixJQUFJLEVBQUUsT0FBTztnQkFDYixJQUFJLEVBQUUsR0FBRyxDQUFDLEtBQUs7YUFDaEIsQ0FBQyxDQUFDO1NBQ0o7S0FDRjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZSBuby1jb25zb2xlXG5pbXBvcnQge2lzTWFpblRocmVhZCwgcGFyZW50UG9ydCwgd29ya2VyRGF0YSwgV29ya2VyT3B0aW9uc30gZnJvbSAnd29ya2VyX3RocmVhZHMnO1xuXG5sZXQgdmVyYm9zZSA9IGZhbHNlO1xubGV0IGluaXRpYWxEb25lOiBQcm9taXNlPGFueT4gPSBQcm9taXNlLnJlc29sdmUoKTtcbi8vIHJlcXVpcmUoJ2luc3BlY3RvcicpLm9wZW4oOTIyMiwgJ2xvY2FsaG9zdCcsIHRydWUpO1xuXG4vLyBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIGZ1bmN0aW9uKGVycikge1xuLy8gICAvLyBsb2cuZXJyb3IoJ1VuY2F1Z2h0IGV4Y2VwdGlvbicsIGVyciwgZXJyLnN0YWNrKTtcbi8vICAgY29uc29sZS5lcnJvcihgW3RocmVhZC1wb29sXSB3b3JrZXIgcGlkOiR7d29ya2VyRGF0YS5pZH0gVW5jYXVnaHQgZXhjZXB0aW9uOiBgLCBlcnIpO1xuLy8gICBwYXJlbnRQb3J0IS5wb3N0TWVzc2FnZSh7XG4vLyAgICAgdHlwZTogJ2Vycm9yJyxcbi8vICAgICBkYXRhOiBlcnIudG9TdHJpbmcoKVxuLy8gICB9KTtcbi8vIH0pO1xuXG4vLyBwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCBlcnIgPT4ge1xuLy8gICAvLyBsb2cud2FybigndW5oYW5kbGVkUmVqZWN0aW9uJywgZXJyKTtcbi8vICAgY29uc29sZS5lcnJvcihgW3RocmVhZC1wb29sXSB3b3JrZXIgcGlkOiR7d29ya2VyRGF0YS5pZH0gdW5oYW5kbGVkUmVqZWN0aW9uYCwgZXJyKTtcbi8vICAgcGFyZW50UG9ydCEucG9zdE1lc3NhZ2Uoe1xuLy8gICAgIHR5cGU6ICdlcnJvcicsXG4vLyAgICAgZGF0YTogZXJyID8gZXJyLnRvU3RyaW5nKCkgOiBlcnJcbi8vICAgfSk7XG4vLyB9KTtcblxuZXhwb3J0IGludGVyZmFjZSBJbml0aWFsT3B0aW9ucyB7XG4gIHZlcmJvc2U/OiBib29sZWFuO1xuICAvKiogQWZ0ZXIgd29ya2VyIGJlaW5nIGNyZWF0ZWQsIHRoZSBleHBvcnRlZCBmdW5jdGlvbiB3aWxsIGJlIHJ1bixcbiAgICogWW91IGNhbiBwdXQgYW55IGluaXRpYWwgbG9naWMgaW4gaXQsIGxpa2UgY2FsbGluZyBgcmVxdWlyZSgnc291cmNlLW1hcC1zdXBwb3J0L3JlZ2lzdGVyJylgIG9yXG4gICAqIHNldHVwIHByb2Nlc3MgZXZlbnQgaGFuZGxpbmcgZm9yIHVuY2F1Z2h0RXhjZXB0aW9uIGFuZCB1bmhhbmRsZWRSZWplY3Rpb24uXG4gICAqL1xuICBpbml0aWFsaXplcj86IHtmaWxlOiBzdHJpbmc7IGV4cG9ydEZuPzogc3RyaW5nfTtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgVGFzayB7XG4gIGZpbGU6IHN0cmluZztcbiAgLyoqXG4gICAqIEEgZnVuY3Rpb24gd2hpY2ggY2FuIHJldHVybiBQcm9taXNlIG9yIG5vbi1Qcm9taXNlIHZhbHVlXG4gICAqL1xuICBleHBvcnRGbjogc3RyaW5nO1xuICBhcmdzPzogYW55W107XG4gIC8qKiBXb3JrZXIgbWVzc2FnZSB0cmFuc2Zlckxpc3QsIHNlZVxuICAgKiBodHRwczovL25vZGVqcy5vcmcvZG9jcy9sYXRlc3QtdjEyLngvYXBpL3dvcmtlcl90aHJlYWRzLmh0bWwjd29ya2VyX3RocmVhZHNfcG9ydF9wb3N0bWVzc2FnZV92YWx1ZV90cmFuc2Zlcmxpc3RcbiAgICogbWF5IGJlIGEgbGlzdCBvZiBBcnJheUJ1ZmZlciwgTWVzc2FnZVBvcnQgYW5kIEZpbGVIYW5kbGUgb2JqZWN0cy4gQWZ0ZXIgdHJhbnNmZXJyaW5nLCBcbiAgICogdGhleSB3aWxsIG5vdCBiZSB1c2FibGUgb24gdGhlIHNlbmRpbmcgc2lkZSBvZiB0aGUgY2hhbm5lbCBhbnltb3JlIChldmVuIGlmIHRoZXkgYXJlIG5vdCBjb250YWluZWQgaW4gdmFsdWUpLlxuICAgKiBVbmxpa2Ugd2l0aCBjaGlsZCBwcm9jZXNzZXMsIHRyYW5zZmVycmluZyBoYW5kbGVzIHN1Y2ggYXMgbmV0d29yayBzb2NrZXRzIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkLlxuICAgKiBJZiB2YWx1ZSBjb250YWlucyBTaGFyZWRBcnJheUJ1ZmZlciBpbnN0YW5jZXMsIHRob3NlIHdpbGwgYmUgYWNjZXNzaWJsZSBmcm9tIGVpdGhlciB0aHJlYWQuIFxuICAgKiBUaGV5IGNhbm5vdCBiZSBsaXN0ZWQgaW4gdHJhbnNmZXJMaXN0LlxuICAgKiB2YWx1ZSBtYXkgc3RpbGwgY29udGFpbiBBcnJheUJ1ZmZlciBpbnN0YW5jZXMgdGhhdCBhcmUgbm90IGluIHRyYW5zZmVyTGlzdDtcbiAgICogaW4gdGhhdCBjYXNlLCB0aGUgdW5kZXJseWluZyBtZW1vcnkgaXMgY29waWVkIHJhdGhlciB0aGFuIG1vdmVkLlxuICAgKi9cbiAgdHJhbnNmZXJMaXN0PzogV29ya2VyT3B0aW9uc1sndHJhbnNmZXJMaXN0J107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGFza1Jlc3VsdCB7XG4gIHRyYW5zZmVyTGlzdD86IFdvcmtlck9wdGlvbnNbJ3RyYW5zZmVyTGlzdCddO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbW1hbmQge1xuICBleGl0OiBib29sZWFuO1xufVxuXG5pZiAod29ya2VyRGF0YSkge1xuICB2ZXJib3NlID0gISEod29ya2VyRGF0YSBhcyBJbml0aWFsT3B0aW9ucykudmVyYm9zZTtcbiAgaWYgKCh3b3JrZXJEYXRhIGFzIEluaXRpYWxPcHRpb25zKS5pbml0aWFsaXplcikge1xuICAgIGNvbnN0IHtmaWxlLCBleHBvcnRGbn0gPSAod29ya2VyRGF0YSBhcyBJbml0aWFsT3B0aW9ucykuaW5pdGlhbGl6ZXIhO1xuICAgIGlmIChleHBvcnRGbiA9PSBudWxsKVxuICAgICAgaW5pdGlhbERvbmUgPSBQcm9taXNlLnJlc29sdmUocmVxdWlyZShmaWxlKSk7XG4gICAgZWxzZVxuICAgICAgaW5pdGlhbERvbmUgPSBQcm9taXNlLnJlc29sdmUocmVxdWlyZShmaWxlKVtleHBvcnRGbl0oKSk7XG4gIH0gZWxzZSB7XG4gICAgaW5pdGlhbERvbmUgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxufVxuXG5pZiAoIWlzTWFpblRocmVhZCkge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW1pc3VzZWQtcHJvbWlzZXNcbiAgcGFyZW50UG9ydCEub24oJ21lc3NhZ2UnLCBleGVjdXRlT25FdmVudCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGVPbkV2ZW50KGRhdGE6IFRhc2sgfCBDb21tYW5kKSB7XG4gIGlmICgoZGF0YSBhcyBDb21tYW5kKS5leGl0KSB7XG4gICAgaWYgKHZlcmJvc2UpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmxvZyhgW3RocmVhZC1wb29sXSB3b3JrZXIgJHt3b3JrZXJEYXRhPy5pZH0gZXhpdGApO1xuICAgIH1cbiAgICBwYXJlbnRQb3J0IS5vZmYoJ21lc3NhZ2UnLCBleGVjdXRlT25FdmVudCk7XG4gICAgLy8gRG9uJ3QgY2FsbCBwcm9jZXNzLmV4aXQoMCksIHRoZXJlIG1pZ2h0IGJlIHNvbWUgdW5maW5pc2hlZCBvdXRwdXQgc3RyZWFtIHN0aWxsIG9uLWdvaW5nIGF0IHRoaXMgbW9tZW50LlxuICAgIHJldHVybjtcbiAgfVxuICBhd2FpdCBpbml0aWFsRG9uZTtcbiAgaWYgKHZlcmJvc2UpIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgIGNvbnNvbGUubG9nKGBbdGhyZWFkLXBvb2xdIHdvcmtlciAke3dvcmtlckRhdGE/LmlkfSBydW5gKTtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShyZXF1aXJlKChkYXRhIGFzIFRhc2spLmZpbGUpWyhkYXRhIGFzIFRhc2spLmV4cG9ydEZuXShcbiAgICAgIC4uLigoZGF0YSBhcyBUYXNrKS5hcmdzIHx8IFtdKVxuICAgICAgKSk7XG5cbiAgICBpZiAodmVyYm9zZSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUubG9nKGBbdGhyZWFkLXBvb2xdIHdvcmtlciAke3dvcmtlckRhdGE/LmlkfSB3YWl0YCk7XG4gICAgfVxuICAgIGlmIChyZXN1bHQgIT0gbnVsbCAmJiAocmVzdWx0IGFzIFRhc2tSZXN1bHQpLnRyYW5zZmVyTGlzdCkge1xuICAgICAgY29uc3QgdHJhbnNmZXJMaXN0ID0gKHJlc3VsdCBhcyBUYXNrUmVzdWx0KS50cmFuc2Zlckxpc3Q7XG4gICAgICBkZWxldGUgcmVzdWx0LnRyYW5zZmVyTGlzdDtcbiAgICAgIHBhcmVudFBvcnQhLnBvc3RNZXNzYWdlKHsgdHlwZTogJ3dhaXQnLCBkYXRhOiByZXN1bHR9LCB0cmFuc2Zlckxpc3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJlbnRQb3J0IS5wb3N0TWVzc2FnZSh7IHR5cGU6ICd3YWl0JywgZGF0YTogcmVzdWx0fSk7XG4gICAgfVxuXG4gIH0gY2F0Y2ggKGV4KSB7XG4gICAgLy8gY29uc29sZS5sb2coYFt0aHJlYWQtcG9vbF0gd29ya2VyICR7d29ya2VyRGF0YT8uaWR9IGVycm9yYCwgZXgpO1xuICAgIC8vIGRlYnVnZ2VyO1xuICAgIHRyeSB7XG4gICAgICBwYXJlbnRQb3J0IS5wb3N0TWVzc2FnZSh7XG4gICAgICAgIHR5cGU6ICdlcnJvcicsXG4gICAgICAgIGRhdGE6IGV4LnN0YWNrXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHBhcmVudFBvcnQhLnBvc3RNZXNzYWdlKHtcbiAgICAgICAgdHlwZTogJ2Vycm9yJyxcbiAgICAgICAgZGF0YTogZXJyLnN0YWNrXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==