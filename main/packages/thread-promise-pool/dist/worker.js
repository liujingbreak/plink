"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable no-console
const worker_threads_1 = require("worker_threads");
let verbose = false;
let initialDone = Promise.resolve();
if (worker_threads_1.workerData) {
    verbose = !!worker_threads_1.workerData.verbose;
    if (worker_threads_1.workerData.initializer) {
        const { file, exportFn } = worker_threads_1.workerData.initializer;
        if (exportFn == null)
            initialDone = Promise.resolve(require(file));
        else
            initialDone = Promise.resolve(require(file)[exportFn]());
    }
    else {
        initialDone = Promise.resolve();
    }
}
if (!worker_threads_1.isMainThread) {
    // eslint-disable-next-line @typescript-eslint/no-misused-promises
    worker_threads_1.parentPort.on('message', executeOnEvent);
}
async function executeOnEvent(data) {
    if (data.exit) {
        if (verbose) {
            // eslint-disable-next-line no-console
            console.log(`[thread-pool] worker ${worker_threads_1.workerData === null || worker_threads_1.workerData === void 0 ? void 0 : worker_threads_1.workerData.id} exit`);
        }
        worker_threads_1.parentPort.off('message', executeOnEvent);
        // Don't call process.exit(0), there might be some unfinished output stream still on-going at this moment.
        return;
    }
    await initialDone;
    if (verbose) {
        // eslint-disable-next-line no-console
        console.log(`[thread-pool] worker ${worker_threads_1.workerData === null || worker_threads_1.workerData === void 0 ? void 0 : worker_threads_1.workerData.id} run`);
    }
    if (data.type !== 'plink:threadPool:task') {
        return;
    }
    try {
        const result = await Promise.resolve(require(data.file)[data.exportFn](...(data.args || [])));
        if (verbose) {
            // eslint-disable-next-line no-console
            console.log(`[thread-pool] worker ${worker_threads_1.workerData === null || worker_threads_1.workerData === void 0 ? void 0 : worker_threads_1.workerData.id} wait`);
        }
        if (result != null && result.transferList) {
            const transferList = result.transferList;
            delete result.transferList;
            worker_threads_1.parentPort.postMessage({ type: 'wait', data: result }, transferList);
        }
        else {
            worker_threads_1.parentPort.postMessage({ type: 'wait', data: result });
        }
    }
    catch (ex) {
        // console.log(`[thread-pool] worker ${workerData?.id} error`, ex);
        // debugger;
        try {
            worker_threads_1.parentPort.postMessage({
                type: 'error',
                data: ex.stack
            });
        }
        catch (err) {
            worker_threads_1.parentPort.postMessage({
                type: 'error',
                data: err.stack
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHMvd29ya2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNEJBQTRCO0FBQzVCLG1EQUFtRjtBQUVuRixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDcEIsSUFBSSxXQUFXLEdBQWlCLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQTBEbEQsSUFBSSwyQkFBVSxFQUFFO0lBQ2QsT0FBTyxHQUFHLENBQUMsQ0FBRSwyQkFBNkIsQ0FBQyxPQUFPLENBQUM7SUFDbkQsSUFBSywyQkFBNkIsQ0FBQyxXQUFXLEVBQUU7UUFDOUMsTUFBTSxFQUFDLElBQUksRUFBRSxRQUFRLEVBQUMsR0FBSSwyQkFBNkIsQ0FBQyxXQUFZLENBQUM7UUFDckUsSUFBSSxRQUFRLElBQUksSUFBSTtZQUNsQixXQUFXLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzs7WUFFN0MsV0FBVyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUM1RDtTQUFNO1FBQ0wsV0FBVyxHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUNqQztDQUNGO0FBRUQsSUFBSSxDQUFDLDZCQUFZLEVBQUU7SUFDakIsa0VBQWtFO0lBQ2xFLDJCQUFXLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztDQUMzQztBQUVELEtBQUssVUFBVSxjQUFjLENBQUMsSUFBb0I7SUFDaEQsSUFBSyxJQUFnQixDQUFDLElBQUksRUFBRTtRQUMxQixJQUFJLE9BQU8sRUFBRTtZQUNYLHNDQUFzQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QiwyQkFBVSxhQUFWLDJCQUFVLHVCQUFWLDJCQUFVLENBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM1RDtRQUNELDJCQUFXLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUMzQywwR0FBMEc7UUFDMUcsT0FBTztLQUNSO0lBQ0QsTUFBTSxXQUFXLENBQUM7SUFDbEIsSUFBSSxPQUFPLEVBQUU7UUFDWCxzQ0FBc0M7UUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsMkJBQVUsYUFBViwyQkFBVSx1QkFBViwyQkFBVSxDQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDM0Q7SUFDRCxJQUFLLElBQWEsQ0FBQyxJQUFJLEtBQUssdUJBQXVCLEVBQUU7UUFDbkQsT0FBTztLQUNSO0lBRUQsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUUsSUFBYSxDQUFDLElBQUksQ0FBQyxDQUFFLElBQWEsQ0FBQyxRQUFRLENBQUMsQ0FDeEYsR0FBRyxDQUFFLElBQWEsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQzdCLENBQUMsQ0FBQztRQUVMLElBQUksT0FBTyxFQUFFO1lBQ1gsc0NBQXNDO1lBQ3RDLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLDJCQUFVLGFBQVYsMkJBQVUsdUJBQVYsMkJBQVUsQ0FBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzVEO1FBQ0QsSUFBSSxNQUFNLElBQUksSUFBSSxJQUFLLE1BQXFCLENBQUMsWUFBWSxFQUFFO1lBQ3pELE1BQU0sWUFBWSxHQUFJLE1BQXFCLENBQUMsWUFBWSxDQUFDO1lBQ3pELE9BQU8sTUFBTSxDQUFDLFlBQVksQ0FBQztZQUMzQiwyQkFBVyxDQUFDLFdBQVcsQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBQyxFQUFFLFlBQVksQ0FBQyxDQUFDO1NBQ3RFO2FBQU07WUFDTCwyQkFBVyxDQUFDLFdBQVcsQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7U0FDeEQ7S0FFRjtJQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ1gsbUVBQW1FO1FBQ25FLFlBQVk7UUFDWixJQUFJO1lBQ0YsMkJBQVcsQ0FBQyxXQUFXLENBQUM7Z0JBQ3RCLElBQUksRUFBRSxPQUFPO2dCQUNiLElBQUksRUFBRSxFQUFFLENBQUMsS0FBSzthQUNmLENBQUMsQ0FBQztTQUNKO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWiwyQkFBVyxDQUFDLFdBQVcsQ0FBQztnQkFDdEIsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsSUFBSSxFQUFFLEdBQUcsQ0FBQyxLQUFLO2FBQ2hCLENBQUMsQ0FBQztTQUNKO0tBQ0Y7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGUgbm8tY29uc29sZVxuaW1wb3J0IHtpc01haW5UaHJlYWQsIHBhcmVudFBvcnQsIHdvcmtlckRhdGEsIFdvcmtlck9wdGlvbnN9IGZyb20gJ3dvcmtlcl90aHJlYWRzJztcblxubGV0IHZlcmJvc2UgPSBmYWxzZTtcbmxldCBpbml0aWFsRG9uZTogUHJvbWlzZTxhbnk+ID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4vLyByZXF1aXJlKCdpbnNwZWN0b3InKS5vcGVuKDkyMjIsICdsb2NhbGhvc3QnLCB0cnVlKTtcblxuLy8gcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCBmdW5jdGlvbihlcnIpIHtcbi8vICAgLy8gbG9nLmVycm9yKCdVbmNhdWdodCBleGNlcHRpb24nLCBlcnIsIGVyci5zdGFjayk7XG4vLyAgIGNvbnNvbGUuZXJyb3IoYFt0aHJlYWQtcG9vbF0gd29ya2VyIHBpZDoke3dvcmtlckRhdGEuaWR9IFVuY2F1Z2h0IGV4Y2VwdGlvbjogYCwgZXJyKTtcbi8vICAgcGFyZW50UG9ydCEucG9zdE1lc3NhZ2Uoe1xuLy8gICAgIHR5cGU6ICdlcnJvcicsXG4vLyAgICAgZGF0YTogZXJyLnRvU3RyaW5nKClcbi8vICAgfSk7XG4vLyB9KTtcblxuLy8gcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgZXJyID0+IHtcbi8vICAgLy8gbG9nLndhcm4oJ3VuaGFuZGxlZFJlamVjdGlvbicsIGVycik7XG4vLyAgIGNvbnNvbGUuZXJyb3IoYFt0aHJlYWQtcG9vbF0gd29ya2VyIHBpZDoke3dvcmtlckRhdGEuaWR9IHVuaGFuZGxlZFJlamVjdGlvbmAsIGVycik7XG4vLyAgIHBhcmVudFBvcnQhLnBvc3RNZXNzYWdlKHtcbi8vICAgICB0eXBlOiAnZXJyb3InLFxuLy8gICAgIGRhdGE6IGVyciA/IGVyci50b1N0cmluZygpIDogZXJyXG4vLyAgIH0pO1xuLy8gfSk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSW5pdGlhbE9wdGlvbnMge1xuICB2ZXJib3NlPzogYm9vbGVhbjtcbiAgLyoqIEFmdGVyIHdvcmtlciBiZWluZyBjcmVhdGVkLCB0aGUgZXhwb3J0ZWQgZnVuY3Rpb24gd2lsbCBiZSBydW4sXG4gICAqIFlvdSBjYW4gcHV0IGFueSBpbml0aWFsIGxvZ2ljIGluIGl0LCBsaWtlIGNhbGxpbmcgYHJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydC9yZWdpc3RlcicpYCBvclxuICAgKiBzZXR1cCBwcm9jZXNzIGV2ZW50IGhhbmRsaW5nIGZvciB1bmNhdWdodEV4Y2VwdGlvbiBhbmQgdW5oYW5kbGVkUmVqZWN0aW9uLlxuICAgKi9cbiAgaW5pdGlhbGl6ZXI/OiB7ZmlsZTogc3RyaW5nOyBleHBvcnRGbj86IHN0cmluZ307XG59XG5leHBvcnQgaW50ZXJmYWNlIFRhc2sge1xuICB0eXBlPzogc3RyaW5nO1xuICBmaWxlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBBIGZ1bmN0aW9uIHdoaWNoIGNhbiByZXR1cm4gUHJvbWlzZSBvciBub24tUHJvbWlzZSB2YWx1ZVxuICAgKi9cbiAgZXhwb3J0Rm46IHN0cmluZztcbiAgYXJncz86IGFueVtdO1xuICAvKiogV29ya2VyIG1lc3NhZ2UgdHJhbnNmZXJMaXN0LCBzZWVcbiAgICogaHR0cHM6Ly9ub2RlanMub3JnL2RvY3MvbGF0ZXN0LXYxMi54L2FwaS93b3JrZXJfdGhyZWFkcy5odG1sI3dvcmtlcl90aHJlYWRzX3BvcnRfcG9zdG1lc3NhZ2VfdmFsdWVfdHJhbnNmZXJsaXN0XG4gICAqIG1heSBiZSBhIGxpc3Qgb2YgQXJyYXlCdWZmZXIsIE1lc3NhZ2VQb3J0IGFuZCBGaWxlSGFuZGxlIG9iamVjdHMuIEFmdGVyIHRyYW5zZmVycmluZywgXG4gICAqIHRoZXkgd2lsbCBub3QgYmUgdXNhYmxlIG9uIHRoZSBzZW5kaW5nIHNpZGUgb2YgdGhlIGNoYW5uZWwgYW55bW9yZSAoZXZlbiBpZiB0aGV5IGFyZSBub3QgY29udGFpbmVkIGluIHZhbHVlKS5cbiAgICogVW5saWtlIHdpdGggY2hpbGQgcHJvY2Vzc2VzLCB0cmFuc2ZlcnJpbmcgaGFuZGxlcyBzdWNoIGFzIG5ldHdvcmsgc29ja2V0cyBpcyBjdXJyZW50bHkgbm90IHN1cHBvcnRlZC5cbiAgICogSWYgdmFsdWUgY29udGFpbnMgU2hhcmVkQXJyYXlCdWZmZXIgaW5zdGFuY2VzLCB0aG9zZSB3aWxsIGJlIGFjY2Vzc2libGUgZnJvbSBlaXRoZXIgdGhyZWFkLiBcbiAgICogVGhleSBjYW5ub3QgYmUgbGlzdGVkIGluIHRyYW5zZmVyTGlzdC5cbiAgICogdmFsdWUgbWF5IHN0aWxsIGNvbnRhaW4gQXJyYXlCdWZmZXIgaW5zdGFuY2VzIHRoYXQgYXJlIG5vdCBpbiB0cmFuc2Zlckxpc3Q7XG4gICAqIGluIHRoYXQgY2FzZSwgdGhlIHVuZGVybHlpbmcgbWVtb3J5IGlzIGNvcGllZCByYXRoZXIgdGhhbiBtb3ZlZC5cbiAgICovXG4gIHRyYW5zZmVyTGlzdD86IFdvcmtlck9wdGlvbnNbJ3RyYW5zZmVyTGlzdCddO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRhc2tSZXN1bHQge1xuICB0cmFuc2Zlckxpc3Q/OiBXb3JrZXJPcHRpb25zWyd0cmFuc2Zlckxpc3QnXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb21tYW5kIHtcbiAgZXhpdDogYm9vbGVhbjtcbn1cblxuaWYgKHdvcmtlckRhdGEpIHtcbiAgdmVyYm9zZSA9ICEhKHdvcmtlckRhdGEgYXMgSW5pdGlhbE9wdGlvbnMpLnZlcmJvc2U7XG4gIGlmICgod29ya2VyRGF0YSBhcyBJbml0aWFsT3B0aW9ucykuaW5pdGlhbGl6ZXIpIHtcbiAgICBjb25zdCB7ZmlsZSwgZXhwb3J0Rm59ID0gKHdvcmtlckRhdGEgYXMgSW5pdGlhbE9wdGlvbnMpLmluaXRpYWxpemVyITtcbiAgICBpZiAoZXhwb3J0Rm4gPT0gbnVsbClcbiAgICAgIGluaXRpYWxEb25lID0gUHJvbWlzZS5yZXNvbHZlKHJlcXVpcmUoZmlsZSkpO1xuICAgIGVsc2VcbiAgICAgIGluaXRpYWxEb25lID0gUHJvbWlzZS5yZXNvbHZlKHJlcXVpcmUoZmlsZSlbZXhwb3J0Rm5dKCkpO1xuICB9IGVsc2Uge1xuICAgIGluaXRpYWxEb25lID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cbn1cblxuaWYgKCFpc01haW5UaHJlYWQpIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1taXN1c2VkLXByb21pc2VzXG4gIHBhcmVudFBvcnQhLm9uKCdtZXNzYWdlJywgZXhlY3V0ZU9uRXZlbnQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlT25FdmVudChkYXRhOiBUYXNrIHwgQ29tbWFuZCkge1xuICBpZiAoKGRhdGEgYXMgQ29tbWFuZCkuZXhpdCkge1xuICAgIGlmICh2ZXJib3NlKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS5sb2coYFt0aHJlYWQtcG9vbF0gd29ya2VyICR7d29ya2VyRGF0YT8uaWR9IGV4aXRgKTtcbiAgICB9XG4gICAgcGFyZW50UG9ydCEub2ZmKCdtZXNzYWdlJywgZXhlY3V0ZU9uRXZlbnQpO1xuICAgIC8vIERvbid0IGNhbGwgcHJvY2Vzcy5leGl0KDApLCB0aGVyZSBtaWdodCBiZSBzb21lIHVuZmluaXNoZWQgb3V0cHV0IHN0cmVhbSBzdGlsbCBvbi1nb2luZyBhdCB0aGlzIG1vbWVudC5cbiAgICByZXR1cm47XG4gIH1cbiAgYXdhaXQgaW5pdGlhbERvbmU7XG4gIGlmICh2ZXJib3NlKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICBjb25zb2xlLmxvZyhgW3RocmVhZC1wb29sXSB3b3JrZXIgJHt3b3JrZXJEYXRhPy5pZH0gcnVuYCk7XG4gIH1cbiAgaWYgKChkYXRhIGFzIFRhc2spLnR5cGUgIT09ICdwbGluazp0aHJlYWRQb29sOnRhc2snKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLnJlc29sdmUocmVxdWlyZSgoZGF0YSBhcyBUYXNrKS5maWxlKVsoZGF0YSBhcyBUYXNrKS5leHBvcnRGbl0oXG4gICAgICAuLi4oKGRhdGEgYXMgVGFzaykuYXJncyB8fCBbXSlcbiAgICAgICkpO1xuXG4gICAgaWYgKHZlcmJvc2UpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmxvZyhgW3RocmVhZC1wb29sXSB3b3JrZXIgJHt3b3JrZXJEYXRhPy5pZH0gd2FpdGApO1xuICAgIH1cbiAgICBpZiAocmVzdWx0ICE9IG51bGwgJiYgKHJlc3VsdCBhcyBUYXNrUmVzdWx0KS50cmFuc2Zlckxpc3QpIHtcbiAgICAgIGNvbnN0IHRyYW5zZmVyTGlzdCA9IChyZXN1bHQgYXMgVGFza1Jlc3VsdCkudHJhbnNmZXJMaXN0O1xuICAgICAgZGVsZXRlIHJlc3VsdC50cmFuc2Zlckxpc3Q7XG4gICAgICBwYXJlbnRQb3J0IS5wb3N0TWVzc2FnZSh7IHR5cGU6ICd3YWl0JywgZGF0YTogcmVzdWx0fSwgdHJhbnNmZXJMaXN0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyZW50UG9ydCEucG9zdE1lc3NhZ2UoeyB0eXBlOiAnd2FpdCcsIGRhdGE6IHJlc3VsdH0pO1xuICAgIH1cblxuICB9IGNhdGNoIChleCkge1xuICAgIC8vIGNvbnNvbGUubG9nKGBbdGhyZWFkLXBvb2xdIHdvcmtlciAke3dvcmtlckRhdGE/LmlkfSBlcnJvcmAsIGV4KTtcbiAgICAvLyBkZWJ1Z2dlcjtcbiAgICB0cnkge1xuICAgICAgcGFyZW50UG9ydCEucG9zdE1lc3NhZ2Uoe1xuICAgICAgICB0eXBlOiAnZXJyb3InLFxuICAgICAgICBkYXRhOiBleC5zdGFja1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBwYXJlbnRQb3J0IS5wb3N0TWVzc2FnZSh7XG4gICAgICAgIHR5cGU6ICdlcnJvcicsXG4gICAgICAgIGRhdGE6IGVyci5zdGFja1xuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=