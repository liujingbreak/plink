{"version":3,"file":"epic.js","sourceRoot":"","sources":["../src/epic.ts"],"names":[],"mappings":"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","sourcesContent":["import * as rx from 'rxjs';\nimport {Action, RxController, ActionFunctions} from './control';\nimport {DuplexController, DuplexOptions} from './duplex';\n\nexport type Reactor<I extends ActionFunctions> = (ctl: RxController<I>) => rx.Observable<any>;\nexport type DuplexReactor<I extends ActionFunctions, O extends ActionFunctions> = (ctl: DuplexController<I, O>) => rx.Observable<any>;\n\nexport type ReactorCompositeActions = {\n  // mergeStream(stream: rx.Observable<any>, disableCatchError?: boolean, errorLabel?: string): void;\n  stopAll(): void;\n};\n\nexport type ReactorCompositeOutput = {\n  onError(label: string, originError: any): void;\n};\n\nexport type InferFuncReturnEvents<I extends ActionFunctions> = {\n  [K in keyof I as `${K & string}Resolved`]: (\n    p: ReturnType<I[K]> extends PromiseLike<infer P> ?\n      P : ReturnType<I[K]> extends rx.Observable<infer OB> ?\n        OB : ReturnType<I[K]>\n    , callerActionId: Action<I>['i']) => void\n} & {\n  [K in keyof I as `${K & string}Completed`]: (callerActionId: Action<I>['i']) => void;\n};\n\nexport class ReactorComposite<\n  I extends ActionFunctions = Record<string, never>,\n  O extends ActionFunctions = Record<string, never>\n> extends DuplexController<I & ReactorCompositeActions, O & ReactorCompositeOutput> {\n  // protected latestCompActPayloads: {[K in 'mergeStream']: PayloadStream<ReactorCompositeActions, K>};\n  protected reactorSubj: rx.Subject<[label: string, stream: rx.Observable<any>, disableCatchError?: boolean]>;\n  // protected control: DuplexController<ReactorCompositeActions, ReactorCompositeOutput>;\n\n  constructor(private opts?: DuplexOptions) {\n    super(opts);\n    // this.latestCompActPayloads = (this as ReactorComposite<ReactorCompositeActions, ReactorCompositeOutput>).i.createLatestPayloadsFor('mergeStream');\n    this.reactorSubj = new rx.ReplaySubject(999);\n  }\n\n  startAll() {\n    return rx.merge(\n      this.reactorSubj.pipe(\n        rx.mergeMap(([label, downStream, noError]) => {\n          if (noError == null || !noError) {\n            downStream = this.handleError(downStream, label);\n          }\n          return downStream;\n        })\n      )\n    ).pipe(\n      rx.takeUntil(this.i.pt.stopAll),\n      rx.catchError((err, src) => {\n        if (this.opts?.log)\n          this.opts.log(err);\n        else\n          console.error(err);\n        return src;\n      })\n    ).subscribe();\n  }\n\n  // eslint-disable-next-line space-before-function-paren\n  reactivize<F extends {[s: string]: (...a: any[]) => any}>(fObject: F) {\n    const funcs = Object.entries(fObject);\n\n    for (const [key, func] of funcs) {\n      if (typeof func === 'function') {\n        this.reactivizeFunction(key, func, fObject);\n      }\n    }\n    return this as ReactorComposite<I & F, InferFuncReturnEvents<F> & O>;\n  }\n\n  /** \n   * It is just a declaration of mergeMap() operator, which merge an observable to the main stream\n   * which will be or has already been observed by `startAll()`.\n   * This is where we can add `side effect`s\n  * */\n  addReaction(...params: [label: string, stream: rx.Observable<any>, disableCatchError?: boolean]) {\n    this.r(...params);\n  }\n\n  /** Abbrevation of addReaction */\n  r = (...params: [label: string, stream: rx.Observable<any>, disableCatchError?: boolean] | [stream: rx.Observable<any>, disableCatchError?: boolean]) => {\n    if (typeof params[0] === 'string')\n      this.reactorSubj.next(params as [label: string, stream: rx.Observable<any>, disableCatchError?: boolean]);\n    else\n      this.reactorSubj.next(['', ...params as [stream: rx.Observable<any>, disableCatchError?: boolean]]);\n  };\n\n  protected reactivizeFunction(key: string, func: (...a: any[]) => any, funcThisRef?: any) {\n    const resolveFuncKey = key + 'Resolved';\n    const finishFuncKey = key + 'Completed';\n    const dispatchResolved = (this as unknown as ReactorComposite<ReactorCompositeActions, any>).o.core.dispatcherFactory(resolveFuncKey as any);\n    const dispatchCompleted = (this as unknown as ReactorComposite<ReactorCompositeActions, any>).o.core.dispatcherFactory(finishFuncKey as any);\n    this.r(this.i.pt[key as keyof I].pipe(\n      rx.mergeMap(([id, ...params]) => {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        const res = func.apply(funcThisRef, params);\n        if (rx.isObservable(res)) {\n          return res.pipe(\n            rx.map(res => dispatchResolved(res, id)),\n            rx.finalize(() => dispatchCompleted(id))\n          );\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n        } else if (res?.then && res?.catch) {\n          return rx.from((res as PromiseLike<unknown>).then(resolved => {\n            dispatchResolved(resolved, id);\n            dispatchCompleted(id);\n          }));\n        } else {\n          dispatchResolved(res, id);\n          dispatchCompleted(id);\n        }\n        return rx.EMPTY;\n      })\n    ));\n    return resolveFuncKey;\n  }\n\n  protected handleError(upStream: rx.Observable<any>, label?: string) {\n    return upStream.pipe(\n      rx.catchError((err, src) => {\n        (this as unknown as ReactorComposite<ReactorCompositeActions, ReactorCompositeOutput>).o.dp.onError(err, label);\n        return src;\n      })\n    );\n  }\n}\n"]}