{"version":3,"file":"stream-core.js","sourceRoot":"","sources":["../src/stream-core.ts"],"names":[],"mappings":"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","sourcesContent":["import * as rx from 'rxjs';\n\nexport type ActionFunctions = Record<string, any>; // instead of A indexed access type, since a \"class type\" can not be assigned to \"Indexed access type with function type property\"\nexport type EmptyActionFunctions = Record<string, never>;\n\nexport type InferPayload<F> = F extends (...a: infer P) => any ? P : unknown[];\n\nexport type ActionMeta = {\n  /** id */\n  i: number;\n  /** reference to other actions */\n  r?: number | number[];\n};\n\nexport type ArrayOrTuple<T> = T[] | readonly T[] | readonly [T, ...T[]];\n\nexport type Action<I, K extends keyof I = keyof I> = {\n  /** type */\n  t: string;\n  /** payload **/\n  p: InferPayload<I[K]>;\n} & ActionMeta;\n\n// export type PayloadStream<I extends ActionFunctions, K extends keyof I> = rx.Observable<[ActionMeta, ...InferPayload<I[K]>]>;\n\nexport type Dispatch<I, K extends keyof I> = (...params: InferPayload<I[K]>) => Action<I, K>;\nexport type DispatchFor<I, K extends keyof I> =\n  (origActionMeta: ActionMeta | ArrayOrTuple<ActionMeta>, ...params: InferPayload<I[K]>) => Action<I, K>;\n\nexport type CoreOptions<I> = {\n  name?: string;\n  /** default is `true`, set to `false` will result in Connectable multicast action observable \"action$\" not \n  * being automatically connected, you have to manually call `RxController::connect()` or `action$.connect()`,\n  * otherwise, any actions that is dispatched to `actionUpstream` will not be observed and emitted by `action$`,\n  * Refer to [https://rxjs.dev/api/index/function/connectable](https://rxjs.dev/api/index/function/connectable)\n  * */\n  autoConnect?: boolean;\n  debug?: boolean;\n  debugExcludeTypes?: (keyof I)[];\n  logStyle?: 'full' | 'noParam';\n  log?: (msg: string, ...objs: any[]) => unknown;\n};\n\nlet SEQ = 1;\nlet ACTION_SEQ = Number((Math.random() + '').slice(2, 10)) + 1;\n\nexport const has = Object.prototype.hasOwnProperty;\n\nexport class ControllerCore<I> {\n  actionUpstream = new rx.Subject<Action<I>>();\n  interceptor$ = new rx.BehaviorSubject<(up: rx.Observable<Action<I>>) => rx.Observable<Action<I>>>(a => a);\n  typePrefix = '#' + SEQ++ + ' ';\n  logPrefix = ''; // TODO: a better identity to distinguish threads\n  action$: rx.Observable<Action<I>>;\n  debugExcludeSet: Set<string | number | symbol>;\n\n  /** Event when `action$` is first time subscribed */\n  actionSubscribed$: rx.Observable<void>;\n  /** Event when `action$` is entirely unsubscribed by all observers */\n  actionUnsubscribed$: rx.Observable<void>;\n  protected dispatcher = {} as {[K in keyof I]: Dispatch<I, K>};\n  protected dispatcherFor = {} as {[K in keyof I]: DispatchFor<I, K>};\n  protected actionSubDispatcher = new rx.Subject<void>();\n  protected actionUnsubDispatcher = new rx.Subject<void>();\n  private connectableAction$: rx.Connectable<Action<I>>;\n\n  constructor(public opts?: CoreOptions<I>) {\n    this.setName(opts?.name);\n    this.debugExcludeSet = new Set(opts?.debugExcludeTypes ?? []);\n\n    const debuggableAction$ = opts?.debug\n      ? this.actionUpstream.pipe(\n        opts?.log ?\n          rx.tap(action => {\n            const type = nameOfAction(action);\n            if (!this.debugExcludeSet.has(type)) {\n              opts.log!(this.logPrefix, 'rx:action', type, actionMetaToStr(action), ...(opts.logStyle === 'noParam' ? [] : action.p));\n            }\n          }) :\n          (typeof window !== 'undefined') || (typeof Worker !== 'undefined') ?\n            rx.tap(action => {\n              const type = nameOfAction(action);\n              if (!this.debugExcludeSet.has(type)) {\n                // eslint-disable-next-line no-console\n                console.log(`%c ${this.logPrefix} rx:action`, 'color: black; background: #8c61ff;',\n                  type, actionMetaToStr(action), ...(opts.logStyle === 'noParam' ? [] : action.p));\n              }\n            }) :\n            rx.tap(action => {\n              const type = nameOfAction(action);\n              if (!this.debugExcludeSet.has(type)) {\n                // eslint-disable-next-line no-console\n                console.log(this.logPrefix, 'rx:action', type, actionMetaToStr(action), ...(opts.logStyle === 'noParam' ? [] : action.p));\n              }\n            })\n      )\n      : this.actionUpstream;\n\n    this.connectableAction$ = rx.connectable(this.interceptor$.pipe(\n      rx.switchMap(interceptor => interceptor ?\n        debuggableAction$.pipe(interceptor) :\n        debuggableAction$)\n    ));\n\n    this.action$ = rx.merge(\n      // merge() helps to leverage a auxiliary Observable to notify when \"connectableAction$\" is actually being\n      // subscribed, since it will be subscribed along together with \"connectableAction$\"\n      this.connectableAction$,\n      new rx.Observable<never>(sub => {\n        // Notify that action$ is subscribed\n        this.actionSubDispatcher.next();\n        sub.complete();\n      })\n    ).pipe(\n      rx.finalize(() => {\n        this.actionUnsubDispatcher.next();\n      }),\n      rx.share()\n    );\n\n    if (opts?.autoConnect == null || opts?.autoConnect) {\n      this.connectableAction$.connect();\n    }\n    this.actionSubscribed$ = this.actionSubDispatcher.asObservable();\n    this.actionUnsubscribed$ = this.actionUnsubDispatcher.asObservable();\n  }\n\n  createAction<J = I, K extends keyof J = keyof J>(type: K, params?: InferPayload<J[K]>) {\n    return {\n      t: this.typePrefix + (type as string),\n      i: ACTION_SEQ++,\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n      p: params ?? []\n    } as Action<J, K>;\n  }\n\n  /** change the \"name\" as previous specified in CoreOptions of constructor */\n  setName(name: string | null | undefined) {\n    this.logPrefix = name ?? this.typePrefix;\n  }\n\n  dispatchFactory<K extends keyof I>(type: K): Dispatch<I, K> {\n    if (has.call(this.dispatcher, type)) {\n      return this.dispatcher[type];\n    }\n    const dispatch = (...params: InferPayload<I[keyof I]>) => {\n      const action = this.createAction(type, params);\n      this.actionUpstream.next(action);\n      return action;\n    };\n    this.dispatcher[type] = dispatch;\n    return dispatch;\n  }\n\n  dispatchForFactory<K extends keyof I>(type: K): DispatchFor<I, K> {\n    if (has.call(this.dispatcherFor, type)) {\n      return this.dispatcherFor[type];\n    }\n    const dispatch = (metas: ActionMeta | ArrayOrTuple<ActionMeta>, ...params: InferPayload<I[keyof I]>) => {\n      const action = this.createAction(type, params);\n      action.r = Array.isArray(metas) ? metas.map(m => m.i) : (metas as ActionMeta).i;\n      this.actionUpstream.next(action);\n      return action;\n    };\n    this.dispatcherFor[type] = dispatch;\n    return dispatch;\n  }\n\n  updateInterceptor(\n    factory: (\n      previous: (up: rx.Observable<Action<I>>) => rx.Observable<Action<I>>\n    ) => (up: rx.Observable<Action<I>>) => rx.Observable<Action<I>>\n  ) {\n    const newInterceptor = factory(this.interceptor$.getValue());\n    this.interceptor$.next(newInterceptor);\n  }\n\n  // eslint-disable-next-line space-before-function-paren\n  ofType<T extends (keyof I)[]>(...types: T): (up: rx.Observable<Action<any, any>>) => rx.Observable<Action<I, T[number]>> {\n    return (up: rx.Observable<Action<any, any>>) => {\n      const matchTypes = types.map(type => this.typePrefix + (type as string));\n      return up.pipe(\n        rx.filter((a): a is Action<I, T[number]> => matchTypes.some(matchType => a.t === matchType))\n      );\n    };\n  }\n\n  // eslint-disable-next-line space-before-function-paren\n  notOfType<T extends (keyof I)[]>(...types: T) {\n    return (up: rx.Observable<Action<any, any>>) => {\n      const matchTypes = types.map(type => this.typePrefix + (type as string));\n      return up.pipe(\n        rx.filter((a): a is Action<I, Exclude<(keyof I), T[number]>> => matchTypes.every(matchType => a.t !== matchType))\n      );\n    };\n  }\n  connect() {\n    this.connectableAction$.connect();\n  }\n}\n\n/**\n * Get the \"action name\" from payload's \"type\" field,\n * `payload.type`` is actually consist of string like `${Prefix}/${actionName}`,\n * this function returns the `actionName` part\n * @return undefined if current action doesn't have a valid \"type\" field\n */\n// eslint-disable-next-line space-before-function-paren\nexport function nameOfAction<I = ActionFunctions>(\n  action: Pick<Action<I>, 't'>\n): keyof I {\n  const match = /(?:#\\d+\\s+)?(\\S+)$/.exec(action.t);\n  return (match ? match[1] : action.t) as keyof I;\n}\n\nexport function actionMetaToStr(action: ActionMeta) {\n  const {r, i} = action;\n  return `(i: ${i}${r != null ? `, r: ${Array.isArray(r) ? [...r.values()].toString() : r}` : ''})`;\n}\n"]}