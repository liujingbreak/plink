{"version":3,"file":"markdown-processor.js","sourceRoot":"","sources":["markdown-processor.ts"],"names":[],"mappings":"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","sourcesContent":["import * as rx from 'rxjs';\nimport {log4File} from '@wfh/plink';\nimport {createWorkerControl, fork, WorkerControl} from '@wfh/reactivizer/dist/fork-join/node-worker';\nimport {ActionMeta, serializeAction, str2ArrayBuffer, arrayBuffer2str} from '@wfh/reactivizer';\nimport md5 from 'md5';\nimport MarkdownIt from 'markdown-it';\nimport highlight from 'highlight.js';\nimport type {DefaultTreeAdapterMap} from 'parse5';\nimport {TOC} from '../isom/md-types';\nimport {ChildNode, Element, lookupTextNodeIn, createTocTree} from './markdown-processor-helper';\n\nconst log = log4File(__filename);\n\ntype MdInputActions = {\n  forkProcessFile(markdownFileContent: string, filePath: string): void;\n  processFile(markdownFileContent: SharedArrayBuffer, filePath: string): void;\n  processFileDone(res: {resultHtml: ArrayBuffer; toc: TOC[]; mermaid: ArrayBuffer[]; transferList: ArrayBuffer[]}): void;\n  /** Consumer should dispatach to be related to \"resolveImage\" event */\n  imageResolved(resultUrl: string): void;\n  /** Consumer should dispatch */\n  anchorLinkResolved(url: string): void;\n};\n\nexport type MdOutputEvents = {\n  processFileDone: MdInputActions['processFileDone'];\n  /** Consumer program should react on this event */\n  imageToBeResolved(imgSrc: string, mdFilePath: string): void;\n  /** Consumer should react and dispatach \"anchorLinkResolved\" */\n  anchorLinkToBeResolved(linkSrc: string, mdFilePath: string): void;\n\n  htmlRendered(file: string, html: string): void;\n};\n\nconst headerSet = new Set<string>('h1 h2 h3 h4 h5'.split(' '));\nconst md = new MarkdownIt({\n  html: true,\n  highlight(str, lang, _attrs) {\n    if (lang && lang !== 'mermaid') {\n      try {\n        const parsed = highlight.highlight(str, {language: lang}).value;\n        return parsed;\n      } catch (e) {\n        log.debug(e); // skip non-important error like: Unknown language: \"mermaid\"\n      }\n    }\n    return str;\n  }\n});\nexport type MarkdownProcessor = WorkerControl<MdInputActions, MdOutputEvents>;\n\nexport const markdownProcessor: MarkdownProcessor = createWorkerControl<MdInputActions, MdOutputEvents>({\n  name: 'markdownProcessor', debug: true,\n  log(...msg) {\n    log.info(...msg);\n  }\n});\n\nconst {r, i, o, outputTable} = markdownProcessor;\n\nr('forkProcessFile -> fork processFile, processFileDone', i.pt.forkProcessFile.pipe(\n  rx.mergeMap(async ([m, content, file]) => {\n    const resultDone = fork(markdownProcessor, 'processFile', [str2ArrayBuffer<SharedArrayBuffer>(content, true), file], 'processFileDone', m);\n    o.dp.wait();\n    const [result] = await resultDone;\n    o.dp.stopWaiting();\n    o.dpf.processFileDone(m, result);\n  })\n));\n\nr('processFile -> processFileDone', i.pt.processFile.pipe(\n  rx.combineLatestWith(import('parse5')),\n  rx.mergeMap(([[m, content, file], parse5]) => {\n    const html = md.render(arrayBuffer2str(content));\n    const doc = parse5.parse(html, {sourceCodeLocationInfo: true});\n    const content$ = dfsAccessElement(m, html, file, doc);\n    return content$.pipe(\n      rx.map(([content, toc, mermaidCodes]) => {\n        const buf = str2ArrayBuffer<ArrayBuffer>(content);\n        const mermaidBufs = mermaidCodes.map(code => str2ArrayBuffer<ArrayBuffer>(code));\n        o.dpf.processFileDone(m, {resultHtml: buf, toc: createTocTree(toc), mermaid: mermaidBufs, transferList: [buf, ...mermaidBufs]});\n      })\n    );\n  }),\n  rx.catchError(err => {\n    log.error(err);\n    // o.dpf.processFileDone({toc: [], content: (err as Error).toString()});\n    return rx.EMPTY;\n  })\n));\n\nr('imageToBeResolved -> main thread port postMessage', o.at.imageToBeResolved.pipe(\n  rx.withLatestFrom(outputTable.l.workerInited),\n  rx.tap(([resolveAction, [, , , port]]) => {\n    if (port) {\n      o.dp.log('pass imageToBeResolved action to main thread');\n      port.postMessage(serializeAction(resolveAction));\n    }\n  })\n));\n\nfunction dfsAccessElement(\n  processFileActionMeta: ActionMeta,\n  sourceHtml: string,\n  file: string,\n  root: DefaultTreeAdapterMap['document']\n  // transpileCode?: (language: string, sourceCode: string) => Promise<string> | rx.Observable<string> | void,\n) {\n  const toc: TOC[] = [];\n  const mermaidCode = [] as string[];\n  const chr = new rx.BehaviorSubject<ChildNode[]>(root.childNodes || []);\n  const output = [] as Array<string | Promise<string> | rx.Observable<string> | null | undefined>;\n  let htmlOffset = 0;\n\n  chr.pipe(\n    rx.mergeMap(children => rx.from(children)),\n    rx.map(node => {\n      const nodeName = node.nodeName.toLowerCase();\n      if (nodeName === '#text' || nodeName === '#comment' || nodeName === '#documentType')\n        return;\n      const el = node as Element;\n      if (nodeName === 'code') {\n        const classAttr = el.attrs.find(item => item.name === 'class');\n        if (classAttr) {\n          const langMatch = /^language-(.*)$/.exec(classAttr.value);\n          const lang = langMatch ? langMatch[1] : null;\n          const endQuoteSyntaxPos = el.sourceCodeLocation!.attrs!.class!.endOffset - 1;\n          output.push(\n            sourceHtml.slice(htmlOffset, endQuoteSyntaxPos),\n            ' hljs'\n          );\n          htmlOffset = endQuoteSyntaxPos;\n\n          if (lang === 'mermaid' && el.childNodes.length > 0) {\n            const mermaidCodeStart = (el.childNodes[0] as Element).sourceCodeLocation!.startOffset;\n            const mermaidCodeEnd = (el.childNodes[el.childNodes.length - 1] as Element).sourceCodeLocation!.endOffset;\n            mermaidCode.push(sourceHtml.slice(mermaidCodeStart, mermaidCodeEnd));\n            output.push(sourceHtml.slice(htmlOffset, mermaidCodeStart));\n            htmlOffset = mermaidCodeEnd;\n          }\n        }\n      } else if (nodeName === 'img') {\n        const imgSrc = el.attrs.find(item => item.name === 'src');\n        if (imgSrc && !imgSrc.value.startsWith('/') && !/^https?:\\/\\//.test(imgSrc.value)) {\n          log.info('found img src=' + imgSrc.value);\n          output.push(sourceHtml.slice(htmlOffset, el.sourceCodeLocation!.attrs!.src!.startOffset + 'src=\"'.length));\n          // eslint-disable-next-line @typescript-eslint/no-non-null-asserted-optional-chain\n          htmlOffset = el.sourceCodeLocation!.attrs?.src.endOffset! - 1;\n          return output.push(rx.merge(\n            new rx.Observable<never>(() => {\n              o.dp.wait();\n            }),\n            o.do.imageToBeResolved(i.at.imageResolved, imgSrc.value, file)\n          ).pipe(\n            rx.take(1),\n            rx.map(([, url]) => url),\n            rx.finalize(() => o.dp.stopWaiting())\n          ));\n        }\n      } else if (headerSet.has(nodeName)) {\n        const text = lookupTextNodeIn(el);\n        const hash = btoa(md5(text, {asString: true}));\n        const posBeforeStartTagEnd = el.sourceCodeLocation!.startTag!.endOffset - 1;\n        output.push(sourceHtml.slice(htmlOffset, posBeforeStartTagEnd), ` id=\"mdt-${hash}\"`);\n        htmlOffset = posBeforeStartTagEnd;\n        toc.push({\n          level: 0,\n          tag: nodeName,\n          text: lookupTextNodeIn(el),\n          id: hash\n        });\n      } else if (el.childNodes) {\n        chr.next(el.childNodes);\n      }\n    })\n  ).subscribe();\n\n  output.push(sourceHtml.slice(htmlOffset));\n\n  return rx.from(output).pipe(\n    rx.concatMap(item => typeof item === 'string' ? rx.of(JSON.stringify(item)) : item == null ? ' + img + ' : item),\n    rx.reduce<string, string[]>((acc, item) => {\n      acc.push(item);\n      return acc;\n    }, []),\n    rx.map(frags => [frags.join(' + '), toc, mermaidCode] as const)\n  );\n}\n"]}