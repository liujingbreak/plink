{"version":3,"file":"markdown-util.js","sourceRoot":"","sources":["markdown-util.ts"],"names":[],"mappings":";;;;AAAA,wDAAwB;AACxB,wDAAwB;AACxB,oDAAoB;AACpB,iDAA2B;AAC3B,2DAAqC;AACrC,kEAA8C;AAC9C,sCAAoC;AACpC,8FAAiF;AACjF,4DAAuB;AACvB,4DAA4D;AAE5D,MAAM,GAAG,GAAG,IAAA,gBAAQ,EAAC,UAAU,CAAC,CAAC;AAEjC,IAAI,UAAgB,CAAC;AACrB,MAAM,SAAS,GAAG,IAAI,GAAG,CAAS,gBAAgB,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;AAE/D;;;;GAIG;AACH,SAAgB,cAAc,CAAC,MAAc,EAAE,YAA0E;IAEvH,IAAI,UAAU,IAAI,IAAI,EAAE;QACtB,UAAU,GAAG,IAAI,0BAAI,EAAE,CAAC;KACzB;IAED,OAAO,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,MAAM,CAAS;QACvC,IAAI,EAAE,cAAI,CAAC,OAAO,CAAC,SAAS,EAAE,2BAA2B,CAAC,EAAE,QAAQ,EAAE,aAAa,EAAE,IAAI,EAAE,CAAC,MAAM,CAAC;KACpG,CAAC,CAAC,CAAC,IAAI,CACN,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE;QACjB,IAAI,GAAG,GAAU,EAAE,CAAC;QACpB,MAAM,GAAG,GAAG,gBAAM,CAAC,KAAK,CAAC,IAAI,EAAE,EAAC,sBAAsB,EAAE,IAAI,EAAC,CAAC,CAAC;QAC/D,MAAM,IAAI,GAAG,gBAAgB,CAAC,GAAG,EAAE,YAAY,EAAE,GAAG,CAAC,CAAC;QAEtD,GAAG,GAAG,aAAa,CAAC,GAAG,CAAC,CAAC;QACzB,OAAO,EAAE,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,CAAC,IAAI,CAC3B,EAAE,CAAC,MAAM,CAAmC,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE;YACxD,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACf,OAAO,GAAG,CAAC;QACb,CAAC,EAAE,EAAsB,CAAC,EAC1B,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE;YACX,MAAM,OAAO,GAAG,IAAA,oBAAW,EAAC,IAAI,EAAE,GAAG,CAAC,CAAC;YACvC,qCAAqC;YACrC,OAAO,EAAC,GAAG,EAAE,OAAO,EAAC,CAAC;QACxB,CAAC,CAAC,EACF,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;YAClB,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YACf,gEAAgE;YAChE,OAAO,EAAE,CAAC,EAAE,CAAC,EAAC,GAAG,EAAE,OAAO,EAAE,MAAM,EAAC,CAAC,CAAC;QACvC,CAAC,CAAC,CACH,CAAC;IACJ,CAAC,CAAC,CACH,CAAC;AACJ,CAAC;AAjCD,wCAiCC;AAED,SAAS,gBAAgB,CAAC,IAAqB,EAAE,YAA0E,EACzH,MAAa,EAAE;IACf,MAAM,GAAG,GAAG,IAAI,EAAE,CAAC,eAAe,CAAc,IAAI,CAAC,UAAU,IAAI,EAAE,CAAC,CAAC;IACvE,MAAM,IAAI,GAAsC,EAAE,CAAC;IAEnD,GAAG,CAAC,IAAI,CACN,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAC3C,CAAC,IAAI,CACJ,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE;QACZ,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;QAC7C,IAAI,QAAQ,KAAK,OAAO,IAAI,QAAQ,KAAK,UAAU,IAAI,QAAQ,KAAK,eAAe;YACjF,OAAO;QACT,MAAM,EAAE,GAAG,IAAe,CAAC;QAC3B,IAAI,QAAQ,KAAK,KAAK,EAAE;YACtB,MAAM,MAAM,GAAG,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,KAAK,CAAC,CAAC;YAC1D,IAAI,YAAY,IAAI,MAAM,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE;gBACjG,GAAG,CAAC,IAAI,CAAC,gBAAgB,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC;gBAC1C,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;qBAC1C,IAAI,CACH,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;oBAChB,MAAM,MAAM,GAAG,EAAE,CAAC,kBAAmB,CAAC,KAAM,CAAC,GAAG,CAAC;oBACjD,GAAG,CAAC,IAAI,CAAC,WAAW,MAAM,CAAC,KAAK,OAAO,cAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;oBACjE,OAAO,EAAC,KAAK,EAAE,MAAM,CAAC,WAAW,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,GAAG,EAAE,MAAM,CAAC,SAAS,EAAE,IAAI,EAAE,QAAQ,EAAC,CAAC;gBAC/F,CAAC,CAAC,CACH,CAAC,CAAC;aACN;SACF;aAAM,IAAI,SAAS,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE;YAClC,GAAG,CAAC,IAAI,CAAC,EAAC,KAAK,EAAE,CAAC,EAAE,GAAG,EAAE,QAAQ;gBAC/B,IAAI,EAAE,gBAAgB,CAAC,EAAE,CAAC;gBAC1B,EAAE,EAAE,EAAE;aACP,CAAC,CAAC;SACJ;QAED,IAAI,EAAE,CAAC,UAAU;YACf,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,CAAC;IAC5B,CAAC,CAAC,CACH,CAAC,SAAS,EAAE,CAAC;IACd,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAS,gBAAgB,CAAC,EAAW;IACnC,MAAM,GAAG,GAAG,IAAI,EAAE,CAAC,eAAe,CAAc,EAAE,CAAC,UAAU,IAAI,EAAE,CAAC,CAAC;IACrE,IAAI,IAAI,GAAG,EAAE,CAAC;IACd,GAAG,CAAC,IAAI,CACN,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAC3C,CAAC,IAAI,CACJ,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE;QACZ,IAAI,IAAI,CAAC,QAAQ,KAAK,OAAO,EAAE;YAC7B,IAAI,IAAK,IAAiB,CAAC,KAAK,CAAC;SAClC;aAAM,IAAK,IAAgB,CAAC,UAAU,EAAE;YACvC,GAAG,CAAC,IAAI,CAAE,IAAgB,CAAC,UAAU,CAAC,CAAC;SACxC;IACH,CAAC,CAAC,CACH,CAAC,SAAS,EAAE,CAAC;IACd,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAS,aAAa,CAAC,KAAY;IACjC,MAAM,IAAI,GAAQ,EAAC,KAAK,EAAE,CAAC,CAAC,EAAE,GAAG,EAAE,IAAI,EAAE,IAAI,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,QAAQ,EAAE,EAAE,EAAC,CAAC;IACzE,MAAM,OAAO,GAAU,CAAC,IAAI,CAAC,CAAC,CAAC,iDAAiD;IAChF,IAAI,cAAc,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;IAChD,KAAK,MAAM,IAAI,IAAI,KAAK,EAAE;QACxB,MAAM,UAAU,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;QAC9C,gEAAgE;QAChE,IAAI,UAAU,GAAG,cAAc,EAAE;YAC/B,MAAM,IAAI,GAAG,gBAAC,CAAC,aAAa,CAAC,OAAO,EAAE,GAAG,CAAC,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,GAAG,UAAU,CAAC,CAAC;YACrF,OAAO,CAAC,MAAM,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC;YACzB,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,IAAI,CAAC,CAAC;SACjC;aAAM,IAAI,UAAU,KAAK,cAAc,EAAE;YACxC,OAAO,CAAC,GAAG,EAAE,CAAC;YACd,MAAM,MAAM,GAAG,OAAO,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;YAC3C,UAAU,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;SAC1B;aAAM;YACL,MAAM,MAAM,GAAG,OAAO,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;YAC3C,UAAU,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;SAC1B;QACD,cAAc,GAAG,UAAU,CAAC;KAC7B;IAED,SAAS,UAAU,CAAC,MAAW,EAAE,KAAU;QACzC,IAAI,MAAM,CAAC,QAAQ,IAAI,IAAI;YACzB,MAAM,CAAC,QAAQ,GAAG,CAAC,KAAK,CAAC,CAAC;;YAE1B,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC9B,KAAK,CAAC,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QACtF,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IACtB,CAAC;IACD,OAAO,IAAI,CAAC,QAAS,CAAC;AACxB,CAAC;AAED,QAAe,CAAC,CAAC,eAAe,CAAC,IAAW;IAC1C,KAAK,MAAM,IAAI,IAAI,IAAI,EAAE;QACvB,MAAM,IAAI,CAAC;QACX,IAAI,IAAI,CAAC,QAAQ;YACf,KAAK,CAAC,CAAC,eAAe,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;KACzC;AACH,CAAC;AAND,0CAMC;AAED,SAAgB,WAAW,CAAC,IAAW;IACrC,IAAI,GAAG,GAAG,EAAE,CAAC;IACb,KAAK,MAAM,IAAI,IAAI,eAAe,CAAC,IAAI,CAAC,EAAE;QACxC,GAAG,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC/B,eAAe;QACf,GAAG,IAAI,KAAK,IAAI,CAAC,IAAI,EAAE,CAAC;QACxB,GAAG,IAAI,YAAE,CAAC,GAAG,CAAC;KACf;IACD,OAAO,GAAG,CAAC;AACb,CAAC;AATD,kCASC;AAED,SAAgB,yBAAyB,CAAC,KAAa;IACrD,OAAO,cAAc,CAAC,KAAK,CAAC,CAAC,IAAI,CAC/B,EAAE,CAAC,GAAG,CAAC,CAAC,EAAC,GAAG,EAAE,OAAO,EAAE,IAAI,EAAC,EAAE,EAAE;QAC9B,MAAM,MAAM,GAAG,WAAW,CAAC,GAAG,CAAC,CAAC;QAChC,MAAM,KAAK,GAAG,6BAA6B,CAAC;QAC5C,MAAM,GAAG,GAAG,iCAAiC,CAAC;QAC9C,MAAM,QAAQ,GAAG,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QACtC,IAAI,SAAS,GAAG,EAAE,CAAC;QACnB,IAAI,QAAQ,IAAI,CAAC,EAAE;YACjB,MAAM,UAAU,GAAG,QAAQ,GAAG,KAAK,CAAC,MAAM,CAAC;YAC3C,MAAM,UAAU,GAAG,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YACtC,SAAS,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,EAAE,UAAU,CAAC,GAAG,IAAI,GAAG,MAAM,GAAG,IAAI,GAAG,KAAK,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;SACzF;aAAM;YACL,SAAS,GAAG,CAAC,KAAK,EAAE,MAAM,EAAE,GAAG,EAAE,KAAK,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SACpD;QACD,OAAO,EAAC,SAAS,EAAE,GAAG,EAAE,WAAW,CAAC,GAAG,CAAC,EAAE,IAAI,EAAC,CAAC;IAClD,CAAC,CAAC,EACF,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,CACX,CAAC,SAAS,EAAE,CAAC;AAChB,CAAC;AAnBD,8DAmBC;AAED,SAAS,WAAW,CAAC,IAAW;IAC9B,IAAI,GAAG,GAAG,EAAE,CAAC;IACb,IAAI,CAAC,GAAG,CAAC,CAAC;IACV,KAAK,MAAM,IAAI,IAAI,eAAe,CAAC,IAAI,CAAC,EAAE;QACxC,IAAI,IAAI,CAAC,KAAK,GAAG,CAAC;YAChB,SAAS,CAAC,iCAAiC;QAC7C,GAAG,IAAI,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC/B,GAAG,IAAI,GAAG,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,YAAE,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,IAAI,IAAI,CAAC,IAAI,EAAE,CAAC;QACpE,GAAG,IAAI,YAAE,CAAC,GAAG,CAAC;QACd,CAAC,EAAE,CAAC;KACL;IACD,OAAO,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;AAC1B,CAAC","sourcesContent":["import path from 'path';\nimport util from 'util';\nimport os from 'os';\nimport * as rx from 'rxjs';\nimport * as op from 'rxjs/operators';\nimport {Pool} from '@wfh/thread-promise-pool';\nimport {log4File} from '@wfh/plink';\nimport replaceCode, {ReplacementInf} from '@wfh/plink/wfh/dist/utils/patch-text';\nimport _ from 'lodash';\nimport parse5, {ChildNode, Element, TextNode} from 'parse5';\nimport {TOC} from '../isom/md-types';\nconst log = log4File(__filename);\n\nlet threadPool: Pool;\nconst headerSet = new Set<string>('h1 h2 h3 h4 h5'.split(' '));\n\n/**\n * Use Thread pool to parse Markdown file simultaneously\n * @param source \n * @param resolveImage \n */\nexport function markdownToHtml(source: string, resolveImage?: (imgSrc: string) => Promise<string> | rx.Observable<string>):\nrx.Observable<{toc: TOC[]; content: string}> {\n  if (threadPool == null) {\n    threadPool = new Pool();\n  }\n\n  return rx.from(threadPool.submit<string>({\n    file: path.resolve(__dirname, 'markdown-loader-worker.js'), exportFn: 'parseToHtml', args: [source]\n  })).pipe(\n    op.mergeMap(html => {\n      let toc: TOC[] = [];\n      const doc = parse5.parse(html, {sourceCodeLocationInfo: true});\n      const done = dfsAccessElement(doc, resolveImage, toc);\n\n      toc = createTocTree(toc);\n      return rx.merge(...done).pipe(\n        op.reduce<ReplacementInf, ReplacementInf[]>((acc, item) => {\n          acc.push(item);\n          return acc;\n        }, [] as ReplacementInf[]),\n        op.map(all => {\n          const content = replaceCode(html, all);\n          // log.warn(html, '\\n=>\\n', content);\n          return {toc, content};\n        }),\n        op.catchError(err => {\n          log.error(err);\n          // cb(err, JSON.stringify({ toc, content: source }), sourceMap);\n          return rx.of({toc, content: source});\n        })\n      );\n    })\n  );\n}\n\nfunction dfsAccessElement(root: parse5.Document, resolveImage?: (imgSrc: string) => Promise<string> | rx.Observable<string>,\n  toc: TOC[] = []) {\n  const chr = new rx.BehaviorSubject<ChildNode[]>(root.childNodes || []);\n  const done: (rx.Observable<ReplacementInf>)[] = [];\n\n  chr.pipe(\n    op.mergeMap(children => rx.from(children))\n  ).pipe(\n    op.map(node => {\n      const nodeName = node.nodeName.toLowerCase();\n      if (nodeName === '#text' || nodeName === '#comment' || nodeName === '#documentType')\n        return;\n      const el = node as Element;\n      if (nodeName === 'img') {\n        const imgSrc = el.attrs.find(item => item.name === 'src');\n        if (resolveImage && imgSrc && !imgSrc.value.startsWith('/') && !/^https?:\\/\\//.test(imgSrc.value)) {\n          log.info('found img src=' + imgSrc.value);\n          done.push(rx.from(resolveImage(imgSrc.value))\n            .pipe(\n              op.map(resolved => {\n                const srcPos = el.sourceCodeLocation!.attrs!.src;\n                log.info(`resolve ${imgSrc.value} to ${util.inspect(resolved)}`);\n                return {start: srcPos.startOffset + 'src'.length + 1, end: srcPos.endOffset, text: resolved};\n              })\n            ));\n        }\n      } else if (headerSet.has(nodeName)) {\n        toc.push({level: 0, tag: nodeName,\n          text: lookupTextNodeIn(el),\n          id: ''\n        });\n      }\n\n      if (el.childNodes)\n        chr.next(el.childNodes);\n    })\n  ).subscribe();\n  return done;\n}\n\nfunction lookupTextNodeIn(el: Element) {\n  const chr = new rx.BehaviorSubject<ChildNode[]>(el.childNodes || []);\n  let text = '';\n  chr.pipe(\n    op.mergeMap(children => rx.from(children))\n  ).pipe(\n    op.map(node => {\n      if (node.nodeName === '#text') {\n        text += (node as TextNode).value;\n      } else if ((node as Element).childNodes) {\n        chr.next((node as Element).childNodes);\n      }\n    })\n  ).subscribe();\n  return text;\n}\n\nfunction createTocTree(input: TOC[]) {\n  const root: TOC = {level: -1, tag: 'h0', text: '', id: '', children: []};\n  const byLevel: TOC[] = [root]; // a stack of previous TOC items ordered by level\n  let prevHeaderSize = Number(root.tag.charAt(1));\n  for (const item of input) {\n    const headerSize = Number(item.tag.charAt(1));\n    // console.log(`${headerSize} ${prevHeaderSize}, ${item.text}`);\n    if (headerSize < prevHeaderSize) {\n      const pIdx = _.findLastIndex(byLevel, toc => Number(toc.tag.charAt(1)) < headerSize);\n      byLevel.splice(pIdx + 1);\n      addAsChild(byLevel[pIdx], item);\n    } else if (headerSize === prevHeaderSize) {\n      byLevel.pop();\n      const parent = byLevel[byLevel.length - 1];\n      addAsChild(parent, item);\n    } else {\n      const parent = byLevel[byLevel.length - 1];\n      addAsChild(parent, item);\n    }\n    prevHeaderSize = headerSize;\n  }\n\n  function addAsChild(parent: TOC, child: TOC) {\n    if (parent.children == null)\n      parent.children = [child];\n    else\n      parent.children.push(child);\n    child.level = byLevel[byLevel.length - 1] ? byLevel[byLevel.length - 1].level + 1 : 0;\n    byLevel.push(child);\n  }\n  return root.children!;\n}\n\nexport function* traverseTocTree(tocs: TOC[]): Generator<TOC> {\n  for (const item of tocs) {\n    yield item;\n    if (item.children)\n      yield* traverseTocTree(item.children);\n  }\n}\n\nexport function tocToString(tocs: TOC[]) {\n  let str = '';\n  for (const item of traverseTocTree(tocs)) {\n    str += ' |'.repeat(item.level);\n    // str += '- ';\n    str += `- ${item.text}`;\n    str += os.EOL;\n  }\n  return str;\n}\n\nexport function insertOrUpdateMarkdownToc(input: string) {\n  return markdownToHtml(input).pipe(\n    op.map(({toc, content: html}) => {\n      const tocStr = tocMarkdown(toc);\n      const BEGIN = '<!-- Plink markdown toc -->';\n      const END = '<!-- Plink markdown toc end -->';\n      const existing = input.indexOf(BEGIN);\n      let changedMd = '';\n      if (existing >= 0) {\n        const replacePos = existing + BEGIN.length;\n        const replaceEnd = input.indexOf(END);\n        changedMd = input.slice(0, replacePos) + '\\n' + tocStr + '\\n' + input.slice(replaceEnd);\n      } else {\n        changedMd = [BEGIN, tocStr, END, input].join('\\n');\n      }\n      return {changedMd, toc: tocToString(toc), html};\n    }),\n    op.take(1)\n  ).toPromise();\n}\n\nfunction tocMarkdown(tocs: TOC[]) {\n  let str = '';\n  let i = 0;\n  for (const item of traverseTocTree(tocs)) {\n    if (item.level > 2)\n      continue; // only show title of level 0 - 2\n    str += '  '.repeat(item.level);\n    str += `${item.level > 0 ? '-' : i > 0 ? os.EOL : ''} ${item.text}`;\n    str += os.EOL;\n    i++;\n  }\n  return str.slice(0, -1);\n}\n"]}