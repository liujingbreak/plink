"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.insertOrUpdateMarkdownToc = exports.tocToString = exports.traverseTocTree = exports.markdownToHtml = void 0;
const rx = __importStar(require("rxjs"));
const op = __importStar(require("rxjs/operators"));
const thread_promise_pool_1 = require("@wfh/thread-promise-pool");
const path_1 = __importDefault(require("path"));
const plink_1 = require("@wfh/plink");
const patch_text_1 = __importDefault(require("@wfh/plink/wfh/dist/utils/patch-text"));
const util_1 = __importDefault(require("util"));
const lodash_1 = __importDefault(require("lodash"));
const parse5_1 = __importDefault(require("parse5"));
const os_1 = __importDefault(require("os"));
const log = (0, plink_1.log4File)(__filename);
let threadPool;
const headerSet = new Set('h1 h2 h3 h4 h5'.split(' '));
/**
 * Use Thread pool to parse Markdown file simultaneously
 * @param source
 * @param resolveImage
 */
function markdownToHtml(source, resolveImage) {
    if (threadPool == null) {
        threadPool = new thread_promise_pool_1.Pool();
    }
    return rx.from(threadPool.submit({
        file: path_1.default.resolve(__dirname, 'markdown-loader-worker.js'), exportFn: 'parseToHtml', args: [source]
    })).pipe(op.mergeMap(html => {
        let toc = [];
        const doc = parse5_1.default.parse(html, { sourceCodeLocationInfo: true });
        const done = dfsAccessElement(doc, resolveImage, toc);
        toc = createTocTree(toc);
        return rx.merge(...done).pipe(op.reduce((acc, item) => {
            acc.push(item);
            return acc;
        }, []), op.map(all => {
            const content = (0, patch_text_1.default)(html, all);
            // log.warn(html, '\n=>\n', content);
            return { toc, content };
        }), op.catchError(err => {
            log.error(err);
            // cb(err, JSON.stringify({ toc, content: source }), sourceMap);
            return rx.of({ toc, content: source });
        }));
    }));
}
exports.markdownToHtml = markdownToHtml;
function dfsAccessElement(root, resolveImage, toc = []) {
    const chr = new rx.BehaviorSubject(root.childNodes || []);
    const done = [];
    chr.pipe(op.mergeMap(children => rx.from(children))).pipe(op.map(node => {
        const nodeName = node.nodeName.toLowerCase();
        if (nodeName === '#text' || nodeName === '#comment' || nodeName === '#documentType')
            return;
        const el = node;
        if (nodeName === 'img') {
            const imgSrc = el.attrs.find(item => item.name === 'src');
            if (resolveImage && imgSrc && !imgSrc.value.startsWith('/') && !/^https?:\/\//.test(imgSrc.value)) {
                log.info('found img src=' + imgSrc.value);
                done.push(rx.from(resolveImage(imgSrc.value))
                    .pipe(op.map(resolved => {
                    const srcPos = el.sourceCodeLocation.attrs.src;
                    log.info(`resolve ${imgSrc.value} to ${util_1.default.inspect(resolved)}`);
                    return { start: srcPos.startOffset + 'src'.length + 1, end: srcPos.endOffset, text: resolved };
                })));
            }
        }
        else if (headerSet.has(nodeName)) {
            toc.push({ level: 0, tag: nodeName,
                text: lookupTextNodeIn(el),
                id: ''
            });
        }
        if (el.childNodes)
            chr.next(el.childNodes);
    })).subscribe();
    return done;
}
function lookupTextNodeIn(el) {
    const chr = new rx.BehaviorSubject(el.childNodes || []);
    let text = '';
    chr.pipe(op.mergeMap(children => rx.from(children))).pipe(op.map(node => {
        if (node.nodeName === '#text') {
            text += node.value;
        }
        else if (node.childNodes) {
            chr.next(node.childNodes);
        }
    })).subscribe();
    return text;
}
function createTocTree(input) {
    const root = { level: -1, tag: 'h0', text: '', id: '', children: [] };
    let byLevel = [root]; // a stack of previous TOC items ordered by level
    let prevHeaderSize = Number(root.tag.charAt(1));
    for (const item of input) {
        const headerSize = Number(item.tag.charAt(1));
        // console.log(`${headerSize} ${prevHeaderSize}, ${item.text}`);
        if (headerSize < prevHeaderSize) {
            const pIdx = lodash_1.default.findLastIndex(byLevel, toc => Number(toc.tag.charAt(1)) < headerSize);
            byLevel.splice(pIdx + 1);
            addAsChild(byLevel[pIdx], item);
        }
        else if (headerSize === prevHeaderSize) {
            byLevel.pop();
            const parent = byLevel[byLevel.length - 1];
            addAsChild(parent, item);
        }
        else {
            const parent = byLevel[byLevel.length - 1];
            addAsChild(parent, item);
        }
        prevHeaderSize = headerSize;
    }
    function addAsChild(parent, child) {
        if (parent.children == null)
            parent.children = [child];
        else
            parent.children.push(child);
        child.level = byLevel[byLevel.length - 1] ? byLevel[byLevel.length - 1].level + 1 : 0;
        byLevel.push(child);
    }
    return root.children;
}
function* traverseTocTree(tocs) {
    for (const item of tocs) {
        yield item;
        if (item.children)
            yield* traverseTocTree(item.children);
    }
}
exports.traverseTocTree = traverseTocTree;
function tocToString(tocs) {
    let str = '';
    for (const item of traverseTocTree(tocs)) {
        str += ' |'.repeat(item.level);
        // str += '- ';
        str += `- ${item.text}`;
        str += os_1.default.EOL;
    }
    return str;
}
exports.tocToString = tocToString;
function insertOrUpdateMarkdownToc(input) {
    return markdownToHtml(input).pipe(op.map(({ toc, content: html }) => {
        const tocStr = tocMarkdown(toc);
        const BEGIN = '<!-- Plink markdown toc -->';
        const END = '<!-- Plink markdown toc end -->';
        const existing = input.indexOf(BEGIN);
        let changedMd = '';
        if (existing >= 0) {
            let replacePos = existing + BEGIN.length;
            const replaceEnd = input.indexOf(END);
            changedMd = input.slice(0, replacePos) + '\n' + tocStr + '\n' + input.slice(replaceEnd);
        }
        else {
            changedMd = [BEGIN, tocStr, END, input].join('\n');
        }
        return { changedMd, toc: tocToString(toc), html };
    }), op.take(1)).toPromise();
}
exports.insertOrUpdateMarkdownToc = insertOrUpdateMarkdownToc;
function tocMarkdown(tocs) {
    let str = '';
    for (const item of traverseTocTree(tocs)) {
        if (item.level > 2)
            continue;
        str += '  '.repeat(item.level);
        str += `${item.level > 0 ? '-' : ''} ${item.text}${item.level > 0 ? '' : os_1.default.EOL}`;
        str += '\n';
    }
    return str.slice(0, -1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2Rvd24tdXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcmtkb3duLXV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHlDQUEyQjtBQUMzQixtREFBcUM7QUFDckMsa0VBQThDO0FBRTlDLGdEQUF3QjtBQUN4QixzQ0FBb0M7QUFDcEMsc0ZBQWlGO0FBQ2pGLGdEQUF3QjtBQUN4QixvREFBdUI7QUFDdkIsb0RBQTREO0FBQzVELDRDQUFvQjtBQUNwQixNQUFNLEdBQUcsR0FBRyxJQUFBLGdCQUFRLEVBQUMsVUFBVSxDQUFDLENBQUM7QUFFakMsSUFBSSxVQUFnQixDQUFDO0FBQ3JCLE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxDQUFTLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBRS9EOzs7O0dBSUc7QUFDSCxTQUFnQixjQUFjLENBQUMsTUFBYyxFQUFFLFlBQTBFO0lBRXZILElBQUksVUFBVSxJQUFJLElBQUksRUFBRTtRQUN0QixVQUFVLEdBQUcsSUFBSSwwQkFBSSxFQUFFLENBQUM7S0FDekI7SUFFRCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBUztRQUN2QyxJQUFJLEVBQUUsY0FBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsMkJBQTJCLENBQUMsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQztLQUNwRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ04sRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNqQixJQUFJLEdBQUcsR0FBVSxFQUFFLENBQUM7UUFDcEIsTUFBTSxHQUFHLEdBQUcsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEVBQUMsc0JBQXNCLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUMvRCxNQUFNLElBQUks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cyBvcCBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1Bvb2x9IGZyb20gJ0B3ZmgvdGhyZWFkLXByb21pc2UtcG9vbCc7XG5pbXBvcnQge1RPQ30gZnJvbSAnLi4vaXNvbS9tZC10eXBlcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7bG9nNEZpbGV9IGZyb20gJ0B3ZmgvcGxpbmsnO1xuaW1wb3J0IHJlcGxhY2VDb2RlLCB7UmVwbGFjZW1lbnRJbmZ9IGZyb20gJ0B3ZmgvcGxpbmsvd2ZoL2Rpc3QvdXRpbHMvcGF0Y2gtdGV4dCc7XG5pbXBvcnQgdXRpbCBmcm9tICd1dGlsJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGFyc2U1LCB7Q2hpbGROb2RlLCBFbGVtZW50LCBUZXh0Tm9kZX0gZnJvbSAncGFyc2U1JztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5jb25zdCBsb2cgPSBsb2c0RmlsZShfX2ZpbGVuYW1lKTtcblxubGV0IHRocmVhZFBvb2w6IFBvb2w7XG5jb25zdCBoZWFkZXJTZXQgPSBuZXcgU2V0PHN0cmluZz4oJ2gxIGgyIGgzIGg0IGg1Jy5zcGxpdCgnICcpKTtcblxuLyoqXG4gKiBVc2UgVGhyZWFkIHBvb2wgdG8gcGFyc2UgTWFya2Rvd24gZmlsZSBzaW11bHRhbmVvdXNseVxuICogQHBhcmFtIHNvdXJjZSBcbiAqIEBwYXJhbSByZXNvbHZlSW1hZ2UgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtYXJrZG93blRvSHRtbChzb3VyY2U6IHN0cmluZywgcmVzb2x2ZUltYWdlPzogKGltZ1NyYzogc3RyaW5nKSA9PiBQcm9taXNlPHN0cmluZz4gfCByeC5PYnNlcnZhYmxlPHN0cmluZz4pOlxuICByeC5PYnNlcnZhYmxlPHt0b2M6IFRPQ1tdOyBjb250ZW50OiBzdHJpbmd9PiB7XG4gIGlmICh0aHJlYWRQb29sID09IG51bGwpIHtcbiAgICB0aHJlYWRQb29sID0gbmV3IFBvb2woKTtcbiAgfVxuXG4gIHJldHVybiByeC5mcm9tKHRocmVhZFBvb2wuc3VibWl0PHN0cmluZz4oe1xuICAgIGZpbGU6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICdtYXJrZG93bi1sb2FkZXItd29ya2VyLmpzJyksIGV4cG9ydEZuOiAncGFyc2VUb0h0bWwnLCBhcmdzOiBbc291cmNlXVxuICB9KSkucGlwZShcbiAgICBvcC5tZXJnZU1hcChodG1sID0+IHtcbiAgICAgIGxldCB0b2M6IFRPQ1tdID0gW107XG4gICAgICBjb25zdCBkb2MgPSBwYXJzZTUucGFyc2UoaHRtbCwge3NvdXJjZUNvZGVMb2NhdGlvbkluZm86IHRydWV9KTtcbiAgICAgIGNvbnN0IGRvbmUgPSBkZnNBY2Nlc3NFbGVtZW50KGRvYywgcmVzb2x2ZUltYWdlLCB0b2MpO1xuXG4gICAgICB0b2MgPSBjcmVhdGVUb2NUcmVlKHRvYyk7XG4gICAgICByZXR1cm4gcngubWVyZ2UoLi4uZG9uZSkucGlwZShcbiAgICAgICAgb3AucmVkdWNlPFJlcGxhY2VtZW50SW5mLCBSZXBsYWNlbWVudEluZltdPigoYWNjLCBpdGVtKSA9PiB7XG4gICAgICAgICAgYWNjLnB1c2goaXRlbSk7XG4gICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSwgW10gYXMgUmVwbGFjZW1lbnRJbmZbXSksXG4gICAgICAgIG9wLm1hcChhbGwgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSByZXBsYWNlQ29kZShodG1sLCBhbGwpO1xuICAgICAgICAgIC8vIGxvZy53YXJuKGh0bWwsICdcXG49PlxcbicsIGNvbnRlbnQpO1xuICAgICAgICAgIHJldHVybiB7IHRvYywgY29udGVudCB9O1xuICAgICAgICB9KSxcbiAgICAgICAgb3AuY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICAgIGxvZy5lcnJvcihlcnIpO1xuICAgICAgICAgIC8vIGNiKGVyciwgSlNPTi5zdHJpbmdpZnkoeyB0b2MsIGNvbnRlbnQ6IHNvdXJjZSB9KSwgc291cmNlTWFwKTtcbiAgICAgICAgICByZXR1cm4gcngub2YoeyB0b2MsIGNvbnRlbnQ6IHNvdXJjZSB9KTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSlcbiAgKTtcbn1cblxuZnVuY3Rpb24gZGZzQWNjZXNzRWxlbWVudChyb290OiBwYXJzZTUuRG9jdW1lbnQsIHJlc29sdmVJbWFnZT86IChpbWdTcmM6IHN0cmluZykgPT4gUHJvbWlzZTxzdHJpbmc+IHwgcnguT2JzZXJ2YWJsZTxzdHJpbmc+LFxudG9jOiBUT0NbXSA9IFtdKSB7XG4gIGNvbnN0IGNociA9IG5ldyByeC5CZWhhdmlvclN1YmplY3Q8Q2hpbGROb2RlW10+KHJvb3QuY2hpbGROb2RlcyB8fCBbXSk7XG4gIGNvbnN0IGRvbmU6IChyeC5PYnNlcnZhYmxlPFJlcGxhY2VtZW50SW5mPilbXSA9IFtdO1xuXG4gIGNoci5waXBlKFxuICAgIG9wLm1lcmdlTWFwKGNoaWxkcmVuID0+IHJ4LmZyb20oY2hpbGRyZW4pKVxuICApLnBpcGUoXG4gICAgb3AubWFwKG5vZGUgPT4ge1xuICAgICAgY29uc3Qgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICBpZiAobm9kZU5hbWUgPT09ICcjdGV4dCcgfHwgbm9kZU5hbWUgPT09ICcjY29tbWVudCcgfHwgbm9kZU5hbWUgPT09ICcjZG9jdW1lbnRUeXBlJylcbiAgICAgICAgcmV0dXJuO1xuICAgICAgY29uc3QgZWwgPSBub2RlIGFzIEVsZW1lbnQ7XG4gICAgICBpZiAobm9kZU5hbWUgPT09ICdpbWcnKSB7XG4gICAgICAgIGNvbnN0IGltZ1NyYyA9IGVsLmF0dHJzLmZpbmQoaXRlbSA9PiBpdGVtLm5hbWUgPT09ICdzcmMnKTtcbiAgICAgICAgaWYgKHJlc29sdmVJbWFnZSAmJiBpbWdTcmMgJiYgIWltZ1NyYy52YWx1ZS5zdGFydHNXaXRoKCcvJykgJiYgIS9eaHR0cHM/OlxcL1xcLy8udGVzdChpbWdTcmMudmFsdWUpKSB7XG4gICAgICAgICAgbG9nLmluZm8oJ2ZvdW5kIGltZyBzcmM9JyArIGltZ1NyYy52YWx1ZSk7XG4gICAgICAgICAgZG9uZS5wdXNoKHJ4LmZyb20ocmVzb2x2ZUltYWdlKGltZ1NyYy52YWx1ZSkpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBvcC5tYXAocmVzb2x2ZWQgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBzcmNQb3MgPSBlbC5zb3VyY2VDb2RlTG9jYXRpb24hLmF0dHJzLnNyYztcbiAgICAgICAgICAgICAgbG9nLmluZm8oYHJlc29sdmUgJHtpbWdTcmMudmFsdWV9IHRvICR7dXRpbC5pbnNwZWN0KHJlc29sdmVkKX1gKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHtzdGFydDogc3JjUG9zLnN0YXJ0T2Zmc2V0ICsgJ3NyYycubGVuZ3RoICsgMSwgZW5kOiBzcmNQb3MuZW5kT2Zmc2V0LCB0ZXh0OiByZXNvbHZlZH07XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICkpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGhlYWRlclNldC5oYXMobm9kZU5hbWUpKSB7XG4gICAgICAgIHRvYy5wdXNoKHtsZXZlbDogMCwgdGFnOiBub2RlTmFtZSxcbiAgICAgICAgICB0ZXh0OiBsb29rdXBUZXh0Tm9kZUluKGVsKSxcbiAgICAgICAgICBpZDogJydcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChlbC5jaGlsZE5vZGVzKVxuICAgICAgICBjaHIubmV4dChlbC5jaGlsZE5vZGVzKTtcbiAgICB9KVxuICApLnN1YnNjcmliZSgpO1xuICByZXR1cm4gZG9uZTtcbn1cblxuZnVuY3Rpb24gbG9va3VwVGV4dE5vZGVJbihlbDogRWxlbWVudCkge1xuICBjb25zdCBjaHIgPSBuZXcgcnguQmVoYXZpb3JTdWJqZWN0PENoaWxkTm9kZVtdPihlbC5jaGlsZE5vZGVzIHx8IFtdKTtcbiAgbGV0IHRleHQgPSAnJztcbiAgY2hyLnBpcGUoXG4gICAgb3AubWVyZ2VNYXAoY2hpbGRyZW4gPT4gcnguZnJvbShjaGlsZHJlbikpXG4gICkucGlwZShcbiAgICBvcC5tYXAobm9kZSA9PiB7XG4gICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gJyN0ZXh0Jykge1xuICAgICAgICB0ZXh0ICs9IChub2RlIGFzIFRleHROb2RlKS52YWx1ZTtcbiAgICAgIH0gZWxzZSBpZiAoKG5vZGUgYXMgRWxlbWVudCkuY2hpbGROb2Rlcykge1xuICAgICAgICBjaHIubmV4dCgobm9kZSBhcyBFbGVtZW50KS5jaGlsZE5vZGVzKTtcbiAgICAgIH1cbiAgICB9KVxuICApLnN1YnNjcmliZSgpO1xuICByZXR1cm4gdGV4dDtcbn1cblxuZnVuY3Rpb24gY3JlYXRlVG9jVHJlZShpbnB1dDogVE9DW10pIHtcbiAgY29uc3Qgcm9vdDogVE9DID0ge2xldmVsOiAtMSwgdGFnOiAnaDAnLCB0ZXh0OiAnJywgaWQ6ICcnLCBjaGlsZHJlbjogW119O1xuICBsZXQgYnlMZXZlbDogVE9DW10gPSBbcm9vdF07IC8vIGEgc3RhY2sgb2YgcHJldmlvdXMgVE9DIGl0ZW1zIG9yZGVyZWQgYnkgbGV2ZWxcbiAgbGV0IHByZXZIZWFkZXJTaXplID0gTnVtYmVyKHJvb3QudGFnLmNoYXJBdCgxKSk7XG4gIGZvciAoY29uc3QgaXRlbSBvZiBpbnB1dCkge1xuICAgIGNvbnN0IGhlYWRlclNpemUgPSBOdW1iZXIoaXRlbS50YWcuY2hhckF0KDEpKTtcbiAgICAvLyBjb25zb2xlLmxvZyhgJHtoZWFkZXJTaXplfSAke3ByZXZIZWFkZXJTaXplfSwgJHtpdGVtLnRleHR9YCk7XG4gICAgaWYgKGhlYWRlclNpemUgPCBwcmV2SGVhZGVyU2l6ZSkge1xuICAgICAgY29uc3QgcElkeCA9IF8uZmluZExhc3RJbmRleChieUxldmVsLCB0b2MgPT4gTnVtYmVyKHRvYy50YWcuY2hhckF0KDEpKSA8IGhlYWRlclNpemUpO1xuICAgICAgYnlMZXZlbC5zcGxpY2UocElkeCArIDEpO1xuICAgICAgYWRkQXNDaGlsZChieUxldmVsW3BJZHhdLCBpdGVtKTtcbiAgICB9IGVsc2UgaWYgKGhlYWRlclNpemUgPT09IHByZXZIZWFkZXJTaXplKSB7XG4gICAgICBieUxldmVsLnBvcCgpO1xuICAgICAgY29uc3QgcGFyZW50ID0gYnlMZXZlbFtieUxldmVsLmxlbmd0aCAtIDFdO1xuICAgICAgYWRkQXNDaGlsZChwYXJlbnQsIGl0ZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSBieUxldmVsW2J5TGV2ZWwubGVuZ3RoIC0gMV07XG4gICAgICBhZGRBc0NoaWxkKHBhcmVudCwgaXRlbSk7XG4gICAgfVxuICAgIHByZXZIZWFkZXJTaXplID0gaGVhZGVyU2l6ZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGFkZEFzQ2hpbGQocGFyZW50OiBUT0MsIGNoaWxkOiBUT0MpIHtcbiAgICBpZiAocGFyZW50LmNoaWxkcmVuID09IG51bGwpXG4gICAgICBwYXJlbnQuY2hpbGRyZW4gPSBbY2hpbGRdO1xuICAgIGVsc2VcbiAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKGNoaWxkKTtcbiAgICBjaGlsZC5sZXZlbCA9IGJ5TGV2ZWxbYnlMZXZlbC5sZW5ndGggLSAxXSA/IGJ5TGV2ZWxbYnlMZXZlbC5sZW5ndGggLSAxXS5sZXZlbCArIDEgOiAwO1xuICAgIGJ5TGV2ZWwucHVzaChjaGlsZCk7XG4gIH1cbiAgcmV0dXJuIHJvb3QuY2hpbGRyZW4hO1xufVxuXG5leHBvcnQgZnVuY3Rpb24qIHRyYXZlcnNlVG9jVHJlZSh0b2NzOiBUT0NbXSk6IEdlbmVyYXRvcjxUT0M+IHtcbiAgZm9yIChjb25zdCBpdGVtIG9mIHRvY3MpIHtcbiAgICB5aWVsZCBpdGVtO1xuICAgIGlmIChpdGVtLmNoaWxkcmVuKVxuICAgICAgeWllbGQqIHRyYXZlcnNlVG9jVHJlZShpdGVtLmNoaWxkcmVuKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdG9jVG9TdHJpbmcodG9jczogVE9DW10pIHtcbiAgbGV0IHN0ciA9ICcnO1xuICBmb3IgKGNvbnN0IGl0ZW0gb2YgdHJhdmVyc2VUb2NUcmVlKHRvY3MpKSB7XG4gICAgc3RyICs9ICcgfCcucmVwZWF0KGl0ZW0ubGV2ZWwpO1xuICAgIC8vIHN0ciArPSAnLSAnO1xuICAgIHN0ciArPSBgLSAke2l0ZW0udGV4dH1gO1xuICAgIHN0ciArPSBvcy5FT0w7XG4gIH1cbiAgcmV0dXJuIHN0cjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluc2VydE9yVXBkYXRlTWFya2Rvd25Ub2MoaW5wdXQ6IHN0cmluZykge1xuICByZXR1cm4gbWFya2Rvd25Ub0h0bWwoaW5wdXQpLnBpcGUoXG4gICAgb3AubWFwKCh7dG9jLCBjb250ZW50OiBodG1sfSkgPT4ge1xuICAgICAgY29uc3QgdG9jU3RyID0gdG9jTWFya2Rvd24odG9jKTtcbiAgICAgIGNvbnN0IEJFR0lOID0gJzwhLS0gUGxpbmsgbWFya2Rvd24gdG9jIC0tPic7XG4gICAgICBjb25zdCBFTkQgPSAnPCEtLSBQbGluayBtYXJrZG93biB0b2MgZW5kIC0tPic7XG4gICAgICBjb25zdCBleGlzdGluZyA9IGlucHV0LmluZGV4T2YoQkVHSU4pO1xuICAgICAgbGV0IGNoYW5nZWRNZCA9ICcnO1xuICAgICAgaWYgKGV4aXN0aW5nID49IDApIHtcbiAgICAgICAgbGV0IHJlcGxhY2VQb3MgPSBleGlzdGluZyArIEJFR0lOLmxlbmd0aDtcbiAgICAgICAgY29uc3QgcmVwbGFjZUVuZCA9IGlucHV0LmluZGV4T2YoRU5EKTtcbiAgICAgICAgY2hhbmdlZE1kID0gaW5wdXQuc2xpY2UoMCwgcmVwbGFjZVBvcykgKyAnXFxuJyArIHRvY1N0ciArICdcXG4nICsgaW5wdXQuc2xpY2UocmVwbGFjZUVuZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjaGFuZ2VkTWQgPSBbQkVHSU4gLCB0b2NTdHIsIEVORCwgaW5wdXRdLmpvaW4oJ1xcbicpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsgY2hhbmdlZE1kLCB0b2M6IHRvY1RvU3RyaW5nKHRvYyksIGh0bWwgfTtcbiAgICB9KSxcbiAgICBvcC50YWtlKDEpXG4gICkudG9Qcm9taXNlKCk7XG59XG5cbmZ1bmN0aW9uIHRvY01hcmtkb3duKHRvY3M6IFRPQ1tdKSB7XG4gIGxldCBzdHIgPSAnJztcbiAgZm9yIChjb25zdCBpdGVtIG9mIHRyYXZlcnNlVG9jVHJlZSh0b2NzKSkge1xuICAgIGlmIChpdGVtLmxldmVsID4gMilcbiAgICAgIGNvbnRpbnVlO1xuICAgIHN0ciArPSAnICAnLnJlcGVhdChpdGVtLmxldmVsKTtcbiAgICBzdHIgKz0gYCR7aXRlbS5sZXZlbCA+IDAgPyAnLScgOiAnJ30gJHtpdGVtLnRleHR9JHtpdGVtLmxldmVsID4gMCA/ICcnIDogb3MuRU9MfWA7XG4gICAgc3RyICs9ICdcXG4nO1xuICB9XG4gIHJldHVybiBzdHIuc2xpY2UoMCwgLTEpO1xufVxuIl19