"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.insertOrUpdateMarkdownToc = exports.tocToString = exports.traverseTocTree = exports.markdownToHtml = void 0;
const rx = __importStar(require("rxjs"));
const op = __importStar(require("rxjs/operators"));
const thread_promise_pool_1 = require("@wfh/thread-promise-pool");
const path_1 = __importDefault(require("path"));
const plink_1 = require("@wfh/plink");
const util_1 = __importDefault(require("util"));
const lodash_1 = __importDefault(require("lodash"));
const parse5_1 = __importDefault(require("parse5"));
const os_1 = __importDefault(require("os"));
const log = (0, plink_1.log4File)(__filename);
let threadPool;
const headerSet = new Set('h1 h2 h3 h4 h5'.split(' '));
/**
 * Use Thread pool to parse Markdown file simultaneously
 * @param source
 * @param resolveImage
 */
function markdownToHtml(source, resolveImage) {
    if (threadPool == null) {
        threadPool = new thread_promise_pool_1.Pool();
    }
    return rx.from(threadPool.submit({
        file: path_1.default.resolve(__dirname, 'markdown-loader-worker.js'), exportFn: 'parseToHtml', args: [source]
    })).pipe(op.mergeMap(html => {
        let toc = [];
        const doc = parse5_1.default.parse(html, { sourceCodeLocationInfo: true });
        const done = dfsAccessElement(doc, resolveImage, toc);
        toc = createTocTree(toc);
        return rx.merge(...done).pipe(op.count(), op.mapTo({ toc, content: html }), op.catchError(err => {
            log.error(err);
            // cb(err, JSON.stringify({ toc, content: source }), sourceMap);
            return rx.of({ toc, content: source });
        }));
    }));
}
exports.markdownToHtml = markdownToHtml;
function dfsAccessElement(root, resolveImage, toc = []) {
    const chr = new rx.BehaviorSubject(root.childNodes || []);
    const done = [];
    chr.pipe(op.mergeMap(children => rx.from(children))).pipe(op.map(node => {
        const nodeName = node.nodeName.toLowerCase();
        if (nodeName === '#text' || nodeName === '#comment' || nodeName === '#documentType')
            return;
        const el = node;
        if (nodeName === 'img') {
            const imgSrc = el.attrs.find(item => item.name === 'src');
            if (resolveImage && imgSrc && !imgSrc.value.startsWith('/') && !/^https?:\/\//.test(imgSrc.value)) {
                log.info('found img src=' + imgSrc.value);
                done.push(rx.from(resolveImage(imgSrc.value))
                    .pipe(op.tap(resolved => {
                    // el.sourceCodeLocation
                    // imgQ.attr('src', resolved);
                    log.info(`resolve ${imgSrc.value} to ${util_1.default.inspect(resolved)}`);
                })));
            }
        }
        else if (headerSet.has(nodeName)) {
            toc.push({ level: 0, tag: nodeName,
                text: lookupTextNodeIn(el),
                id: ''
            });
        }
        if (el.childNodes)
            chr.next(el.childNodes);
    })).subscribe();
    return done;
}
function lookupTextNodeIn(el) {
    const chr = new rx.BehaviorSubject(el.childNodes || []);
    let text = '';
    chr.pipe(op.mergeMap(children => rx.from(children))).pipe(op.map(node => {
        if (node.nodeName === '#text') {
            text += node.value;
        }
        else if (node.childNodes) {
            chr.next(node.childNodes);
        }
    })).subscribe();
    return text;
}
function createTocTree(input) {
    const root = { level: -1, tag: 'h0', text: '', id: '', children: [] };
    let byLevel = [root]; // a stack of previous TOC items ordered by level
    let prevHeaderSize = Number(root.tag.charAt(1));
    for (const item of input) {
        const headerSize = Number(item.tag.charAt(1));
        // console.log(`${headerSize} ${prevHeaderSize}, ${item.text}`);
        if (headerSize < prevHeaderSize) {
            const pIdx = lodash_1.default.findLastIndex(byLevel, toc => Number(toc.tag.charAt(1)) < headerSize);
            byLevel.splice(pIdx + 1);
            addAsChild(byLevel[pIdx], item);
        }
        else if (headerSize === prevHeaderSize) {
            byLevel.pop();
            const parent = byLevel[byLevel.length - 1];
            addAsChild(parent, item);
        }
        else {
            const parent = byLevel[byLevel.length - 1];
            addAsChild(parent, item);
        }
        prevHeaderSize = headerSize;
    }
    function addAsChild(parent, child) {
        if (parent.children == null)
            parent.children = [child];
        else
            parent.children.push(child);
        child.level = byLevel[byLevel.length - 1] ? byLevel[byLevel.length - 1].level + 1 : 0;
        byLevel.push(child);
    }
    return root.children;
}
function* traverseTocTree(tocs) {
    for (const item of tocs) {
        yield item;
        if (item.children)
            yield* traverseTocTree(item.children);
    }
}
exports.traverseTocTree = traverseTocTree;
function tocToString(tocs) {
    let str = '';
    for (const item of traverseTocTree(tocs)) {
        str += ' |'.repeat(item.level);
        // str += '- ';
        str += `- ${item.text}`;
        str += os_1.default.EOL;
    }
    return str;
}
exports.tocToString = tocToString;
function insertOrUpdateMarkdownToc(input) {
    return markdownToHtml(input).pipe(op.map(({ toc, content: html }) => {
        const tocStr = tocMarkdown(toc);
        const BEGIN = '<!-- Plink markdown toc -->';
        const END = '<!-- Plink markdown toc end -->';
        const existing = input.indexOf(BEGIN);
        let changedMd = '';
        if (existing >= 0) {
            let replacePos = existing + BEGIN.length;
            const replaceEnd = input.indexOf(END);
            changedMd = input.slice(0, replacePos) + '\n' + tocStr + '\n' + input.slice(replaceEnd);
        }
        else {
            changedMd = [BEGIN, tocStr, END, input].join('\n');
        }
        return { changedMd, toc: tocToString(toc), html };
    }), op.take(1)).toPromise();
}
exports.insertOrUpdateMarkdownToc = insertOrUpdateMarkdownToc;
function tocMarkdown(tocs) {
    let str = '';
    for (const item of traverseTocTree(tocs)) {
        if (item.level > 2)
            continue;
        str += '  '.repeat(item.level);
        str += `${item.level > 0 ? '-' : ''} ${item.text}${item.level > 0 ? '' : os_1.default.EOL}`;
        str += '\n';
    }
    return str.slice(0, -1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2Rvd24tdXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcmtkb3duLXV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLHlDQUEyQjtBQUMzQixtREFBcUM7QUFDckMsa0VBQThDO0FBRTlDLGdEQUF3QjtBQUN4QixzQ0FBb0M7QUFDcEMsZ0RBQXdCO0FBQ3hCLG9EQUF1QjtBQUN2QixvREFBNEQ7QUFDNUQsNENBQW9CO0FBQ3BCLE1BQU0sR0FBRyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxVQUFVLENBQUMsQ0FBQztBQUVqQyxJQUFJLFVBQWdCLENBQUM7QUFDckIsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQVMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFFL0Q7Ozs7R0FJRztBQUNILFNBQWdCLGNBQWMsQ0FBQyxNQUFjLEVBQUUsWUFBMEU7SUFFdkgsSUFBSSxVQUFVLElBQUksSUFBSSxFQUFFO1FBQ3RCLFVBQVUsR0FBRyxJQUFJLDBCQUFJLEVBQUUsQ0FBQztLQUN6QjtJQUVELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFTO1FBQ3ZDLElBQUksRUFBRSxjQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSwyQkFBMkIsQ0FBQyxFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDO0tBQ3BHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDTixFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2pCLElBQUksR0FBRyxHQUFVLEVBQUUsQ0FBQztRQUNwQixNQUFNLEdBQUcsR0FBRyxnQkFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBQyxzQkFBc0IsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO1FBQy9ELE1BQU0sSUFBSSxHQUFHLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxZQUFZLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFdEQsR0FBRyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQzNCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFDVixFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUNoQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2xCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDZixnRUFBZ0U7WUFDaEUsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDLENBQUMsQ0FDSCxDQUFDO0FBQ0osQ0FBQztBQTFCRCx3Q0EwQkM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLElBQXFCLEVBQUUsWUFBMEUsRUFDM0gsTUFBYSxFQUFFO0lBQ2IsTUFBTSxHQUFHLEdBQUcsSUFBSSxFQUFFLENBQUMsZUFBZSxDQUFjLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDLENBQUM7SUFDdkUsTUFBTSxJQUFJLEdBQWdELEVBQUUsQ0FBQztJQUU3RCxHQUFHLENBQUMsSUFBSSxDQUNOLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQzNDLENBQUMsSUFBSSxDQUNKLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDWixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdDLElBQUksUUFBUSxLQUFLLE9BQU8sSUFBSSxRQUFRLEtBQUssVUFBVSxJQUFJLFFBQVEsS0FBSyxlQUFlO1lBQ2pGLE9BQU87UUFDVCxNQUFNLEVBQUUsR0FBRyxJQUFlLENBQUM7UUFDM0IsSUFBSSxRQUFRLEtBQUssS0FBSyxFQUFFO1lBQ3RCLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQztZQUMxRCxJQUFJLFlBQVksSUFBSSxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNqRyxHQUFHLENBQUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDMUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7cUJBQzVDLElBQUksQ0FDSCxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO29CQUNoQix3QkFBd0I7b0JBQ3hCLDhCQUE4QjtvQkFDOUIsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLE1BQU0sQ0FBQyxLQUFLLE9BQU8sY0FBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25FLENBQUMsQ0FBQyxDQUNILENBQUMsQ0FBQzthQUNKO1NBQ0Y7YUFBTSxJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDbEMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLFFBQVE7Z0JBQy9CLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxFQUFFLENBQUM7Z0JBQzFCLEVBQUUsRUFBRSxFQUFFO2FBQ1AsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxJQUFJLEVBQUUsQ0FBQyxVQUFVO1lBQ2YsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDNUIsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNkLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsRUFBVztJQUNuQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEVBQUUsQ0FBQyxlQUFlLENBQWMsRUFBRSxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNyRSxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7SUFDZCxHQUFHLENBQUMsSUFBSSxDQUNOLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQzNDLENBQUMsSUFBSSxDQUNKLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDWixJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssT0FBTyxFQUFFO1lBQzdCLElBQUksSUFBSyxJQUFpQixDQUFDLEtBQUssQ0FBQztTQUNsQzthQUFNLElBQUssSUFBZ0IsQ0FBQyxVQUFVLEVBQUU7WUFDdkMsR0FBRyxDQUFDLElBQUksQ0FBRSxJQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ3hDO0lBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNkLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELFNBQVMsYUFBYSxDQUFDLEtBQVk7SUFDakMsTUFBTSxJQUFJLEdBQVEsRUFBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBQyxDQUFDO0lBQ3pFLElBQUksT0FBTyxHQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxpREFBaUQ7SUFDOUUsSUFBSSxjQUFjLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEQsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7UUFDeEIsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUMsZ0VBQWdFO1FBQ2hFLElBQUksVUFBVSxHQUFHLGNBQWMsRUFBRTtZQUMvQixNQUFNLElBQUksR0FBRyxnQkFBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBQztZQUNyRixPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN6QixVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ2pDO2FBQU0sSUFBSSxVQUFVLEtBQUssY0FBYyxFQUFFO1lBQ3hDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNkLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzNDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDMUI7YUFBTTtZQUNMLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzNDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDMUI7UUFDRCxjQUFjLEdBQUcsVUFBVSxDQUFDO0tBQzdCO0lBRUQsU0FBUyxVQUFVLENBQUMsTUFBVyxFQUFFLEtBQVU7UUFDekMsSUFBSSxNQUFNLENBQUMsUUFBUSxJQUFJLElBQUk7WUFDekIsTUFBTSxDQUFDLFFBQVEsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDOztZQUUxQixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixLQUFLLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEYsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxRQUFlLENBQUMsQ0FBQyxlQUFlLENBQUMsSUFBVztJQUMxQyxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksRUFBRTtRQUN2QixNQUFNLElBQUksQ0FBQztRQUNYLElBQUksSUFBSSxDQUFDLFFBQVE7WUFDZixLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ3pDO0FBQ0gsQ0FBQztBQU5ELDBDQU1DO0FBRUQsU0FBZ0IsV0FBVyxDQUFDLElBQVc7SUFDckMsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDO0lBQ2IsS0FBSyxNQUFNLElBQUksSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDeEMsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9CLGVBQWU7UUFDZixHQUFHLElBQUksS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDeEIsR0FBRyxJQUFJLFlBQUUsQ0FBQyxHQUFHLENBQUM7S0FDZjtJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQVRELGtDQVNDO0FBRUQsU0FBZ0IseUJBQXlCLENBQUMsS0FBYTtJQUNyRCxPQUFPLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQy9CLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFDLEVBQUUsRUFBRTtRQUM5QixNQUFNLE1BQU0sR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEMsTUFBTSxLQUFLLEdBQUcsNkJBQTZCLENBQUM7UUFDNUMsTUFBTSxHQUFHLEdBQUcsaUNBQWlDLENBQUM7UUFDOUMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QyxJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxRQUFRLElBQUksQ0FBQyxFQUFFO1lBQ2pCLElBQUksVUFBVSxHQUFHLFFBQVEsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQ3pDLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEMsU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxHQUFHLElBQUksR0FBRyxNQUFNLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDekY7YUFBTTtZQUNMLFNBQVMsR0FBRyxDQUFDLEtBQUssRUFBRyxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNyRDtRQUNELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUNwRCxDQUFDLENBQUMsRUFDRixFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNYLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDaEIsQ0FBQztBQW5CRCw4REFtQkM7QUFFRCxTQUFTLFdBQVcsQ0FBQyxJQUFXO0lBQzlCLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztJQUNiLEtBQUssTUFBTSxJQUFJLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3hDLElBQUksSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDO1lBQ2hCLFNBQVM7UUFDWCxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0IsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xGLEdBQUcsSUFBSSxJQUFJLENBQUM7S0FDYjtJQUNELE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMxQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcnggZnJvbSAncnhqcyc7XG5pbXBvcnQgKiBhcyBvcCBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1Bvb2x9IGZyb20gJ0B3ZmgvdGhyZWFkLXByb21pc2UtcG9vbCc7XG5pbXBvcnQge1RPQ30gZnJvbSAnLi4vaXNvbS9tZC10eXBlcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7bG9nNEZpbGV9IGZyb20gJ0B3ZmgvcGxpbmsnO1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhcnNlNSwge0NoaWxkTm9kZSwgRWxlbWVudCwgVGV4dE5vZGV9IGZyb20gJ3BhcnNlNSc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuY29uc3QgbG9nID0gbG9nNEZpbGUoX19maWxlbmFtZSk7XG5cbmxldCB0aHJlYWRQb29sOiBQb29sO1xuY29uc3QgaGVhZGVyU2V0ID0gbmV3IFNldDxzdHJpbmc+KCdoMSBoMiBoMyBoNCBoNScuc3BsaXQoJyAnKSk7XG5cbi8qKlxuICogVXNlIFRocmVhZCBwb29sIHRvIHBhcnNlIE1hcmtkb3duIGZpbGUgc2ltdWx0YW5lb3VzbHlcbiAqIEBwYXJhbSBzb3VyY2UgXG4gKiBAcGFyYW0gcmVzb2x2ZUltYWdlIFxuICovXG5leHBvcnQgZnVuY3Rpb24gbWFya2Rvd25Ub0h0bWwoc291cmNlOiBzdHJpbmcsIHJlc29sdmVJbWFnZT86IChpbWdTcmM6IHN0cmluZykgPT4gUHJvbWlzZTxzdHJpbmc+IHwgcnguT2JzZXJ2YWJsZTxzdHJpbmc+KTpcbiAgcnguT2JzZXJ2YWJsZTx7dG9jOiBUT0NbXTsgY29udGVudDogc3RyaW5nfT4ge1xuICBpZiAodGhyZWFkUG9vbCA9PSBudWxsKSB7XG4gICAgdGhyZWFkUG9vbCA9IG5ldyBQb29sKCk7XG4gIH1cblxuICByZXR1cm4gcnguZnJvbSh0aHJlYWRQb29sLnN1Ym1pdDxzdHJpbmc+KHtcbiAgICBmaWxlOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnbWFya2Rvd24tbG9hZGVyLXdvcmtlci5qcycpLCBleHBvcnRGbjogJ3BhcnNlVG9IdG1sJywgYXJnczogW3NvdXJjZV1cbiAgfSkpLnBpcGUoXG4gICAgb3AubWVyZ2VNYXAoaHRtbCA9PiB7XG4gICAgICBsZXQgdG9jOiBUT0NbXSA9IFtdO1xuICAgICAgY29uc3QgZG9jID0gcGFyc2U1LnBhcnNlKGh0bWwsIHtzb3VyY2VDb2RlTG9jYXRpb25JbmZvOiB0cnVlfSk7XG4gICAgICBjb25zdCBkb25lID0gZGZzQWNjZXNzRWxlbWVudChkb2MsIHJlc29sdmVJbWFnZSwgdG9jKTtcblxuICAgICAgdG9jID0gY3JlYXRlVG9jVHJlZSh0b2MpO1xuICAgICAgcmV0dXJuIHJ4Lm1lcmdlKC4uLmRvbmUpLnBpcGUoXG4gICAgICAgIG9wLmNvdW50KCksXG4gICAgICAgIG9wLm1hcFRvKHsgdG9jLCBjb250ZW50OiBodG1sIH0pLFxuICAgICAgICBvcC5jYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgICAgbG9nLmVycm9yKGVycik7XG4gICAgICAgICAgLy8gY2IoZXJyLCBKU09OLnN0cmluZ2lmeSh7IHRvYywgY29udGVudDogc291cmNlIH0pLCBzb3VyY2VNYXApO1xuICAgICAgICAgIHJldHVybiByeC5vZih7IHRvYywgY29udGVudDogc291cmNlIH0pO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KVxuICApO1xufVxuXG5mdW5jdGlvbiBkZnNBY2Nlc3NFbGVtZW50KHJvb3Q6IHBhcnNlNS5Eb2N1bWVudCwgcmVzb2x2ZUltYWdlPzogKGltZ1NyYzogc3RyaW5nKSA9PiBQcm9taXNlPHN0cmluZz4gfCByeC5PYnNlcnZhYmxlPHN0cmluZz4sXG50b2M6IFRPQ1tdID0gW10pIHtcbiAgY29uc3QgY2hyID0gbmV3IHJ4LkJlaGF2aW9yU3ViamVjdDxDaGlsZE5vZGVbXT4ocm9vdC5jaGlsZE5vZGVzIHx8IFtdKTtcbiAgY29uc3QgZG9uZTogKHJ4Lk9ic2VydmFibGU8c3RyaW5nPiB8IFByb21pc2U8c3RyaW5nPilbXSA9IFtdO1xuXG4gIGNoci5waXBlKFxuICAgIG9wLm1lcmdlTWFwKGNoaWxkcmVuID0+IHJ4LmZyb20oY2hpbGRyZW4pKVxuICApLnBpcGUoXG4gICAgb3AubWFwKG5vZGUgPT4ge1xuICAgICAgY29uc3Qgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICBpZiAobm9kZU5hbWUgPT09ICcjdGV4dCcgfHwgbm9kZU5hbWUgPT09ICcjY29tbWVudCcgfHwgbm9kZU5hbWUgPT09ICcjZG9jdW1lbnRUeXBlJylcbiAgICAgICAgcmV0dXJuO1xuICAgICAgY29uc3QgZWwgPSBub2RlIGFzIEVsZW1lbnQ7XG4gICAgICBpZiAobm9kZU5hbWUgPT09ICdpbWcnKSB7XG4gICAgICAgIGNvbnN0IGltZ1NyYyA9IGVsLmF0dHJzLmZpbmQoaXRlbSA9PiBpdGVtLm5hbWUgPT09ICdzcmMnKTtcbiAgICAgICAgaWYgKHJlc29sdmVJbWFnZSAmJiBpbWdTcmMgJiYgIWltZ1NyYy52YWx1ZS5zdGFydHNXaXRoKCcvJykgJiYgIS9eaHR0cHM/OlxcL1xcLy8udGVzdChpbWdTcmMudmFsdWUpKSB7XG4gICAgICAgICAgbG9nLmluZm8oJ2ZvdW5kIGltZyBzcmM9JyArIGltZ1NyYy52YWx1ZSk7XG4gICAgICAgICAgZG9uZS5wdXNoKHJ4LmZyb20ocmVzb2x2ZUltYWdlKGltZ1NyYy52YWx1ZSkpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBvcC50YXAocmVzb2x2ZWQgPT4ge1xuICAgICAgICAgICAgICAvLyBlbC5zb3VyY2VDb2RlTG9jYXRpb25cbiAgICAgICAgICAgICAgLy8gaW1nUS5hdHRyKCdzcmMnLCByZXNvbHZlZCk7XG4gICAgICAgICAgICAgIGxvZy5pbmZvKGByZXNvbHZlICR7aW1nU3JjLnZhbHVlfSB0byAke3V0aWwuaW5zcGVjdChyZXNvbHZlZCl9YCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICkpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGhlYWRlclNldC5oYXMobm9kZU5hbWUpKSB7XG4gICAgICAgIHRvYy5wdXNoKHtsZXZlbDogMCwgdGFnOiBub2RlTmFtZSxcbiAgICAgICAgICB0ZXh0OiBsb29rdXBUZXh0Tm9kZUluKGVsKSxcbiAgICAgICAgICBpZDogJydcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChlbC5jaGlsZE5vZGVzKVxuICAgICAgICBjaHIubmV4dChlbC5jaGlsZE5vZGVzKTtcbiAgICB9KVxuICApLnN1YnNjcmliZSgpO1xuICByZXR1cm4gZG9uZTtcbn1cblxuZnVuY3Rpb24gbG9va3VwVGV4dE5vZGVJbihlbDogRWxlbWVudCkge1xuICBjb25zdCBjaHIgPSBuZXcgcnguQmVoYXZpb3JTdWJqZWN0PENoaWxkTm9kZVtdPihlbC5jaGlsZE5vZGVzIHx8IFtdKTtcbiAgbGV0IHRleHQgPSAnJztcbiAgY2hyLnBpcGUoXG4gICAgb3AubWVyZ2VNYXAoY2hpbGRyZW4gPT4gcnguZnJvbShjaGlsZHJlbikpXG4gICkucGlwZShcbiAgICBvcC5tYXAobm9kZSA9PiB7XG4gICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gJyN0ZXh0Jykge1xuICAgICAgICB0ZXh0ICs9IChub2RlIGFzIFRleHROb2RlKS52YWx1ZTtcbiAgICAgIH0gZWxzZSBpZiAoKG5vZGUgYXMgRWxlbWVudCkuY2hpbGROb2Rlcykge1xuICAgICAgICBjaHIubmV4dCgobm9kZSBhcyBFbGVtZW50KS5jaGlsZE5vZGVzKTtcbiAgICAgIH1cbiAgICB9KVxuICApLnN1YnNjcmliZSgpO1xuICByZXR1cm4gdGV4dDtcbn1cblxuZnVuY3Rpb24gY3JlYXRlVG9jVHJlZShpbnB1dDogVE9DW10pIHtcbiAgY29uc3Qgcm9vdDogVE9DID0ge2xldmVsOiAtMSwgdGFnOiAnaDAnLCB0ZXh0OiAnJywgaWQ6ICcnLCBjaGlsZHJlbjogW119O1xuICBsZXQgYnlMZXZlbDogVE9DW10gPSBbcm9vdF07IC8vIGEgc3RhY2sgb2YgcHJldmlvdXMgVE9DIGl0ZW1zIG9yZGVyZWQgYnkgbGV2ZWxcbiAgbGV0IHByZXZIZWFkZXJTaXplID0gTnVtYmVyKHJvb3QudGFnLmNoYXJBdCgxKSk7XG4gIGZvciAoY29uc3QgaXRlbSBvZiBpbnB1dCkge1xuICAgIGNvbnN0IGhlYWRlclNpemUgPSBOdW1iZXIoaXRlbS50YWcuY2hhckF0KDEpKTtcbiAgICAvLyBjb25zb2xlLmxvZyhgJHtoZWFkZXJTaXplfSAke3ByZXZIZWFkZXJTaXplfSwgJHtpdGVtLnRleHR9YCk7XG4gICAgaWYgKGhlYWRlclNpemUgPCBwcmV2SGVhZGVyU2l6ZSkge1xuICAgICAgY29uc3QgcElkeCA9IF8uZmluZExhc3RJbmRleChieUxldmVsLCB0b2MgPT4gTnVtYmVyKHRvYy50YWcuY2hhckF0KDEpKSA8IGhlYWRlclNpemUpO1xuICAgICAgYnlMZXZlbC5zcGxpY2UocElkeCArIDEpO1xuICAgICAgYWRkQXNDaGlsZChieUxldmVsW3BJZHhdLCBpdGVtKTtcbiAgICB9IGVsc2UgaWYgKGhlYWRlclNpemUgPT09IHByZXZIZWFkZXJTaXplKSB7XG4gICAgICBieUxldmVsLnBvcCgpO1xuICAgICAgY29uc3QgcGFyZW50ID0gYnlMZXZlbFtieUxldmVsLmxlbmd0aCAtIDFdO1xuICAgICAgYWRkQXNDaGlsZChwYXJlbnQsIGl0ZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSBieUxldmVsW2J5TGV2ZWwubGVuZ3RoIC0gMV07XG4gICAgICBhZGRBc0NoaWxkKHBhcmVudCwgaXRlbSk7XG4gICAgfVxuICAgIHByZXZIZWFkZXJTaXplID0gaGVhZGVyU2l6ZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGFkZEFzQ2hpbGQocGFyZW50OiBUT0MsIGNoaWxkOiBUT0MpIHtcbiAgICBpZiAocGFyZW50LmNoaWxkcmVuID09IG51bGwpXG4gICAgICBwYXJlbnQuY2hpbGRyZW4gPSBbY2hpbGRdO1xuICAgIGVsc2VcbiAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKGNoaWxkKTtcbiAgICBjaGlsZC5sZXZlbCA9IGJ5TGV2ZWxbYnlMZXZlbC5sZW5ndGggLSAxXSA/IGJ5TGV2ZWxbYnlMZXZlbC5sZW5ndGggLSAxXS5sZXZlbCArIDEgOiAwO1xuICAgIGJ5TGV2ZWwucHVzaChjaGlsZCk7XG4gIH1cbiAgcmV0dXJuIHJvb3QuY2hpbGRyZW4hO1xufVxuXG5leHBvcnQgZnVuY3Rpb24qIHRyYXZlcnNlVG9jVHJlZSh0b2NzOiBUT0NbXSk6IEdlbmVyYXRvcjxUT0M+IHtcbiAgZm9yIChjb25zdCBpdGVtIG9mIHRvY3MpIHtcbiAgICB5aWVsZCBpdGVtO1xuICAgIGlmIChpdGVtLmNoaWxkcmVuKVxuICAgICAgeWllbGQqIHRyYXZlcnNlVG9jVHJlZShpdGVtLmNoaWxkcmVuKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdG9jVG9TdHJpbmcodG9jczogVE9DW10pIHtcbiAgbGV0IHN0ciA9ICcnO1xuICBmb3IgKGNvbnN0IGl0ZW0gb2YgdHJhdmVyc2VUb2NUcmVlKHRvY3MpKSB7XG4gICAgc3RyICs9ICcgfCcucmVwZWF0KGl0ZW0ubGV2ZWwpO1xuICAgIC8vIHN0ciArPSAnLSAnO1xuICAgIHN0ciArPSBgLSAke2l0ZW0udGV4dH1gO1xuICAgIHN0ciArPSBvcy5FT0w7XG4gIH1cbiAgcmV0dXJuIHN0cjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluc2VydE9yVXBkYXRlTWFya2Rvd25Ub2MoaW5wdXQ6IHN0cmluZykge1xuICByZXR1cm4gbWFya2Rvd25Ub0h0bWwoaW5wdXQpLnBpcGUoXG4gICAgb3AubWFwKCh7dG9jLCBjb250ZW50OiBodG1sfSkgPT4ge1xuICAgICAgY29uc3QgdG9jU3RyID0gdG9jTWFya2Rvd24odG9jKTtcbiAgICAgIGNvbnN0IEJFR0lOID0gJzwhLS0gUGxpbmsgbWFya2Rvd24gdG9jIC0tPic7XG4gICAgICBjb25zdCBFTkQgPSAnPCEtLSBQbGluayBtYXJrZG93biB0b2MgZW5kIC0tPic7XG4gICAgICBjb25zdCBleGlzdGluZyA9IGlucHV0LmluZGV4T2YoQkVHSU4pO1xuICAgICAgbGV0IGNoYW5nZWRNZCA9ICcnO1xuICAgICAgaWYgKGV4aXN0aW5nID49IDApIHtcbiAgICAgICAgbGV0IHJlcGxhY2VQb3MgPSBleGlzdGluZyArIEJFR0lOLmxlbmd0aDtcbiAgICAgICAgY29uc3QgcmVwbGFjZUVuZCA9IGlucHV0LmluZGV4T2YoRU5EKTtcbiAgICAgICAgY2hhbmdlZE1kID0gaW5wdXQuc2xpY2UoMCwgcmVwbGFjZVBvcykgKyAnXFxuJyArIHRvY1N0ciArICdcXG4nICsgaW5wdXQuc2xpY2UocmVwbGFjZUVuZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjaGFuZ2VkTWQgPSBbQkVHSU4gLCB0b2NTdHIsIEVORCwgaW5wdXRdLmpvaW4oJ1xcbicpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsgY2hhbmdlZE1kLCB0b2M6IHRvY1RvU3RyaW5nKHRvYyksIGh0bWwgfTtcbiAgICB9KSxcbiAgICBvcC50YWtlKDEpXG4gICkudG9Qcm9taXNlKCk7XG59XG5cbmZ1bmN0aW9uIHRvY01hcmtkb3duKHRvY3M6IFRPQ1tdKSB7XG4gIGxldCBzdHIgPSAnJztcbiAgZm9yIChjb25zdCBpdGVtIG9mIHRyYXZlcnNlVG9jVHJlZSh0b2NzKSkge1xuICAgIGlmIChpdGVtLmxldmVsID4gMilcbiAgICAgIGNvbnRpbnVlO1xuICAgIHN0ciArPSAnICAnLnJlcGVhdChpdGVtLmxldmVsKTtcbiAgICBzdHIgKz0gYCR7aXRlbS5sZXZlbCA+IDAgPyAnLScgOiAnJ30gJHtpdGVtLnRleHR9JHtpdGVtLmxldmVsID4gMCA/ICcnIDogb3MuRU9MfWA7XG4gICAgc3RyICs9ICdcXG4nO1xuICB9XG4gIHJldHVybiBzdHIuc2xpY2UoMCwgLTEpO1xufVxuIl19