"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parse = exports.RCF822TokenType = void 0;
const tslib_1 = require("tslib");
const async_LLn_parser_1 = require("@wfh/plink/wfh/dist/async-LLn-parser");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const fs_extra_1 = tslib_1.__importDefault(require("fs-extra"));
const path_1 = tslib_1.__importDefault(require("path"));
const log = require('log4js').getLogger('@wfh/assets-processer.rfc822-parser');
var RCF822TokenType;
(function (RCF822TokenType) {
    RCF822TokenType[RCF822TokenType["CRLF"] = 0] = "CRLF";
    RCF822TokenType[RCF822TokenType[":"] = 1] = ":";
    RCF822TokenType[RCF822TokenType[";"] = 2] = ";";
    RCF822TokenType[RCF822TokenType["quoteStr"] = 3] = "quoteStr";
    RCF822TokenType[RCF822TokenType["ATOM"] = 4] = "ATOM";
    RCF822TokenType[RCF822TokenType["BOUNDARY"] = 5] = "BOUNDARY";
    RCF822TokenType[RCF822TokenType["PART_BODY"] = 6] = "PART_BODY";
    RCF822TokenType[RCF822TokenType["DOUBLE_DASH"] = 7] = "DOUBLE_DASH";
})(RCF822TokenType = exports.RCF822TokenType || (exports.RCF822TokenType = {}));
const CR = '\r'.charCodeAt(0);
const LF = '\n'.charCodeAt(0);
const BACK_SLASH = '\\'.charCodeAt(0);
const QUOTE_MARK1 = '"'.charCodeAt(0);
const QUOTE_MARK2 = '\''.charCodeAt(0);
const COLON_MARK = ':'.charCodeAt(0);
const SEMI_COL = ';'.charCodeAt(0);
const WS = ' '.charCodeAt(0);
const TAB = '\t'.charCodeAt(0);
const DASH = '-'.charCodeAt(0);
// const DASH = '-'.charCodeAt(0);
const TEMP_DIR = 'dist/assets-processer/rfc822';
class RfcParserContext {
    constructor(origBuffer) {
        this.origBuffer = origBuffer;
        this.multipartStarted = false;
        this.parseLexer = async (la) => {
            let chrCode = await la.la();
            while (chrCode != null) {
                const chr = String.fromCharCode(chrCode);
                if (this.multipartStarted && await la.isNext(CR, LF, CR, LF)) {
                    // part header must be over
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance(2);
                    la.emitToken();
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance(2);
                    la.emitToken();
                    await this.parsePartBodyToken(la);
                }
                else if (this.multipartStarted && await la.isNext(DASH, DASH)) {
                    la.startToken(RCF822TokenType.DOUBLE_DASH);
                    await la.advance(2); // end of whole message
                    la.emitToken();
                    break;
                }
                else if (this.boundary && await la.isNext(...this.boundary)) {
                    la.startToken(RCF822TokenType.BOUNDARY);
                    await la.advance(this.boundary.length);
                    la.emitToken();
                    this.multipartStarted = true;
                    // console.log('multipartStarted true');
                }
                else if (await la.isNext(CR, LF)) {
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance(2);
                    la.emitToken();
                }
                else if ((await la.la()) === LF) {
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance();
                    la.emitToken();
                }
                else if (chr === ':' || chr === ';') {
                    la.startToken(RCF822TokenType[chr]);
                    await la.advance();
                    la.emitToken();
                    await skipWhiteSpace(la);
                }
                else if (/\s/.test(chr)) {
                    await skipWhiteSpace(la);
                }
                else if (chr === '"' || chr === '\'') {
                    await quoteStr(la);
                }
                else {
                    await consumeAtom(la);
                }
                chrCode = await la.la();
            }
        };
        this.parseGrammar = async (la) => {
            let result = {
                headers: await this.parseHeaders(la),
                parts: []
            };
            // console.log('boundary:', String.fromCharCode(...this.boundary!));
            let tk = await la.la();
            while (tk != null) {
                // console.log('tk:', tk.text);
                await la.assertAdvanceWith([RCF822TokenType.BOUNDARY], compareTokenType);
                if ((await la.la()).type === RCF822TokenType.DOUBLE_DASH) {
                    break;
                }
                const partHeaders = await this.parseHeaders(la);
                const partBody = await la.advance();
                await la.assertAdvanceWith([RCF822TokenType.CRLF], compareTokenType);
                this.onParseEachPart(result, partHeaders, partBody);
                // console.log('rfc token: ' + RCF822TokenType[(await la.advance()).type]);
                tk = await la.la();
            }
            return result;
        };
    }
    onParseEachPart(result, partHeaders, partBody) {
        const encodingHeader = partHeaders.find(header => header.key === 'Content-Transfer-Encoding');
        const isBase64 = encodingHeader && encodingHeader.value[0] === 'base64';
        if (isBase64) {
            partBody.data = Buffer.from(partBody.data.toString(), 'base64');
        }
        const attachmentHeader = partHeaders.find(header => header.key === 'Content-Disposition');
        let attachmentName;
        if (attachmentHeader && attachmentHeader.value[0] === 'attachment') {
            const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(attachmentHeader.value[1]);
            if (m && m[1] === 'filename') {
                attachmentName = path_1.default.resolve(TEMP_DIR, m[2]);
                fs_extra_1.default.mkdirpSync(TEMP_DIR);
                fs_extra_1.default.writeFileSync(attachmentName, partBody.data);
                log.info(attachmentName + ' is written');
            }
        }
        result.parts.push({
            headers: partHeaders,
            body: attachmentName ? undefined : partBody.data,
            file: attachmentName ? attachmentName : undefined
        });
    }
    setBoundary(str) {
        const chrs = new Array(str.length);
        for (let i = 0, l = str.length; i < l; i++) {
            chrs[i] = str.charCodeAt(i);
        }
        this.boundary = chrs;
    }
    async parseHeaders(la) {
        const headers = [];
        let nextTk = await la.la();
        while (nextTk != null) {
            if (nextTk.type === RCF822TokenType.ATOM && (await la.la(2)) && (await la.la(2)).type === RCF822TokenType[':']) {
                const key = nextTk.text;
                await la.advance(2);
                nextTk = await la.la();
                let value = [];
                const header = { key, value };
                headers.push(header);
                let lastValueItem = '';
                while (nextTk != null && nextTk.type !== RCF822TokenType.CRLF) {
                    if (nextTk.type === RCF822TokenType[';']) {
                        value.push(lastValueItem);
                        lastValueItem = '';
                        await la.advance();
                        nextTk = await la.la();
                        continue;
                    }
                    lastValueItem += (await la.advance()).text;
                    nextTk = await la.la();
                }
                value.push(lastValueItem);
                if (key.toLowerCase() === 'content-type' && value[0] === 'multipart/mixed') {
                    let boundary;
                    for (const valueItem of value.slice(1)) {
                        const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(valueItem);
                        if (m && m[1] === 'boundary') {
                            boundary = m[2];
                            break;
                        }
                    }
                    if (boundary) {
                        this.setBoundary('--' + boundary);
                    }
                }
            }
            else if (await la.isNextWith([RCF822TokenType.CRLF, RCF822TokenType.CRLF], compareTokenType)) {
                await la.advance(2);
                let next = await la.la();
                while (next && next.type === RCF822TokenType.CRLF) {
                    await la.advance();
                    next = await la.la();
                }
                break;
            }
            else if (await la.isNextWith([RCF822TokenType.CRLF], compareTokenType)) {
                await la.advance();
            }
            else {
                la.throwError((await la.advance()).text);
                // await la.advance();
            }
            nextTk = await la.la();
        }
        return headers;
    }
    /**
     * Generate tokens: PART_BODY CRLF BOUNDARY
     * @param la
     */
    async parsePartBodyToken(la) {
        const tk = la.startToken(RCF822TokenType.PART_BODY);
        tk.trackValue = false;
        const origBufferOffset = la.position;
        while ((await la.la()) != null) {
            if (await la.isNext(CR, LF, ...this.boundary)) {
                tk.data = Buffer.from(this.origBuffer, origBufferOffset, la.position - origBufferOffset);
                la.emitToken();
                la.startToken(RCF822TokenType.CRLF);
                await la.advance(2);
                la.emitToken();
                la.startToken(RCF822TokenType.BOUNDARY);
                await la.advance(this.boundary.length);
                la.emitToken();
                break;
            }
            await la.advance();
        }
    }
}
async function quoteStr(la) {
    la.startToken(RCF822TokenType.quoteStr);
    const openChar = await la.advance();
    while (true) {
        const next = await la.la();
        if (next == null) {
            return la.throwError();
        }
        if (next === BACK_SLASH) {
            await la.advance(2);
        }
        else if (next === openChar) {
            await la.advance();
            la.emitToken();
            break;
        }
        else {
            await la.advance();
        }
    }
}
async function skipWhiteSpace(la) {
    do {
        const code = await la.la();
        if (code == null)
            return;
        if (/\s/.test(String.fromCharCode(code))) {
            await la.advance();
        }
        else {
            break;
        }
    } while (true);
}
async function consumeAtom(la) {
    la.startToken(RCF822TokenType.ATOM);
    await la.advance();
    let code = await la.la();
    let emit = false;
    while (code != null) {
        switch (code) {
            case COLON_MARK:
            case SEMI_COL:
            case QUOTE_MARK1:
            case QUOTE_MARK2:
                emit = true;
                la.emitToken();
                break;
            case CR:
                // console.log((await la.la()), (await la.la(2)), (await la.la(3)));
                if (!(await la.isNext(CR, LF, WS)) && !(await la.isNext(CR, WS)) &&
                    !(await la.isNext(CR, LF, TAB)) && !(await la.isNext(CR, TAB))) {
                    // console.log('emit: ', (await la.la()), (await la.la(2)), (await la.la(3)));
                    emit = true;
                    la.emitToken();
                    break;
                }
                else {
                    await la.advance(3);
                    code = await la.la();
                    break;
                }
            case LF:
                if (!await la.isNext(LF, WS) && !await la.isNext(LF, TAB)) {
                    emit = true;
                    la.emitToken();
                    break;
                }
                else {
                    await la.advance(2);
                    code = await la.la();
                    break;
                }
            default:
                await la.advance();
                code = await la.la();
        }
        if (emit)
            break;
    }
}
// async function parseMultipart(la: Parameters<typeof parseGrammar>[0]) {
//   while (await la.isNext(DASH, DASH))
// }
function compareTokenType(tk, type) {
    return tk.type === type;
}
function parse(readable) {
    // fs.writeFileSync('email-temp.txt', readable.toString('utf8'), 'utf8');
    const pctx = new RfcParserContext(readable);
    const done = (0, rxjs_1.of)(readable).pipe((0, operators_1.observeOn)(rxjs_1.queueScheduler), (0, async_LLn_parser_1.mapChunks)('RCF822-lexer', (la, sub) => pctx.parseLexer(la, sub)), (0, operators_1.map)(chunk => {
        if (chunk.values)
            chunk.text = Buffer.from(Uint8Array.from(chunk.values)).toString();
        delete chunk.values;
        return [chunk];
    }), (0, async_LLn_parser_1.mapChunksObs)('RCF822-parser', la => (0, rxjs_1.from)(pctx.parseGrammar(la))), (0, operators_1.share)()).toPromise();
    return done;
}
exports.parse = parse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmZjODIyLXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJmYzgyMi1wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLDJFQUM2RjtBQUM3RiwrQkFBOEM7QUFDOUMsOENBQXFEO0FBRXJELGdFQUEwQjtBQUMxQix3REFBd0I7QUFDeEIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO0FBRS9FLElBQVksZUFTWDtBQVRELFdBQVksZUFBZTtJQUN6QixxREFBSSxDQUFBO0lBQ0osK0NBQUcsQ0FBQTtJQUNILCtDQUFHLENBQUE7SUFDSCw2REFBUSxDQUFBO0lBQ1IscURBQUksQ0FBQTtJQUNKLDZEQUFRLENBQUE7SUFDUiwrREFBUyxDQUFBO0lBQ1QsbUVBQVcsQ0FBQTtBQUNiLENBQUMsRUFUVyxlQUFlLEdBQWYsdUJBQWUsS0FBZix1QkFBZSxRQVMxQjtBQU1ELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QyxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JDLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbkMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMs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QyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDO0FBQzNCLENBQUM7QUFHRCxTQUFnQixLQUFLLENBQUMsUUFBZ0I7SUFDcEMseUVBQXlFO0lBRXpFLE1BQU0sSUFBSSxHQUFHLElBQUksZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFNUMsTUFBTSxJQUFJLEdBQUcsSUFBQSxTQUFFLEVBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUM1QixJQUFBLHFCQUFTLEVBQUMscUJBQWMsQ0FBQyxFQUN6QixJQUFBLDRCQUFTLEVBQTBCLGNBQWMsRUFBRSxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQ3pGLElBQUEsZUFBRyxFQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ1YsSUFBSSxLQUFLLENBQUMsTUFBTTtZQUNiLEtBQWdDLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNsRyxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDcEIsT0FBTyxDQUFDLEtBQStCLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsRUFDRixJQUFBLCtCQUFZLEVBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBQSxXQUFJLEVBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQ2hFLElBQUEsaUJBQUssR0FBRSxDQUNSLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDZCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFsQkQsc0JBa0JDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBQYXJzZUdyYW1tYXIsIFBhcnNlTGV4LCBUb2tlbixcbiAgbWFwQ2h1bmtzLCBtYXBDaHVua3NPYnMsIExvb2tBaGVhZE9ic2VydmFibGUgfSBmcm9tICdAd2ZoL3BsaW5rL3dmaC9kaXN0L2FzeW5jLUxMbi1wYXJzZXInO1xuaW1wb3J0IHtxdWV1ZVNjaGVkdWxlciwgZnJvbSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtvYnNlcnZlT24sIG1hcCwgc2hhcmV9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5jb25zdCBsb2cgPSByZXF1aXJlKCdsb2c0anMnKS5nZXRMb2dnZXIoJ0B3ZmgvYXNzZXRzLXByb2Nlc3Nlci5yZmM4MjItcGFyc2VyJyk7XG5cbmV4cG9ydCBlbnVtIFJDRjgyMlRva2VuVHlwZSB7XG4gIENSTEYsXG4gICc6JyxcbiAgJzsnLFxuICBxdW90ZVN0cixcbiAgQVRPTSxcbiAgQk9VTkRBUlksXG4gIFBBUlRfQk9EWSxcbiAgRE9VQkxFX0RBU0hcbn1cblxuaW50ZXJmYWNlIFBhcnRCb2R5VG9rZW4gZXh0ZW5kcyBUb2tlbjxSQ0Y4MjJUb2tlblR5cGU+IHtcbiAgZGF0YTogQnVmZmVyO1xufVxuXG5jb25zdCBDUiA9ICdcXHInLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBMRiA9ICdcXG4nLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBCQUNLX1NMQVNIID0gJ1xcXFwnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBRVU9URV9NQVJLMSA9ICdcIicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFFVT1RFX01BUksyID0gJ1xcJycuY2hhckNvZGVBdCgwKTtcbmNvbnN0IENPTE9OX01BUksgPSAnOicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFNFTUlfQ09MID0gJzsnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBXUyA9ICcgJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgVEFCID0gJ1xcdCcuY2hhckNvZGVBdCgwKTtcbmNvbnN0IERBU0ggPSAnLScuY2hhckNvZGVBdCgwKTtcbi8vIGNvbnN0IERBU0ggPSAnLScuY2hhckNvZGVBdCgwKTtcblxuY29uc3QgVEVNUF9ESVIgPSAnZGlzdC9hc3NldHMtcHJvY2Vzc2VyL3JmYzgyMic7XG5leHBvcnQgaW50ZXJmYWNlIFJDRjgyMlBhcnNlUmVzdWx0IHtcbiAgaGVhZGVyczogUkNGODIySGVhZGVyVHlwZVtdO1xuICBwYXJ0czoge1xuICAgIGhlYWRlcnM6IFJDRjgyMkhlYWRlclR5cGVbXTtcbiAgICBib2R5PzogQnVmZmVyO1xuICAgIGZpbGU/OiBzdHJpbmc7XG4gIH1bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSQ0Y4MjJIZWFkZXJUeXBlIHtcbiAga2V5OiBzdHJpbmc7XG4gIHZhbHVlOiBzdHJpbmdbXTtcbn1cblxuY2xhc3MgUmZjUGFyc2VyQ29udGV4dCB7XG4gIHByaXZhdGUgYm91bmRhcnk6IG51bWJlcltdIHwgdW5kZWZpbmVkO1xuXG4gIHByaXZhdGUgbXVsdGlwYXJ0U3RhcnRlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3JpZ0J1ZmZlcjogVWludDhBcnJheSkge1xuICB9XG5cblxuXG4gIHBhcnNlTGV4ZXI6IFBhcnNlTGV4PG51bWJlciwgUkNGODIyVG9rZW5UeXBlPiA9IGFzeW5jIChsYSkgPT4ge1xuICAgIGxldCBjaHJDb2RlID0gYXdhaXQgbGEubGEoKTtcbiAgICB3aGlsZSAoY2hyQ29kZSAhPSBudWxsKSB7XG4gICAgICBjb25zdCBjaHIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNockNvZGUpO1xuICAgICAgaWYgKHRoaXMubXVsdGlwYXJ0U3RhcnRlZCAmJiBhd2FpdCBsYS5pc05leHQoQ1IsIExGLCBDUiwgTEYpKSB7XG4gICAgICAgIC8vIHBhcnQgaGVhZGVyIG11c3QgYmUgb3ZlclxuICAgICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG5cbiAgICAgICAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgICBhd2FpdCB0aGlzLnBhcnNlUGFydEJvZHlUb2tlbihsYSk7XG5cbiAgICAgIH0gZWxzZSBpZiAodGhpcy5tdWx0aXBhcnRTdGFydGVkICYmIGF3YWl0IGxhLmlzTmV4dChEQVNILCBEQVNIKSkge1xuICAgICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5ET1VCTEVfREFTSCk7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7IC8vIGVuZCBvZiB3aG9sZSBtZXNzYWdlXG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgICBicmVhaztcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5ib3VuZGFyeSAmJiBhd2FpdCBsYS5pc05leHQoLi4udGhpcy5ib3VuZGFyeSkpIHtcbiAgICAgICAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQk9VTkRBUlkpO1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKHRoaXMuYm91bmRhcnkubGVuZ3RoKTtcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICAgIHRoaXMubXVsdGlwYXJ0U3RhcnRlZCA9IHRydWU7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdtdWx0aXBhcnRTdGFydGVkIHRydWUnKTtcbiAgICAgIH0gZWxzZSBpZiAoYXdhaXQgbGEuaXNOZXh0KENSLCBMRikpIHtcbiAgICAgICAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgfSBlbHNlIGlmICgoYXdhaXQgbGEubGEoKSkgPT09IExGKSB7XG4gICAgICAgIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLkNSTEYpO1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgfSBlbHNlIGlmIChjaHIgPT09ICc6JyB8fCBjaHIgPT09ICc7Jykge1xuICAgICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZVtjaHJdKTtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgICBsYS5lbWl0VG9rZW4oKTtcbiAgICAgICAgYXdhaXQgc2tpcFdoaXRlU3BhY2UobGEpO1xuICAgICAgfSBlbHNlIGlmICgvXFxzLy50ZXN0KGNocikpIHtcbiAgICAgICAgYXdhaXQgc2tpcFdoaXRlU3BhY2UobGEpO1xuICAgICAgfSBlbHNlIGlmIChjaHIgPT09ICdcIicgfHwgY2hyID09PSAnXFwnJykge1xuICAgICAgICBhd2FpdCBxdW90ZVN0cihsYSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCBjb25zdW1lQXRvbShsYSk7XG4gICAgICB9XG4gICAgICBjaHJDb2RlID0gYXdhaXQgbGEubGEoKTtcbiAgICB9XG4gIH1cblxuICBwYXJzZUdyYW1tYXI6IFBhcnNlR3JhbW1hcjxSQ0Y4MjJQYXJzZVJlc3VsdCwgUkNGODIyVG9rZW5UeXBlPiA9IGFzeW5jIChsYSkgPT4ge1xuICAgIGxldCByZXN1bHQ6IFJDRjgyMlBhcnNlUmVzdWx0ID0ge1xuICAgICAgaGVhZGVyczogYXdhaXQgdGhpcy5wYXJzZUhlYWRlcnMobGEpLFxuICAgICAgcGFydHM6IFtdXG4gICAgfTtcblxuICAgIC8vIGNvbnNvbGUubG9nKCdib3VuZGFyeTonLCBTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLnRoaXMuYm91bmRhcnkhKSk7XG5cbiAgICBsZXQgdGsgPSBhd2FpdCBsYS5sYSgpO1xuICAgIHdoaWxlICh0ayAhPSBudWxsKSB7XG4gICAgICAvLyBjb25zb2xlLmxvZygndGs6JywgdGsudGV4dCk7XG4gICAgICBhd2FpdCBsYS5hc3NlcnRBZHZhbmNlV2l0aChbUkNGODIyVG9rZW5UeXBlLkJPVU5EQVJZXSwgY29tcGFyZVRva2VuVHlwZSk7XG4gICAgICBpZiAoKGF3YWl0IGxhLmxhKCkpIS50eXBlID09PSBSQ0Y4MjJUb2tlblR5cGUuRE9VQkxFX0RBU0gpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjb25zdCBwYXJ0SGVhZGVycyA9IGF3YWl0IHRoaXMucGFyc2VIZWFkZXJzKGxhKTtcbiAgICAgIGNvbnN0IHBhcnRCb2R5ID0gYXdhaXQgbGEuYWR2YW5jZSgpIGFzIFBhcnRCb2R5VG9rZW47XG4gICAgICBhd2FpdCBsYS5hc3NlcnRBZHZhbmNlV2l0aChbUkNGODIyVG9rZW5UeXBlLkNSTEZdLCBjb21wYXJlVG9rZW5UeXBlKTtcblxuICAgICAgdGhpcy5vblBhcnNlRWFjaFBhcnQocmVzdWx0LCBwYXJ0SGVhZGVycywgcGFydEJvZHkpO1xuICAgICAgLy8gY29uc29sZS5sb2coJ3JmYyB0b2tlbjogJyArIFJDRjgyMlRva2VuVHlwZVsoYXdhaXQgbGEuYWR2YW5jZSgpKS50eXBlXSk7XG4gICAgICB0ayA9IGF3YWl0IGxhLmxhKCk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQgYXMgUkNGODIyUGFyc2VSZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIG9uUGFyc2VFYWNoUGFydChyZXN1bHQ6IFJDRjgyMlBhcnNlUmVzdWx0LFxuICAgIHBhcnRIZWFkZXJzOiBSQ0Y4MjJQYXJzZVJlc3VsdFsnaGVhZGVycyddLFxuICAgIHBhcnRCb2R5OiBQYXJ0Qm9keVRva2VuKSB7XG4gICAgY29uc3QgZW5jb2RpbmdIZWFkZXIgPSBwYXJ0SGVhZGVycy5maW5kKGhlYWRlciA9PiBoZWFkZXIua2V5ID09PSAnQ29udGVudC1UcmFuc2Zlci1FbmNvZGluZycpO1xuICAgIGNvbnN0IGlzQmFzZTY0ID0gZW5jb2RpbmdIZWFkZXIgJiYgZW5jb2RpbmdIZWFkZXIudmFsdWVbMF0gPT09ICdiYXNlNjQnO1xuXG4gICAgaWYgKGlzQmFzZTY0KSB7XG4gICAgICBwYXJ0Qm9keS5kYXRhID0gQnVmZmVyLmZyb20ocGFydEJvZHkuZGF0YS50b1N0cmluZygpLCAnYmFzZTY0Jyk7XG4gICAgfVxuICAgIGNvbnN0IGF0dGFjaG1lbnRIZWFkZXIgPSBwYXJ0SGVhZGVycy5maW5kKGhlYWRlciA9PiBoZWFkZXIua2V5ID09PSAnQ29udGVudC1EaXNwb3NpdGlvbicpO1xuICAgIGxldCBhdHRhY2htZW50TmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgaWYgKGF0dGFjaG1lbnRIZWFkZXIgJiYgYXR0YWNobWVudEhlYWRlci52YWx1ZVswXSA9PT0gJ2F0dGFjaG1lbnQnKSB7XG4gICAgICBjb25zdCBtID0gL14oW149XSopPVtcIl0/KFteXCJdKilbXCJdPyQvLmV4ZWMoYXR0YWNobWVudEhlYWRlci52YWx1ZVsxXSk7XG4gICAgICBpZiAobSAmJiBtWzFdID09PSAnZmlsZW5hbWUnKSB7XG4gICAgICAgIGF0dGFjaG1lbnROYW1lID0gUGF0aC5yZXNvbHZlKFRFTVBfRElSLCBtWzJdKTtcbiAgICAgICAgZnMubWtkaXJwU3luYyhURU1QX0RJUik7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoYXR0YWNobWVudE5hbWUsIHBhcnRCb2R5LmRhdGEpO1xuICAgICAgICBsb2cuaW5mbyhhdHRhY2htZW50TmFtZSArICcgaXMgd3JpdHRlbicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJlc3VsdC5wYXJ0cy5wdXNoKHtcbiAgICAgIGhlYWRlcnM6IHBhcnRIZWFkZXJzLFxuICAgICAgYm9keTogYXR0YWNobWVudE5hbWUgPyB1bmRlZmluZWQgOiBwYXJ0Qm9keS5kYXRhLFxuICAgICAgZmlsZTogYXR0YWNobWVudE5hbWUgPyBhdHRhY2htZW50TmFtZSA6IHVuZGVmaW5lZFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRCb3VuZGFyeShzdHI6IHN0cmluZykge1xuICAgIGNvbnN0IGNocnM6IG51bWJlcltdID0gbmV3IEFycmF5KHN0ci5sZW5ndGgpO1xuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBzdHIubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICBjaHJzW2ldID0gc3RyLmNoYXJDb2RlQXQoaSk7XG4gICAgfVxuICAgIHRoaXMuYm91bmRhcnkgPSBjaHJzO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwYXJzZUhlYWRlcnMobGE6IFBhcmFtZXRlcnM8UmZjUGFyc2VyQ29udGV4dFsncGFyc2VHcmFtbWFyJ10+WzBdKSB7XG4gICAgY29uc3QgaGVhZGVyczoge2tleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nW119W10gPSBbXTtcbiAgICBsZXQgbmV4dFRrID0gYXdhaXQgbGEubGEoKTtcblxuICAgIHdoaWxlIChuZXh0VGsgIT0gbnVsbCkge1xuICAgICAgaWYgKG5leHRUay50eXBlID09PSBSQ0Y4MjJUb2tlblR5cGUuQVRPTSAmJiAoYXdhaXQgbGEubGEoMikpICYmIChhd2FpdCBsYS5sYSgyKSkhLnR5cGUgPT09IFJDRjgyMlRva2VuVHlwZVsnOiddKSB7XG4gICAgICAgIGNvbnN0IGtleSA9IG5leHRUay50ZXh0O1xuXG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgICAgIG5leHRUayA9IGF3YWl0IGxhLmxhKCk7XG5cbiAgICAgICAgbGV0IHZhbHVlID0gW10gYXMgc3RyaW5nW107XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IHtrZXksIHZhbHVlfTtcbiAgICAgICAgaGVhZGVycy5wdXNoKGhlYWRlcik7XG4gICAgICAgIGxldCBsYXN0VmFsdWVJdGVtID0gJyc7XG4gICAgICAgIHdoaWxlIChuZXh0VGsgIT0gbnVsbCAmJiBuZXh0VGsudHlwZSAhPT0gUkNGODIyVG9rZW5UeXBlLkNSTEYpIHtcbiAgICAgICAgICBpZiAobmV4dFRrLnR5cGUgPT09IFJDRjgyMlRva2VuVHlwZVsnOyddKSB7XG4gICAgICAgICAgICB2YWx1ZS5wdXNoKGxhc3RWYWx1ZUl0ZW0pO1xuICAgICAgICAgICAgbGFzdFZhbHVlSXRlbSA9ICcnO1xuICAgICAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgICAgICAgbmV4dFRrID0gYXdhaXQgbGEubGEoKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsYXN0VmFsdWVJdGVtICs9IChhd2FpdCBsYS5hZHZhbmNlKCkpLnRleHQ7XG4gICAgICAgICAgbmV4dFRrID0gYXdhaXQgbGEubGEoKTtcbiAgICAgICAgfVxuICAgICAgICB2YWx1ZS5wdXNoKGxhc3RWYWx1ZUl0ZW0pO1xuICAgICAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkgPT09ICdjb250ZW50LXR5cGUnICYmIHZhbHVlWzBdID09PSAnbXVsdGlwYXJ0L21peGVkJykge1xuICAgICAgICAgIGxldCBib3VuZGFyeTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgICAgIGZvciAoY29uc3QgdmFsdWVJdGVtIG9mIHZhbHVlLnNsaWNlKDEpKSB7XG4gICAgICAgICAgICBjb25zdCBtID0gL14oW149XSopPVtcIl0/KFteXCJdKilbXCJdPyQvLmV4ZWModmFsdWVJdGVtKTtcbiAgICAgICAgICAgIGlmIChtICYmIG1bMV0gPT09ICdib3VuZGFyeScpIHtcbiAgICAgICAgICAgICAgYm91bmRhcnkgPSBtWzJdO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGJvdW5kYXJ5KSB7XG4gICAgICAgICAgICB0aGlzLnNldEJvdW5kYXJ5KCctLScgKyBib3VuZGFyeSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgIH0gZWxzZSBpZiAoYXdhaXQgbGEuaXNOZXh0V2l0aDxSQ0Y4MjJUb2tlblR5cGU+KFtSQ0Y4MjJUb2tlblR5cGUuQ1JMRiwgUkNGODIyVG9rZW5UeXBlLkNSTEZdLCBjb21wYXJlVG9rZW5UeXBlKSkge1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKDIpO1xuICAgICAgICBsZXQgbmV4dCA9IGF3YWl0IGxhLmxhKCk7XG4gICAgICAgIHdoaWxlIChuZXh0ICYmIG5leHQudHlwZSA9PT0gUkNGODIyVG9rZW5UeXBlLkNSTEYpIHtcbiAgICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICAgICAgbmV4dCA9IGF3YWl0IGxhLmxhKCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9IGVsc2UgaWYgKGF3YWl0IGxhLmlzTmV4dFdpdGgoW1JDRjgyMlRva2VuVHlwZS5DUkxGXSwgY29tcGFyZVRva2VuVHlwZSkpIHtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGEudGhyb3dFcnJvcigoYXdhaXQgbGEuYWR2YW5jZSgpKS50ZXh0KTtcbiAgICAgICAgLy8gYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgfVxuICAgICAgbmV4dFRrID0gYXdhaXQgbGEubGEoKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlcnM7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgdG9rZW5zOiBQQVJUX0JPRFkgQ1JMRiBCT1VOREFSWVxuICAgKiBAcGFyYW0gbGEgXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHBhcnNlUGFydEJvZHlUb2tlbihsYTogTG9va0FoZWFkT2JzZXJ2YWJsZTxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4pIHtcbiAgICBjb25zdCB0ayA9IGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLlBBUlRfQk9EWSk7XG4gICAgdGsudHJhY2tWYWx1ZSA9IGZhbHNlO1xuICAgIGNvbnN0IG9yaWdCdWZmZXJPZmZzZXQgPSBsYS5wb3NpdGlvbjtcblxuICAgIHdoaWxlICgoYXdhaXQgbGEubGEoKSkgIT0gbnVsbCkge1xuXG4gICAgICBpZiAoYXdhaXQgbGEuaXNOZXh0KENSLCBMRiwgLi4udGhpcy5ib3VuZGFyeSEpKSB7XG4gICAgICAgICh0ayBhcyB1bmtub3duIGFzIFBhcnRCb2R5VG9rZW4pLmRhdGEgPSBCdWZmZXIuZnJvbSh0aGlzLm9yaWdCdWZmZXIsIG9yaWdCdWZmZXJPZmZzZXQsIGxhLnBvc2l0aW9uIC0gb3JpZ0J1ZmZlck9mZnNldCk7XG5cbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG5cbiAgICAgICAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuXG4gICAgICAgIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLkJPVU5EQVJZKTtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSh0aGlzLmJvdW5kYXJ5IS5sZW5ndGgpO1xuICAgICAgICBsYS5lbWl0VG9rZW4oKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgfVxuICB9XG5cbn1cblxuYXN5bmMgZnVuY3Rpb24gcXVvdGVTdHIobGE6IExvb2tBaGVhZE9ic2VydmFibGU8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+KSB7XG4gIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLnF1b3RlU3RyKTtcbiAgY29uc3Qgb3BlbkNoYXIgPSBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gIHdoaWxlICh0cnVlKSB7XG4gICAgY29uc3QgbmV4dCA9IGF3YWl0IGxhLmxhKCk7XG4gICAgaWYgKG5leHQgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGxhLnRocm93RXJyb3IoKTtcbiAgICB9XG4gICAgaWYgKG5leHQgPT09IEJBQ0tfU0xBU0gpIHtcbiAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgfSBlbHNlIGlmIChuZXh0ID09PSBvcGVuQ2hhcikge1xuICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICBicmVhaztcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBza2lwV2hpdGVTcGFjZShsYTogTG9va0FoZWFkT2JzZXJ2YWJsZTxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4pIHtcbiAgZG8ge1xuICAgIGNvbnN0IGNvZGUgPSBhd2FpdCBsYS5sYSgpO1xuICAgIGlmIChjb2RlID09IG51bGwpIHJldHVybjtcbiAgICBpZiAoL1xccy8udGVzdChTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpKSkge1xuICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH0gd2hpbGUgKHRydWUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb25zdW1lQXRvbShsYTogTG9va0FoZWFkT2JzZXJ2YWJsZTxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4pIHtcbiAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQVRPTSk7XG4gIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgbGV0IGNvZGUgPSBhd2FpdCBsYS5sYSgpO1xuICBsZXQgZW1pdCA9IGZhbHNlO1xuICB3aGlsZSAoY29kZSAhPSBudWxsKSB7XG4gICAgc3dpdGNoIChjb2RlKSB7XG4gICAgICBjYXNlIENPTE9OX01BUks6XG4gICAgICBjYXNlIFNFTUlfQ09MOlxuICAgICAgY2FzZSBRVU9URV9NQVJLMTpcbiAgICAgIGNhc2UgUVVPVEVfTUFSSzI6XG4gICAgICAgIGVtaXQgPSB0cnVlO1xuICAgICAgICBsYS5lbWl0VG9rZW4oKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIENSOlxuICAgICAgICAvLyBjb25zb2xlLmxvZygoYXdhaXQgbGEubGEoKSksIChhd2FpdCBsYS5sYSgyKSksIChhd2FpdCBsYS5sYSgzKSkpO1xuICAgICAgICBpZiAoIShhd2FpdCBsYS5pc05leHQoQ1IsIExGLCBXUykpICYmICEoYXdhaXQgbGEuaXNOZXh0KENSLCBXUykpICYmXG4gICAgICAgICAgIShhd2FpdCBsYS5pc05leHQoQ1IsIExGLCBUQUIpKSAmJiAhKGF3YWl0IGxhLmlzTmV4dChDUiwgVEFCKSkpIHtcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnZW1pdDogJywgKGF3YWl0IGxhLmxhKCkpLCAoYXdhaXQgbGEubGEoMikpLCAoYXdhaXQgbGEubGEoMykpKTtcbiAgICAgICAgICBlbWl0ID0gdHJ1ZTtcbiAgICAgICAgICBsYS5lbWl0VG9rZW4oKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKDMpO1xuICAgICAgICAgIGNvZGUgPSBhd2FpdCBsYS5sYSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICBjYXNlIExGOlxuICAgICAgICBpZiAoISBhd2FpdCBsYS5pc05leHQoTEYsIFdTKSAmJiAhIGF3YWl0IGxhLmlzTmV4dChMRiwgVEFCKSkge1xuICAgICAgICAgIGVtaXQgPSB0cnVlO1xuICAgICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgICAgICAgY29kZSA9IGF3YWl0IGxhLmxhKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICAgICAgY29kZSA9IGF3YWl0IGxhLmxhKCk7XG4gICAgfVxuICAgIGlmIChlbWl0KSBicmVhaztcbiAgfVxufVxuXG4vLyBhc3luYyBmdW5jdGlvbiBwYXJzZU11bHRpcGFydChsYTogUGFyYW1ldGVyczx0eXBlb2YgcGFyc2VHcmFtbWFyPlswXSkge1xuLy8gICB3aGlsZSAoYXdhaXQgbGEuaXNOZXh0KERBU0gsIERBU0gpKVxuLy8gfVxuZnVuY3Rpb24gY29tcGFyZVRva2VuVHlwZTxUPih0azogVG9rZW48VD4sIHR5cGU6IFQpIHtcbiAgIHJldHVybiB0ay50eXBlID09PSB0eXBlO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZShyZWFkYWJsZTogQnVmZmVyKSB7XG4gIC8vIGZzLndyaXRlRmlsZVN5bmMoJ2VtYWlsLXRlbXAudHh0JywgcmVhZGFibGUudG9TdHJpbmcoJ3V0ZjgnKSwgJ3V0ZjgnKTtcblxuICBjb25zdCBwY3R4ID0gbmV3IFJmY1BhcnNlckNvbnRleHQocmVhZGFibGUpO1xuXG4gIGNvbnN0IGRvbmUgPSBvZihyZWFkYWJsZSkucGlwZShcbiAgICBvYnNlcnZlT24ocXVldWVTY2hlZHVsZXIpLFxuICAgIG1hcENodW5rczxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4oJ1JDRjgyMi1sZXhlcicsIChsYSwgc3ViKSA9PiBwY3R4LnBhcnNlTGV4ZXIobGEsIHN1YikpLFxuICAgIG1hcChjaHVuayA9PiB7XG4gICAgICBpZiAoY2h1bmsudmFsdWVzKVxuICAgICAgICAoY2h1bmsgYXMgVG9rZW48UkNGODIyVG9rZW5UeXBlPikudGV4dCA9IEJ1ZmZlci5mcm9tKFVpbnQ4QXJyYXkuZnJvbShjaHVuay52YWx1ZXMhKSkudG9TdHJpbmcoKTtcbiAgICAgIGRlbGV0ZSBjaHVuay52YWx1ZXM7XG4gICAgICByZXR1cm4gW2NodW5rIGFzIFRva2VuPFJDRjgyMlRva2VuVHlwZT5dO1xuICAgIH0pLFxuICAgIG1hcENodW5rc09icygnUkNGODIyLXBhcnNlcicsIGxhID0+IGZyb20ocGN0eC5wYXJzZUdyYW1tYXIobGEpKSksXG4gICAgc2hhcmUoKVxuICApLnRvUHJvbWlzZSgpO1xuICByZXR1cm4gZG9uZTtcbn1cbiJdfQ==