"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.parse = exports.RCF822TokenType = void 0;
const async_LLn_parser_1 = require("@wfh/plink/wfh/dist/async-LLn-parser");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const log = require('log4js').getLogger('@wfh/assets-processer.rfc822-parser');
var RCF822TokenType;
(function (RCF822TokenType) {
    RCF822TokenType[RCF822TokenType["CRLF"] = 0] = "CRLF";
    RCF822TokenType[RCF822TokenType[":"] = 1] = ":";
    RCF822TokenType[RCF822TokenType[";"] = 2] = ";";
    RCF822TokenType[RCF822TokenType["quoteStr"] = 3] = "quoteStr";
    RCF822TokenType[RCF822TokenType["ATOM"] = 4] = "ATOM";
    RCF822TokenType[RCF822TokenType["BOUNDARY"] = 5] = "BOUNDARY";
    RCF822TokenType[RCF822TokenType["PART_BODY"] = 6] = "PART_BODY";
    RCF822TokenType[RCF822TokenType["DOUBLE_DASH"] = 7] = "DOUBLE_DASH";
})(RCF822TokenType = exports.RCF822TokenType || (exports.RCF822TokenType = {}));
const CR = '\r'.charCodeAt(0);
const LF = '\n'.charCodeAt(0);
const BACK_SLASH = '\\'.charCodeAt(0);
const QUOTE_MARK1 = '"'.charCodeAt(0);
const QUOTE_MARK2 = '\''.charCodeAt(0);
const COLON_MARK = ':'.charCodeAt(0);
const SEMI_COL = ';'.charCodeAt(0);
const WS = ' '.charCodeAt(0);
const TAB = '\t'.charCodeAt(0);
const DASH = '-'.charCodeAt(0);
// const DASH = '-'.charCodeAt(0);
const TEMP_DIR = 'dist/assets-processer/rfc822';
class RfcParserContext {
    constructor(origBuffer) {
        this.origBuffer = origBuffer;
        this.multipartStarted = false;
        this.parseLexer = async (la) => {
            let chrCode = await la.la();
            while (chrCode != null) {
                const chr = String.fromCharCode(chrCode);
                if (this.multipartStarted && await la.isNext(CR, LF, CR, LF)) {
                    // part header must be over
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance(2);
                    la.emitToken();
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance(2);
                    la.emitToken();
                    await this.parsePartBodyToken(la);
                }
                else if (this.multipartStarted && await la.isNext(DASH, DASH)) {
                    la.startToken(RCF822TokenType.DOUBLE_DASH);
                    await la.advance(2); // end of whole message
                    la.emitToken();
                    break;
                }
                else if (this.boundary && await la.isNext(...this.boundary)) {
                    la.startToken(RCF822TokenType.BOUNDARY);
                    await la.advance(this.boundary.length);
                    la.emitToken();
                    this.multipartStarted = true;
                    // console.log('multipartStarted true');
                }
                else if (await la.isNext(CR, LF)) {
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance(2);
                    la.emitToken();
                }
                else if ((await la.la()) === LF) {
                    la.startToken(RCF822TokenType.CRLF);
                    await la.advance();
                    la.emitToken();
                }
                else if (chr === ':' || chr === ';') {
                    la.startToken(RCF822TokenType[chr]);
                    await la.advance();
                    la.emitToken();
                    await skipWhiteSpace(la);
                }
                else if (/\s/.test(chr)) {
                    await skipWhiteSpace(la);
                }
                else if (chr === '"' || chr === '\'') {
                    await quoteStr(la);
                }
                else {
                    await consumeAtom(la);
                }
                chrCode = await la.la();
            }
        };
        this.parseGrammar = async (la) => {
            let result = {
                headers: await this.parseHeaders(la),
                parts: []
            };
            // console.log('boundary:', String.fromCharCode(...this.boundary!));
            let tk = await la.la();
            while (tk != null) {
                // console.log('tk:', tk.text);
                await la.assertAdvanceWith([RCF822TokenType.BOUNDARY], compareTokenType);
                if ((await la.la()).type === RCF822TokenType.DOUBLE_DASH) {
                    break;
                }
                const partHeaders = await this.parseHeaders(la);
                const partBody = await la.advance();
                await la.assertAdvanceWith([RCF822TokenType.CRLF], compareTokenType);
                this.onParseEachPart(result, partHeaders, partBody);
                // console.log('rfc token: ' + RCF822TokenType[(await la.advance()).type]);
                tk = await la.la();
            }
            return result;
        };
    }
    onParseEachPart(result, partHeaders, partBody) {
        const encodingHeader = partHeaders.find(header => header.key === 'Content-Transfer-Encoding');
        const isBase64 = encodingHeader && encodingHeader.value[0] === 'base64';
        if (isBase64) {
            partBody.data = Buffer.from(partBody.data.toString(), 'base64');
        }
        const attachmentHeader = partHeaders.find(header => header.key === 'Content-Disposition');
        let attachmentName;
        if (attachmentHeader && attachmentHeader.value[0] === 'attachment') {
            const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(attachmentHeader.value[1]);
            if (m && m[1] === 'filename') {
                attachmentName = path_1.default.resolve(TEMP_DIR, m[2]);
                fs_extra_1.default.mkdirpSync(TEMP_DIR);
                fs_extra_1.default.writeFileSync(attachmentName, partBody.data);
                log.info(attachmentName + ' is written');
            }
        }
        result.parts.push({
            headers: partHeaders,
            body: attachmentName ? undefined : partBody.data,
            file: attachmentName ? attachmentName : undefined
        });
    }
    setBoundary(str) {
        const chrs = new Array(str.length);
        for (let i = 0, l = str.length; i < l; i++) {
            chrs[i] = str.charCodeAt(i);
        }
        this.boundary = chrs;
    }
    async parseHeaders(la) {
        const headers = [];
        let nextTk = await la.la();
        while (nextTk != null) {
            if (nextTk.type === RCF822TokenType.ATOM && (await la.la(2)) && (await la.la(2)).type === RCF822TokenType[':']) {
                const key = nextTk.text;
                await la.advance(2);
                nextTk = await la.la();
                let value = [];
                const header = { key, value };
                headers.push(header);
                let lastValueItem = '';
                while (nextTk != null && nextTk.type !== RCF822TokenType.CRLF) {
                    if (nextTk.type === RCF822TokenType[';']) {
                        value.push(lastValueItem);
                        lastValueItem = '';
                        await la.advance();
                        nextTk = await la.la();
                        continue;
                    }
                    lastValueItem += (await la.advance()).text;
                    nextTk = await la.la();
                }
                value.push(lastValueItem);
                if (key.toLowerCase() === 'content-type' && value[0] === 'multipart/mixed') {
                    let boundary;
                    for (const valueItem of value.slice(1)) {
                        const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(valueItem);
                        if (m && m[1] === 'boundary') {
                            boundary = m[2];
                            break;
                        }
                    }
                    if (boundary) {
                        this.setBoundary('--' + boundary);
                    }
                }
            }
            else if (await la.isNextWith([RCF822TokenType.CRLF, RCF822TokenType.CRLF], compareTokenType)) {
                await la.advance(2);
                let next = await la.la();
                while (next && next.type === RCF822TokenType.CRLF) {
                    await la.advance();
                    next = await la.la();
                }
                break;
            }
            else if (await la.isNextWith([RCF822TokenType.CRLF], compareTokenType)) {
                await la.advance();
            }
            else {
                la.throwError((await la.advance()).text);
                // await la.advance();
            }
            nextTk = await la.la();
        }
        return headers;
    }
    /**
     * Generate tokens: PART_BODY CRLF BOUNDARY
     * @param la
     */
    async parsePartBodyToken(la) {
        const tk = la.startToken(RCF822TokenType.PART_BODY);
        tk.trackValue = false;
        const origBufferOffset = la.position;
        while ((await la.la()) != null) {
            if (await la.isNext(CR, LF, ...this.boundary)) {
                tk.data = Buffer.from(this.origBuffer, origBufferOffset, la.position - origBufferOffset);
                la.emitToken();
                la.startToken(RCF822TokenType.CRLF);
                await la.advance(2);
                la.emitToken();
                la.startToken(RCF822TokenType.BOUNDARY);
                await la.advance(this.boundary.length);
                la.emitToken();
                break;
            }
            await la.advance();
        }
    }
}
async function quoteStr(la) {
    la.startToken(RCF822TokenType.quoteStr);
    const openChar = await la.advance();
    while (true) {
        const next = await la.la();
        if (next == null) {
            return la.throwError();
        }
        if (next === BACK_SLASH) {
            await la.advance(2);
        }
        else if (next === openChar) {
            await la.advance();
            la.emitToken();
            break;
        }
        else {
            await la.advance();
        }
    }
}
async function skipWhiteSpace(la) {
    do {
        const code = await la.la();
        if (code == null)
            return;
        if (/\s/.test(String.fromCharCode(code))) {
            await la.advance();
        }
        else {
            break;
        }
    } while (true);
}
async function consumeAtom(la) {
    la.startToken(RCF822TokenType.ATOM);
    await la.advance();
    let code = await la.la();
    let emit = false;
    while (code != null) {
        switch (code) {
            case COLON_MARK:
            case SEMI_COL:
            case QUOTE_MARK1:
            case QUOTE_MARK2:
                emit = true;
                la.emitToken();
                break;
            case CR:
                // console.log((await la.la()), (await la.la(2)), (await la.la(3)));
                if (!(await la.isNext(CR, LF, WS)) && !(await la.isNext(CR, WS)) &&
                    !(await la.isNext(CR, LF, TAB)) && !(await la.isNext(CR, TAB))) {
                    // console.log('emit: ', (await la.la()), (await la.la(2)), (await la.la(3)));
                    emit = true;
                    la.emitToken();
                    break;
                }
                else {
                    await la.advance(3);
                    code = await la.la();
                    break;
                }
            case LF:
                if (!await la.isNext(LF, WS) && !await la.isNext(LF, TAB)) {
                    emit = true;
                    la.emitToken();
                    break;
                }
                else {
                    await la.advance(2);
                    code = await la.la();
                    break;
                }
            default:
                await la.advance();
                code = await la.la();
        }
        if (emit)
            break;
    }
}
// async function parseMultipart(la: Parameters<typeof parseGrammar>[0]) {
//   while (await la.isNext(DASH, DASH))
// }
function compareTokenType(tk, type) {
    return tk.type === type;
}
function parse(readable) {
    // fs.writeFileSync('email-temp.txt', readable.toString('utf8'), 'utf8');
    const pctx = new RfcParserContext(readable);
    const done = (0, rxjs_1.of)(readable).pipe((0, operators_1.observeOn)(rxjs_1.queueScheduler), (0, async_LLn_parser_1.mapChunks)('RCF822-lexer', (la, sub) => pctx.parseLexer(la, sub)), (0, operators_1.map)(chunk => {
        if (chunk.values)
            chunk.text = Buffer.from(Uint8Array.from(chunk.values)).toString();
        delete chunk.values;
        return [chunk];
    }), (0, async_LLn_parser_1.mapChunksObs)('RCF822-parser', la => (0, rxjs_1.from)(pctx.parseGrammar(la))), (0, operators_1.share)()).toPromise();
    return done;
}
exports.parse = parse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmZjODIyLXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJmYzgyMi1wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsMkVBQzZGO0FBQzdGLCtCQUE4QztBQUM5Qyw4Q0FBcUQ7QUFFckQsd0RBQTBCO0FBQzFCLGdEQUF3QjtBQUN4QixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7QUFFL0UsSUFBWSxlQVNYO0FBVEQsV0FBWSxlQUFlO0lBQ3pCLHFEQUFJLENBQUE7SUFDSiwrQ0FBRyxDQUFBO0lBQ0gsK0NBQUcsQ0FBQTtJQUNILDZEQUFRLENBQUE7SUFDUixxREFBSSxDQUFBO0lBQ0osNkRBQVEsQ0FBQTtJQUNSLCtEQUFTLENBQUE7SUFDVCxtRUFBVyxDQUFBO0FBQ2IsQ0FBQyxFQVRXLGVBQWUsR0FBZix1QkFBZSxLQUFmLHVCQUFlLFFBUzFCO0FBTUQsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckMsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzdCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDL0IsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvQixrQ0FBa0M7QUFFbEMsTUFBTSxRQUFRLEdBQUcsOEJBQThCLENBQUM7QUFlaEQsTUFBTSxnQkFBZ0I7SUFLcEIsWUFBb0IsVUFBc0I7UUFBdEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUZsQyxxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFPakMsZUFBVSxHQUFzQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUU7WUFDM0QsSUFBSSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDNUIsT0FBTyxPQUFPLElBQUksSUFBSSxFQUFFO2dCQUN0QixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN6QyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUU7b0JBQzVELDJCQUEyQjtvQkFDM0IsRUFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ3BDLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDcEIsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO29CQUVmLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNwQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztvQkFDZixNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFFbkM7cUJBQU0sSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRTtvQkFDL0QsRUFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQzNDLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLHVCQUF1QjtvQkFDNUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO29CQUNmLE1BQU07aUJBQ1A7cUJBQU0sSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDN0QsRUFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQ3hDLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUN2QyxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUM7b0JBQ2YsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztvQkFDN0Isd0NBQXdDO2lCQUN6QztxQkFBTSxJQUFJLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUU7b0JBQ2xDLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNwQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztpQkFDaEI7cUJBQU0sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUNqQyxFQUFFLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDcEMsTUFBTSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7b0JBQ25CLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztpQkFDaEI7cUJBQU0sSUFBSSxHQUFHLEtBQUssR0FBRyxJQUFJLEdBQUcsS0FBSyxHQUFHLEVBQUU7b0JBQ3JDLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ3BDLE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO29CQUNuQixFQUFFLENBQUMsU0FBUyxFQUFFLENBQUM7b0JBQ2YsTUFBTSxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQzFCO3FCQUFNLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDekIsTUFBTSxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQzFCO3FCQUFNLElBQUksR0FBRyxLQUFLLEdBQUcsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFO29CQUN0QyxNQUFNLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDcEI7cUJBQU07b0JBQ0wsTUFBTSxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ3ZCO2dCQUNELE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQzthQUN6QjtRQUNILENBQUMsQ0FBQTtRQUVELGlCQUFZLEdBQXFELEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRTtZQUM1RSxJQUFJLE1BQU0sR0FBc0I7Z0JBQzlCLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO2dCQUNwQyxLQUFLLEVBQUUsRUFBRTthQUNWLENBQUM7WUFFRixvRUFBb0U7WUFFcEUsSUFBSSxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDdkIsT0FBTyxFQUFFLElBQUksSUFBSSxFQUFFO2dCQUNqQiwrQkFBK0I7Z0JBQy9CLE1BQU0sRUFBRSxDQUFDLGlCQUFpQixDQUFDLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLENBQUM7Z0JBQ3pFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBRSxDQUFDLElBQUksS0FBSyxlQUFlLENBQUMsV0FBVyxFQUFFO29CQUN6RCxNQUFNO2lCQUNQO2dCQUNELE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDaEQsTUFBTSxRQUFRLEdBQUcsTUFBTSxFQUFFLENBQUMsT0FBTyxFQUFtQixDQUFDO2dCQUNyRCxNQUFNLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUVyRSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQ3BELDJFQUEyRTtnQkFDM0UsRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2FBQ3BCO1lBQ0QsT0FBTyxNQUEyQixDQUFDO1FBQ3JDLENBQUMsQ0FBQTtJQTlFRCxDQUFDO0lBZ0ZPLGVBQWUsQ0FBQyxNQUF5QixFQUMvQyxXQUF5QyxFQUN6QyxRQUF1QjtRQUN2QixNQUFNLGNBQWMsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSywyQkFBMkIsQ0FBQyxDQUFDO1FBQzlGLE1BQU0sUUFBUSxHQUFHLGNBQWMsSUFBSSxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQztRQUV4RSxJQUFJLFFBQVEsRUFBRTtZQUNaLFFBQVEsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ2pFO1FBQ0QsTUFBTSxnQkFBZ0IsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxxQkFBcUIsQ0FBQyxDQUFDO1FBQzFGLElBQUksY0FBa0MsQ0FBQztRQUV2QyxJQUFJLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxZQUFZLEVBQUU7WUFDbEUsTUFBTSxDQUFDLEdBQUcsMkJBQTJCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxVQUFVLEVBQUU7Z0JBQzVCLGNBQWMsR0FBRyxjQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsa0JBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3hCLGtCQUFFLENBQUMsYUFBYSxDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2hELEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQyxDQUFDO2FBQzFDO1NBQ0Y7UUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztZQUNoQixPQUFPLEVBQUUsV0FBVztZQUNwQixJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJO1lBQ2hELElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsU0FBUztTQUNsRCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sV0FBVyxDQUFDLEdBQVc7UUFDN0IsTUFBTSxJQUFJLEdBQWEsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTdDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDMUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDN0I7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztJQUN2QixDQUFDO0lBRU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUFtRDtRQUM1RSxNQUFNLE9BQU8sR0FBcUMsRUFBRSxDQUFDO1FBQ3JELElBQUksTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBRTNCLE9BQU8sTUFBTSxJQUFJLElBQUksRUFBRTtZQUNyQixJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssZUFBZSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFFLENBQUMsSUFBSSxLQUFLLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDL0csTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFFeEIsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBRXZCLElBQUksS0FBSyxHQUFHLEVBQWMsQ0FBQztnQkFDM0IsTUFBTSxNQUFNLEdBQUcsRUFBQyxHQUFHLEVBQUUsS0FBSyxFQUFDLENBQUM7Z0JBQzVCLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3JCLElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQztnQkFDdkIsT0FBTyxNQUFNLElBQUksSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssZUFBZSxDQUFDLElBQUksRUFBRTtvQkFDN0QsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRTt3QkFDeEMsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQzt3QkFDMUIsYUFBYSxHQUFHLEVBQUUsQ0FBQzt3QkFDbkIsTUFBTSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7d0JBQ25CLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQzt3QkFDdkIsU0FBUztxQkFDVjtvQkFDRCxhQUFhLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDM0MsTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2lCQUN4QjtnQkFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUMxQixJQUFJLEdBQUcsQ0FBQyxXQUFXLEVBQUUsS0FBSyxjQUFjLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLGlCQUFpQixFQUFFO29CQUMxRSxJQUFJLFFBQTRCLENBQUM7b0JBQ2pDLEtBQUssTUFBTSxTQUFTLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDdEMsTUFBTSxDQUFDLEdBQUcsMkJBQTJCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO3dCQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssVUFBVSxFQUFFOzRCQUM1QixRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUNoQixNQUFNO3lCQUNQO3FCQUNGO29CQUNELElBQUksUUFBUSxFQUFFO3dCQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxDQUFDO3FCQUNuQztpQkFDRjthQUVGO2lCQUFNLElBQUksTUFBTSxFQUFFLENBQUMsVUFBVSxDQUFrQixDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLGdCQUFnQixDQUFDLEVBQUU7Z0JBQy9HLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEIsSUFBSSxJQUFJLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3pCLE9BQU8sSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssZUFBZSxDQUFDLElBQUksRUFBRTtvQkFDakQsTUFBTSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7b0JBQ25CLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztpQkFDdEI7Z0JBQ0QsTUFBTTthQUNQO2lCQUFNLElBQUksTUFBTSxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLGdCQUFnQixDQUFDLEVBQUU7Z0JBQ3hFLE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO2FBQ3BCO2lCQUFNO2dCQUNMLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN6QyxzQkFBc0I7YUFDdkI7WUFDRCxNQUFNLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7U0FDeEI7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssS0FBSyxDQUFDLGtCQUFrQixDQUFDLEVBQWdEO1FBQy9FLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BELEVBQUUsQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLE1BQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQztRQUVyQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxJQUFJLEVBQUU7WUFFOUIsSUFBSSxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFTLENBQUMsRUFBRTtnQkFDN0MsRUFBK0IsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsQ0FBQztnQkFFdkgsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUVmLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BCLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFFZixFQUFFLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDeEMsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3hDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDZixNQUFNO2FBQ1A7WUFDRCxNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNwQjtJQUNILENBQUM7Q0FFRjtBQUVELEtBQUssVUFBVSxRQUFRLENBQUMsRUFBZ0Q7SUFDdEUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDeEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDcEMsT0FBTyxJQUFJLEVBQUU7UUFDWCxNQUFNLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUMzQixJQUFJLElBQUksSUFBSSxJQUFJLEVBQUU7WUFDaEIsT0FBTyxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDeEI7UUFDRCxJQUFJLElBQUksS0FBSyxVQUFVLEVBQUU7WUFDdkIsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3JCO2FBQU0sSUFBSSxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQzVCLE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ25CLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNmLE1BQU07U0FDUDthQUFNO1lBQ0wsTUFBTSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDcEI7S0FDRjtBQUNILENBQUM7QUFFRCxLQUFLLFVBQVUsY0FBYyxDQUFDLEVBQWdEO0lBQzVFLEdBQUc7UUFDRCxNQUFNLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUMzQixJQUFJLElBQUksSUFBSSxJQUFJO1lBQUUsT0FBTztRQUN6QixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQ3hDLE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3BCO2FBQU07WUFDTCxNQUFNO1NBQ1A7S0FDRixRQUFRLElBQUksRUFBRTtBQUNqQixDQUFDO0FBRUQsS0FBSyxVQUFVLFdBQVcsQ0FBQyxFQUFnRDtJQUN6RSxFQUFFLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQyxNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuQixJQUFJLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztJQUN6QixJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7SUFDakIsT0FBTyxJQUFJLElBQUksSUFBSSxFQUFFO1FBQ25CLFFBQVEsSUFBSSxFQUFFO1lBQ1osS0FBSyxVQUFVLENBQUM7WUFDaEIsS0FBSyxRQUFRLENBQUM7WUFDZCxLQUFLLFdBQVcsQ0FBQztZQUNqQixLQUFLLFdBQVc7Z0JBQ2QsSUFBSSxHQUFHLElBQUksQ0FBQztnQkFDWixFQUFFLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ2YsTUFBTTtZQUNSLEtBQUssRUFBRTtnQkFDTCxvRUFBb0U7Z0JBQ3BFLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBQzlELENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQUU7b0JBQ2hFLDhFQUE4RTtvQkFDOUUsSUFBSSxHQUFHLElBQUksQ0FBQztvQkFDWixFQUFFLENBQUMsU0FBUyxFQUFFLENBQUM7b0JBQ2YsTUFBTTtpQkFDUDtxQkFBTTtvQkFDTCxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BCLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztvQkFDckIsTUFBTTtpQkFDUDtZQUNILEtBQUssRUFBRTtnQkFDTCxJQUFJLENBQUUsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFFLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLEVBQUU7b0JBQzNELElBQUksR0FBRyxJQUFJLENBQUM7b0JBQ1osRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO29CQUNmLE1BQU07aUJBQ1A7cUJBQU07b0JBQ0wsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNwQixJQUFJLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7b0JBQ3JCLE1BQU07aUJBQ1A7WUFDSDtnQkFDRSxNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDbkIsSUFBSSxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1NBQ3hCO1FBQ0QsSUFBSSxJQUFJO1lBQUUsTUFBTTtLQUNqQjtBQUNILENBQUM7QUFFRCwwRUFBMEU7QUFDMUUsd0NBQXdDO0FBQ3hDLElBQUk7QUFDSixTQUFTLGdCQUFnQixDQUFJLEVBQVksRUFBRSxJQUFPO0lBQy9DLE9BQU8sRUFBRSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUM7QUFDM0IsQ0FBQztBQUdELFNBQWdCLEtBQUssQ0FBQyxRQUFnQjtJQUNwQyx5RUFBeUU7SUFFekUsTUFBTSxJQUFJLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUU1QyxNQUFNLElBQUksR0FBRyxJQUFBLFNBQUUsRUFBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQzVCLElBQUEscUJBQVMsRUFBQyxxQkFBYyxDQUFDLEVBQ3pCLElBQUEsNEJBQVMsRUFBMEIsY0FBYyxFQUFFLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUMsRUFDekYsSUFBQSxlQUFHLEVBQUMsS0FBSyxDQUFDLEVBQUU7UUFDVixJQUFJLEtBQUssQ0FBQyxNQUFNO1lBQ2IsS0FBZ0MsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2xHLE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBK0IsQ0FBQyxDQUFDO0lBQzNDLENBQUMsQ0FBQyxFQUNGLElBQUEsK0JBQVksRUFBQyxlQUFlLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFBLFdBQUksRUFBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFDaEUsSUFBQSxpQkFBSyxHQUFFLENBQ1IsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNkLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQWxCRCxzQkFrQkMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IFBhcnNlR3JhbW1hciwgUGFyc2VMZXgsIFRva2VuLFxuICBtYXBDaHVua3MsIG1hcENodW5rc09icywgTG9va0FoZWFkT2JzZXJ2YWJsZSB9IGZyb20gJ0B3ZmgvcGxpbmsvd2ZoL2Rpc3QvYXN5bmMtTExuLXBhcnNlcic7XG5pbXBvcnQge3F1ZXVlU2NoZWR1bGVyLCBmcm9tLCBvZn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge29ic2VydmVPbiwgbWFwLCBzaGFyZX0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgUGF0aCBmcm9tICdwYXRoJztcbmNvbnN0IGxvZyA9IHJlcXVpcmUoJ2xvZzRqcycpLmdldExvZ2dlcignQHdmaC9hc3NldHMtcHJvY2Vzc2VyLnJmYzgyMi1wYXJzZXInKTtcblxuZXhwb3J0IGVudW0gUkNGODIyVG9rZW5UeXBlIHtcbiAgQ1JMRixcbiAgJzonLFxuICAnOycsXG4gIHF1b3RlU3RyLFxuICBBVE9NLFxuICBCT1VOREFSWSxcbiAgUEFSVF9CT0RZLFxuICBET1VCTEVfREFTSFxufVxuXG5pbnRlcmZhY2UgUGFydEJvZHlUb2tlbiBleHRlbmRzIFRva2VuPFJDRjgyMlRva2VuVHlwZT4ge1xuICBkYXRhOiBCdWZmZXI7XG59XG5cbmNvbnN0IENSID0gJ1xccicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IExGID0gJ1xcbicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IEJBQ0tfU0xBU0ggPSAnXFxcXCcuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFFVT1RFX01BUksxID0gJ1wiJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgUVVPVEVfTUFSSzIgPSAnXFwnJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgQ09MT05fTUFSSyA9ICc6Jy5jaGFyQ29kZUF0KDApO1xuY29uc3QgU0VNSV9DT0wgPSAnOycuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFdTID0gJyAnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBUQUIgPSAnXFx0Jy5jaGFyQ29kZUF0KDApO1xuY29uc3QgREFTSCA9ICctJy5jaGFyQ29kZUF0KDApO1xuLy8gY29uc3QgREFTSCA9ICctJy5jaGFyQ29kZUF0KDApO1xuXG5jb25zdCBURU1QX0RJUiA9ICdkaXN0L2Fzc2V0cy1wcm9jZXNzZXIvcmZjODIyJztcbmV4cG9ydCBpbnRlcmZhY2UgUkNGODIyUGFyc2VSZXN1bHQge1xuICBoZWFkZXJzOiBSQ0Y4MjJIZWFkZXJUeXBlW107XG4gIHBhcnRzOiB7XG4gICAgaGVhZGVyczogUkNGODIySGVhZGVyVHlwZVtdO1xuICAgIGJvZHk/OiBCdWZmZXI7XG4gICAgZmlsZT86IHN0cmluZztcbiAgfVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJDRjgyMkhlYWRlclR5cGUge1xuICBrZXk6IHN0cmluZztcbiAgdmFsdWU6IHN0cmluZ1tdO1xufVxuXG5jbGFzcyBSZmNQYXJzZXJDb250ZXh0IHtcbiAgcHJpdmF0ZSBib3VuZGFyeTogbnVtYmVyW10gfCB1bmRlZmluZWQ7XG5cbiAgcHJpdmF0ZSBtdWx0aXBhcnRTdGFydGVkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcmlnQnVmZmVyOiBVaW50OEFycmF5KSB7XG4gIH1cblxuXG5cbiAgcGFyc2VMZXhlcjogUGFyc2VMZXg8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+ID0gYXN5bmMgKGxhKSA9PiB7XG4gICAgbGV0IGNockNvZGUgPSBhd2FpdCBsYS5sYSgpO1xuICAgIHdoaWxlIChjaHJDb2RlICE9IG51bGwpIHtcbiAgICAgIGNvbnN0IGNociA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY2hyQ29kZSk7XG4gICAgICBpZiAodGhpcy5tdWx0aXBhcnRTdGFydGVkICYmIGF3YWl0IGxhLmlzTmV4dChDUiwgTEYsIENSLCBMRikpIHtcbiAgICAgICAgLy8gcGFydCBoZWFkZXIgbXVzdCBiZSBvdmVyXG4gICAgICAgIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLkNSTEYpO1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKDIpO1xuICAgICAgICBsYS5lbWl0VG9rZW4oKTtcblxuICAgICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICAgIGF3YWl0IHRoaXMucGFyc2VQYXJ0Qm9keVRva2VuKGxhKTtcblxuICAgICAgfSBlbHNlIGlmICh0aGlzLm11bHRpcGFydFN0YXJ0ZWQgJiYgYXdhaXQgbGEuaXNOZXh0KERBU0gsIERBU0gpKSB7XG4gICAgICAgIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlLkRPVUJMRV9EQVNIKTtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTsgLy8gZW5kIG9mIHdob2xlIG1lc3NhZ2VcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmJvdW5kYXJ5ICYmIGF3YWl0IGxhLmlzTmV4dCguLi50aGlzLmJvdW5kYXJ5KSkge1xuICAgICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5CT1VOREFSWSk7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UodGhpcy5ib3VuZGFyeS5sZW5ndGgpO1xuICAgICAgICBsYS5lbWl0VG9rZW4oKTtcbiAgICAgICAgdGhpcy5tdWx0aXBhcnRTdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ211bHRpcGFydFN0YXJ0ZWQgdHJ1ZScpO1xuICAgICAgfSBlbHNlIGlmIChhd2FpdCBsYS5pc05leHQoQ1IsIExGKSkge1xuICAgICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICB9IGVsc2UgaWYgKChhd2FpdCBsYS5sYSgpKSA9PT0gTEYpIHtcbiAgICAgICAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICB9IGVsc2UgaWYgKGNociA9PT0gJzonIHx8IGNociA9PT0gJzsnKSB7XG4gICAgICAgIGxhLnN0YXJ0VG9rZW4oUkNGODIyVG9rZW5UeXBlW2Nocl0pO1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgICBhd2FpdCBza2lwV2hpdGVTcGFjZShsYSk7XG4gICAgICB9IGVsc2UgaWYgKC9cXHMvLnRlc3QoY2hyKSkge1xuICAgICAgICBhd2FpdCBza2lwV2hpdGVTcGFjZShsYSk7XG4gICAgICB9IGVsc2UgaWYgKGNociA9PT0gJ1wiJyB8fCBjaHIgPT09ICdcXCcnKSB7XG4gICAgICAgIGF3YWl0IHF1b3RlU3RyKGxhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IGNvbnN1bWVBdG9tKGxhKTtcbiAgICAgIH1cbiAgICAgIGNockNvZGUgPSBhd2FpdCBsYS5sYSgpO1xuICAgIH1cbiAgfVxuXG4gIHBhcnNlR3JhbW1hcjogUGFyc2VHcmFtbWFyPFJDRjgyMlBhcnNlUmVzdWx0LCBSQ0Y4MjJUb2tlblR5cGU+ID0gYXN5bmMgKGxhKSA9PiB7XG4gICAgbGV0IHJlc3VsdDogUkNGODIyUGFyc2VSZXN1bHQgPSB7XG4gICAgICBoZWFkZXJzOiBhd2FpdCB0aGlzLnBhcnNlSGVhZGVycyhsYSksXG4gICAgICBwYXJ0czogW11cbiAgICB9O1xuXG4gICAgLy8gY29uc29sZS5sb2coJ2JvdW5kYXJ5OicsIFN0cmluZy5mcm9tQ2hhckNvZGUoLi4udGhpcy5ib3VuZGFyeSEpKTtcblxuICAgIGxldCB0ayA9IGF3YWl0IGxhLmxhKCk7XG4gICAgd2hpbGUgKHRrICE9IG51bGwpIHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCd0azonLCB0ay50ZXh0KTtcbiAgICAgIGF3YWl0IGxhLmFzc2VydEFkdmFuY2VXaXRoKFtSQ0Y4MjJUb2tlblR5cGUuQk9VTkRBUlldLCBjb21wYXJlVG9rZW5UeXBlKTtcbiAgICAgIGlmICgoYXdhaXQgbGEubGEoKSkhLnR5cGUgPT09IFJDRjgyMlRva2VuVHlwZS5ET1VCTEVfREFTSCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBhcnRIZWFkZXJzID0gYXdhaXQgdGhpcy5wYXJzZUhlYWRlcnMobGEpO1xuICAgICAgY29uc3QgcGFydEJvZHkgPSBhd2FpdCBsYS5hZHZhbmNlKCkgYXMgUGFydEJvZHlUb2tlbjtcbiAgICAgIGF3YWl0IGxhLmFzc2VydEFkdmFuY2VXaXRoKFtSQ0Y4MjJUb2tlblR5cGUuQ1JMRl0sIGNvbXBhcmVUb2tlblR5cGUpO1xuXG4gICAgICB0aGlzLm9uUGFyc2VFYWNoUGFydChyZXN1bHQsIHBhcnRIZWFkZXJzLCBwYXJ0Qm9keSk7XG4gICAgICAvLyBjb25zb2xlLmxvZygncmZjIHRva2VuOiAnICsgUkNGODIyVG9rZW5UeXBlWyhhd2FpdCBsYS5hZHZhbmNlKCkpLnR5cGVdKTtcbiAgICAgIHRrID0gYXdhaXQgbGEubGEoKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdCBhcyBSQ0Y4MjJQYXJzZVJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgb25QYXJzZUVhY2hQYXJ0KHJlc3VsdDogUkNGODIyUGFyc2VSZXN1bHQsXG4gICAgcGFydEhlYWRlcnM6IFJDRjgyMlBhcnNlUmVzdWx0WydoZWFkZXJzJ10sXG4gICAgcGFydEJvZHk6IFBhcnRCb2R5VG9rZW4pIHtcbiAgICBjb25zdCBlbmNvZGluZ0hlYWRlciA9IHBhcnRIZWFkZXJzLmZpbmQoaGVhZGVyID0+IGhlYWRlci5rZXkgPT09ICdDb250ZW50LVRyYW5zZmVyLUVuY29kaW5nJyk7XG4gICAgY29uc3QgaXNCYXNlNjQgPSBlbmNvZGluZ0hlYWRlciAmJiBlbmNvZGluZ0hlYWRlci52YWx1ZVswXSA9PT0gJ2Jhc2U2NCc7XG5cbiAgICBpZiAoaXNCYXNlNjQpIHtcbiAgICAgIHBhcnRCb2R5LmRhdGEgPSBCdWZmZXIuZnJvbShwYXJ0Qm9keS5kYXRhLnRvU3RyaW5nKCksICdiYXNlNjQnKTtcbiAgICB9XG4gICAgY29uc3QgYXR0YWNobWVudEhlYWRlciA9IHBhcnRIZWFkZXJzLmZpbmQoaGVhZGVyID0+IGhlYWRlci5rZXkgPT09ICdDb250ZW50LURpc3Bvc2l0aW9uJyk7XG4gICAgbGV0IGF0dGFjaG1lbnROYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAoYXR0YWNobWVudEhlYWRlciAmJiBhdHRhY2htZW50SGVhZGVyLnZhbHVlWzBdID09PSAnYXR0YWNobWVudCcpIHtcbiAgICAgIGNvbnN0IG0gPSAvXihbXj1dKik9W1wiXT8oW15cIl0qKVtcIl0/JC8uZXhlYyhhdHRhY2htZW50SGVhZGVyLnZhbHVlWzFdKTtcbiAgICAgIGlmIChtICYmIG1bMV0gPT09ICdmaWxlbmFtZScpIHtcbiAgICAgICAgYXR0YWNobWVudE5hbWUgPSBQYXRoLnJlc29sdmUoVEVNUF9ESVIsIG1bMl0pO1xuICAgICAgICBmcy5ta2RpcnBTeW5jKFRFTVBfRElSKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhhdHRhY2htZW50TmFtZSwgcGFydEJvZHkuZGF0YSk7XG4gICAgICAgIGxvZy5pbmZvKGF0dGFjaG1lbnROYW1lICsgJyBpcyB3cml0dGVuJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmVzdWx0LnBhcnRzLnB1c2goe1xuICAgICAgaGVhZGVyczogcGFydEhlYWRlcnMsXG4gICAgICBib2R5OiBhdHRhY2htZW50TmFtZSA/IHVuZGVmaW5lZCA6IHBhcnRCb2R5LmRhdGEsXG4gICAgICBmaWxlOiBhdHRhY2htZW50TmFtZSA/IGF0dGFjaG1lbnROYW1lIDogdW5kZWZpbmVkXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNldEJvdW5kYXJ5KHN0cjogc3RyaW5nKSB7XG4gICAgY29uc3QgY2hyczogbnVtYmVyW10gPSBuZXcgQXJyYXkoc3RyLmxlbmd0aCk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHN0ci5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIGNocnNbaV0gPSBzdHIuY2hhckNvZGVBdChpKTtcbiAgICB9XG4gICAgdGhpcy5ib3VuZGFyeSA9IGNocnM7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHBhcnNlSGVhZGVycyhsYTogUGFyYW1ldGVyczxSZmNQYXJzZXJDb250ZXh0WydwYXJzZUdyYW1tYXInXT5bMF0pIHtcbiAgICBjb25zdCBoZWFkZXJzOiB7a2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmdbXX1bXSA9IFtdO1xuICAgIGxldCBuZXh0VGsgPSBhd2FpdCBsYS5sYSgpO1xuXG4gICAgd2hpbGUgKG5leHRUayAhPSBudWxsKSB7XG4gICAgICBpZiAobmV4dFRrLnR5cGUgPT09IFJDRjgyMlRva2VuVHlwZS5BVE9NICYmIChhd2FpdCBsYS5sYSgyKSkgJiYgKGF3YWl0IGxhLmxhKDIpKSEudHlwZSA9PT0gUkNGODIyVG9rZW5UeXBlWyc6J10pIHtcbiAgICAgICAgY29uc3Qga2V5ID0gbmV4dFRrLnRleHQ7XG5cbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgbmV4dFRrID0gYXdhaXQgbGEubGEoKTtcblxuICAgICAgICBsZXQgdmFsdWUgPSBbXSBhcyBzdHJpbmdbXTtcbiAgICAgICAgY29uc3QgaGVhZGVyID0ge2tleSwgdmFsdWV9O1xuICAgICAgICBoZWFkZXJzLnB1c2goaGVhZGVyKTtcbiAgICAgICAgbGV0IGxhc3RWYWx1ZUl0ZW0gPSAnJztcbiAgICAgICAgd2hpbGUgKG5leHRUayAhPSBudWxsICYmIG5leHRUay50eXBlICE9PSBSQ0Y4MjJUb2tlblR5cGUuQ1JMRikge1xuICAgICAgICAgIGlmIChuZXh0VGsudHlwZSA9PT0gUkNGODIyVG9rZW5UeXBlWyc7J10pIHtcbiAgICAgICAgICAgIHZhbHVlLnB1c2gobGFzdFZhbHVlSXRlbSk7XG4gICAgICAgICAgICBsYXN0VmFsdWVJdGVtID0gJyc7XG4gICAgICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICAgICAgICBuZXh0VGsgPSBhd2FpdCBsYS5sYSgpO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxhc3RWYWx1ZUl0ZW0gKz0gKGF3YWl0IGxhLmFkdmFuY2UoKSkudGV4dDtcbiAgICAgICAgICBuZXh0VGsgPSBhd2FpdCBsYS5sYSgpO1xuICAgICAgICB9XG4gICAgICAgIHZhbHVlLnB1c2gobGFzdFZhbHVlSXRlbSk7XG4gICAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKSA9PT0gJ2NvbnRlbnQtdHlwZScgJiYgdmFsdWVbMF0gPT09ICdtdWx0aXBhcnQvbWl4ZWQnKSB7XG4gICAgICAgICAgbGV0IGJvdW5kYXJ5OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgICAgZm9yIChjb25zdCB2YWx1ZUl0ZW0gb2YgdmFsdWUuc2xpY2UoMSkpIHtcbiAgICAgICAgICAgIGNvbnN0IG0gPSAvXihbXj1dKik9W1wiXT8oW15cIl0qKVtcIl0/JC8uZXhlYyh2YWx1ZUl0ZW0pO1xuICAgICAgICAgICAgaWYgKG0gJiYgbVsxXSA9PT0gJ2JvdW5kYXJ5Jykge1xuICAgICAgICAgICAgICBib3VuZGFyeSA9IG1bMl07XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYm91bmRhcnkpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Qm91bmRhcnkoJy0tJyArIGJvdW5kYXJ5KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgfSBlbHNlIGlmIChhd2FpdCBsYS5pc05leHRXaXRoPFJDRjgyMlRva2VuVHlwZT4oW1JDRjgyMlRva2VuVHlwZS5DUkxGLCBSQ0Y4MjJUb2tlblR5cGUuQ1JMRl0sIGNvbXBhcmVUb2tlblR5cGUpKSB7XG4gICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMik7XG4gICAgICAgIGxldCBuZXh0ID0gYXdhaXQgbGEubGEoKTtcbiAgICAgICAgd2hpbGUgKG5leHQgJiYgbmV4dC50eXBlID09PSBSQ0Y4MjJUb2tlblR5cGUuQ1JMRikge1xuICAgICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICAgICAgICBuZXh0ID0gYXdhaXQgbGEubGEoKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH0gZWxzZSBpZiAoYXdhaXQgbGEuaXNOZXh0V2l0aChbUkNGODIyVG9rZW5UeXBlLkNSTEZdLCBjb21wYXJlVG9rZW5UeXBlKSkge1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsYS50aHJvd0Vycm9yKChhd2FpdCBsYS5hZHZhbmNlKCkpLnRleHQpO1xuICAgICAgICAvLyBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgICBuZXh0VGsgPSBhd2FpdCBsYS5sYSgpO1xuICAgIH1cbiAgICByZXR1cm4gaGVhZGVycztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSB0b2tlbnM6IFBBUlRfQk9EWSBDUkxGIEJPVU5EQVJZXG4gICAqIEBwYXJhbSBsYSBcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcGFyc2VQYXJ0Qm9keVRva2VuKGxhOiBMb29rQWhlYWRPYnNlcnZhYmxlPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPikge1xuICAgIGNvbnN0IHRrID0gbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuUEFSVF9CT0RZKTtcbiAgICB0ay50cmFja1ZhbHVlID0gZmFsc2U7XG4gICAgY29uc3Qgb3JpZ0J1ZmZlck9mZnNldCA9IGxhLnBvc2l0aW9uO1xuXG4gICAgd2hpbGUgKChhd2FpdCBsYS5sYSgpKSAhPSBudWxsKSB7XG5cbiAgICAgIGlmIChhd2FpdCBsYS5pc05leHQoQ1IsIExGLCAuLi50aGlzLmJvdW5kYXJ5ISkpIHtcbiAgICAgICAgKHRrIGFzIHVua25vd24gYXMgUGFydEJvZHlUb2tlbikuZGF0YSA9IEJ1ZmZlci5mcm9tKHRoaXMub3JpZ0J1ZmZlciwgb3JpZ0J1ZmZlck9mZnNldCwgbGEucG9zaXRpb24gLSBvcmlnQnVmZmVyT2Zmc2V0KTtcblxuICAgICAgICBsYS5lbWl0VG9rZW4oKTtcblxuICAgICAgICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgbGEuZW1pdFRva2VuKCk7XG5cbiAgICAgICAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUuQk9VTkRBUlkpO1xuICAgICAgICBhd2FpdCBsYS5hZHZhbmNlKHRoaXMuYm91bmRhcnkhLmxlbmd0aCk7XG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgICB9XG4gIH1cblxufVxuXG5hc3luYyBmdW5jdGlvbiBxdW90ZVN0cihsYTogTG9va0FoZWFkT2JzZXJ2YWJsZTxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4pIHtcbiAgbGEuc3RhcnRUb2tlbihSQ0Y4MjJUb2tlblR5cGUucXVvdGVTdHIpO1xuICBjb25zdCBvcGVuQ2hhciA9IGF3YWl0IGxhLmFkdmFuY2UoKTtcbiAgd2hpbGUgKHRydWUpIHtcbiAgICBjb25zdCBuZXh0ID0gYXdhaXQgbGEubGEoKTtcbiAgICBpZiAobmV4dCA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gbGEudGhyb3dFcnJvcigpO1xuICAgIH1cbiAgICBpZiAobmV4dCA9PT0gQkFDS19TTEFTSCkge1xuICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTtcbiAgICB9IGVsc2UgaWYgKG5leHQgPT09IG9wZW5DaGFyKSB7XG4gICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgICBsYS5lbWl0VG9rZW4oKTtcbiAgICAgIGJyZWFrO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNraXBXaGl0ZVNwYWNlKGxhOiBMb29rQWhlYWRPYnNlcnZhYmxlPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPikge1xuICBkbyB7XG4gICAgY29uc3QgY29kZSA9IGF3YWl0IGxhLmxhKCk7XG4gICAgaWYgKGNvZGUgPT0gbnVsbCkgcmV0dXJuO1xuICAgIGlmICgvXFxzLy50ZXN0KFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkpKSB7XG4gICAgICBhd2FpdCBsYS5hZHZhbmNlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSB3aGlsZSAodHJ1ZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbnN1bWVBdG9tKGxhOiBMb29rQWhlYWRPYnNlcnZhYmxlPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPikge1xuICBsYS5zdGFydFRva2VuKFJDRjgyMlRva2VuVHlwZS5BVE9NKTtcbiAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICBsZXQgY29kZSA9IGF3YWl0IGxhLmxhKCk7XG4gIGxldCBlbWl0ID0gZmFsc2U7XG4gIHdoaWxlIChjb2RlICE9IG51bGwpIHtcbiAgICBzd2l0Y2ggKGNvZGUpIHtcbiAgICAgIGNhc2UgQ09MT05fTUFSSzpcbiAgICAgIGNhc2UgU0VNSV9DT0w6XG4gICAgICBjYXNlIFFVT1RFX01BUksxOlxuICAgICAgY2FzZSBRVU9URV9NQVJLMjpcbiAgICAgICAgZW1pdCA9IHRydWU7XG4gICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgQ1I6XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKChhd2FpdCBsYS5sYSgpKSwgKGF3YWl0IGxhLmxhKDIpKSwgKGF3YWl0IGxhLmxhKDMpKSk7XG4gICAgICAgIGlmICghKGF3YWl0IGxhLmlzTmV4dChDUiwgTEYsIFdTKSkgJiYgIShhd2FpdCBsYS5pc05leHQoQ1IsIFdTKSkgJiZcbiAgICAgICAgICAhKGF3YWl0IGxhLmlzTmV4dChDUiwgTEYsIFRBQikpICYmICEoYXdhaXQgbGEuaXNOZXh0KENSLCBUQUIpKSkge1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdlbWl0OiAnLCAoYXdhaXQgbGEubGEoKSksIChhd2FpdCBsYS5sYSgyKSksIChhd2FpdCBsYS5sYSgzKSkpO1xuICAgICAgICAgIGVtaXQgPSB0cnVlO1xuICAgICAgICAgIGxhLmVtaXRUb2tlbigpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGF3YWl0IGxhLmFkdmFuY2UoMyk7XG4gICAgICAgICAgY29kZSA9IGF3YWl0IGxhLmxhKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIGNhc2UgTEY6XG4gICAgICAgIGlmICghIGF3YWl0IGxhLmlzTmV4dChMRiwgV1MpICYmICEgYXdhaXQgbGEuaXNOZXh0KExGLCBUQUIpKSB7XG4gICAgICAgICAgZW1pdCA9IHRydWU7XG4gICAgICAgICAgbGEuZW1pdFRva2VuKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgICBjb2RlID0gYXdhaXQgbGEubGEoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYXdhaXQgbGEuYWR2YW5jZSgpO1xuICAgICAgICBjb2RlID0gYXdhaXQgbGEubGEoKTtcbiAgICB9XG4gICAgaWYgKGVtaXQpIGJyZWFrO1xuICB9XG59XG5cbi8vIGFzeW5jIGZ1bmN0aW9uIHBhcnNlTXVsdGlwYXJ0KGxhOiBQYXJhbWV0ZXJzPHR5cGVvZiBwYXJzZUdyYW1tYXI+WzBdKSB7XG4vLyAgIHdoaWxlIChhd2FpdCBsYS5pc05leHQoREFTSCwgREFTSCkpXG4vLyB9XG5mdW5jdGlvbiBjb21wYXJlVG9rZW5UeXBlPFQ+KHRrOiBUb2tlbjxUPiwgdHlwZTogVCkge1xuICAgcmV0dXJuIHRrLnR5cGUgPT09IHR5cGU7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlKHJlYWRhYmxlOiBCdWZmZXIpIHtcbiAgLy8gZnMud3JpdGVGaWxlU3luYygnZW1haWwtdGVtcC50eHQnLCByZWFkYWJsZS50b1N0cmluZygndXRmOCcpLCAndXRmOCcpO1xuXG4gIGNvbnN0IHBjdHggPSBuZXcgUmZjUGFyc2VyQ29udGV4dChyZWFkYWJsZSk7XG5cbiAgY29uc3QgZG9uZSA9IG9mKHJlYWRhYmxlKS5waXBlKFxuICAgIG9ic2VydmVPbihxdWV1ZVNjaGVkdWxlciksXG4gICAgbWFwQ2h1bmtzPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPignUkNGODIyLWxleGVyJywgKGxhLCBzdWIpID0+IHBjdHgucGFyc2VMZXhlcihsYSwgc3ViKSksXG4gICAgbWFwKGNodW5rID0+IHtcbiAgICAgIGlmIChjaHVuay52YWx1ZXMpXG4gICAgICAgIChjaHVuayBhcyBUb2tlbjxSQ0Y4MjJUb2tlblR5cGU+KS50ZXh0ID0gQnVmZmVyLmZyb20oVWludDhBcnJheS5mcm9tKGNodW5rLnZhbHVlcyEpKS50b1N0cmluZygpO1xuICAgICAgZGVsZXRlIGNodW5rLnZhbHVlcztcbiAgICAgIHJldHVybiBbY2h1bmsgYXMgVG9rZW48UkNGODIyVG9rZW5UeXBlPl07XG4gICAgfSksXG4gICAgbWFwQ2h1bmtzT2JzKCdSQ0Y4MjItcGFyc2VyJywgbGEgPT4gZnJvbShwY3R4LnBhcnNlR3JhbW1hcihsYSkpKSxcbiAgICBzaGFyZSgpXG4gICkudG9Qcm9taXNlKCk7XG4gIHJldHVybiBkb25lO1xufVxuIl19