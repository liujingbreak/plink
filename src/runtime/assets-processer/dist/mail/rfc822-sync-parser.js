"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.parse = exports.RCF822TokenType = void 0;
const LLn_parser_1 = require("@wfh/plink/wfh/dist/LLn-parser");
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const log = require('log4js').getLogger('@wfh/assets-processer.rfc822-sync-parser');
var RCF822TokenType;
(function (RCF822TokenType) {
    RCF822TokenType[RCF822TokenType["CRLF"] = 0] = "CRLF";
    RCF822TokenType[RCF822TokenType[":"] = 1] = ":";
    RCF822TokenType[RCF822TokenType[";"] = 2] = ";";
    RCF822TokenType[RCF822TokenType["quoteStr"] = 3] = "quoteStr";
    RCF822TokenType[RCF822TokenType["ATOM"] = 4] = "ATOM";
    RCF822TokenType[RCF822TokenType["BOUNDARY"] = 5] = "BOUNDARY";
    RCF822TokenType[RCF822TokenType["PART_BODY"] = 6] = "PART_BODY";
    RCF822TokenType[RCF822TokenType["DOUBLE_DASH"] = 7] = "DOUBLE_DASH";
})(RCF822TokenType = exports.RCF822TokenType || (exports.RCF822TokenType = {}));
const CR = '\r'.charCodeAt(0);
const LF = '\n'.charCodeAt(0);
const BACK_SLASH = '\\'.charCodeAt(0);
const QUOTE_MARK1 = '"'.charCodeAt(0);
const QUOTE_MARK2 = '\''.charCodeAt(0);
const COLON_MARK = ':'.charCodeAt(0);
const SEMI_COL = ';'.charCodeAt(0);
const WS = ' '.charCodeAt(0);
const TAB = '\t'.charCodeAt(0);
const DASH = '-'.charCodeAt(0);
// const DASH = '-'.charCodeAt(0);
const TEMP_DIR = 'dist/assets-processer/rfc822';
class RfcParserContext {
    constructor(origBuffer) {
        this.origBuffer = origBuffer;
        this.multipartStarted = false;
        this.textBodyStarted = false;
        this.parseLexer = (la, emitter) => {
            let chrCode = la.la();
            if (chrCode == null) {
                emitter.end();
                return;
            }
            const chr = String.fromCharCode(chrCode);
            if (this.multipartStarted && la.isNext(CR, LF, CR, LF)) {
                // part header must be over
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
                this.parsePartBodyToken(la, emitter);
            }
            else if (this.multipartStarted && la.isNext(DASH, DASH)) {
                la.startChunk(RCF822TokenType.DOUBLE_DASH);
                la.advance(2); // end of whole message
                emitter.emit();
                return;
            }
            else if (this.boundary && la.isNext(...this.boundary)) {
                la.startChunk(RCF822TokenType.BOUNDARY);
                la.advance(this.boundary.length);
                emitter.emit();
                this.multipartStarted = true;
                // console.log('multipartStarted true');
            }
            else if (this.textBodyStarted) {
                while (la.la() != null && la.la() === CR || la.la() === LF) {
                    la.advance();
                }
                la.startChunk(RCF822TokenType.PART_BODY, false);
                while (la.la() != null) {
                    la.advance();
                }
                emitter.emit();
                return;
            }
            else if (la.isNext(CR, LF)) {
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
            }
            else if ((la.la()) === LF) {
                la.startChunk(RCF822TokenType.CRLF);
                la.advance();
                emitter.emit();
            }
            else if (chr === ':' || chr === ';') {
                la.startChunk(RCF822TokenType[chr]);
                la.advance();
                emitter.emit();
                skipWhiteSpace(la);
            }
            else if (/\s/.test(chr)) {
                skipWhiteSpace(la);
            }
            else if (chr === '"' || chr === '\'') {
                quoteStr(la, emitter);
            }
            else {
                consumeAtom(la, emitter);
            }
            chrCode = la.la();
        };
        this.parseGrammar = (la) => {
            let result = {
                headers: this.parseHeaders(la),
                parts: []
            };
            // console.log('boundary:', String.fromCharCode(...this.boundary!));
            if (this.boundary == null) {
                this.textBodyStarted = true;
                const tk = la.la();
                if (tk != null) {
                    la.advance();
                    result.textBody = Buffer.from(this.origBuffer.slice(tk.pos, tk.end)).toString('utf8');
                }
            }
            else {
                let tk = la.la();
                while (tk != null) {
                    // console.log('tk:', tk.text);
                    la.assertAdvanceWith([RCF822TokenType.BOUNDARY], compareTokenType);
                    if ((la.la()).type === RCF822TokenType.DOUBLE_DASH) {
                        break;
                    }
                    const partHeaders = this.parseHeaders(la);
                    const partBody = la.advance();
                    la.assertAdvanceWith([RCF822TokenType.CRLF], compareTokenType);
                    this.onParseEachPart(result, partHeaders, partBody);
                    // console.log('rfc token: ' + RCF822TokenType[(la.advance()).type]);
                    tk = la.la();
                }
            }
            return result;
        };
    }
    parse() {
        const ps = (0, LLn_parser_1.parser)('rfc822-messagee', (la, emitter) => this.parseLexer(la, emitter), (la) => this.parseGrammar(la), chunk => {
            chunk.text = chunk.values ?
                Buffer.from(Uint8Array.from(chunk.values)).toString() :
                '';
            return chunk;
        });
        ps.write(this.origBuffer);
        ps.end();
        try {
            return ps.getResult();
        }
        catch (err) {
            // eslint-disable-next-line no-console
            log.error('Failed to parse:\n' + Buffer.from(this.origBuffer).toString('utf8'));
            throw err;
        }
    }
    onParseEachPart(result, partHeaders, partBody) {
        const encodingHeader = partHeaders.find(header => header.key === 'Content-Transfer-Encoding');
        const isBase64 = encodingHeader && encodingHeader.value[0] === 'base64';
        if (isBase64) {
            partBody.data = Buffer.from(partBody.data.toString(), 'base64');
        }
        const attachmentHeader = partHeaders.find(header => header.key === 'Content-Disposition');
        let attachmentName;
        if (attachmentHeader && attachmentHeader.value[0] === 'attachment') {
            const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(attachmentHeader.value[1]);
            if (m && m[1] === 'filename') {
                attachmentName = path_1.default.resolve(TEMP_DIR, m[2]);
                fs_extra_1.default.mkdirpSync(TEMP_DIR);
                fs_extra_1.default.writeFileSync(attachmentName, partBody.data);
                log.info(attachmentName + ' is written');
            }
        }
        result.parts.push({
            headers: partHeaders,
            body: attachmentName ? undefined : partBody.data,
            file: attachmentName ? attachmentName : undefined
        });
    }
    setBoundary(str) {
        const chrs = new Array(str.length);
        for (let i = 0, l = str.length; i < l; i++) {
            chrs[i] = str.charCodeAt(i);
        }
        this.boundary = chrs;
    }
    parseHeaders(la) {
        const headers = [];
        let nextTk = la.la();
        while (nextTk != null) {
            if (la.isNextWith([RCF822TokenType.ATOM, RCF822TokenType[':']], compareTokenType)) {
                const key = nextTk.text;
                la.advance(2);
                nextTk = la.la();
                let value = [];
                const header = { key, value };
                headers.push(header);
                let lastValueItem = '';
                while (nextTk != null && nextTk.type !== RCF822TokenType.CRLF) {
                    if (nextTk.type === RCF822TokenType[';']) {
                        value.push(lastValueItem);
                        lastValueItem = '';
                        la.advance();
                        nextTk = la.la();
                        continue;
                    }
                    lastValueItem += (la.advance()).text;
                    nextTk = la.la();
                }
                value.push(lastValueItem);
                if (key.toLowerCase() === 'content-type' && value[0] === 'multipart/mixed') {
                    let boundary;
                    for (const valueItem of value.slice(1)) {
                        const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(valueItem);
                        if (m && m[1] === 'boundary') {
                            boundary = m[2];
                            break;
                        }
                    }
                    if (boundary) {
                        this.setBoundary('--' + boundary);
                    }
                }
            }
            else if (la.isNextWith([RCF822TokenType.CRLF, RCF822TokenType.CRLF], compareTokenType)) {
                la.advance(2);
                let next = la.la();
                while (next && next.type === RCF822TokenType.CRLF) {
                    la.advance();
                    next = la.la();
                }
                break;
            }
            else if (la.isNextWith([RCF822TokenType.CRLF], compareTokenType)) {
                la.advance();
            }
            else {
                la.throwError((la.advance()).text);
                // la.advance();
            }
            nextTk = la.la();
        }
        return headers;
    }
    /**
     * Generate tokens: PART_BODY CRLF BOUNDARY
     * @param la
     */
    parsePartBodyToken(la, emitter) {
        const tk = la.startChunk(RCF822TokenType.PART_BODY);
        tk.trackValue = false;
        const origBufferOffset = la.position;
        while ((la.la()) != null) {
            if (la.isNext(CR, LF, ...this.boundary)) {
                tk.data = Buffer.from(this.origBuffer.slice(origBufferOffset, la.position));
                emitter.emit();
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
                la.startChunk(RCF822TokenType.BOUNDARY);
                la.advance(this.boundary.length);
                emitter.emit();
                break;
            }
            la.advance();
        }
    }
}
function quoteStr(la, emitter) {
    la.startChunk(RCF822TokenType.quoteStr);
    const openChar = la.advance();
    while (true) {
        const next = la.la();
        if (next == null) {
            return la.throwError();
        }
        if (next === BACK_SLASH) {
            la.advance(2);
        }
        else if (next === openChar) {
            la.advance();
            emitter.emit();
            break;
        }
        else {
            la.advance();
        }
    }
}
function skipWhiteSpace(la) {
    do {
        const code = la.la();
        if (code == null)
            return;
        if (/\s/.test(String.fromCharCode(code))) {
            la.advance();
        }
        else {
            break;
        }
    } while (true);
}
function consumeAtom(la, emitter) {
    la.startChunk(RCF822TokenType.ATOM);
    la.advance();
    let code = la.la();
    let emit = false;
    while (code != null) {
        switch (code) {
            case COLON_MARK:
            case SEMI_COL:
            case QUOTE_MARK1:
            case QUOTE_MARK2:
                emit = true;
                emitter.emit();
                break;
            case CR:
                // console.log((la.la()), (la.la(2)), (la.la(3)));
                if (!(la.isNext(CR, LF, WS)) && !(la.isNext(CR, WS)) &&
                    !(la.isNext(CR, LF, TAB)) && !(la.isNext(CR, TAB))) {
                    // console.log('emit: ', (la.la()), (la.la(2)), (la.la(3)));
                    emit = true;
                    emitter.emit();
                    break;
                }
                else {
                    la.advance(3);
                    code = la.la();
                    break;
                }
            case LF:
                if (!la.isNext(LF, WS) && !la.isNext(LF, TAB)) {
                    emit = true;
                    emitter.emit();
                    break;
                }
                else {
                    la.advance(2);
                    code = la.la();
                    break;
                }
            default:
                la.advance();
                code = la.la();
        }
        if (emit)
            break;
    }
}
// function parseMultipart(la: Parameters<typeof parseGrammar>[0]) {
//   while (la.isNext(DASH, DASH))
// }
function compareTokenType(tk, type) {
    return tk.type === type;
}
function parse(readable) {
    const pctx = new RfcParserContext(readable);
    return pctx.parse();
}
exports.parse = parse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmZjODIyLXN5bmMtcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmZjODIyLXN5bmMtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLCtEQUErRTtBQUMvRSx3REFBMEI7QUFDMUIsZ0RBQXdCO0FBQ3hCLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsMENBQTBDLENBQUMsQ0FBQztBQUVwRixJQUFZLGVBU1g7QUFURCxXQUFZLGVBQWU7SUFDekIscURBQUksQ0FBQTtJQUNKLCtDQUFHLENBQUE7SUFDSCwrQ0FBRyxDQUFBO0lBQ0gsNkRBQVEsQ0FBQTtJQUNSLHFEQUFJLENBQUE7SUFDSiw2REFBUSxDQUFBO0lBQ1IsK0RBQVMsQ0FBQTtJQUNULG1FQUFXLENBQUE7QUFDYixDQUFDLEVBVFcsZUFBZSxHQUFmLHVCQUFlLEtBQWYsdUJBQWUsUUFTMUI7QUFVRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDOUIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QyxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkMsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNyQyxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25DLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDN0IsTUFB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Q1A7WUFDSDtnQkFDRSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ2IsSUFBSSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztTQUNsQjtRQUNELElBQUksSUFBSTtZQUFFLE1BQU07S0FDakI7QUFDSCxDQUFDO0FBRUQsb0VBQW9FO0FBQ3BFLGtDQUFrQztBQUNsQyxJQUFJO0FBQ0osU0FBUyxnQkFBZ0IsQ0FBSSxFQUFvQixFQUFFLElBQU87SUFDdkQsT0FBTyxFQUFFLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQztBQUMzQixDQUFDO0FBR0QsU0FBZ0IsS0FBSyxDQUFDLFFBQWdCO0lBQ3BDLE1BQU0sSUFBSSxHQUFHLElBQUksZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDNUMsT0FBTyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDdEIsQ0FBQztBQUhELHNCQUdDIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBMZXhlciwgR3JhbW1hciwgcGFyc2VyLCBDaHVuayB9IGZyb20gJ0B3ZmgvcGxpbmsvd2ZoL2Rpc3QvTExuLXBhcnNlcic7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5jb25zdCBsb2cgPSByZXF1aXJlKCdsb2c0anMnKS5nZXRMb2dnZXIoJ0B3ZmgvYXNzZXRzLXByb2Nlc3Nlci5yZmM4MjItc3luYy1wYXJzZXInKTtcblxuZXhwb3J0IGVudW0gUkNGODIyVG9rZW5UeXBlIHtcbiAgQ1JMRixcbiAgJzonLFxuICAnOycsXG4gIHF1b3RlU3RyLFxuICBBVE9NLFxuICBCT1VOREFSWSxcbiAgUEFSVF9CT0RZLFxuICBET1VCTEVfREFTSFxufVxuXG5pbnRlcmZhY2UgUGFydEJvZHlUb2tlbiBleHRlbmRzIENodW5rPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPiB7XG4gIGRhdGE6IEJ1ZmZlcjtcbn1cblxuaW50ZXJmYWNlIFRva2VuIGV4dGVuZHMgQ2h1bms8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+IHtcbiAgdGV4dD86IHN0cmluZztcbn1cblxuY29uc3QgQ1IgPSAnXFxyJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgTEYgPSAnXFxuJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgQkFDS19TTEFTSCA9ICdcXFxcJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgUVVPVEVfTUFSSzEgPSAnXCInLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBRVU9URV9NQVJLMiA9ICdcXCcnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBDT0xPTl9NQVJLID0gJzonLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBTRU1JX0NPTCA9ICc7Jy5jaGFyQ29kZUF0KDApO1xuY29uc3QgV1MgPSAnICcuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFRBQiA9ICdcXHQnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBEQVNIID0gJy0nLmNoYXJDb2RlQXQoMCk7XG4vLyBjb25zdCBEQVNIID0gJy0nLmNoYXJDb2RlQXQoMCk7XG5cbmNvbnN0IFRFTVBfRElSID0gJ2Rpc3QvYXNzZXRzLXByb2Nlc3Nlci9yZmM4MjInO1xuZXhwb3J0IGludGVyZmFjZSBSQ0Y4MjJQYXJzZVJlc3VsdCB7XG4gIGhlYWRlcnM6IFJDRjgyMkhlYWRlclR5cGVbXTtcbiAgdGV4dEJvZHk/OiBzdHJpbmc7XG4gIHBhcnRzOiB7XG4gICAgaGVhZGVyczogUkNGODIySGVhZGVyVHlwZVtdO1xuICAgIGJvZHk/OiBCdWZmZXI7XG4gICAgZmlsZT86IHN0cmluZztcbiAgfVtdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJDRjgyMkhlYWRlclR5cGUge1xuICBrZXk6IHN0cmluZztcbiAgdmFsdWU6IHN0cmluZ1tdO1xufVxuXG5jbGFzcyBSZmNQYXJzZXJDb250ZXh0IHtcbiAgcHJpdmF0ZSBib3VuZGFyeTogbnVtYmVyW10gfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgbXVsdGlwYXJ0U3RhcnRlZCA9IGZhbHNlO1xuICBwcml2YXRlIHRleHRCb2R5U3RhcnRlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3JpZ0J1ZmZlcjogVWludDhBcnJheSkge1xuICB9XG5cbiAgcGFyc2UoKSB7XG4gICAgY29uc3QgcHMgPSBwYXJzZXI8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGUsIFRva2VuLCBSQ0Y4MjJQYXJzZVJlc3VsdD4oXG4gICAgICAncmZjODIyLW1lc3NhZ2VlJywgKGxhLCBlbWl0dGVyKSA9PiB0aGlzLnBhcnNlTGV4ZXIobGEsIGVtaXR0ZXIpLFxuICAgICAgKGxhKSA9PiB0aGlzLnBhcnNlR3JhbW1hcihsYSksXG4gICAgICBjaHVuayA9PiB7XG4gICAgICAgIChjaHVuayBhcyBUb2tlbikudGV4dCA9IGNodW5rLnZhbHVlcyA/XG4gICAgICAgICAgQnVmZmVyLmZyb20oVWludDhBcnJheS5mcm9tKGNodW5rLnZhbHVlcykpLnRvU3RyaW5nKCkgOlxuICAgICAgICAgICcnO1xuICAgICAgICByZXR1cm4gKGNodW5rIGFzIFRva2VuKTtcbiAgICAgIH0pO1xuICAgIHBzLndyaXRlKHRoaXMub3JpZ0J1ZmZlcik7XG4gICAgcHMuZW5kKCk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBwcy5nZXRSZXN1bHQoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBsb2cuZXJyb3IoJ0ZhaWxlZCB0byBwYXJzZTpcXG4nICsgQnVmZmVyLmZyb20odGhpcy5vcmlnQnVmZmVyKS50b1N0cmluZygndXRmOCcpKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlTGV4ZXI6IExleGVyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPiA9IChsYSwgZW1pdHRlcikgPT4ge1xuICAgIGxldCBjaHJDb2RlID0gbGEubGEoKTtcbiAgICBpZiAoY2hyQ29kZSA9PSBudWxsKSB7XG4gICAgICBlbWl0dGVyLmVuZCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBjaHIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNockNvZGUpO1xuICAgIGlmICh0aGlzLm11bHRpcGFydFN0YXJ0ZWQgJiYgbGEuaXNOZXh0KENSLCBMRiwgQ1IsIExGKSkge1xuICAgICAgLy8gcGFydCBoZWFkZXIgbXVzdCBiZSBvdmVyXG4gICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgIGxhLmFkdmFuY2UoMik7XG4gICAgICBlbWl0dGVyLmVtaXQoKTtcblxuICAgICAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICBsYS5hZHZhbmNlKDIpO1xuICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICB0aGlzLnBhcnNlUGFydEJvZHlUb2tlbihsYSwgZW1pdHRlcik7XG5cbiAgICB9IGVsc2UgaWYgKHRoaXMubXVsdGlwYXJ0U3RhcnRlZCAmJiBsYS5pc05leHQoREFTSCwgREFTSCkpIHtcbiAgICAgIGxhLnN0YXJ0Q2h1bmsoUkNGODIyVG9rZW5UeXBlLkRPVUJMRV9EQVNIKTtcbiAgICAgIGxhLmFkdmFuY2UoMik7IC8vIGVuZCBvZiB3aG9sZSBtZXNzYWdlXG4gICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKHRoaXMuYm91bmRhcnkgJiYgbGEuaXNOZXh0KC4uLnRoaXMuYm91bmRhcnkpKSB7XG4gICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5CT1VOREFSWSk7XG4gICAgICBsYS5hZHZhbmNlKHRoaXMuYm91bmRhcnkubGVuZ3RoKTtcbiAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgICAgdGhpcy5tdWx0aXBhcnRTdGFydGVkID0gdHJ1ZTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdtdWx0aXBhcnRTdGFydGVkIHRydWUnKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMudGV4dEJvZHlTdGFydGVkKSB7XG4gICAgICB3aGlsZSAobGEubGEoKSAhPSBudWxsICYmIGxhLmxhKCkgPT09IENSIHx8IGxhLmxhKCkgPT09IExGKSB7XG4gICAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICAgIH1cbiAgICAgIGxhLnN0YXJ0Q2h1bmsoUkNGODIyVG9rZW5UeXBlLlBBUlRfQk9EWSwgZmFsc2UpO1xuICAgICAgd2hpbGUgKGxhLmxhKCkgIT0gbnVsbCkge1xuICAgICAgICBsYS5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKGxhLmlzTmV4dChDUiwgTEYpKSB7XG4gICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgIGxhLmFkdmFuY2UoMik7XG4gICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICB9IGVsc2UgaWYgKChsYS5sYSgpKSA9PT0gTEYpIHtcbiAgICAgIGxhLnN0YXJ0Q2h1bmsoUkNGODIyVG9rZW5UeXBlLkNSTEYpO1xuICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgfSBlbHNlIGlmIChjaHIgPT09ICc6JyB8fCBjaHIgPT09ICc7Jykge1xuICAgICAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGVbY2hyXSk7XG4gICAgICBsYS5hZHZhbmNlKCk7XG4gICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICAgIHNraXBXaGl0ZVNwYWNlKGxhKTtcbiAgICB9IGVsc2UgaWYgKC9cXHMvLnRlc3QoY2hyKSkge1xuICAgICAgc2tpcFdoaXRlU3BhY2UobGEpO1xuICAgIH0gZWxzZSBpZiAoY2hyID09PSAnXCInIHx8IGNociA9PT0gJ1xcJycpIHtcbiAgICAgIHF1b3RlU3RyKGxhLCBlbWl0dGVyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3VtZUF0b20obGEsIGVtaXR0ZXIpO1xuICAgIH1cbiAgICBjaHJDb2RlID0gbGEubGEoKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VHcmFtbWFyOiBHcmFtbWFyPFRva2VuLCBSQ0Y4MjJQYXJzZVJlc3VsdD4gPSAobGEpID0+IHtcbiAgICBsZXQgcmVzdWx0OiBSQ0Y4MjJQYXJzZVJlc3VsdCA9IHtcbiAgICAgIGhlYWRlcnM6IHRoaXMucGFyc2VIZWFkZXJzKGxhKSxcbiAgICAgIHBhcnRzOiBbXVxuICAgIH07XG5cbiAgICAvLyBjb25zb2xlLmxvZygnYm91bmRhcnk6JywgU3RyaW5nLmZyb21DaGFyQ29kZSguLi50aGlzLmJvdW5kYXJ5ISkpO1xuXG4gICAgaWYgKHRoaXMuYm91bmRhcnkgPT0gbnVsbCkge1xuICAgICAgdGhpcy50ZXh0Qm9keVN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgY29uc3QgdGsgPSBsYS5sYSgpO1xuICAgICAgaWYgKHRrICE9IG51bGwpIHtcbiAgICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgICByZXN1bHQudGV4dEJvZHkgPSBCdWZmZXIuZnJvbSh0aGlzLm9yaWdCdWZmZXIuc2xpY2UodGshLnBvcywgdGshLmVuZCkpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCB0ayA9IGxhLmxhKCk7XG4gICAgICB3aGlsZSAodGsgIT0gbnVsbCkge1xuICAgICAgICAvLyBjb25zb2xlLmxvZygndGs6JywgdGsudGV4dCk7XG4gICAgICAgIGxhLmFzc2VydEFkdmFuY2VXaXRoKFtSQ0Y4MjJUb2tlblR5cGUuQk9VTkRBUlldLCBjb21wYXJlVG9rZW5UeXBlKTtcbiAgICAgICAgaWYgKChsYS5sYSgpKSEudHlwZSA9PT0gUkNGODIyVG9rZW5UeXBlLkRPVUJMRV9EQVNIKSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGFydEhlYWRlcnMgPSB0aGlzLnBhcnNlSGVhZGVycyhsYSk7XG4gICAgICAgIGNvbnN0IHBhcnRCb2R5ID0gbGEuYWR2YW5jZSgpIGFzIFBhcnRCb2R5VG9rZW47XG4gICAgICAgIGxhLmFzc2VydEFkdmFuY2VXaXRoKFtSQ0Y4MjJUb2tlblR5cGUuQ1JMRl0sIGNvbXBhcmVUb2tlblR5cGUpO1xuXG4gICAgICAgIHRoaXMub25QYXJzZUVhY2hQYXJ0KHJlc3VsdCwgcGFydEhlYWRlcnMsIHBhcnRCb2R5KTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ3JmYyB0b2tlbjogJyArIFJDRjgyMlRva2VuVHlwZVsobGEuYWR2YW5jZSgpKS50eXBlXSk7XG4gICAgICAgIHRrID0gbGEubGEoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdCBhcyBSQ0Y4MjJQYXJzZVJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgb25QYXJzZUVhY2hQYXJ0KHJlc3VsdDogUkNGODIyUGFyc2VSZXN1bHQsXG4gICAgcGFydEhlYWRlcnM6IFJDRjgyMlBhcnNlUmVzdWx0WydoZWFkZXJzJ10sXG4gICAgcGFydEJvZHk6IFBhcnRCb2R5VG9rZW4pIHtcbiAgICBjb25zdCBlbmNvZGluZ0hlYWRlciA9IHBhcnRIZWFkZXJzLmZpbmQoaGVhZGVyID0+IGhlYWRlci5rZXkgPT09ICdDb250ZW50LVRyYW5zZmVyLUVuY29kaW5nJyk7XG4gICAgY29uc3QgaXNCYXNlNjQgPSBlbmNvZGluZ0hlYWRlciAmJiBlbmNvZGluZ0hlYWRlci52YWx1ZVswXSA9PT0gJ2Jhc2U2NCc7XG5cbiAgICBpZiAoaXNCYXNlNjQpIHtcbiAgICAgIHBhcnRCb2R5LmRhdGEgPSBCdWZmZXIuZnJvbShwYXJ0Qm9keS5kYXRhLnRvU3RyaW5nKCksICdiYXNlNjQnKTtcbiAgICB9XG4gICAgY29uc3QgYXR0YWNobWVudEhlYWRlciA9IHBhcnRIZWFkZXJzLmZpbmQoaGVhZGVyID0+IGhlYWRlci5rZXkgPT09ICdDb250ZW50LURpc3Bvc2l0aW9uJyk7XG4gICAgbGV0IGF0dGFjaG1lbnROYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAoYXR0YWNobWVudEhlYWRlciAmJiBhdHRhY2htZW50SGVhZGVyLnZhbHVlWzBdID09PSAnYXR0YWNobWVudCcpIHtcbiAgICAgIGNvbnN0IG0gPSAvXihbXj1dKik9W1wiXT8oW15cIl0qKVtcIl0/JC8uZXhlYyhhdHRhY2htZW50SGVhZGVyLnZhbHVlWzFdKTtcbiAgICAgIGlmIChtICYmIG1bMV0gPT09ICdmaWxlbmFtZScpIHtcbiAgICAgICAgYXR0YWNobWVudE5hbWUgPSBQYXRoLnJlc29sdmUoVEVNUF9ESVIsIG1bMl0pO1xuICAgICAgICBmcy5ta2RpcnBTeW5jKFRFTVBfRElSKTtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhhdHRhY2htZW50TmFtZSwgcGFydEJvZHkuZGF0YSk7XG4gICAgICAgIGxvZy5pbmZvKGF0dGFjaG1lbnROYW1lICsgJyBpcyB3cml0dGVuJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmVzdWx0LnBhcnRzLnB1c2goe1xuICAgICAgaGVhZGVyczogcGFydEhlYWRlcnMsXG4gICAgICBib2R5OiBhdHRhY2htZW50TmFtZSA/IHVuZGVmaW5lZCA6IHBhcnRCb2R5LmRhdGEsXG4gICAgICBmaWxlOiBhdHRhY2htZW50TmFtZSA/IGF0dGFjaG1lbnROYW1lIDogdW5kZWZpbmVkXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNldEJvdW5kYXJ5KHN0cjogc3RyaW5nKSB7XG4gICAgY29uc3QgY2hyczogbnVtYmVyW10gPSBuZXcgQXJyYXkoc3RyLmxlbmd0aCk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHN0ci5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIGNocnNbaV0gPSBzdHIuY2hhckNvZGVBdChpKTtcbiAgICB9XG4gICAgdGhpcy5ib3VuZGFyeSA9IGNocnM7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlSGVhZGVycyhsYTogUGFyYW1ldGVyczxSZmNQYXJzZXJDb250ZXh0WydwYXJzZUdyYW1tYXInXT5bMF0pIHtcbiAgICBjb25zdCBoZWFkZXJzOiB7a2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmdbXX1bXSA9IFtdO1xuICAgIGxldCBuZXh0VGsgPSBsYS5sYSgpO1xuXG4gICAgd2hpbGUgKG5leHRUayAhPSBudWxsKSB7XG4gICAgICBpZiAobGEuaXNOZXh0V2l0aChbUkNGODIyVG9rZW5UeXBlLkFUT00sIFJDRjgyMlRva2VuVHlwZVsnOiddXSwgY29tcGFyZVRva2VuVHlwZSkpIHtcbiAgICAgICAgY29uc3Qga2V5ID0gbmV4dFRrLnRleHQhO1xuXG4gICAgICAgIGxhLmFkdmFuY2UoMik7XG4gICAgICAgIG5leHRUayA9IGxhLmxhKCk7XG5cbiAgICAgICAgbGV0IHZhbHVlID0gW10gYXMgc3RyaW5nW107XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IHtrZXksIHZhbHVlfTtcbiAgICAgICAgaGVhZGVycy5wdXNoKGhlYWRlcik7XG4gICAgICAgIGxldCBsYXN0VmFsdWVJdGVtID0gJyc7XG4gICAgICAgIHdoaWxlIChuZXh0VGsgIT0gbnVsbCAmJiBuZXh0VGsudHlwZSAhPT0gUkNGODIyVG9rZW5UeXBlLkNSTEYpIHtcbiAgICAgICAgICBpZiAobmV4dFRrLnR5cGUgPT09IFJDRjgyMlRva2VuVHlwZVsnOyddKSB7XG4gICAgICAgICAgICB2YWx1ZS5wdXNoKGxhc3RWYWx1ZUl0ZW0pO1xuICAgICAgICAgICAgbGFzdFZhbHVlSXRlbSA9ICcnO1xuICAgICAgICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgICAgICAgbmV4dFRrID0gbGEubGEoKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsYXN0VmFsdWVJdGVtICs9IChsYS5hZHZhbmNlKCkpLnRleHQ7XG4gICAgICAgICAgbmV4dFRrID0gbGEubGEoKTtcbiAgICAgICAgfVxuICAgICAgICB2YWx1ZS5wdXNoKGxhc3RWYWx1ZUl0ZW0pO1xuICAgICAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkgPT09ICdjb250ZW50LXR5cGUnICYmIHZhbHVlWzBdID09PSAnbXVsdGlwYXJ0L21peGVkJykge1xuICAgICAgICAgIGxldCBib3VuZGFyeTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgICAgIGZvciAoY29uc3QgdmFsdWVJdGVtIG9mIHZhbHVlLnNsaWNlKDEpKSB7XG4gICAgICAgICAgICBjb25zdCBtID0gL14oW149XSopPVtcIl0/KFteXCJdKilbXCJdPyQvLmV4ZWModmFsdWVJdGVtKTtcbiAgICAgICAgICAgIGlmIChtICYmIG1bMV0gPT09ICdib3VuZGFyeScpIHtcbiAgICAgICAgICAgICAgYm91bmRhcnkgPSBtWzJdO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGJvdW5kYXJ5KSB7XG4gICAgICAgICAgICB0aGlzLnNldEJvdW5kYXJ5KCctLScgKyBib3VuZGFyeSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgIH0gZWxzZSBpZiAobGEuaXNOZXh0V2l0aDxSQ0Y4MjJUb2tlblR5cGU+KFtSQ0Y4MjJUb2tlblR5cGUuQ1JMRiwgUkNGODIyVG9rZW5UeXBlLkNSTEZdLCBjb21wYXJlVG9rZW5UeXBlKSkge1xuICAgICAgICBsYS5hZHZhbmNlKDIpO1xuICAgICAgICBsZXQgbmV4dCA9IGxhLmxhKCk7XG4gICAgICAgIHdoaWxlIChuZXh0ICYmIG5leHQudHlwZSA9PT0gUkNGODIyVG9rZW5UeXBlLkNSTEYpIHtcbiAgICAgICAgICBsYS5hZHZhbmNlKCk7XG4gICAgICAgICAgbmV4dCA9IGxhLmxhKCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9IGVsc2UgaWYgKGxhLmlzTmV4dFdpdGgoW1JDRjgyMlRva2VuVHlwZS5DUkxGXSwgY29tcGFyZVRva2VuVHlwZSkpIHtcbiAgICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGEudGhyb3dFcnJvcigobGEuYWR2YW5jZSgpKS50ZXh0KTtcbiAgICAgICAgLy8gbGEuYWR2YW5jZSgpO1xuICAgICAgfVxuICAgICAgbmV4dFRrID0gbGEubGEoKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlcnM7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgdG9rZW5zOiBQQVJUX0JPRFkgQ1JMRiBCT1VOREFSWVxuICAgKiBAcGFyYW0gbGEgXG4gICAqL1xuICBwcml2YXRlIHBhcnNlUGFydEJvZHlUb2tlbihsYTogUGFyYW1ldGVyczxMZXhlcjxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4+WzBdLFxuICAgIGVtaXR0ZXI6IFBhcmFtZXRlcnM8TGV4ZXI8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+PlsxXSkge1xuICAgIGNvbnN0IHRrID0gbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUuUEFSVF9CT0RZKTtcbiAgICB0ay50cmFja1ZhbHVlID0gZmFsc2U7XG4gICAgY29uc3Qgb3JpZ0J1ZmZlck9mZnNldCA9IGxhLnBvc2l0aW9uO1xuXG4gICAgd2hpbGUgKChsYS5sYSgpKSAhPSBudWxsKSB7XG5cbiAgICAgIGlmIChsYS5pc05leHQoQ1IsIExGLCAuLi50aGlzLmJvdW5kYXJ5ISkpIHtcbiAgICAgICAgKHRrIGFzIHVua25vd24gYXMgUGFydEJvZHlUb2tlbikuZGF0YSA9IEJ1ZmZlci5mcm9tKHRoaXMub3JpZ0J1ZmZlci5zbGljZShvcmlnQnVmZmVyT2Zmc2V0LCBsYS5wb3NpdGlvbikpO1xuXG4gICAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuXG4gICAgICAgIGxhLnN0YXJ0Q2h1bmsoUkNGODIyVG9rZW5UeXBlLkNSTEYpO1xuICAgICAgICBsYS5hZHZhbmNlKDIpO1xuICAgICAgICBlbWl0dGVyLmVtaXQoKTtcblxuICAgICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5CT1VOREFSWSk7XG4gICAgICAgIGxhLmFkdmFuY2UodGhpcy5ib3VuZGFyeSEubGVuZ3RoKTtcbiAgICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgbGEuYWR2YW5jZSgpO1xuICAgIH1cbiAgfVxuXG59XG5cbmZ1bmN0aW9uIHF1b3RlU3RyKGxhOiBQYXJhbWV0ZXJzPExleGVyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPj5bMF0sXG4gIGVtaXR0ZXI6IFBhcmFtZXRlcnM8TGV4ZXI8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+PlsxXSkge1xuICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5xdW90ZVN0cik7XG4gIGNvbnN0IG9wZW5DaGFyID0gbGEuYWR2YW5jZSgpO1xuICB3aGlsZSAodHJ1ZSkge1xuICAgIGNvbnN0IG5leHQgPSBsYS5sYSgpO1xuICAgIGlmIChuZXh0ID09IG51bGwpIHtcbiAgICAgIHJldHVybiBsYS50aHJvd0Vycm9yKCk7XG4gICAgfVxuICAgIGlmIChuZXh0ID09PSBCQUNLX1NMQVNIKSB7XG4gICAgICBsYS5hZHZhbmNlKDIpO1xuICAgIH0gZWxzZSBpZiAobmV4dCA9PT0gb3BlbkNoYXIpIHtcbiAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgICAgYnJlYWs7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gc2tpcFdoaXRlU3BhY2UobGE6IFBhcmFtZXRlcnM8TGV4ZXI8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+PlswXSkge1xuICBkbyB7XG4gICAgY29uc3QgY29kZSA9IGxhLmxhKCk7XG4gICAgaWYgKGNvZGUgPT0gbnVsbCkgcmV0dXJuO1xuICAgIGlmICgvXFxzLy50ZXN0KFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkpKSB7XG4gICAgICBsYS5hZHZhbmNlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSB3aGlsZSAodHJ1ZSk7XG59XG5cbmZ1bmN0aW9uIGNvbnN1bWVBdG9tKGxhOiBQYXJhbWV0ZXJzPExleGVyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPj5bMF0sXG4gIGVtaXR0ZXI6IFBhcmFtZXRlcnM8TGV4ZXI8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+PlsxXSkge1xuICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5BVE9NKTtcbiAgbGEuYWR2YW5jZSgpO1xuICBsZXQgY29kZSA9IGxhLmxhKCk7XG4gIGxldCBlbWl0ID0gZmFsc2U7XG4gIHdoaWxlIChjb2RlICE9IG51bGwpIHtcbiAgICBzd2l0Y2ggKGNvZGUpIHtcbiAgICAgIGNhc2UgQ09MT05fTUFSSzpcbiAgICAgIGNhc2UgU0VNSV9DT0w6XG4gICAgICBjYXNlIFFVT1RFX01BUksxOlxuICAgICAgY2FzZSBRVU9URV9NQVJLMjpcbiAgICAgICAgZW1pdCA9IHRydWU7XG4gICAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgQ1I6XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKChsYS5sYSgpKSwgKGxhLmxhKDIpKSwgKGxhLmxhKDMpKSk7XG4gICAgICAgIGlmICghKGxhLmlzTmV4dChDUiwgTEYsIFdTKSkgJiYgIShsYS5pc05leHQoQ1IsIFdTKSkgJiZcbiAgICAgICAgICAhKGxhLmlzTmV4dChDUiwgTEYsIFRBQikpICYmICEobGEuaXNOZXh0KENSLCBUQUIpKSkge1xuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdlbWl0OiAnLCAobGEubGEoKSksIChsYS5sYSgyKSksIChsYS5sYSgzKSkpO1xuICAgICAgICAgIGVtaXQgPSB0cnVlO1xuICAgICAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxhLmFkdmFuY2UoMyk7XG4gICAgICAgICAgY29kZSA9IGxhLmxhKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIGNhc2UgTEY6XG4gICAgICAgIGlmICghIGxhLmlzTmV4dChMRiwgV1MpICYmICEgbGEuaXNOZXh0KExGLCBUQUIpKSB7XG4gICAgICAgICAgZW1pdCA9IHRydWU7XG4gICAgICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgICBjb2RlID0gbGEubGEoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgICBjb2RlID0gbGEubGEoKTtcbiAgICB9XG4gICAgaWYgKGVtaXQpIGJyZWFrO1xuICB9XG59XG5cbi8vIGZ1bmN0aW9uIHBhcnNlTXVsdGlwYXJ0KGxhOiBQYXJhbWV0ZXJzPHR5cGVvZiBwYXJzZUdyYW1tYXI+WzBdKSB7XG4vLyAgIHdoaWxlIChsYS5pc05leHQoREFTSCwgREFTSCkpXG4vLyB9XG5mdW5jdGlvbiBjb21wYXJlVG9rZW5UeXBlPFQ+KHRrOiBDaHVuazxudW1iZXIsIFQ+LCB0eXBlOiBUKSB7XG4gICByZXR1cm4gdGsudHlwZSA9PT0gdHlwZTtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2UocmVhZGFibGU6IEJ1ZmZlcik6IFJDRjgyMlBhcnNlUmVzdWx0IHtcbiAgY29uc3QgcGN0eCA9IG5ldyBSZmNQYXJzZXJDb250ZXh0KHJlYWRhYmxlKTtcbiAgcmV0dXJuIHBjdHgucGFyc2UoKTtcbn1cbiJdfQ==