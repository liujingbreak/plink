"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parse = exports.RCF822TokenType = void 0;
const tslib_1 = require("tslib");
const LLn_parser_1 = require("@wfh/plink/wfh/dist/LLn-parser");
const fs_extra_1 = tslib_1.__importDefault(require("fs-extra"));
const path_1 = tslib_1.__importDefault(require("path"));
const log = require('log4js').getLogger('@wfh/assets-processer.rfc822-sync-parser');
var RCF822TokenType;
(function (RCF822TokenType) {
    RCF822TokenType[RCF822TokenType["CRLF"] = 0] = "CRLF";
    RCF822TokenType[RCF822TokenType[":"] = 1] = ":";
    RCF822TokenType[RCF822TokenType[";"] = 2] = ";";
    RCF822TokenType[RCF822TokenType["quoteStr"] = 3] = "quoteStr";
    RCF822TokenType[RCF822TokenType["ATOM"] = 4] = "ATOM";
    RCF822TokenType[RCF822TokenType["BOUNDARY"] = 5] = "BOUNDARY";
    RCF822TokenType[RCF822TokenType["PART_BODY"] = 6] = "PART_BODY";
    RCF822TokenType[RCF822TokenType["DOUBLE_DASH"] = 7] = "DOUBLE_DASH";
})(RCF822TokenType = exports.RCF822TokenType || (exports.RCF822TokenType = {}));
const CR = '\r'.charCodeAt(0);
const LF = '\n'.charCodeAt(0);
const BACK_SLASH = '\\'.charCodeAt(0);
const QUOTE_MARK1 = '"'.charCodeAt(0);
const QUOTE_MARK2 = '\''.charCodeAt(0);
const COLON_MARK = ':'.charCodeAt(0);
const SEMI_COL = ';'.charCodeAt(0);
const WS = ' '.charCodeAt(0);
const TAB = '\t'.charCodeAt(0);
const DASH = '-'.charCodeAt(0);
// const DASH = '-'.charCodeAt(0);
const TEMP_DIR = 'dist/assets-processer/rfc822';
class RfcParserContext {
    constructor(origBuffer) {
        this.origBuffer = origBuffer;
        this.multipartStarted = false;
        this.textBodyStarted = false;
        this.parseLexer = (la, emitter) => {
            let chrCode = la.la();
            if (chrCode == null) {
                emitter.end();
                return;
            }
            const chr = String.fromCharCode(chrCode);
            if (this.multipartStarted && la.isNext(CR, LF, CR, LF)) {
                // part header must be over
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
                this.parsePartBodyToken(la, emitter);
            }
            else if (this.multipartStarted && la.isNext(DASH, DASH)) {
                la.startChunk(RCF822TokenType.DOUBLE_DASH);
                la.advance(2); // end of whole message
                emitter.emit();
                return;
            }
            else if (this.boundary && la.isNext(...this.boundary)) {
                la.startChunk(RCF822TokenType.BOUNDARY);
                la.advance(this.boundary.length);
                emitter.emit();
                this.multipartStarted = true;
                // console.log('multipartStarted true');
            }
            else if (this.textBodyStarted) {
                while (la.la() != null && la.la() === CR || la.la() === LF) {
                    la.advance();
                }
                la.startChunk(RCF822TokenType.PART_BODY, false);
                while (la.la() != null) {
                    la.advance();
                }
                emitter.emit();
                return;
            }
            else if (la.isNext(CR, LF)) {
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
            }
            else if ((la.la()) === LF) {
                la.startChunk(RCF822TokenType.CRLF);
                la.advance();
                emitter.emit();
            }
            else if (chr === ':' || chr === ';') {
                la.startChunk(RCF822TokenType[chr]);
                la.advance();
                emitter.emit();
                skipWhiteSpace(la);
            }
            else if (/\s/.test(chr)) {
                skipWhiteSpace(la);
            }
            else if (chr === '"' || chr === '\'') {
                quoteStr(la, emitter);
            }
            else {
                consumeAtom(la, emitter);
            }
            chrCode = la.la();
        };
        this.parseGrammar = (la) => {
            let result = {
                headers: this.parseHeaders(la),
                parts: []
            };
            // console.log('boundary:', String.fromCharCode(...this.boundary!));
            if (this.boundary == null) {
                this.textBodyStarted = true;
                const tk = la.la();
                if (tk != null) {
                    la.advance();
                    result.textBody = Buffer.from(this.origBuffer.slice(tk.pos, tk.end)).toString('utf8');
                }
            }
            else {
                let tk = la.la();
                while (tk != null) {
                    // console.log('tk:', tk.text);
                    la.assertAdvanceWith([RCF822TokenType.BOUNDARY], compareTokenType);
                    if ((la.la()).type === RCF822TokenType.DOUBLE_DASH) {
                        break;
                    }
                    const partHeaders = this.parseHeaders(la);
                    const partBody = la.advance();
                    la.assertAdvanceWith([RCF822TokenType.CRLF], compareTokenType);
                    this.onParseEachPart(result, partHeaders, partBody);
                    // console.log('rfc token: ' + RCF822TokenType[(la.advance()).type]);
                    tk = la.la();
                }
            }
            return result;
        };
    }
    parse() {
        const ps = (0, LLn_parser_1.parser)('rfc822-messagee', (la, emitter) => this.parseLexer(la, emitter), (la) => this.parseGrammar(la), chunk => {
            chunk.text = chunk.values ?
                Buffer.from(Uint8Array.from(chunk.values)).toString() :
                '';
            return chunk;
        });
        ps.write(this.origBuffer);
        ps.end();
        try {
            return ps.getResult();
        }
        catch (err) {
            // eslint-disable-next-line no-console
            log.error('Failed to parse:\n' + Buffer.from(this.origBuffer).toString('utf8'));
            throw err;
        }
    }
    onParseEachPart(result, partHeaders, partBody) {
        const encodingHeader = partHeaders.find(header => header.key === 'Content-Transfer-Encoding');
        const isBase64 = encodingHeader && encodingHeader.value[0] === 'base64';
        if (isBase64) {
            partBody.data = Buffer.from(partBody.data.toString(), 'base64');
        }
        const attachmentHeader = partHeaders.find(header => header.key === 'Content-Disposition');
        let attachmentName;
        if (attachmentHeader && attachmentHeader.value[0] === 'attachment') {
            const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(attachmentHeader.value[1]);
            if (m && m[1] === 'filename') {
                attachmentName = path_1.default.resolve(TEMP_DIR, m[2]);
                fs_extra_1.default.mkdirpSync(TEMP_DIR);
                fs_extra_1.default.writeFileSync(attachmentName, partBody.data);
                log.info(attachmentName + ' is written');
            }
        }
        result.parts.push({
            headers: partHeaders,
            body: attachmentName ? undefined : partBody.data,
            file: attachmentName ? attachmentName : undefined
        });
    }
    setBoundary(str) {
        const chrs = new Array(str.length);
        for (let i = 0, l = str.length; i < l; i++) {
            chrs[i] = str.charCodeAt(i);
        }
        this.boundary = chrs;
    }
    parseHeaders(la) {
        const headers = [];
        let nextTk = la.la();
        while (nextTk != null) {
            if (la.isNextWith([RCF822TokenType.ATOM, RCF822TokenType[':']], compareTokenType)) {
                const key = nextTk.text;
                la.advance(2);
                nextTk = la.la();
                let value = [];
                const header = { key, value };
                headers.push(header);
                let lastValueItem = '';
                while (nextTk != null && nextTk.type !== RCF822TokenType.CRLF) {
                    if (nextTk.type === RCF822TokenType[';']) {
                        value.push(lastValueItem);
                        lastValueItem = '';
                        la.advance();
                        nextTk = la.la();
                        continue;
                    }
                    lastValueItem += (la.advance()).text;
                    nextTk = la.la();
                }
                value.push(lastValueItem);
                if (key.toLowerCase() === 'content-type' && value[0] === 'multipart/mixed') {
                    let boundary;
                    for (const valueItem of value.slice(1)) {
                        const m = /^([^=]*)=["]?([^"]*)["]?$/.exec(valueItem);
                        if (m && m[1] === 'boundary') {
                            boundary = m[2];
                            break;
                        }
                    }
                    if (boundary) {
                        this.setBoundary('--' + boundary);
                    }
                }
            }
            else if (la.isNextWith([RCF822TokenType.CRLF, RCF822TokenType.CRLF], compareTokenType)) {
                la.advance(2);
                let next = la.la();
                while (next && next.type === RCF822TokenType.CRLF) {
                    la.advance();
                    next = la.la();
                }
                break;
            }
            else if (la.isNextWith([RCF822TokenType.CRLF], compareTokenType)) {
                la.advance();
            }
            else {
                la.throwError((la.advance()).text);
                // la.advance();
            }
            nextTk = la.la();
        }
        return headers;
    }
    /**
     * Generate tokens: PART_BODY CRLF BOUNDARY
     * @param la
     */
    parsePartBodyToken(la, emitter) {
        const tk = la.startChunk(RCF822TokenType.PART_BODY);
        tk.trackValue = false;
        const origBufferOffset = la.position;
        while ((la.la()) != null) {
            if (la.isNext(CR, LF, ...this.boundary)) {
                tk.data = Buffer.from(this.origBuffer.slice(origBufferOffset, la.position));
                emitter.emit();
                la.startChunk(RCF822TokenType.CRLF);
                la.advance(2);
                emitter.emit();
                la.startChunk(RCF822TokenType.BOUNDARY);
                la.advance(this.boundary.length);
                emitter.emit();
                break;
            }
            la.advance();
        }
    }
}
function quoteStr(la, emitter) {
    la.startChunk(RCF822TokenType.quoteStr);
    const openChar = la.advance();
    while (true) {
        const next = la.la();
        if (next == null) {
            return la.throwError();
        }
        if (next === BACK_SLASH) {
            la.advance(2);
        }
        else if (next === openChar) {
            la.advance();
            emitter.emit();
            break;
        }
        else {
            la.advance();
        }
    }
}
function skipWhiteSpace(la) {
    do {
        const code = la.la();
        if (code == null)
            return;
        if (/\s/.test(String.fromCharCode(code))) {
            la.advance();
        }
        else {
            break;
        }
    } while (true);
}
function consumeAtom(la, emitter) {
    la.startChunk(RCF822TokenType.ATOM);
    la.advance();
    let code = la.la();
    let emit = false;
    while (code != null) {
        switch (code) {
            case COLON_MARK:
            case SEMI_COL:
            case QUOTE_MARK1:
            case QUOTE_MARK2:
                emit = true;
                emitter.emit();
                break;
            case CR:
                // console.log((la.la()), (la.la(2)), (la.la(3)));
                if (!(la.isNext(CR, LF, WS)) && !(la.isNext(CR, WS)) &&
                    !(la.isNext(CR, LF, TAB)) && !(la.isNext(CR, TAB))) {
                    // console.log('emit: ', (la.la()), (la.la(2)), (la.la(3)));
                    emit = true;
                    emitter.emit();
                    break;
                }
                else {
                    la.advance(3);
                    code = la.la();
                    break;
                }
            case LF:
                if (!la.isNext(LF, WS) && !la.isNext(LF, TAB)) {
                    emit = true;
                    emitter.emit();
                    break;
                }
                else {
                    la.advance(2);
                    code = la.la();
                    break;
                }
            default:
                la.advance();
                code = la.la();
        }
        if (emit)
            break;
    }
}
// function parseMultipart(la: Parameters<typeof parseGrammar>[0]) {
//   while (la.isNext(DASH, DASH))
// }
function compareTokenType(tk, type) {
    return tk.type === type;
}
function parse(readable) {
    const pctx = new RfcParserContext(readable);
    return pctx.parse();
}
exports.parse = parse;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmZjODIyLXN5bmMtcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmZjODIyLXN5bmMtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSwrREFBK0U7QUFDL0UsZ0VBQTBCO0FBQzFCLHdEQUF3QjtBQUN4QixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7QUFFcEYsSUFBWSxlQVNYO0FBVEQsV0FBWSxlQUFlO0lBQ3pCLHFEQUFJLENBQUE7SUFDSiwrQ0FBRyxDQUFBO0lBQ0gsK0NBQUcsQ0FBQTtJQUNILDZEQUFRLENBQUE7SUFDUixxREFBSSxDQUFBO0lBQ0osNkRBQVEsQ0FBQTtJQUNSLCtEQUFTLENBQUE7SUFDVCxtRUFBVyxDQUFBO0FBQ2IsQ0FBQyxFQVRXLGVBQWUsR0FBZix1QkFBZSxLQUFmLHVCQUFlLFFBUzFCO0FBVUQsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0QyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckMsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzdCLE1BQU0s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O1lBQ0g7Z0JBQ0UsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNiLElBQUksR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7U0FDbEI7UUFDRCxJQUFJLElBQUk7WUFBRSxNQUFNO0tBQ2pCO0FBQ0gsQ0FBQztBQUVELG9FQUFvRTtBQUNwRSxrQ0FBa0M7QUFDbEMsSUFBSTtBQUNKLFNBQVMsZ0JBQWdCLENBQUksRUFBb0IsRUFBRSxJQUFPO0lBQ3ZELE9BQU8sRUFBRSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUM7QUFDM0IsQ0FBQztBQUdELFNBQWdCLEtBQUssQ0FBQyxRQUFnQjtJQUNwQyxNQUFNLElBQUksR0FBRyxJQUFJLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLE9BQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3RCLENBQUM7QUFIRCxzQkFHQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgTGV4ZXIsIEdyYW1tYXIsIHBhcnNlciwgQ2h1bmsgfSBmcm9tICdAd2ZoL3BsaW5rL3dmaC9kaXN0L0xMbi1wYXJzZXInO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuY29uc3QgbG9nID0gcmVxdWlyZSgnbG9nNGpzJykuZ2V0TG9nZ2VyKCdAd2ZoL2Fzc2V0cy1wcm9jZXNzZXIucmZjODIyLXN5bmMtcGFyc2VyJyk7XG5cbmV4cG9ydCBlbnVtIFJDRjgyMlRva2VuVHlwZSB7XG4gIENSTEYsXG4gICc6JyxcbiAgJzsnLFxuICBxdW90ZVN0cixcbiAgQVRPTSxcbiAgQk9VTkRBUlksXG4gIFBBUlRfQk9EWSxcbiAgRE9VQkxFX0RBU0hcbn1cblxuaW50ZXJmYWNlIFBhcnRCb2R5VG9rZW4gZXh0ZW5kcyBDaHVuazxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4ge1xuICBkYXRhOiBCdWZmZXI7XG59XG5cbmludGVyZmFjZSBUb2tlbiBleHRlbmRzIENodW5rPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPiB7XG4gIHRleHQ/OiBzdHJpbmc7XG59XG5cbmNvbnN0IENSID0gJ1xccicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IExGID0gJ1xcbicuY2hhckNvZGVBdCgwKTtcbmNvbnN0IEJBQ0tfU0xBU0ggPSAnXFxcXCcuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFFVT1RFX01BUksxID0gJ1wiJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgUVVPVEVfTUFSSzIgPSAnXFwnJy5jaGFyQ29kZUF0KDApO1xuY29uc3QgQ09MT05fTUFSSyA9ICc6Jy5jaGFyQ29kZUF0KDApO1xuY29uc3QgU0VNSV9DT0wgPSAnOycuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFdTID0gJyAnLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBUQUIgPSAnXFx0Jy5jaGFyQ29kZUF0KDApO1xuY29uc3QgREFTSCA9ICctJy5jaGFyQ29kZUF0KDApO1xuLy8gY29uc3QgREFTSCA9ICctJy5jaGFyQ29kZUF0KDApO1xuXG5jb25zdCBURU1QX0RJUiA9ICdkaXN0L2Fzc2V0cy1wcm9jZXNzZXIvcmZjODIyJztcbmV4cG9ydCBpbnRlcmZhY2UgUkNGODIyUGFyc2VSZXN1bHQge1xuICBoZWFkZXJzOiBSQ0Y4MjJIZWFkZXJUeXBlW107XG4gIHRleHRCb2R5Pzogc3RyaW5nO1xuICBwYXJ0czoge1xuICAgIGhlYWRlcnM6IFJDRjgyMkhlYWRlclR5cGVbXTtcbiAgICBib2R5PzogQnVmZmVyO1xuICAgIGZpbGU/OiBzdHJpbmc7XG4gIH1bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSQ0Y4MjJIZWFkZXJUeXBlIHtcbiAga2V5OiBzdHJpbmc7XG4gIHZhbHVlOiBzdHJpbmdbXTtcbn1cblxuY2xhc3MgUmZjUGFyc2VyQ29udGV4dCB7XG4gIHByaXZhdGUgYm91bmRhcnk6IG51bWJlcltdIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIG11bHRpcGFydFN0YXJ0ZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSB0ZXh0Qm9keVN0YXJ0ZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9yaWdCdWZmZXI6IFVpbnQ4QXJyYXkpIHtcbiAgfVxuXG4gIHBhcnNlKCkge1xuICAgIGNvbnN0IHBzID0gcGFyc2VyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlLCBUb2tlbiwgUkNGODIyUGFyc2VSZXN1bHQ+KFxuICAgICAgJ3JmYzgyMi1tZXNzYWdlZScsIChsYSwgZW1pdHRlcikgPT4gdGhpcy5wYXJzZUxleGVyKGxhLCBlbWl0dGVyKSxcbiAgICAgIChsYSkgPT4gdGhpcy5wYXJzZUdyYW1tYXIobGEpLFxuICAgICAgY2h1bmsgPT4ge1xuICAgICAgICAoY2h1bmsgYXMgVG9rZW4pLnRleHQgPSBjaHVuay52YWx1ZXMgP1xuICAgICAgICAgIEJ1ZmZlci5mcm9tKFVpbnQ4QXJyYXkuZnJvbShjaHVuay52YWx1ZXMpKS50b1N0cmluZygpIDpcbiAgICAgICAgICAnJztcbiAgICAgICAgcmV0dXJuIChjaHVuayBhcyBUb2tlbik7XG4gICAgICB9KTtcbiAgICBwcy53cml0ZSh0aGlzLm9yaWdCdWZmZXIpO1xuICAgIHBzLmVuZCgpO1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gcHMuZ2V0UmVzdWx0KCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgbG9nLmVycm9yKCdGYWlsZWQgdG8gcGFyc2U6XFxuJyArIEJ1ZmZlci5mcm9tKHRoaXMub3JpZ0J1ZmZlcikudG9TdHJpbmcoJ3V0ZjgnKSk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUxleGVyOiBMZXhlcjxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4gPSAobGEsIGVtaXR0ZXIpID0+IHtcbiAgICBsZXQgY2hyQ29kZSA9IGxhLmxhKCk7XG4gICAgaWYgKGNockNvZGUgPT0gbnVsbCkge1xuICAgICAgZW1pdHRlci5lbmQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgY2hyID0gU3RyaW5nLmZyb21DaGFyQ29kZShjaHJDb2RlKTtcbiAgICBpZiAodGhpcy5tdWx0aXBhcnRTdGFydGVkICYmIGxhLmlzTmV4dChDUiwgTEYsIENSLCBMRikpIHtcbiAgICAgIC8vIHBhcnQgaGVhZGVyIG11c3QgYmUgb3ZlclxuICAgICAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICBsYS5hZHZhbmNlKDIpO1xuICAgICAgZW1pdHRlci5lbWl0KCk7XG5cbiAgICAgIGxhLnN0YXJ0Q2h1bmsoUkNGODIyVG9rZW5UeXBlLkNSTEYpO1xuICAgICAgbGEuYWR2YW5jZSgyKTtcbiAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgICAgdGhpcy5wYXJzZVBhcnRCb2R5VG9rZW4obGEsIGVtaXR0ZXIpO1xuXG4gICAgfSBlbHNlIGlmICh0aGlzLm11bHRpcGFydFN0YXJ0ZWQgJiYgbGEuaXNOZXh0KERBU0gsIERBU0gpKSB7XG4gICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5ET1VCTEVfREFTSCk7XG4gICAgICBsYS5hZHZhbmNlKDIpOyAvLyBlbmQgb2Ygd2hvbGUgbWVzc2FnZVxuICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmICh0aGlzLmJvdW5kYXJ5ICYmIGxhLmlzTmV4dCguLi50aGlzLmJvdW5kYXJ5KSkge1xuICAgICAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUuQk9VTkRBUlkpO1xuICAgICAgbGEuYWR2YW5jZSh0aGlzLmJvdW5kYXJ5Lmxlbmd0aCk7XG4gICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICAgIHRoaXMubXVsdGlwYXJ0U3RhcnRlZCA9IHRydWU7XG4gICAgICAvLyBjb25zb2xlLmxvZygnbXVsdGlwYXJ0U3RhcnRlZCB0cnVlJyk7XG4gICAgfSBlbHNlIGlmICh0aGlzLnRleHRCb2R5U3RhcnRlZCkge1xuICAgICAgd2hpbGUgKGxhLmxhKCkgIT0gbnVsbCAmJiBsYS5sYSgpID09PSBDUiB8fCBsYS5sYSgpID09PSBMRikge1xuICAgICAgICBsYS5hZHZhbmNlKCk7XG4gICAgICB9XG4gICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5QQVJUX0JPRFksIGZhbHNlKTtcbiAgICAgIHdoaWxlIChsYS5sYSgpICE9IG51bGwpIHtcbiAgICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgfVxuICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChsYS5pc05leHQoQ1IsIExGKSkge1xuICAgICAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUuQ1JMRik7XG4gICAgICBsYS5hZHZhbmNlKDIpO1xuICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgfSBlbHNlIGlmICgobGEubGEoKSkgPT09IExGKSB7XG4gICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgIH0gZWxzZSBpZiAoY2hyID09PSAnOicgfHwgY2hyID09PSAnOycpIHtcbiAgICAgIGxhLnN0YXJ0Q2h1bmsoUkNGODIyVG9rZW5UeXBlW2Nocl0pO1xuICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgZW1pdHRlci5lbWl0KCk7XG4gICAgICBza2lwV2hpdGVTcGFjZShsYSk7XG4gICAgfSBlbHNlIGlmICgvXFxzLy50ZXN0KGNocikpIHtcbiAgICAgIHNraXBXaGl0ZVNwYWNlKGxhKTtcbiAgICB9IGVsc2UgaWYgKGNociA9PT0gJ1wiJyB8fCBjaHIgPT09ICdcXCcnKSB7XG4gICAgICBxdW90ZVN0cihsYSwgZW1pdHRlcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN1bWVBdG9tKGxhLCBlbWl0dGVyKTtcbiAgICB9XG4gICAgY2hyQ29kZSA9IGxhLmxhKCk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlR3JhbW1hcjogR3JhbW1hcjxUb2tlbiwgUkNGODIyUGFyc2VSZXN1bHQ+ID0gKGxhKSA9PiB7XG4gICAgbGV0IHJlc3VsdDogUkNGODIyUGFyc2VSZXN1bHQgPSB7XG4gICAgICBoZWFkZXJzOiB0aGlzLnBhcnNlSGVhZGVycyhsYSksXG4gICAgICBwYXJ0czogW11cbiAgICB9O1xuXG4gICAgLy8gY29uc29sZS5sb2coJ2JvdW5kYXJ5OicsIFN0cmluZy5mcm9tQ2hhckNvZGUoLi4udGhpcy5ib3VuZGFyeSEpKTtcblxuICAgIGlmICh0aGlzLmJvdW5kYXJ5ID09IG51bGwpIHtcbiAgICAgIHRoaXMudGV4dEJvZHlTdGFydGVkID0gdHJ1ZTtcbiAgICAgIGNvbnN0IHRrID0gbGEubGEoKTtcbiAgICAgIGlmICh0ayAhPSBudWxsKSB7XG4gICAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICAgICAgcmVzdWx0LnRleHRCb2R5ID0gQnVmZmVyLmZyb20odGhpcy5vcmlnQnVmZmVyLnNsaWNlKHRrIS5wb3MsIHRrIS5lbmQpKS50b1N0cmluZygndXRmOCcpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgdGsgPSBsYS5sYSgpO1xuICAgICAgd2hpbGUgKHRrICE9IG51bGwpIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ3RrOicsIHRrLnRleHQpO1xuICAgICAgICBsYS5hc3NlcnRBZHZhbmNlV2l0aChbUkNGODIyVG9rZW5UeXBlLkJPVU5EQVJZXSwgY29tcGFyZVRva2VuVHlwZSk7XG4gICAgICAgIGlmICgobGEubGEoKSkhLnR5cGUgPT09IFJDRjgyMlRva2VuVHlwZS5ET1VCTEVfREFTSCkge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhcnRIZWFkZXJzID0gdGhpcy5wYXJzZUhlYWRlcnMobGEpO1xuICAgICAgICBjb25zdCBwYXJ0Qm9keSA9IGxhLmFkdmFuY2UoKSBhcyBQYXJ0Qm9keVRva2VuO1xuICAgICAgICBsYS5hc3NlcnRBZHZhbmNlV2l0aChbUkNGODIyVG9rZW5UeXBlLkNSTEZdLCBjb21wYXJlVG9rZW5UeXBlKTtcblxuICAgICAgICB0aGlzLm9uUGFyc2VFYWNoUGFydChyZXN1bHQsIHBhcnRIZWFkZXJzLCBwYXJ0Qm9keSk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdyZmMgdG9rZW46ICcgKyBSQ0Y4MjJUb2tlblR5cGVbKGxhLmFkdmFuY2UoKSkudHlwZV0pO1xuICAgICAgICB0ayA9IGxhLmxhKCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQgYXMgUkNGODIyUGFyc2VSZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIG9uUGFyc2VFYWNoUGFydChyZXN1bHQ6IFJDRjgyMlBhcnNlUmVzdWx0LFxuICAgIHBhcnRIZWFkZXJzOiBSQ0Y4MjJQYXJzZVJlc3VsdFsnaGVhZGVycyddLFxuICAgIHBhcnRCb2R5OiBQYXJ0Qm9keVRva2VuKSB7XG4gICAgY29uc3QgZW5jb2RpbmdIZWFkZXIgPSBwYXJ0SGVhZGVycy5maW5kKGhlYWRlciA9PiBoZWFkZXIua2V5ID09PSAnQ29udGVudC1UcmFuc2Zlci1FbmNvZGluZycpO1xuICAgIGNvbnN0IGlzQmFzZTY0ID0gZW5jb2RpbmdIZWFkZXIgJiYgZW5jb2RpbmdIZWFkZXIudmFsdWVbMF0gPT09ICdiYXNlNjQnO1xuXG4gICAgaWYgKGlzQmFzZTY0KSB7XG4gICAgICBwYXJ0Qm9keS5kYXRhID0gQnVmZmVyLmZyb20ocGFydEJvZHkuZGF0YS50b1N0cmluZygpLCAnYmFzZTY0Jyk7XG4gICAgfVxuICAgIGNvbnN0IGF0dGFjaG1lbnRIZWFkZXIgPSBwYXJ0SGVhZGVycy5maW5kKGhlYWRlciA9PiBoZWFkZXIua2V5ID09PSAnQ29udGVudC1EaXNwb3NpdGlvbicpO1xuICAgIGxldCBhdHRhY2htZW50TmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgaWYgKGF0dGFjaG1lbnRIZWFkZXIgJiYgYXR0YWNobWVudEhlYWRlci52YWx1ZVswXSA9PT0gJ2F0dGFjaG1lbnQnKSB7XG4gICAgICBjb25zdCBtID0gL14oW149XSopPVtcIl0/KFteXCJdKilbXCJdPyQvLmV4ZWMoYXR0YWNobWVudEhlYWRlci52YWx1ZVsxXSk7XG4gICAgICBpZiAobSAmJiBtWzFdID09PSAnZmlsZW5hbWUnKSB7XG4gICAgICAgIGF0dGFjaG1lbnROYW1lID0gUGF0aC5yZXNvbHZlKFRFTVBfRElSLCBtWzJdKTtcbiAgICAgICAgZnMubWtkaXJwU3luYyhURU1QX0RJUik7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMoYXR0YWNobWVudE5hbWUsIHBhcnRCb2R5LmRhdGEpO1xuICAgICAgICBsb2cuaW5mbyhhdHRhY2htZW50TmFtZSArICcgaXMgd3JpdHRlbicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJlc3VsdC5wYXJ0cy5wdXNoKHtcbiAgICAgIGhlYWRlcnM6IHBhcnRIZWFkZXJzLFxuICAgICAgYm9keTogYXR0YWNobWVudE5hbWUgPyB1bmRlZmluZWQgOiBwYXJ0Qm9keS5kYXRhLFxuICAgICAgZmlsZTogYXR0YWNobWVudE5hbWUgPyBhdHRhY2htZW50TmFtZSA6IHVuZGVmaW5lZFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRCb3VuZGFyeShzdHI6IHN0cmluZykge1xuICAgIGNvbnN0IGNocnM6IG51bWJlcltdID0gbmV3IEFycmF5KHN0ci5sZW5ndGgpO1xuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBzdHIubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICBjaHJzW2ldID0gc3RyLmNoYXJDb2RlQXQoaSk7XG4gICAgfVxuICAgIHRoaXMuYm91bmRhcnkgPSBjaHJzO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUhlYWRlcnMobGE6IFBhcmFtZXRlcnM8UmZjUGFyc2VyQ29udGV4dFsncGFyc2VHcmFtbWFyJ10+WzBdKSB7XG4gICAgY29uc3QgaGVhZGVyczoge2tleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nW119W10gPSBbXTtcbiAgICBsZXQgbmV4dFRrID0gbGEubGEoKTtcblxuICAgIHdoaWxlIChuZXh0VGsgIT0gbnVsbCkge1xuICAgICAgaWYgKGxhLmlzTmV4dFdpdGgoW1JDRjgyMlRva2VuVHlwZS5BVE9NLCBSQ0Y4MjJUb2tlblR5cGVbJzonXV0sIGNvbXBhcmVUb2tlblR5cGUpKSB7XG4gICAgICAgIGNvbnN0IGtleSA9IG5leHRUay50ZXh0ITtcblxuICAgICAgICBsYS5hZHZhbmNlKDIpO1xuICAgICAgICBuZXh0VGsgPSBsYS5sYSgpO1xuXG4gICAgICAgIGxldCB2YWx1ZSA9IFtdIGFzIHN0cmluZ1tdO1xuICAgICAgICBjb25zdCBoZWFkZXIgPSB7a2V5LCB2YWx1ZX07XG4gICAgICAgIGhlYWRlcnMucHVzaChoZWFkZXIpO1xuICAgICAgICBsZXQgbGFzdFZhbHVlSXRlbSA9ICcnO1xuICAgICAgICB3aGlsZSAobmV4dFRrICE9IG51bGwgJiYgbmV4dFRrLnR5cGUgIT09IFJDRjgyMlRva2VuVHlwZS5DUkxGKSB7XG4gICAgICAgICAgaWYgKG5leHRUay50eXBlID09PSBSQ0Y4MjJUb2tlblR5cGVbJzsnXSkge1xuICAgICAgICAgICAgdmFsdWUucHVzaChsYXN0VmFsdWVJdGVtKTtcbiAgICAgICAgICAgIGxhc3RWYWx1ZUl0ZW0gPSAnJztcbiAgICAgICAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICAgICAgICAgIG5leHRUayA9IGxhLmxhKCk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbGFzdFZhbHVlSXRlbSArPSAobGEuYWR2YW5jZSgpKS50ZXh0O1xuICAgICAgICAgIG5leHRUayA9IGxhLmxhKCk7XG4gICAgICAgIH1cbiAgICAgICAgdmFsdWUucHVzaChsYXN0VmFsdWVJdGVtKTtcbiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpID09PSAnY29udGVudC10eXBlJyAmJiB2YWx1ZVswXSA9PT0gJ211bHRpcGFydC9taXhlZCcpIHtcbiAgICAgICAgICBsZXQgYm91bmRhcnk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgICAgICBmb3IgKGNvbnN0IHZhbHVlSXRlbSBvZiB2YWx1ZS5zbGljZSgxKSkge1xuICAgICAgICAgICAgY29uc3QgbSA9IC9eKFtePV0qKT1bXCJdPyhbXlwiXSopW1wiXT8kLy5leGVjKHZhbHVlSXRlbSk7XG4gICAgICAgICAgICBpZiAobSAmJiBtWzFdID09PSAnYm91bmRhcnknKSB7XG4gICAgICAgICAgICAgIGJvdW5kYXJ5ID0gbVsyXTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChib3VuZGFyeSkge1xuICAgICAgICAgICAgdGhpcy5zZXRCb3VuZGFyeSgnLS0nICsgYm91bmRhcnkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICB9IGVsc2UgaWYgKGxhLmlzTmV4dFdpdGg8UkNGODIyVG9rZW5UeXBlPihbUkNGODIyVG9rZW5UeXBlLkNSTEYsIFJDRjgyMlRva2VuVHlwZS5DUkxGXSwgY29tcGFyZVRva2VuVHlwZSkpIHtcbiAgICAgICAgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgbGV0IG5leHQgPSBsYS5sYSgpO1xuICAgICAgICB3aGlsZSAobmV4dCAmJiBuZXh0LnR5cGUgPT09IFJDRjgyMlRva2VuVHlwZS5DUkxGKSB7XG4gICAgICAgICAgbGEuYWR2YW5jZSgpO1xuICAgICAgICAgIG5leHQgPSBsYS5sYSgpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfSBlbHNlIGlmIChsYS5pc05leHRXaXRoKFtSQ0Y4MjJUb2tlblR5cGUuQ1JMRl0sIGNvbXBhcmVUb2tlblR5cGUpKSB7XG4gICAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxhLnRocm93RXJyb3IoKGxhLmFkdmFuY2UoKSkudGV4dCk7XG4gICAgICAgIC8vIGxhLmFkdmFuY2UoKTtcbiAgICAgIH1cbiAgICAgIG5leHRUayA9IGxhLmxhKCk7XG4gICAgfVxuICAgIHJldHVybiBoZWFkZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIHRva2VuczogUEFSVF9CT0RZIENSTEYgQk9VTkRBUllcbiAgICogQHBhcmFtIGxhIFxuICAgKi9cbiAgcHJpdmF0ZSBwYXJzZVBhcnRCb2R5VG9rZW4obGE6IFBhcmFtZXRlcnM8TGV4ZXI8bnVtYmVyLCBSQ0Y4MjJUb2tlblR5cGU+PlswXSxcbiAgICBlbWl0dGVyOiBQYXJhbWV0ZXJzPExleGVyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPj5bMV0pIHtcbiAgICBjb25zdCB0ayA9IGxhLnN0YXJ0Q2h1bmsoUkNGODIyVG9rZW5UeXBlLlBBUlRfQk9EWSk7XG4gICAgdGsudHJhY2tWYWx1ZSA9IGZhbHNlO1xuICAgIGNvbnN0IG9yaWdCdWZmZXJPZmZzZXQgPSBsYS5wb3NpdGlvbjtcblxuICAgIHdoaWxlICgobGEubGEoKSkgIT0gbnVsbCkge1xuXG4gICAgICBpZiAobGEuaXNOZXh0KENSLCBMRiwgLi4udGhpcy5ib3VuZGFyeSEpKSB7XG4gICAgICAgICh0ayBhcyB1bmtub3duIGFzIFBhcnRCb2R5VG9rZW4pLmRhdGEgPSBCdWZmZXIuZnJvbSh0aGlzLm9yaWdCdWZmZXIuc2xpY2Uob3JpZ0J1ZmZlck9mZnNldCwgbGEucG9zaXRpb24pKTtcblxuICAgICAgICBlbWl0dGVyLmVtaXQoKTtcblxuICAgICAgICBsYS5zdGFydENodW5rKFJDRjgyMlRva2VuVHlwZS5DUkxGKTtcbiAgICAgICAgbGEuYWR2YW5jZSgyKTtcbiAgICAgICAgZW1pdHRlci5lbWl0KCk7XG5cbiAgICAgICAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUuQk9VTkRBUlkpO1xuICAgICAgICBsYS5hZHZhbmNlKHRoaXMuYm91bmRhcnkhLmxlbmd0aCk7XG4gICAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICB9XG4gIH1cblxufVxuXG5mdW5jdGlvbiBxdW90ZVN0cihsYTogUGFyYW1ldGVyczxMZXhlcjxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4+WzBdLFxuICBlbWl0dGVyOiBQYXJhbWV0ZXJzPExleGVyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPj5bMV0pIHtcbiAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUucXVvdGVTdHIpO1xuICBjb25zdCBvcGVuQ2hhciA9IGxhLmFkdmFuY2UoKTtcbiAgd2hpbGUgKHRydWUpIHtcbiAgICBjb25zdCBuZXh0ID0gbGEubGEoKTtcbiAgICBpZiAobmV4dCA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gbGEudGhyb3dFcnJvcigpO1xuICAgIH1cbiAgICBpZiAobmV4dCA9PT0gQkFDS19TTEFTSCkge1xuICAgICAgbGEuYWR2YW5jZSgyKTtcbiAgICB9IGVsc2UgaWYgKG5leHQgPT09IG9wZW5DaGFyKSB7XG4gICAgICBsYS5hZHZhbmNlKCk7XG4gICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICAgIGJyZWFrO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYS5hZHZhbmNlKCk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHNraXBXaGl0ZVNwYWNlKGxhOiBQYXJhbWV0ZXJzPExleGVyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPj5bMF0pIHtcbiAgZG8ge1xuICAgIGNvbnN0IGNvZGUgPSBsYS5sYSgpO1xuICAgIGlmIChjb2RlID09IG51bGwpIHJldHVybjtcbiAgICBpZiAoL1xccy8udGVzdChTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpKSkge1xuICAgICAgbGEuYWR2YW5jZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH0gd2hpbGUgKHRydWUpO1xufVxuXG5mdW5jdGlvbiBjb25zdW1lQXRvbShsYTogUGFyYW1ldGVyczxMZXhlcjxudW1iZXIsIFJDRjgyMlRva2VuVHlwZT4+WzBdLFxuICBlbWl0dGVyOiBQYXJhbWV0ZXJzPExleGVyPG51bWJlciwgUkNGODIyVG9rZW5UeXBlPj5bMV0pIHtcbiAgbGEuc3RhcnRDaHVuayhSQ0Y4MjJUb2tlblR5cGUuQVRPTSk7XG4gIGxhLmFkdmFuY2UoKTtcbiAgbGV0IGNvZGUgPSBsYS5sYSgpO1xuICBsZXQgZW1pdCA9IGZhbHNlO1xuICB3aGlsZSAoY29kZSAhPSBudWxsKSB7XG4gICAgc3dpdGNoIChjb2RlKSB7XG4gICAgICBjYXNlIENPTE9OX01BUks6XG4gICAgICBjYXNlIFNFTUlfQ09MOlxuICAgICAgY2FzZSBRVU9URV9NQVJLMTpcbiAgICAgIGNhc2UgUVVPVEVfTUFSSzI6XG4gICAgICAgIGVtaXQgPSB0cnVlO1xuICAgICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIENSOlxuICAgICAgICAvLyBjb25zb2xlLmxvZygobGEubGEoKSksIChsYS5sYSgyKSksIChsYS5sYSgzKSkpO1xuICAgICAgICBpZiAoIShsYS5pc05leHQoQ1IsIExGLCBXUykpICYmICEobGEuaXNOZXh0KENSLCBXUykpICYmXG4gICAgICAgICAgIShsYS5pc05leHQoQ1IsIExGLCBUQUIpKSAmJiAhKGxhLmlzTmV4dChDUiwgVEFCKSkpIHtcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnZW1pdDogJywgKGxhLmxhKCkpLCAobGEubGEoMikpLCAobGEubGEoMykpKTtcbiAgICAgICAgICBlbWl0ID0gdHJ1ZTtcbiAgICAgICAgICBlbWl0dGVyLmVtaXQoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsYS5hZHZhbmNlKDMpO1xuICAgICAgICAgIGNvZGUgPSBsYS5sYSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICBjYXNlIExGOlxuICAgICAgICBpZiAoISBsYS5pc05leHQoTEYsIFdTKSAmJiAhIGxhLmlzTmV4dChMRiwgVEFCKSkge1xuICAgICAgICAgIGVtaXQgPSB0cnVlO1xuICAgICAgICAgIGVtaXR0ZXIuZW1pdCgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxhLmFkdmFuY2UoMik7XG4gICAgICAgICAgY29kZSA9IGxhLmxhKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGxhLmFkdmFuY2UoKTtcbiAgICAgICAgY29kZSA9IGxhLmxhKCk7XG4gICAgfVxuICAgIGlmIChlbWl0KSBicmVhaztcbiAgfVxufVxuXG4vLyBmdW5jdGlvbiBwYXJzZU11bHRpcGFydChsYTogUGFyYW1ldGVyczx0eXBlb2YgcGFyc2VHcmFtbWFyPlswXSkge1xuLy8gICB3aGlsZSAobGEuaXNOZXh0KERBU0gsIERBU0gpKVxuLy8gfVxuZnVuY3Rpb24gY29tcGFyZVRva2VuVHlwZTxUPih0azogQ2h1bms8bnVtYmVyLCBUPiwgdHlwZTogVCkge1xuICAgcmV0dXJuIHRrLnR5cGUgPT09IHR5cGU7XG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlKHJlYWRhYmxlOiBCdWZmZXIpOiBSQ0Y4MjJQYXJzZVJlc3VsdCB7XG4gIGNvbnN0IHBjdHggPSBuZXcgUmZjUGFyc2VyQ29udGV4dChyZWFkYWJsZSk7XG4gIHJldHVybiBwY3R4LnBhcnNlKCk7XG59XG4iXX0=