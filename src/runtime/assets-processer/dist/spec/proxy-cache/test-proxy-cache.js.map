{"version":3,"file":"test-proxy-cache.js","sourceRoot":"","sources":["test-proxy-cache.ts"],"names":[],"mappings":"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","sourcesContent":["import {spawn} from 'child_process';\nimport os from 'os';\nimport Path from 'path';\nimport * as rx from 'rxjs';\nimport * as op from 'rxjs/operators';\nimport fs from 'fs-extra';\nimport {config, runServer} from '@wfh/plink';\nconst isWin = os.platform() === 'win32';\n\nasync function runNpmInstall(clean: boolean) {\n  if (clean) {\n    const serverCache = Path.resolve(config().destDir, 'npm-server-cache');\n    if (fs.existsSync(serverCache))\n      await fs.remove(serverCache);\n  }\n\n  config.change(setting => {\n    setting['@wfh/assets-processer'].npmRegistryCacheServer = {\n      path: '/npm',\n      cacheDir: setting.destDir + '/npm-server-cache',\n      // registry: 'https://registry.npm.taobao.org/'\n      registry: 'https://registry.npmjs.org/'\n    };\n  });\n\n  const {started, shutdown} = runServer();\n  await started;\n  await rx.of('node_modules', 'package-lock.json', 'npm-cache').pipe(\n    op.mergeMap(dir => {\n      const target = Path.resolve(__dirname, dir);\n      if (fs.existsSync(target)) {\n        return fs.remove(target);\n      }\n      return rx.EMPTY;\n    })\n  ).toPromise();\n\n  const cp = spawn(isWin ? 'npm.cmd' : 'npm', ['install', '--ddd'], {\n    cwd: __dirname, stdio: 'inherit',\n    timeout: 65000\n  });\n\n  const error$ = rx.fromEventPattern<Error>(\n    h => cp.on('error', h), h => cp.off('error', h)\n  ).pipe(\n    op.switchMap(err => rx.throwError(err))\n  );\n\n  const exit$ = rx.fromEventPattern(h => cp.on('exit', h), h => cp.off('exit', h));\n\n  return rx.merge(error$, exit$, rx.timer(3 * 60000)).pipe(\n    op.take(1),\n    op.catchError(err => {\n      // eslint-disable-next-line no-console\n      console.log('test npm install failed:', err);\n      return rx.of(1);\n    }),\n    op.concatMap(async () => {\n      // eslint-disable-next-line no-console\n      console.log('kill: ', cp.kill('SIGINT'));\n      await shutdown();\n      // eslint-disable-next-line no-console\n      console.log('------- shutdown http server done ---------');\n    }),\n    op.tap(() => process.exit(0))\n  ).toPromise();\n\n}\n\nexport async function npmInstall() {\n  await rx.of('node_modules', 'package-lock.json', 'npm-cache').pipe(\n    op.mergeMap(dir => {\n      const target = Path.resolve(__dirname, dir);\n      if (fs.existsSync(target)) {\n        return fs.remove(target);\n      }\n      return rx.EMPTY;\n    })\n  ).toPromise();\n\n  const cp = spawn(isWin ? 'npm.cmd' : 'npm', ['install', '--ddd'], {\n    cwd: __dirname, stdio: 'inherit',\n    timeout: 65000\n  });\n\n  const error$ = rx.fromEventPattern<Error>(\n    h => cp.on('error', h), h => cp.off('error', h)\n  ).pipe(\n    op.switchMap(err => rx.throwError(err))\n  );\n\n  const exit$ = rx.fromEventPattern(h => cp.on('exit', h), h => cp.off('exit', h));\n\n  return rx.merge(error$, exit$, rx.timer(3 * 60000)).pipe(\n    op.take(1),\n    op.catchError(err => {\n      // eslint-disable-next-line no-console\n      console.log('test npm install failed:', err);\n      return rx.of(1);\n    }),\n    op.tap(() => {\n      // eslint-disable-next-line no-console\n      console.log('kill: ', cp.kill('SIGINT'));\n      // await shutdown();\n      // eslint-disable-next-line no-console\n      console.log('------- shutdown http server done ---------');\n    })\n  ).toPromise();\n}\n\nexport function test() {\n  return runNpmInstall(false);\n}\n\nexport function cleanTest() {\n  return runNpmInstall(true);\n}\n\n"]}