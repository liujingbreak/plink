{"version":3,"file":"utils.js","sourceRoot":"","sources":["utils.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-argument */\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\nimport stream from 'stream';\nimport {ClientRequest, IncomingMessage} from 'http';\nimport * as querystring from 'querystring';\nimport {Request, Response, NextFunction} from 'express';\nimport api from '__plink';\nimport _ from 'lodash';\nimport * as rx from 'rxjs';\nimport * as op from 'rxjs/operators';\nimport {readCompressedResponse} from '@wfh/http-server/dist/utils';\nimport {logger} from '@wfh/plink';\nimport {ServerOptions} from 'http-proxy';\nimport { createProxyMiddleware as proxy, Options as ProxyOptions} from 'http-proxy-middleware';\n\nconst logTime = logger.getLogger(api.packageName + '.timestamp');\n/**\n * Middleware for printing each response process duration time to log\n * @param req \n * @param res \n * @param next \n */\nexport function createResponseTimestamp(req: Request, res: Response, next: NextFunction) {\n  const date = new Date();\n  const startTime = date.getTime();\n\n  const end = res.end;\n\n  function print() {\n    const now = new Date().getTime();\n    logTime.info(`request: ${req.method} ${req.originalUrl} | status: ${res.statusCode}, [response duration: ${now - startTime}ms` +\n      `] (since ${date.toLocaleTimeString()} ${startTime}) [${req.header('user-agent')!}]`);\n  }\n\n  res.end = function(_chunk?: any, _encoding?: string | (() => void), _cb?: () => void) {\n    const argv = Array.prototype.slice.call(arguments, 0);\n    const lastArg = arguments[arguments.length - 1];\n    if (typeof lastArg === 'function') {\n      const originCb = arguments[arguments.length - 1];\n      argv[argv.length - 1] = () => {\n        originCb();\n        print();\n      };\n    } else if (argv.length === 0) {\n      argv.push(null, print);\n    } else if (argv.length === 1) {\n      argv.push(print);\n    }\n    const ret = end.apply(res, argv as any);\n    return ret;\n  };\n\n  next();\n}\n\n/**\n * This function uses http-proxy-middleware internally.\n * \n * Be aware with command line option \"--verbose\", once enable \"verbose\", this function will\n * read (pipe) remote server response body into a string buffer for any message with content-type is \"text\" or \"json\" based\n * Create and use an HTTP request proxy for specific request path\n * @param proxyPath \n * @param targetUrl \n */\nexport function setupHttpProxy(proxyPath: string, targetUrl: string,\n  opts: {\n    /** Bypass CORS restrict on target server, default is true */\n    deleteOrigin?: boolean;\n    pathRewrite?: ProxyOptions['pathRewrite'];\n    onProxyReq?: ProxyOptions['onProxyReq'];\n    onProxyRes?: ProxyOptions['onProxyRes'];\n    onError?: ProxyOptions['onError'];\n    buffer?: ProxyOptions['buffer'];\n    selfHandleResponse?: ProxyOptions['selfHandleResponse'];\n    proxyTimeout?: ProxyOptions['proxyTimeout'];\n  } = {}) {\n\n  proxyPath = _.trimEnd(proxyPath, '/');\n  targetUrl = _.trimEnd(targetUrl, '/');\n\n  const defaultOpt = defaultProxyOptions(proxyPath, targetUrl);\n\n  const proxyMidOpt: ProxyOptions = {\n    ...defaultOpt,\n    onProxyReq(...args) {\n      const origHeader = args[0].getHeader('Origin');\n      defaultOpt.onProxyReq(...args);\n\n      if (opts.deleteOrigin === false) {\n        // Recover removed header \"Origin\"\n        args[0].setHeader('Origin', origHeader as string);\n      }\n      if (opts.onProxyReq)\n        opts.onProxyReq(...args);\n    },\n    onProxyRes(...args) {\n      if (opts.onProxyRes)\n        opts.onProxyRes(...args);\n      defaultOpt.onProxyRes(...args);\n    },\n    onError(...args) {\n      defaultOpt.onError(...args);\n      if (opts.onError)\n        opts.onError(...args);\n    }\n  };\n\n\n  api.expressAppSet(app => {\n    app.use(proxyPath, proxy(proxyMidOpt));\n  });\n}\n\n/*\n * This interface is not exposed by http-proxy-middleware, it is used when option \"followRedirect\"\n * is enabled, most likely this is behavior of http-proxy\n */\ninterface RedirectableRequest {\n  _currentRequest: ClientRequest;\n}\n\nexport function isRedirectableRequest(req: unknown): req is RedirectableRequest {\n  return (req as RedirectableRequest)._currentRequest != null;\n}\n\n/**\n * Options of http-proxy-middleware\n */\nexport function defaultProxyOptions(proxyPath: string, targetUrl: string) {\n  proxyPath = _.trimEnd(proxyPath, '/');\n  targetUrl = _.trimEnd(targetUrl, '/');\n  const { protocol, host, pathname } = new URL(targetUrl);\n\n  const patPath = new RegExp('^' + _.escapeRegExp(proxyPath) + '(/|$)');\n  const hpmLog = logger.getLogger('HPM.' + targetUrl);\n\n  const proxyMidOpt: ProxyOptions &  {[K in 'pathRewrite' | 'onProxyReq' | 'onProxyRes' | 'onError']: NonNullable<ProxyOptions[K]>} = {\n    // eslint-disable-next-line max-len\n    target: protocol + '//' + host,\n    changeOrigin: true,\n    ws: false,\n    secure: false,\n    cookieDomainRewrite: { '*': '' },\n    pathRewrite: (path, _req) => {\n      // hpmLog.warn('patPath=', patPath, 'path=', path);\n      const ret = path && path.replace(patPath, _.trimEnd(pathname, '/') + '/');\n      // hpmLog.info(`proxy to path: ${req.method} ${protocol + '//' + host}${ret}, req.url = ${req.url}`);\n      return ret;\n    },\n    logLevel: 'debug',\n    logProvider: _provider => hpmLog,\n    proxyTimeout: 10000,\n    onProxyReq(proxyReq, req, _res, ..._rest) {\n      // This proxyReq could be \"RedirectRequest\" if option \"followRedirect\" is on\n      if (isRedirectableRequest(proxyReq)) {\n        hpmLog.warn(`Redirect request to ${protocol}//${host}${proxyReq._currentRequest.path} method: ${req.method || 'uknown'}, ${JSON.stringify(\n          proxyReq._currentRequest.getHeaders(), null, '  ')}`);\n      } else {\n        proxyReq.removeHeader('Origin'); // Bypass CORS restrict on target server\n        const referer = proxyReq.getHeader('referer');\n        if (typeof referer === 'string') {\n          proxyReq.setHeader('referer', `${protocol}//${host}${new URL(referer).pathname}`);\n        }\n        hpmLog.info(`Proxy request to ${protocol}//${host}${proxyReq.path} method: ${req.method || 'uknown'}, ${JSON.stringify(\n          proxyReq.getHeaders(), null, '  ')}`);\n      }\n    },\n    onProxyRes(incoming, req, _res) {\n      incoming.headers['Access-Control-Allow-Origin'] = '*';\n      if (api.config().devMode) {\n        hpmLog.info(`Proxy recieve ${req.url || ''}, status: ${incoming.statusCode!}\\n`,\n          JSON.stringify(incoming.headers, null, '  '));\n      } else {\n        hpmLog.info(`Proxy recieve ${req.url || ''}, status: ${incoming.statusCode!}`);\n      }\n      if (api.config().devMode) {\n\n        const ct = incoming.headers['content-type'];\n        hpmLog.info(`Response ${req.url || ''} headers:\\n`, incoming.headers);\n        const isText = (ct && /\\b(json|text)\\b/i.test(ct));\n        if (isText) {\n          if (!incoming.complete) {\n            const bufs = [] as string[];\n            void readCompressedResponse(incoming, new stream.Writable({\n              write(chunk: Buffer | string, _enc, cb) {\n                bufs.push(Buffer.isBuffer(chunk) ? chunk.toString() : chunk);\n                cb();\n              },\n              final(_cb) {\n                hpmLog.info(`Response ${req.url || ''} text body:\\n`, bufs.join(''));\n              }\n            }));\n          } else if ((incoming as {body?: Buffer | string}).body) {\n            hpmLog.info(`Response ${req.url || ''} text body:\\n`, (incoming as {body?: Buffer | string}).toString());\n          }\n        }\n      }\n    },\n    onError(err, _req, _res) {\n      hpmLog.warn(err);\n    }\n  };\n  return proxyMidOpt;\n}\n\n/** Options of http-proxy\n */\nexport function defaultHttpProxyOptions(target?: string): ServerOptions {\n  return {\n    target,\n    changeOrigin: true,\n    ws: false,\n    secure: false,\n    cookieDomainRewrite: { '*': '' },\n    // logLevel: 'debug',\n    // logProvider: provider => hpmLog,\n    proxyTimeout: 10000\n  };\n}\n\nconst log = logger.getLogger(api.packageName + '.createReplayReadableFactory');\n\nexport function createReplayReadableFactory(\n  readable: NodeJS.ReadableStream, transforms?: NodeJS.ReadWriteStream[],\n  opts?: {debugInfo?: string; expectLen?: number}\n) {\n  const buf$ = new rx.ReplaySubject<Buffer>();\n  let cacheBufLen = 0;\n  const cacheWriter = new stream.Writable({\n    write(chunk: Buffer, _enc, cb) {\n      cacheBufLen += chunk.length;\n      // log.warn('cache updated:', cacheBufLen);\n      buf$.next(chunk);\n      cb();\n    },\n    final(cb) {\n      buf$.complete();\n      if (cacheBufLen === 0 || (opts?.expectLen != null && opts?.expectLen > cacheBufLen )) {\n        log.error((opts?.debugInfo || '') + `, cache completed length is ${cacheBufLen} which is less than expected ${opts!.expectLen!}`);\n        cb(new Error('Cache length does not meet expected length'));\n      }\n      cb();\n    }\n  });\n\n  let caching = false;\n  // let readerCount = 0;\n\n  return () => {\n    // readerCount++;\n    // let bufferLengthSum = 0;\n    // const readerId = readerCount;\n    const readCall$ = new rx.Subject<stream.Readable>();\n    const readableStream = new stream.Readable({\n      read(_size) {\n        readCall$.next(this);\n        if (!caching) {\n          caching = true;\n          const streams = [readable,\n            ...(transforms || []), cacheWriter] as Array<NodeJS.ReadableStream | NodeJS.WritableStream | NodeJS.ReadWriteStream>;\n          // To workaround NodeJS 16 bug\n          streams.reduce(\n            (prev, curr) => (prev as NodeJS.ReadableStream)\n            .pipe(curr as NodeJS.ReadWriteStream))\n            .on('error', err => log.error(err));\n        }\n      }\n    });\n\n    rx.zip(readCall$, buf$)\n      .pipe(\n        op.map(([readable, buf], _idx) => {\n          readable.push(buf);\n          // bufferLengthSum += buf.length;\n          // log.debug(`reader: ${readerId}, reads (${idx}) ${bufferLengthSum}`);\n        }),\n        op.finalize(() => {\n          readableStream.push(null);\n        })\n      ).subscribe();\n\n    return readableStream;\n  };\n}\n\n/**\n * This is not working for POST request according to my experience in Node 16.3.0, due to\n * by the time node-http-proxy emits event \"proxyReq\", `req.pipe(proxyReq)` has already\n * been executed, meaning the proxyReq has \"end\" itself as reacting to req.complete: true \n * or end event.\n *\n * Fix proxied body if bodyParser is involved.\n * Copied from https://github.com/chimurai/http-proxy-middleware/blob/master/src/handlers/fix-request-body.ts\n */\nexport function fixRequestBody(proxyReq: ClientRequest, req: IncomingMessage): void {\n  const requestBody = (req as Request).body;\n\n  if (!requestBody || !Object.keys(requestBody).length) {\n    return;\n  }\n\n  const contentType = proxyReq.getHeader('Content-Type') as string | undefined;\n  const writeBody = (bodyData: string) => {\n    if (proxyReq.headersSent) {\n      log.error('proxy request header is sent earlier than the moment of fixRequestBody()!');\n    } else {\n      // deepcode ignore ContentLengthInCode: bodyParser fix\n      const len = Buffer.byteLength(bodyData);\n      proxyReq.setHeader('Content-Length', len);\n      log.info('fix proxy body', contentType, len);\n      proxyReq.write(bodyData);\n    }\n  };\n\n  if (contentType?.includes('application/json')) {\n    writeBody(JSON.stringify(requestBody));\n  } else if (contentType?.includes('application/x-www-form-urlencoded')) {\n    writeBody(querystring.stringify(requestBody));\n  }\n}\n\nexport function createBufferForHttpProxy(req: IncomingMessage) {\n  const contentType = req.headers['content-type'];\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n  const body = (req as any).body;\n  if (body == null)\n    return undefined;\n\n  if (contentType?.includes('application/json')) {\n    const buf = Buffer.from(JSON.stringify(body));\n    return {\n      readable: new stream.Readable({\n        read() {\n          this.push(buf);\n          this.push(null);\n        }\n      }),\n      length: buf.length\n    };\n  } else if (contentType?.includes('application/x-www-form-urlencoded')) {\n    const buf = Buffer.from(querystring.stringify(body));\n    return {\n      readable: new stream.Readable({\n        read() {\n          this.push(buf);\n          this.push(null);\n        }\n      }),\n      length: buf.length\n    };\n  } else if (Buffer.isBuffer(body)) {\n    return {\n      readable: new stream.Readable({\n        read() {\n          this.push(body);\n          this.push(null);\n        }\n      }),\n      length: body.length\n    };\n  }\n}\n\n"]}