{"version":3,"file":"http-proxy-observable.js","sourceRoot":"","sources":["http-proxy-observable.ts"],"names":[],"mappings":"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","sourcesContent":["import HttpProxy from 'http-proxy';\nimport * as rx from 'rxjs';\nimport * as op from 'rxjs/operators';\nimport {compressedIncomingMsgToBuffer, compressResponse} from '@wfh/http-server/dist/utils';\n\ntype Response = Parameters<HttpProxy['web']>[1];\n\nexport type HttpProxyEventParams = {\n  error: Parameters<HttpProxy.ErrorCallback>;\n  start: Parameters<HttpProxy.StartCallback>;\n  proxyReq: Parameters<HttpProxy.ProxyReqCallback>;\n  proxyRes: Parameters<HttpProxy.ProxyResCallback>;\n  proxyReqWs: Parameters<HttpProxy.ProxyReqWsCallback>;\n  econnreset: Parameters<HttpProxy.EconnresetCallback>;\n  end: Parameters<HttpProxy.EndCallback>;\n  open: Parameters<HttpProxy.OpenCallback>;\n  close: Parameters<HttpProxy.CloseCallback>;\n};\n\nconst EVENTS = 'error,start,proxyReq,proxyRes,ProxyReqWs,econnreset,end,open,close'.split(',') as\n  Array<keyof HttpProxyEventParams>;\n\nexport type HttpProxyEventObs = {\n  [evt in keyof HttpProxyEventParams]: rx.Observable<{type: evt; payload: HttpProxyEventParams[evt]}>\n};\n\nexport function httpProxyObservable(proxy: HttpProxy): HttpProxyEventObs {\n  const obsObj = {} as HttpProxyEventObs;\n  const createdSubjs = {} as typeof obsObj;\n\n  for (const event of EVENTS) {\n    Object.defineProperty(obsObj, event, {\n      get() {\n        const ob = createdSubjs[event];\n        if (ob) {\n          return ob;\n        }\n\n        const sub = rx.fromEventPattern<HttpProxyEventParams[typeof event]>(\n          handler => proxy.on(event, handler),\n          handler => proxy.off(event, handler)\n        ).pipe(\n          op.map(args => ({\n            type: event,\n            payload: args\n          }))\n        );\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\n        createdSubjs[event] = sub as any;\n        return sub;\n      }\n    });\n  }\n  return obsObj;\n}\n\nconst REDIRECT_STATUS = new Map<number, number>([301, 302, 307, 308].map(code => [code, code]));\n/**\n * e.g.\n```\n  rx.defer(() => {\n    proxy.web(req, res, {timeout: 10000});\n    return observeProxyResponse(proxy$, payload.res);\n  })\n```\n */\nexport function observeProxyResponse(httpProxy$: HttpProxyEventObs, res: Response,\n  skipRedirectRes = true):\n  HttpProxyEventObs['proxyRes'] {\n  // Same as \"race\" which is deprecated in RxJS 7\n  return httpProxy$.proxyRes.pipe(\n    op.filter(event => event.payload[2] === res &&\n        !(skipRedirectRes && REDIRECT_STATUS.has(event.payload[0].statusCode || 200))\n    ),\n    op.take(1),\n    op.takeUntil(rx.merge(httpProxy$.econnreset, httpProxy$.error).pipe(\n      op.filter(event => event.payload[2] === res),\n      op.take(1),\n      op.mergeMap(({payload: [err]}) => {\n        return rx.throwError(err);\n      })\n    ))\n  ).pipe(\n    op.take(1)\n  );\n}\n\nexport function observeProxyResponseAndChange(\n  httpProxy$: HttpProxyEventObs, res: Response, change: (origContent: Buffer) => Buffer | string | PromiseLike<Buffer | string>,\n  skipRedirectRes = true) {\n  return observeProxyResponse(httpProxy$, res, skipRedirectRes).pipe(\n    op.mergeMap(async ({payload: [pRes]}) => {\n      const content = await compressedIncomingMsgToBuffer(pRes);\n      const changed = await Promise.resolve(change(content));\n      for (const [header, value] of Object.entries(pRes.headers)) {\n        if (header.toLowerCase() === 'content-length') {\n          continue;\n        }\n        if (Array.isArray(value)) {\n          for (const item of value) {\n            res.setHeader(header, item);\n          }\n        } else if (value)\n          res.setHeader(header, value);\n      }\n      await compressResponse(changed, res, pRes.headers['content-encoding']);\n    })\n  );\n}\n\n"]}