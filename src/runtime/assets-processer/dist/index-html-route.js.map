{"version":3,"file":"index-html-route.js","sourceRoot":"","sources":["index-html-route.ts"],"names":[],"mappings":"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","sourcesContent":["import {createProxyMiddleware as proxy, Options, fixRequestBody} from 'http-proxy-middleware';\nimport express from '@wfh/express-app/dist/express';\nimport _ from 'lodash';\n// import Url from 'url';\nimport {log4File, config as plinkConfig, ExtensionContext} from '@wfh/plink';\nimport {getSetting} from '../isom/assets-processer-setting';\nconst log = log4File(__filename);\ninterface ReqWithNextCb extends express.Request {\n  __goNext: express.NextFunction;\n}\nfunction isReqWithNextCb(obj: any): obj is ReqWithNextCb {\n  return obj.__goNext != null;\n}\n\nexport function proxyToDevServer(api: ExtensionContext) {\n  // const hpmLog = log4js.getLogger('assets-process.index-html-route.proxy');\n  let setting: Options | undefined = getSetting().proxyToDevServer;\n  if (setting == null)\n    return;\n\n  const config: Options = _.cloneDeep(setting);\n  config.changeOrigin = true;\n  config.ws = true;\n  config.logProvider = () => log;\n  const plinkSetting = plinkConfig();\n  config.onProxyReq = fixRequestBody;\n  config.logLevel = plinkSetting.devMode || plinkSetting.cliOptions?.verbose ? 'debug' : 'info';\n  config.onError = (err, req, res) => {\n    if ((err as NodeJS.ErrnoException).code === 'ECONNREFUSED') {\n      log.info('Can not connect to %s%s, farward to local static resource', config.target, req.url);\n      if (isReqWithNextCb(req))\n        return req.__goNext();\n      return;\n    }\n    log.warn(err);\n    if (isReqWithNextCb(req))\n      req.__goNext(err);\n  };\n\n  const proxyHandler = proxy('/', config);\n  api.expressAppUse((app, express) => {\n    app.use((req, res, next) => {\n      (req as ReqWithNextCb).__goNext = next;\n      proxyHandler(req, res, next);\n    });\n  });\n}\n\nexport function fallbackIndexHtml(api: ExtensionContext) {\n  const ruleObj: {[key: string]: string} = getSetting().fallbackIndexHtml;\n\n  const rules: Array<{reg: RegExp; tmpl: _.TemplateExecutor}> = [];\n\n  Object.keys(ruleObj).forEach(key => {\n    rules.push({\n      reg: new RegExp(key),\n      tmpl: _.template(ruleObj[key] )\n    });\n  });\n\n  api.use('/', (req, res, next) => {\n    if (req.method !== 'GET')\n      return next();\n    log.debug(req.url);\n    rules.some(({reg, tmpl}) => {\n      const orig = req.url;\n      const match = reg.exec(req.url);\n      if (!match)\n        return false;\n      // Reference to https://github.com/kapouer/express-urlrewrite/blob/master/index.js#L45\n      req.url = req.originalUrl = tmpl({match});\n      log.info('rewrite url %s to %s', orig, req.url);\n      // const qpSetting: string | undefined = api.expressApp.get('query parser');\n\n      return true;\n    });\n    next();\n  });\n}\n"]}