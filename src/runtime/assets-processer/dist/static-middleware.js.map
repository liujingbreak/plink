{"version":3,"file":"static-middleware.js","sourceRoot":"","sources":["static-middleware.ts"],"names":[],"mappings":";;;;AAEA,wDAAwB;AACxB,4DAAuB;AACvB,8DAA8B;AAE9B,MAAM,EAAE,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC;AAEzB,SAAgB,iBAAiB,CAAC,SAAiB,EAAE,YAAyD,EAAE;IAC9G,IAAI,YAAY,GAAG,cAAc,CAAC,SAAS,CAAC,CAAC;IAC7C,OAAO,iBAAO,CAAC,MAAM,CAAC,SAAS,EAAE;QAC/B,UAAU,EAAE,mBAAmB,CAAC,YAAY,CAAC;QAC7C,QAAQ,EAAE,KAAK;KAChB,CAAC,CAAC;AACL,CAAC;AAND,8CAMC;AAED,+EAA+E;AAC/E,mCAAmC;AACnC,oDAAoD;AACpD,+EAA+E;AAC/E,gBAAgB;AAChB,IAAI;AAEJ,SAAS,mBAAmB,CAAC,YAAyC;IACpE,OAAO,CAAC,GAAa,EAAE,IAAY,EAAE,KAAU,EAAE,EAAE;QACjD,IAAI,GAAG,GAAG,cAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,WAAW,EAAE,CAAC;QAC3C,IAAI,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC;YACrB,GAAG,GAAG,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;QACzB,IAAI,gBAAC,CAAC,GAAG,CAAC,YAAY,EAAE,GAAG,CAAC;YAC1B,qBAAqB,CAAC,GAAG,EAAE,YAAY,CAAC,GAAG,CAAC,CAAC,CAAC;;YAE9C,GAAG,CAAC,SAAS,CAAC,eAAe,EAAE,UAAU,CAAC,CAAC;QAC7C,GAAG,CAAC,SAAS,CAAC,6BAA6B,EAAE,GAAG,CAAC,CAAC;IACpD,CAAC,CAAC;AACJ,CAAC;AAED,SAAS,qBAAqB,CAAC,GAAa,EAAE,UAAyB,CAAC,EAAE,SAAS,GAAG,KAAK;IACzF,IAAI,OAAO,IAAI,IAAI,EAAE;QACnB,GAAG,CAAC,SAAS,CAAC,eAAe,EAAE,UAAU,CAAC,CAAC;QAC3C,OAAO;KACR;IACD,IAAI,YAAY,GAAG,kBAAkB,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,GAAG,IAAI,CAAC,CAAC;IACnE,IAAI,SAAS,EAAE;QACb,YAAY,IAAI,aAAa,CAAC;KAC/B;IACD,GAAG,CAAC,SAAS,CAAC,eAAe,EAAE,YAAY,CAAC,CAAC;AAC/C,CAAC;AAED,SAAS,cAAc,CAAC,SAAsD;IAC5E,IAAI,YAAY,GAAgC,EAAE,CAAC;IACnD,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE;QACpD,IAAI,KAAK,IAAI,IAAI;YACf,YAAY,CAAC,GAAG,CAAC,GAAG,OAAO,KAAK,KAAK,QAAQ,CAAC,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;KACrE;IACD,OAAO,YAAY,CAAC;AACtB,CAAC","sourcesContent":["// import serveZip from 'serve-static-zip';\nimport {Response, Handler} from 'express';\nimport Path from 'path';\nimport _ from 'lodash';\nimport express from 'express';\n\nconst ms = require('ms');\n\nexport function createStaticRoute(staticDir: string, maxAgeMap: {[extname: string]: string | number | null} = {}): Handler {\n  let maxAgeNumMap = parseMaxAgeMap(maxAgeMap);\n  return express.static(staticDir, {\n    setHeaders: createSetHeaderFunc(maxAgeNumMap),\n    redirect: false\n  });\n}\n\n// export function createZipRoute(maxAgeMap: {[extname: string]: string} = {}):\n// serveZip.ZipResourceMiddleware {\n//   const maxAgeNumMap = parseMaxAgeMap(maxAgeMap);\n//   const zss = serveZip('', {setHeaders: createSetHeaderFunc(maxAgeNumMap)});\n//   return zss;\n// }\n\nfunction createSetHeaderFunc(maxAgeNumMap: {[extname: string]: number}) {\n  return (res: Response, path: string, entry: any) => {\n    var ext = Path.extname(path).toLowerCase();\n    if (ext.startsWith('.'))\n      ext = ext.substring(1);\n    if (_.has(maxAgeNumMap, ext))\n      setCacheControlHeader(res, maxAgeNumMap[ext]);\n    else\n      res.setHeader('Cache-Control', 'no-cache');\n    res.setHeader('Access-Control-Allow-Origin', '*');\n  };\n}\n\nfunction setCacheControlHeader(res: Response, _maxage: number | null = 0, immutable = false) {\n  if (_maxage == null) {\n    res.setHeader('Cache-Control', 'no-cache');\n    return;\n  }\n  var cacheControl = 'public, max-age=' + Math.floor(_maxage / 1000);\n  if (immutable) {\n    cacheControl += ', immutable';\n  }\n  res.setHeader('Cache-Control', cacheControl);\n}\n\nfunction parseMaxAgeMap(maxAgeMap: {[extname: string]: string | number | null}) {\n  let maxAgeNumMap: {[extname: string]: number} = {};\n  for (const [key, value] of Object.entries(maxAgeMap)) {\n    if (value != null)\n      maxAgeNumMap[key] = typeof value === 'string' ? ms(value) : value;\n  }\n  return maxAgeNumMap;\n}\n"]}