"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.keyOfUri = exports.createProxyWithCache = void 0;
const path_1 = __importDefault(require("path"));
const stream_1 = __importDefault(require("stream"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const rx = __importStar(require("rxjs"));
const op = __importStar(require("rxjs/operators"));
const lodash_1 = __importDefault(require("lodash"));
const __plink_1 = __importDefault(require("__plink"));
const plink_1 = require("@wfh/plink");
const http_proxy_middleware_1 = require("http-proxy-middleware");
const tiny_redux_toolkit_1 = require("@wfh/redux-toolkit-observable/dist/tiny-redux-toolkit");
const utils_1 = require("../utils");
const log = (0, plink_1.log4File)(__filename);
const httpProxyLog = plink_1.logger.getLogger(log.category + '#httpProxy');
function createProxyWithCache(proxyPath, targetUrl, cacheRootDir, opts = { manual: false }) {
    var _a;
    const initialState = {
        // proxyOptions: defaultProxyOptions(proxyPath, targetUrl),
        cacheDir: cacheRootDir,
        cacheByUri: new Map(),
        responseTransformer: []
    };
    if (!opts.manual) {
        __plink_1.default.expressAppSet(app => {
            app.use(proxyPath, (req, res, next) => {
                const key = keyOfUri(req.method, req.url);
                cacheController.actionDispatcher.hitCache({ key, req, res, next });
            });
        });
    }
    const cacheController = (0, tiny_redux_toolkit_1.createSlice)({
        initialState,
        name: `HTTP-proxy-cache-${proxyPath}`,
        debug: (_a = (0, plink_1.config)().cliOptions) === null || _a === void 0 ? void 0 : _a.verbose,
        reducers: {
            configureProxy(s, payload) {
            },
            configTransformer(s, payload) {
                s.responseTransformer = payload;
            },
            hitCache(s, payload) { },
            _addToCache(s, payload) { },
            _loadFromStorage(s, payload) {
                s.cacheByUri.set(payload.key, 'loading');
            },
            _requestRemote(s, payload) {
                s.cacheByUri.set(payload.key, 'requesting');
            },
            _gotCache(s, payload) {
                if (payload.data.statusCode !== 304)
                    s.cacheByUri.set(payload.key, payload.data);
            }
        }
    });
    cacheController.epic(action$ => {
        const defaultProxyOpt = (0, utils_1.defaultProxyOptions)(proxyPath, targetUrl);
        const proxyError$ = new rx.Subject();
        const proxyRes$ = new rx.Subject();
        let proxyMiddleware$ = new rx.ReplaySubject(1);
        const actions = (0, tiny_redux_toolkit_1.castByActionType)(cacheController.actions, action$);
        return rx.merge(actions.configureProxy.pipe(op.map(({ payload: extraOpt }) => {
            proxyMiddleware$.next((0, http_proxy_middleware_1.createProxyMiddleware)(Object.assign(Object.assign(Object.assign(Object.assign({}, defaultProxyOpt), { followRedirects: true }), extraOpt), { onProxyRes(...args) {
                    proxyRes$.next(args);
                    defaultProxyOpt.onProxyRes(...args);
                    if (extraOpt.onProxyRes)
                        extraOpt.onProxyRes(...args);
                },
                onError(...args) {
                    defaultProxyOpt.onError(...args);
                    proxyError$.next(args);
                    if (extraOpt.onError)
                        extraOpt.onError(...args);
                } })));
        })), actions.hitCache.pipe(op.mergeMap(({ payload }) => {
            const waitCacheAndSendRes = actions._gotCache.pipe(op.filter(action => action.payload.key === payload.key &&
                payload.res.writableEnded !== true), // In case it is of redirected request, HPM has done piping response (ignored "manual reponse" setting)
            op.take(1), op.map(({ payload: { data } }) => {
                for (const entry of data.headers) {
                    payload.res.setHeader(entry[0], entry[1]);
                }
                payload.res.status(data.statusCode);
                payload.res.end(data.body);
            }));
            const item = cacheController.getState().cacheByUri.get(payload.key);
            if (item == null) {
                cacheController.actionDispatcher._loadFromStorage(payload);
                return waitCacheAndSendRes;
            }
            else if (item === 'loading' || item === 'requesting') {
                return waitCacheAndSendRes;
            }
            else {
                httpProxyLog.info('hit cached', payload.key);
                sendRes(payload.res, item.statusCode, item.headers, item.body);
                return rx.EMPTY;
            }
        })), actions._loadFromStorage.pipe(op.map(async ({ payload }) => {
            const dir = path_1.default.join(cacheController.getState().cacheDir, payload.key);
            const hFile = path_1.default.join(dir, 'header.json');
            const bFile = path_1.default.join(dir, 'body');
            if (fs_extra_1.default.existsSync(hFile)) {
                httpProxyLog.info('load', payload.key);
                const [headersStr, body] = await Promise.all([
                    fs_extra_1.default.promises.readFile(hFile, 'utf-8'),
                    fs_extra_1.default.promises.readFile(bFile)
                ]);
                const { statusCode, headers } = JSON.parse(headersStr);
                cacheController.actionDispatcher._gotCache({ key: payload.key, data: {
                        statusCode,
                        headers,
                        body
                    } });
                // sendRes(payload.res, statusCode, headers, body);
            }
            else {
                log.info('No existing file for', payload.key);
                cacheController.actionDispatcher._requestRemote(payload);
            }
        })), actions._requestRemote.pipe(op.mergeMap(({ payload }) => rx.merge(rx.race(proxyRes$.pipe(op.filter(([proxyRes, origReq]) => origReq === payload.req), op.take(1), op.map(([proxyRes]) => {
            cacheController.actionDispatcher._addToCache({
                key: payload.key,
                res: payload.res,
                data: {
                    headers: Object.entries(proxyRes.headers)
                        .filter(entry => entry[1] != null),
                    readable: proxyRes
                }
            });
        })), proxyError$.pipe(op.filter(([err, origReq]) => origReq === payload.req), op.take(1), op.map(() => { }))), proxyMiddleware$.pipe(op.take(1), op.map(proxy => proxy(payload.req, payload.res, payload.next)))))), actions._addToCache.pipe(op.mergeMap(({ payload: { key, res, data } }) => {
            httpProxyLog.info('cache size:', cacheController.getState().cacheByUri.size);
            const dir = path_1.default.join(cacheController.getState().cacheDir, key);
            const file = path_1.default.join(dir, 'body');
            const statusCode = data.readable.statusCode || 200;
            const { responseTransformer } = cacheController.getState();
            return (statusCode === 200 ? pipeToBuffer(data.readable, ...(responseTransformer ? lodash_1.default.flatten(responseTransformer.map(entry => entry(data.headers))) :
                [])) :
                pipeToBuffer(data.readable)).pipe(op.mergeMap(async (buf) => {
                // log.warn('content-length:', buf.length);
                const lengthHeaderIdx = data.headers.findIndex(row => row[0] === 'content-length');
                if (lengthHeaderIdx >= 0)
                    data.headers[lengthHeaderIdx][1] = '' + buf.length;
                cacheController.actionDispatcher._gotCache({ key, data: {
                        statusCode,
                        headers: data.headers,
                        body: buf
                    } });
                if (statusCode === 304) {
                    log.warn('Version info is not recorded, due to response 304 from', res.req.url, ',\n you can remove existing npm/cache cache to avoid 304');
                    return rx.EMPTY;
                }
                await fs_extra_1.default.mkdirp(path_1.default.dirname(file));
                await Promise.all([
                    fs_extra_1.default.promises.writeFile(file, buf),
                    fs_extra_1.default.promises.writeFile(path_1.default.join(dir, 'header.json'), JSON.stringify({ statusCode, headers: data.headers }, null, '  '), 'utf-8')
                ]);
                httpProxyLog.info('write response to file', path_1.default.posix.relative(process.cwd(), file), 'size', buf.length);
            }), op.catchError((err, src) => {
                httpProxyLog.error('HTTP proxy cache error: failed to cache response', err);
                if (fs_extra_1.default.existsSync(dir)) {
                    return rx.defer(() => fs_extra_1.default.remove(dir)).pipe(op.take(1), op.ignoreElements() // for better TS type inference
                    );
                }
                return rx.EMPTY;
            }));
        }))).pipe(op.ignoreElements(), op.catchError((err, src) => {
            httpProxyLog.error('HTTP proxy cache error', err);
            return src;
        }));
    });
    return cacheController;
}
exports.createProxyWithCache = createProxyWithCache;
function pipeToBuffer(source, ...transformers) {
    return new rx.Observable(sub => {
        const bodyBufs = [];
        let completeBody;
        if (source.complete) {
            sub.error(new Error('response is completed earlier'));
        }
        else {
            const streams = [
                source,
                ...transformers,
                new stream_1.default.Writable({
                    write(chunk, enc, cb) {
                        bodyBufs.push(chunk);
                        cb();
                    }
                })
            ];
            stream_1.default.pipeline(streams, (err) => {
                if (err)
                    return sub.error(err);
                completeBody = Buffer.concat(bodyBufs);
                sub.next(completeBody);
                sub.complete();
            });
        }
        return () => {
            // I am not sure if this is proper cancelling of a stream pipeline
            source.pause();
            source.destroy();
        };
    });
}
function sendRes(res, statusCode, headers, body) {
    res.status(statusCode);
    for (const [name, value] of headers) {
        res.setHeader(name, value);
    }
    if (Buffer.isBuffer(body))
        res.end(body);
    else
        stream_1.default.pipeline(body, res);
}
function keyOfUri(method, path) {
    const url = new URL('http://f.com' + path);
    const key = method + url.pathname + (url.search ? '/' + lodash_1.default.trimStart(url.search, '?') : '');
    return key;
}
exports.keyOfUri = keyOfUri;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNhY2hlLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF3QjtBQUN4QixvREFBNEI7QUFFNUIsd0RBQTBCO0FBQzFCLHlDQUEyQjtBQUMzQixtREFBcUM7QUFDckMsb0RBQXVCO0FBRXZCLHNEQUEwQjtBQUMxQixzQ0FBb0Q7QUFDcEQsaUVBQTZGO0FBQzdGLDhGQUFvRztBQUNwRyxvQ0FBNkM7QUFHN0MsTUFBTSxHQUFHLEdBQUcsSUFBQSxnQkFBUSxFQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0sWUFBWSxHQUFHLGNBQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsQ0FBQztBQUVuRSxTQUFnQixvQkFBb0IsQ0FBQyxTQUFpQixFQUFFLFNBQWlCLEVBQUUsWUFBb0IsRUFDOUUsT0FBMEIsRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFDOztJQUN4RCxNQUFNLFlBQVksR0FBb0I7UUFDcEMsMkRBQTJEO1FBQzNELFFBQVEsRUFBRSxZQUFZO1FBQ3RCLFVBQVUsRUFBRSxJQUFJLEdBQUcsRUFBRTtRQUNyQixtQkFBbUIsRUFBRSxFQUFFO0tBQ3hCLENBQUM7SUFFRixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNoQixpQkFBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN0QixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ3BDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxFQUFDLEdBQUcsRUFBRSxH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RSxJQUFZO0lBQ25ELE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUMzQyxNQUFNLEdBQUcsR0FBRyxNQUFNLEdBQUcsR0FBRyxDQUFDLFFBQVEsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxnQkFBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzRixPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUM7QUFKRCw0QkFJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHN0cmVhbSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgSW5jb21pbmdNZXNzYWdlIH0gZnJvbSAnaHR0cCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgcnggZnJvbSAncnhqcyc7XG5pbXBvcnQgKiBhcyBvcCBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9ufSBmcm9tICdleHByZXNzJztcbmltcG9ydCBhcGkgZnJvbSAnX19wbGluayc7XG5pbXBvcnQge2xvZ2dlciwgbG9nNEZpbGUsIGNvbmZpZ30gZnJvbSAnQHdmaC9wbGluayc7XG5pbXBvcnQgeyBjcmVhdGVQcm94eU1pZGRsZXdhcmUgYXMgcHJveHksIE9wdGlvbnMgYXMgSHBtT3B0aW9uc30gZnJvbSAnaHR0cC1wcm94eS1taWRkbGV3YXJlJztcbmltcG9ydCB7Y3JlYXRlU2xpY2UsIGNhc3RCeUFjdGlvblR5cGV9IGZyb20gJ0B3ZmgvcmVkdXgtdG9vbGtpdC1vYnNlcnZhYmxlL2Rpc3QvdGlueS1yZWR1eC10b29sa2l0JztcbmltcG9ydCB7ZGVmYXVsdFByb3h5T3B0aW9uc30gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHtQcm94eUNhY2hlU3RhdGUsIENhY2hlRGF0YX0gZnJvbSAnLi90eXBlcyc7XG5cbmNvbnN0IGxvZyA9IGxvZzRGaWxlKF9fZmlsZW5hbWUpO1xuY29uc3QgaHR0cFByb3h5TG9nID0gbG9nZ2VyLmdldExvZ2dlcihsb2cuY2F0ZWdvcnkgKyAnI2h0dHBQcm94eScpO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUHJveHlXaXRoQ2FjaGUocHJveHlQYXRoOiBzdHJpbmcsIHRhcmdldFVybDogc3RyaW5nLCBjYWNoZVJvb3REaXI6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgb3B0czoge21hbnVhbDogYm9vbGVhbn0gPSB7bWFudWFsOiBmYWxzZX0pIHtcbiAgY29uc3QgaW5pdGlhbFN0YXRlOiBQcm94eUNhY2hlU3RhdGUgPSB7XG4gICAgLy8gcHJveHlPcHRpb25zOiBkZWZhdWx0UHJveHlPcHRpb25zKHByb3h5UGF0aCwgdGFyZ2V0VXJsKSxcbiAgICBjYWNoZURpcjogY2FjaGVSb290RGlyLFxuICAgIGNhY2hlQnlVcmk6IG5ldyBNYXAoKSxcbiAgICByZXNwb25zZVRyYW5zZm9ybWVyOiBbXVxuICB9O1xuXG4gIGlmICghb3B0cy5tYW51YWwpIHtcbiAgICBhcGkuZXhwcmVzc0FwcFNldChhcHAgPT4ge1xuICAgICAgYXBwLnVzZShwcm94eVBhdGgsIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICBjb25zdCBrZXkgPSBrZXlPZlVyaShyZXEubWV0aG9kLCByZXEudXJsKTtcbiAgICAgICAgY2FjaGVDb250cm9sbGVyLmFjdGlvbkRpc3BhdGNoZXIuaGl0Q2FjaGUoe2tleSwgcmVxLCByZXMsIG5leHR9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGNvbnN0IGNhY2hlQ29udHJvbGxlciA9IGNyZWF0ZVNsaWNlKHtcbiAgICBpbml0aWFsU3RhdGUsXG4gICAgbmFtZTogYEhUVFAtcHJveHktY2FjaGUtJHtwcm94eVBhdGh9YCAsXG4gICAgZGVidWc6IGNvbmZpZygpLmNsaU9wdGlvbnM/LnZlcmJvc2UsXG4gICAgcmVkdWNlcnM6IHtcbiAgICAgIGNvbmZpZ3VyZVByb3h5KHM6IFByb3h5Q2FjaGVTdGF0ZSwgcGF5bG9hZDogSHBtT3B0aW9ucykge1xuICAgICAgfSxcbiAgICAgIGNvbmZpZ1RyYW5zZm9ybWVyKHM6IFByb3h5Q2FjaGVTdGF0ZSwgcGF5bG9hZDogUHJveHlDYWNoZVN0YXRlWydyZXNwb25zZVRyYW5zZm9ybWVyJ10pIHtcbiAgICAgICAgcy5yZXNwb25zZVRyYW5zZm9ybWVyID0gcGF5bG9hZDtcbiAgICAgIH0sXG4gICAgICBoaXRDYWNoZShzOiBQcm94eUNhY2hlU3RhdGUsIHBheWxvYWQ6IHtrZXk6IHN0cmluZzsgcmVxOiBSZXF1ZXN0OyByZXM6IFJlc3BvbnNlOyBuZXh0OiBOZXh0RnVuY3Rpb259KSB7fSxcblxuICAgICAgX2FkZFRvQ2FjaGUoczogUHJveHlDYWNoZVN0YXRlLCBwYXlsb2FkOiB7XG4gICAgICAgIGtleTogc3RyaW5nO1xuICAgICAgICByZXM6IFJlc3BvbnNlO1xuICAgICAgICBkYXRhOiB7aGVhZGVyczogQ2FjaGVEYXRhWydoZWFkZXJzJ107IHJlYWRhYmxlOiBJbmNvbWluZ01lc3NhZ2V9O1xuICAgICAgfSkge30sXG5cbiAgICAgIF9sb2FkRnJvbVN0b3JhZ2UoczogUHJveHlDYWNoZVN0YXRlLCBwYXlsb2FkOiB7a2V5OiBzdHJpbmc7IHJlcTogUmVxdWVzdDsgcmVzOiBSZXNwb25zZTsgbmV4dDogTmV4dEZ1bmN0aW9ufSkge1xuICAgICAgICBzLmNhY2hlQnlVcmkuc2V0KHBheWxvYWQua2V5LCAnbG9hZGluZycpO1xuICAgICAgfSxcblxuICAgICAgX3JlcXVlc3RSZW1vdGUoczogUHJveHlDYWNoZVN0YXRlLCBwYXlsb2FkOiB7a2V5OiBzdHJpbmc7IHJlcTogUmVxdWVzdDsgcmVzOiBSZXNwb25zZTsgbmV4dDogTmV4dEZ1bmN0aW9ufSkge1xuICAgICAgICBzLmNhY2hlQnlVcmkuc2V0KHBheWxvYWQua2V5LCAncmVxdWVzdGluZycpO1xuICAgICAgfSxcbiAgICAgIF9nb3RDYWNoZShzOiBQcm94eUNhY2hlU3RhdGUsIHBheWxvYWQ6IHtcbiAgICAgICAga2V5OiBzdHJpbmc7XG4gICAgICAgIGRhdGE6IENhY2hlRGF0YTtcbiAgICAgIH0pIHtcbiAgICAgICAgaWYgKHBheWxvYWQuZGF0YS5zdGF0dXNDb2RlICE9PSAzMDQpXG4gICAgICAgICAgcy5jYWNoZUJ5VXJpLnNldChwYXlsb2FkLmtleSwgcGF5bG9hZC5kYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGNhY2hlQ29udHJvbGxlci5lcGljKGFjdGlvbiQgPT4ge1xuICAgIGNvbnN0IGRlZmF1bHRQcm94eU9wdCA9IGRlZmF1bHRQcm94eU9wdGlvbnMocHJveHlQYXRoLCB0YXJnZXRVcmwpO1xuXG4gICAgY29uc3QgcHJveHlFcnJvciQgPSBuZXcgcnguU3ViamVjdDxQYXJhbWV0ZXJzPCh0eXBlb2YgZGVmYXVsdFByb3h5T3B0KVsnb25FcnJvciddPj4oKTtcbiAgICBjb25zdCBwcm94eVJlcyQgPSBuZXcgcnguU3ViamVjdDxQYXJhbWV0ZXJzPCh0eXBlb2YgZGVmYXVsdFByb3h5T3B0KVsnb25Qcm94eVJlcyddPj4oKTtcblxuICAgIGxldCBwcm94eU1pZGRsZXdhcmUkID0gbmV3IHJ4LlJlcGxheVN1YmplY3Q8UmV0dXJuVHlwZTx0eXBlb2YgcHJveHk+PigxKTtcbiAgICBjb25zdCBhY3Rpb25zID0gY2FzdEJ5QWN0aW9uVHlwZShjYWNoZUNvbnRyb2xsZXIuYWN0aW9ucywgYWN0aW9uJCk7XG5cbiAgICByZXR1cm4gcngubWVyZ2UoXG4gICAgICBhY3Rpb25zLmNvbmZpZ3VyZVByb3h5LnBpcGUoXG4gICAgICAgIG9wLm1hcCgoe3BheWxvYWQ6IGV4dHJhT3B0fSkgPT4ge1xuICAgICAgICAgIHByb3h5TWlkZGxld2FyZSQubmV4dChwcm94eSh7XG4gICAgICAgICAgICAuLi5kZWZhdWx0UHJveHlPcHQsXG4gICAgICAgICAgICBmb2xsb3dSZWRpcmVjdHM6IHRydWUsXG4gICAgICAgICAgICAuLi5leHRyYU9wdCxcbiAgICAgICAgICAgIG9uUHJveHlSZXMoLi4uYXJncykge1xuICAgICAgICAgICAgICBwcm94eVJlcyQubmV4dChhcmdzKTtcbiAgICAgICAgICAgICAgZGVmYXVsdFByb3h5T3B0Lm9uUHJveHlSZXMoLi4uYXJncyk7XG4gICAgICAgICAgICAgIGlmIChleHRyYU9wdC5vblByb3h5UmVzKVxuICAgICAgICAgICAgICAgIGV4dHJhT3B0Lm9uUHJveHlSZXMoLi4uYXJncyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25FcnJvciguLi5hcmdzKSB7XG4gICAgICAgICAgICAgIGRlZmF1bHRQcm94eU9wdC5vbkVycm9yKC4uLmFyZ3MpO1xuICAgICAgICAgICAgICBwcm94eUVycm9yJC5uZXh0KGFyZ3MpO1xuICAgICAgICAgICAgICBpZiAoZXh0cmFPcHQub25FcnJvcilcbiAgICAgICAgICAgICAgICBleHRyYU9wdC5vbkVycm9yKC4uLmFyZ3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBhY3Rpb25zLmhpdENhY2hlLnBpcGUoXG4gICAgICAgIG9wLm1lcmdlTWFwKCAoe3BheWxvYWR9KSA9PiB7XG4gICAgICAgICAgY29uc3Qgd2FpdENhY2hlQW5kU2VuZFJlcyA9IGFjdGlvbnMuX2dvdENhY2hlLnBpcGUoXG4gICAgICAgICAgICBvcC5maWx0ZXIoYWN0aW9uID0+IGFjdGlvbi5wYXlsb2FkLmtleSA9PT0gcGF5bG9hZC5rZXkgJiZcbiAgICAgICAgICAgICAgcGF5bG9hZC5yZXMud3JpdGFibGVFbmRlZCAhPT0gdHJ1ZSksIC8vIEluIGNhc2UgaXQgaXMgb2YgcmVkaXJlY3RlZCByZXF1ZXN0LCBIUE0gaGFzIGRvbmUgcGlwaW5nIHJlc3BvbnNlIChpZ25vcmVkIFwibWFudWFsIHJlcG9uc2VcIiBzZXR0aW5nKVxuICAgICAgICAgICAgb3AudGFrZSgxKSxcbiAgICAgICAgICAgIG9wLm1hcCgoe3BheWxvYWQ6IHtkYXRhfX0pID0+IHtcbiAgICAgICAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBkYXRhLmhlYWRlcnMpIHtcbiAgICAgICAgICAgICAgICBwYXlsb2FkLnJlcy5zZXRIZWFkZXIoZW50cnlbMF0sIGVudHJ5WzFdKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBwYXlsb2FkLnJlcy5zdGF0dXMoZGF0YS5zdGF0dXNDb2RlKTtcbiAgICAgICAgICAgICAgcGF5bG9hZC5yZXMuZW5kKGRhdGEuYm9keSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IGNhY2hlQ29udHJvbGxlci5nZXRTdGF0ZSgpLmNhY2hlQnlVcmkuZ2V0KHBheWxvYWQua2V5KTtcbiAgICAgICAgICBpZiAoaXRlbSA9PSBudWxsKSB7XG4gICAgICAgICAgICBjYWNoZUNvbnRyb2xsZXIuYWN0aW9uRGlzcGF0Y2hlci5fbG9hZEZyb21TdG9yYWdlKHBheWxvYWQpO1xuICAgICAgICAgICAgcmV0dXJuIHdhaXRDYWNoZUFuZFNlbmRSZXM7XG4gICAgICAgICAgfSBlbHNlIGlmIChpdGVtID09PSAnbG9hZGluZycgfHwgaXRlbSA9PT0gJ3JlcXVlc3RpbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gd2FpdENhY2hlQW5kU2VuZFJlcztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaHR0cFByb3h5TG9nLmluZm8oJ2hpdCBjYWNoZWQnLCBwYXlsb2FkLmtleSk7XG4gICAgICAgICAgICBzZW5kUmVzKHBheWxvYWQucmVzLCBpdGVtLnN0YXR1c0NvZGUsIGl0ZW0uaGVhZGVycywgaXRlbS5ib2R5KTtcbiAgICAgICAgICAgIHJldHVybiByeC5FTVBUWTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgYWN0aW9ucy5fbG9hZEZyb21TdG9yYWdlLnBpcGUoXG4gICAgICAgIG9wLm1hcChhc3luYyAoe3BheWxvYWR9KSA9PiB7XG4gICAgICAgICAgY29uc3QgZGlyID0gUGF0aC5qb2luKGNhY2hlQ29udHJvbGxlci5nZXRTdGF0ZSgpLmNhY2hlRGlyLCBwYXlsb2FkLmtleSk7XG4gICAgICAgICAgY29uc3QgaEZpbGUgPSBQYXRoLmpvaW4oZGlyLCAnaGVhZGVyLmpzb24nKTtcbiAgICAgICAgICBjb25zdCBiRmlsZSA9IFBhdGguam9pbihkaXIsICdib2R5Jyk7XG4gICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoaEZpbGUpKSB7XG4gICAgICAgICAgICBodHRwUHJveHlMb2cuaW5mbygnbG9hZCcsIHBheWxvYWQua2V5KTtcbiAgICAgICAgICAgIGNvbnN0IFtoZWFkZXJzU3RyLCBib2R5XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgZnMucHJvbWlzZXMucmVhZEZpbGUoaEZpbGUsICd1dGYtOCcpLFxuICAgICAgICAgICAgICBmcy5wcm9taXNlcy5yZWFkRmlsZShiRmlsZSlcbiAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgY29uc3Qge3N0YXR1c0NvZGUsIGhlYWRlcnN9ID0gSlNPTi5wYXJzZShoZWFkZXJzU3RyKSBhcyB7c3RhdHVzQ29kZTogbnVtYmVyOyBoZWFkZXJzOiBbc3RyaW5nLCBzdHJpbmcgfCBzdHJpbmdbXV1bXX07XG4gICAgICAgICAgICBjYWNoZUNvbnRyb2xsZXIuYWN0aW9uRGlzcGF0Y2hlci5fZ290Q2FjaGUoe2tleTogcGF5bG9hZC5rZXksIGRhdGE6IHtcbiAgICAgICAgICAgICAgc3RhdHVzQ29kZSxcbiAgICAgICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICAgICAgYm9keVxuICAgICAgICAgICAgfX0pO1xuICAgICAgICAgICAgLy8gc2VuZFJlcyhwYXlsb2FkLnJlcywgc3RhdHVzQ29kZSwgaGVhZGVycywgYm9keSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKCdObyBleGlzdGluZyBmaWxlIGZvcicsIHBheWxvYWQua2V5KTtcbiAgICAgICAgICAgIGNhY2hlQ29udHJvbGxlci5hY3Rpb25EaXNwYXRjaGVyLl9yZXF1ZXN0UmVtb3RlKHBheWxvYWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBhY3Rpb25zLl9yZXF1ZXN0UmVtb3RlLnBpcGUoXG4gICAgICAgIG9wLm1lcmdlTWFwKCh7cGF5bG9hZH0pID0+IHJ4Lm1lcmdlKFxuICAgICAgICAgIHJ4LnJhY2UoXG4gICAgICAgICAgICBwcm94eVJlcyQucGlwZShcbiAgICAgICAgICAgICAgb3AuZmlsdGVyKChbcHJveHlSZXMsIG9yaWdSZXFdKSA9PiBvcmlnUmVxID09PSBwYXlsb2FkLnJlcSksXG4gICAgICAgICAgICAgIG9wLnRha2UoMSksXG4gICAgICAgICAgICAgIG9wLm1hcCgoW3Byb3h5UmVzXSkgPT4ge1xuICAgICAgICAgICAgICAgIGNhY2hlQ29udHJvbGxlci5hY3Rpb25EaXNwYXRjaGVyLl9hZGRUb0NhY2hlKHtcbiAgICAgICAgICAgICAgICAgIGtleTogcGF5bG9hZC5rZXksXG4gICAgICAgICAgICAgICAgICByZXM6IHBheWxvYWQucmVzLFxuICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiBPYmplY3QuZW50cmllcyhwcm94eVJlcy5oZWFkZXJzKVxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKGVudHJ5ID0+IGVudHJ5WzFdICE9IG51bGwpIGFzIFtzdHJpbmcsIHN0cmluZyB8IHN0cmluZ1tdXVtdLFxuICAgICAgICAgICAgICAgICAgICByZWFkYWJsZTogcHJveHlSZXNcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBwcm94eUVycm9yJC5waXBlKFxuICAgICAgICAgICAgICBvcC5maWx0ZXIoKFtlcnIsIG9yaWdSZXFdKSA9PiBvcmlnUmVxID09PSBwYXlsb2FkLnJlcSksXG4gICAgICAgICAgICAgIG9wLnRha2UoMSksXG4gICAgICAgICAgICAgIG9wLm1hcCgoKSA9PiB7fSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApLFxuICAgICAgICAgIHByb3h5TWlkZGxld2FyZSQucGlwZShcbiAgICAgICAgICAgIG9wLnRha2UoMSksXG4gICAgICAgICAgICBvcC5tYXAocHJveHkgPT4gcHJveHkocGF5bG9hZC5yZXEsIHBheWxvYWQucmVzLCBwYXlsb2FkLm5leHQpKVxuICAgICAgICAgIClcbiAgICAgICAgKSlcbiAgICAgICksXG4gICAgICBhY3Rpb25zLl9hZGRUb0NhY2hlLnBpcGUoXG4gICAgICAgIG9wLm1lcmdlTWFwKCh7cGF5bG9hZDoge2tleSwgcmVzLCBkYXRhfX0pID0+IHtcbiAgICAgICAgICBodHRwUHJveHlMb2cuaW5mbygnY2FjaGUgc2l6ZTonLCBjYWNoZUNvbnRyb2xsZXIuZ2V0U3RhdGUoKS5jYWNoZUJ5VXJpLnNpemUpO1xuICAgICAgICAgIGNvbnN0IGRpciA9IFBhdGguam9pbihjYWNoZUNvbnRyb2xsZXIuZ2V0U3RhdGUoKS5jYWNoZURpciwga2V5KTtcbiAgICAgICAgICBjb25zdCBmaWxlID0gUGF0aC5qb2luKGRpciwgJ2JvZHknKTtcbiAgICAgICAgICBjb25zdCBzdGF0dXNDb2RlID0gZGF0YS5yZWFkYWJsZS5zdGF0dXNDb2RlIHx8IDIwMDtcbiAgICAgICAgICBjb25zdCB7cmVzcG9uc2VUcmFuc2Zvcm1lcn0gPSBjYWNoZUNvbnRyb2xsZXIuZ2V0U3RhdGUoKTtcbiAgICAgICAgICByZXR1cm4gKHN0YXR1c0NvZGUgPT09IDIwMCA/IHBpcGVUb0J1ZmZlcihkYXRhLnJlYWRhYmxlLFxuICAgICAgICAgICAgLi4uKHJlc3BvbnNlVHJhbnNmb3JtZXIgPyBfLmZsYXR0ZW4ocmVzcG9uc2VUcmFuc2Zvcm1lci5tYXAoZW50cnkgPT4gZW50cnkoZGF0YS5oZWFkZXJzKSkpIDpcbiAgICAgICAgICAgICAgICBbXSkgKSA6XG4gICAgICAgICAgICBwaXBlVG9CdWZmZXIoZGF0YS5yZWFkYWJsZSlcbiAgICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICBvcC5tZXJnZU1hcChhc3luYyBidWYgPT4ge1xuICAgICAgICAgICAgICAvLyBsb2cud2FybignY29udGVudC1sZW5ndGg6JywgYnVmLmxlbmd0aCk7XG4gICAgICAgICAgICAgIGNvbnN0IGxlbmd0aEhlYWRlcklkeCA9IGRhdGEuaGVhZGVycy5maW5kSW5kZXgocm93ID0+IHJvd1swXSA9PT0gJ2NvbnRlbnQtbGVuZ3RoJyk7XG4gICAgICAgICAgICAgIGlmIChsZW5ndGhIZWFkZXJJZHggPj0gMClcbiAgICAgICAgICAgICAgICBkYXRhLmhlYWRlcnNbbGVuZ3RoSGVhZGVySWR4XVsxXSA9ICcnICsgYnVmLmxlbmd0aDtcblxuICAgICAgICAgICAgICBjYWNoZUNvbnRyb2xsZXIuYWN0aW9uRGlzcGF0Y2hlci5fZ290Q2FjaGUoe2tleSwgZGF0YToge1xuICAgICAgICAgICAgICAgIHN0YXR1c0NvZGUsXG4gICAgICAgICAgICAgICAgaGVhZGVyczogZGF0YS5oZWFkZXJzLFxuICAgICAgICAgICAgICAgIGJvZHk6IGJ1ZlxuICAgICAgICAgICAgICB9fSk7XG4gICAgICAgICAgICAgIGlmIChzdGF0dXNDb2RlID09PSAzMDQpIHtcbiAgICAgICAgICAgICAgICBsb2cud2FybignVmVyc2lvbiBpbmZvIGlzIG5vdCByZWNvcmRlZCwgZHVlIHRvIHJlc3BvbnNlIDMwNCBmcm9tJywgcmVzLnJlcS51cmwsICcsXFxuIHlvdSBjYW4gcmVtb3ZlIGV4aXN0aW5nIG5wbS9jYWNoZSBjYWNoZSB0byBhdm9pZCAzMDQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcnguRU1QVFk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBhd2FpdCBmcy5ta2RpcnAoUGF0aC5kaXJuYW1lKGZpbGUpKTtcbiAgICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgIGZzLnByb21pc2VzLndyaXRlRmlsZShmaWxlLCBidWYpLFxuICAgICAgICAgICAgICAgIGZzLnByb21pc2VzLndyaXRlRmlsZShcbiAgICAgICAgICAgICAgICAgIFBhdGguam9pbihkaXIsICdoZWFkZXIuanNvbicpLFxuICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7c3RhdHVzQ29kZSwgaGVhZGVyczogZGF0YS5oZWFkZXJzfSwgbnVsbCwgJyAgJyksXG4gICAgICAgICAgICAgICAgICAndXRmLTgnKVxuICAgICAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgICBodHRwUHJveHlMb2cuaW5mbygnd3JpdGUgcmVzcG9uc2UgdG8gZmlsZScsIFBhdGgucG9zaXgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgZmlsZSksICdzaXplJywgYnVmLmxlbmd0aCk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG9wLmNhdGNoRXJyb3IoKGVyciwgc3JjKSA9PiB7XG4gICAgICAgICAgICAgIGh0dHBQcm94eUxvZy5lcnJvcignSFRUUCBwcm94eSBjYWNoZSBlcnJvcjogZmFpbGVkIHRvIGNhY2hlIHJlc3BvbnNlJywgZXJyKTtcbiAgICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZGlyKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByeC5kZWZlcigoKSA9PiBmcy5yZW1vdmUoZGlyKSkucGlwZShvcC50YWtlKDEpLFxuICAgICAgICAgICAgICAgICAgb3AuaWdub3JlRWxlbWVudHMoKSAvLyBmb3IgYmV0dGVyIFRTIHR5cGUgaW5mZXJlbmNlXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXR1cm4gcnguRU1QVFk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKS5waXBlKFxuICAgICAgb3AuaWdub3JlRWxlbWVudHMoKSxcbiAgICAgIG9wLmNhdGNoRXJyb3IoKGVyciwgc3JjKSA9PiB7XG4gICAgICAgIGh0dHBQcm94eUxvZy5lcnJvcignSFRUUCBwcm94eSBjYWNoZSBlcnJvcicsIGVycik7XG4gICAgICAgIHJldHVybiBzcmM7XG4gICAgICB9KVxuICAgICk7XG4gIH0pO1xuXG4gIHJldHVybiBjYWNoZUNvbnRyb2xsZXI7XG59XG5cbmZ1bmN0aW9uIHBpcGVUb0J1ZmZlcihzb3VyY2U6IEluY29taW5nTWVzc2FnZSwgLi4udHJhbnNmb3JtZXJzOiBOb2RlSlMuUmVhZFdyaXRlU3RyZWFtW10pIHtcbiAgcmV0dXJuIG5ldyByeC5PYnNlcnZhYmxlPEJ1ZmZlcj4oc3ViID0+IHtcbiAgICBjb25zdCBib2R5QnVmczogQnVmZmVyW10gPSBbXTtcbiAgICBsZXQgY29tcGxldGVCb2R5OiBCdWZmZXI7XG4gICAgaWYgKHNvdXJjZS5jb21wbGV0ZSkge1xuICAgICAgc3ViLmVycm9yKG5ldyBFcnJvcigncmVzcG9uc2UgaXMgY29tcGxldGVkIGVhcmxpZXInKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHN0cmVhbXM6IEFycmF5PHN0cmVhbS5SZWFkYWJsZSB8IE5vZGVKUy5Xcml0YWJsZVN0cmVhbSB8IE5vZGVKUy5SZWFkV3JpdGVTdHJlYW0+ID0gW1xuICAgICAgICBzb3VyY2UsXG4gICAgICAgIC4uLnRyYW5zZm9ybWVycyxcbiAgICAgICAgbmV3IHN0cmVhbS5Xcml0YWJsZSh7XG4gICAgICAgICAgd3JpdGUoY2h1bmssIGVuYywgY2IpIHtcbiAgICAgICAgICAgIGJvZHlCdWZzLnB1c2goY2h1bmspO1xuICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXTtcbiAgICAgIHN0cmVhbS5waXBlbGluZShzdHJlYW1zLFxuICAgICAgICAoZXJyOiBOb2RlSlMuRXJybm9FeGNlcHRpb24gfCBudWxsKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikgcmV0dXJuIHN1Yi5lcnJvcihlcnIpO1xuICAgICAgICAgIGNvbXBsZXRlQm9keSA9IEJ1ZmZlci5jb25jYXQoYm9keUJ1ZnMpO1xuICAgICAgICAgIHN1Yi5uZXh0KGNvbXBsZXRlQm9keSk7XG4gICAgICAgICAgc3ViLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAvLyBJIGFtIG5vdCBzdXJlIGlmIHRoaXMgaXMgcHJvcGVyIGNhbmNlbGxpbmcgb2YgYSBzdHJlYW0gcGlwZWxpbmVcbiAgICAgIHNvdXJjZS5wYXVzZSgpO1xuICAgICAgc291cmNlLmRlc3Ryb3koKTtcbiAgICB9O1xuICB9KTtcbn1cblxuZnVuY3Rpb24gc2VuZFJlcyhyZXM6IFJlc3BvbnNlLCBzdGF0dXNDb2RlOiBudW1iZXIsIGhlYWRlcnM6IFtzdHJpbmcsIHN0cmluZyB8IHN0cmluZ1tdXVtdLCBib2R5OiBCdWZmZXIgfCBzdHJlYW0uUmVhZGFibGUpIHtcbiAgcmVzLnN0YXR1cyhzdGF0dXNDb2RlKTtcbiAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIGhlYWRlcnMpIHtcbiAgICByZXMuc2V0SGVhZGVyKG5hbWUsIHZhbHVlKTtcbiAgfVxuICBpZiAoQnVmZmVyLmlzQnVmZmVyKGJvZHkpKVxuICAgIHJlcy5lbmQoYm9keSk7XG4gIGVsc2VcbiAgICBzdHJlYW0ucGlwZWxpbmUoYm9keSwgcmVzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGtleU9mVXJpKG1ldGhvZDogc3RyaW5nLCBwYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgdXJsID0gbmV3IFVSTCgnaHR0cDovL2YuY29tJyArIHBhdGgpO1xuICBjb25zdCBrZXkgPSBtZXRob2QgKyB1cmwucGF0aG5hbWUgKyAodXJsLnNlYXJjaCA/ICcvJyArIF8udHJpbVN0YXJ0KHVybC5zZWFyY2gsICc/JykgOiAnJyk7XG4gIHJldHVybiBrZXk7XG59XG4iXX0=