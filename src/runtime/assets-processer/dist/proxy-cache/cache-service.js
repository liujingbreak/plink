"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.keyOfUri = exports.createProxyWithCache = void 0;
const path_1 = __importDefault(require("path"));
const stream_1 = __importDefault(require("stream"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const rx = __importStar(require("rxjs"));
const op = __importStar(require("rxjs/operators"));
const lodash_1 = __importDefault(require("lodash"));
const __plink_1 = __importDefault(require("__plink"));
const plink_1 = require("@wfh/plink");
const http_proxy_middleware_1 = require("http-proxy-middleware");
const tiny_redux_toolkit_1 = require("@wfh/redux-toolkit-observable/dist/tiny-redux-toolkit");
const utils_1 = require("../utils");
const log = (0, plink_1.log4File)(__filename);
const httpProxyLog = plink_1.logger.getLogger(log.category + '#httpProxy');
function createProxyWithCache(proxyPath, targetUrl, cacheRootDir, opts = { manual: false }) {
    var _a;
    const initialState = {
        // proxyOptions: defaultProxyOptions(proxyPath, targetUrl),
        cacheDir: cacheRootDir,
        cacheByUri: new Map(),
        responseTransformer: []
    };
    if (!opts.manual) {
        __plink_1.default.expressAppSet(app => {
            app.use(proxyPath, (req, res, next) => {
                const key = keyOfUri(req.method, req.url);
                cacheController.actionDispatcher.hitCache({ key, req, res, next });
            });
        });
    }
    const cacheController = (0, tiny_redux_toolkit_1.createSlice)({
        initialState,
        name: `HTTP-proxy-cache-${proxyPath}`,
        debug: (_a = (0, plink_1.config)().cliOptions) === null || _a === void 0 ? void 0 : _a.verbose,
        reducers: {
            configureProxy(s, payload) {
            },
            configTransformer(s, payload) {
                s.responseTransformer = payload;
            },
            hitCache(s, payload) { },
            _addToCache(s, payload) { },
            _loadFromStorage(s, payload) {
                s.cacheByUri.set(payload.key, 'loading');
            },
            _requestRemote(s, payload) {
                s.cacheByUri.set(payload.key, 'requesting');
            },
            _gotCache(s, payload) {
                log.info('got cache', payload.key);
                s.cacheByUri.set(payload.key, payload.data);
                // s.cacheByUri.delete(payload.key);
            }
        }
    });
    cacheController.epic(action$ => {
        const defaultProxyOpt = (0, utils_1.defaultProxyOptions)(proxyPath, targetUrl);
        if (opts.pathRewrite)
            defaultProxyOpt.pathRewrite = opts.pathRewrite;
        const proxyError$ = new rx.Subject();
        const proxyRes$ = new rx.Subject();
        let proxyMiddleware$ = new rx.ReplaySubject(1);
        const actions = (0, tiny_redux_toolkit_1.castByActionType)(cacheController.actions, action$);
        return rx.merge(actions.configureProxy.pipe(op.map(({ payload: extraOpt }) => {
            proxyMiddleware$.next((0, http_proxy_middleware_1.createProxyMiddleware)(Object.assign(Object.assign(Object.assign({}, defaultProxyOpt), extraOpt), { onProxyRes(...args) {
                    proxyRes$.next(args);
                    defaultProxyOpt.onProxyRes(...args);
                    if (extraOpt.onProxyRes)
                        extraOpt.onProxyRes(...args);
                },
                onError(...args) {
                    defaultProxyOpt.onError(...args);
                    proxyError$.next(args);
                    if (extraOpt.onError)
                        extraOpt.onError(...args);
                } })));
        })), actions.hitCache.pipe(op.mergeMap(({ payload }) => {
            const item = cacheController.getState().cacheByUri.get(payload.key);
            if (item == null) {
                cacheController.actionDispatcher._loadFromStorage(payload);
                return rx.EMPTY;
            }
            else if (item === 'loading' || item === 'requesting') {
                return actions._gotCache.pipe(op.filter(action => action.payload.key === payload.key), op.take(1), op.map(({ payload: { data } }) => {
                    for (const entry of data.headers) {
                        payload.res.setHeader(entry[0], entry[1]);
                    }
                    payload.res.end(data.body);
                }));
            }
            else {
                httpProxyLog.info('hit cached', payload.key);
                sendRes(payload.res, item.statusCode, item.headers, item.body);
                return rx.EMPTY;
            }
        })), actions._loadFromStorage.pipe(op.map(async ({ payload }) => {
            const dir = path_1.default.join(cacheController.getState().cacheDir, payload.key);
            const hFile = path_1.default.join(dir, 'header.json');
            const bFile = path_1.default.join(dir, 'body');
            if (fs_extra_1.default.existsSync(hFile)) {
                httpProxyLog.info('load', payload.key);
                const [headersStr, body] = await Promise.all([
                    fs_extra_1.default.promises.readFile(hFile, 'utf-8'),
                    fs_extra_1.default.promises.readFile(bFile)
                ]);
                const { statusCode, headers } = JSON.parse(headersStr);
                cacheController.actionDispatcher._gotCache({ key: payload.key, data: {
                        statusCode,
                        headers,
                        body
                    } });
                sendRes(payload.res, statusCode, headers, body);
            }
            else {
                log.info('No existing file for', payload.key);
                cacheController.actionDispatcher._requestRemote(payload);
            }
        })), actions._requestRemote.pipe(op.mergeMap(({ payload }) => rx.merge(rx.race(proxyRes$.pipe(op.filter(([proxyRes, origReq]) => origReq === payload.req), op.take(1), op.map(([proxyRes]) => {
            httpProxyLog.warn('Incoming response read completed ?', proxyRes.complete);
            cacheController.actionDispatcher._addToCache({
                key: payload.key,
                data: {
                    headers: Object.entries(proxyRes.headers).filter(entry => entry[1] != null),
                    readable: proxyRes
                }
            });
        })), proxyError$.pipe(op.filter(([err, origReq]) => origReq === payload.req), op.take(1), op.map(() => { }))), proxyMiddleware$.pipe(op.take(1), op.map(proxy => proxy(payload.req, payload.res, payload.next)))))), actions._addToCache.pipe(op.mergeMap(({ payload: { key, data } }) => {
            httpProxyLog.info('cache size:', cacheController.getState().cacheByUri.size);
            const dir = path_1.default.join(cacheController.getState().cacheDir, key);
            const file = path_1.default.join(dir, 'body');
            const statusCode = data.readable.statusCode || 200;
            const { responseTransformer } = cacheController.getState();
            return pipeToBuffer(data.readable, ...(responseTransformer ? lodash_1.default.flatten(responseTransformer.map(entry => entry(data.headers))) :
                [])).pipe(op.mergeMap(async (buf) => {
                cacheController.actionDispatcher._gotCache({ key, data: {
                        statusCode,
                        headers: data.headers,
                        body: buf
                    } });
                await fs_extra_1.default.mkdirp(path_1.default.dirname(file));
                await Promise.all([
                    fs_extra_1.default.promises.writeFile(file, buf),
                    fs_extra_1.default.promises.writeFile(path_1.default.join(dir, 'header.json'), JSON.stringify({ statusCode, headers: data.headers }, null, '  '), 'utf-8')
                ]);
                httpProxyLog.info('write response to file', path_1.default.posix.relative(process.cwd(), file));
            }), op.catchError((err, src) => {
                httpProxyLog.error('HTTP proxy cache error: failed to cache response', err);
                if (fs_extra_1.default.existsSync(dir)) {
                    return rx.defer(() => fs_extra_1.default.remove(dir)).pipe(op.take(1), op.ignoreElements() // for better TS type inference
                    );
                }
                return rx.EMPTY;
            }));
        }))).pipe(op.ignoreElements(), op.catchError((err, src) => {
            httpProxyLog.error('HTTP proxy cache error', err);
            return src;
        }));
    });
    return cacheController;
}
exports.createProxyWithCache = createProxyWithCache;
function pipeToBuffer(source, ...transformers) {
    return new rx.Observable(sub => {
        const bodyBufs = [];
        let completeBody;
        if (source.complete) {
            sub.error(new Error('response is completed earlier'));
        }
        else {
            const streams = [
                source,
                ...transformers,
                new stream_1.default.Writable({
                    write(chunk, enc, cb) {
                        bodyBufs.push(chunk);
                        cb();
                    }
                })
            ];
            stream_1.default.pipeline(streams, (err) => {
                if (err)
                    return sub.error(err);
                completeBody = Buffer.concat(bodyBufs);
                sub.next(completeBody);
                sub.complete();
            });
        }
        return () => {
            // I am not sure if this is proper cancelling of a stream pipeline
            source.pause();
            source.destroy();
        };
    });
}
function sendRes(res, statusCode, headers, body) {
    res.status(statusCode);
    for (const [name, value] of headers) {
        res.setHeader(name, value);
    }
    if (Buffer.isBuffer(body))
        res.end(body);
    else
        stream_1.default.pipeline(body, res);
}
function keyOfUri(method, uri) {
    const url = new URL('http://f.com' + uri);
    const key = method + url.pathname + (url.search ? '/' + lodash_1.default.trimStart(url.search, '?') : '');
    return key;
}
exports.keyOfUri = keyOfUri;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNhY2hlLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF3QjtBQUN4QixvREFBNEI7QUFFNUIsd0RBQTBCO0FBQzFCLHlDQUEyQjtBQUMzQixtREFBcUM7QUFDckMsb0RBQXVCO0FBRXZCLHNEQUEwQjtBQUMxQixzQ0FBb0Q7QUFDcEQsaUVBQTZGO0FBQzdGLDhGQUFvRztBQUNwRyxvQ0FBNkM7QUFHN0MsTUFBTSxHQUFHLEdBQUcsSUFBQSxnQkFBUSxFQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0sWUFBWSxHQUFHLGNBQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUMsQ0FBQztBQUVuRSxTQUFnQixvQkFBb0IsQ0FBQyxTQUFpQixFQUFFLFNBQWlCLEVBQUUsWUFBb0IsRUFDOUUsT0FBbUUsRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFDOztJQUNqRyxNQUFNLFlBQVksR0FBb0I7UUFDcEMsMkRBQTJEO1FBQzNELFFBQVEsRUFBRSxZQUFZO1FBQ3RCLFVBQVUsRUFBRSxJQUFJLEdBQUcsRUFBRTtRQUNyQixtQkFBbUIsRUFBRSxFQUFFO0tBQ3hCLENBQUM7SUFFRixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNoQixpQkFBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN0QixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ3BDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxFQUFDLEdBQUcsRUFBRSxH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LENBQUM7QUFDTCxDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUMsR0FBYSxFQUFFLFVBQWtCLEVBQUUsT0FBc0MsRUFBRSxJQUE4QjtJQUN4SCxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3ZCLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSSxPQUFPLEVBQUU7UUFDbkMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDNUI7SUFDRCxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7O1FBRWQsZ0JBQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQy9CLENBQUM7QUFFRCxTQUFnQixRQUFRLENBQUMsTUFBYyxFQUFFLEdBQVc7SUFDbEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsY0FBYyxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQzFDLE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxHQUFHLENBQUMsUUFBUSxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLGdCQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzNGLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQUpELDRCQUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgc3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBJbmNvbWluZ01lc3NhZ2UgfSBmcm9tICdodHRwJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyByeCBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIG9wIGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge1JlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb259IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGFwaSBmcm9tICdfX3BsaW5rJztcbmltcG9ydCB7bG9nZ2VyLCBsb2c0RmlsZSwgY29uZmlnfSBmcm9tICdAd2ZoL3BsaW5rJztcbmltcG9ydCB7IGNyZWF0ZVByb3h5TWlkZGxld2FyZSBhcyBwcm94eSwgT3B0aW9ucyBhcyBIcG1PcHRpb25zfSBmcm9tICdodHRwLXByb3h5LW1pZGRsZXdhcmUnO1xuaW1wb3J0IHtjcmVhdGVTbGljZSwgY2FzdEJ5QWN0aW9uVHlwZX0gZnJvbSAnQHdmaC9yZWR1eC10b29sa2l0LW9ic2VydmFibGUvZGlzdC90aW55LXJlZHV4LXRvb2xraXQnO1xuaW1wb3J0IHtkZWZhdWx0UHJveHlPcHRpb25zfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQge1Byb3h5Q2FjaGVTdGF0ZSwgQ2FjaGVEYXRhfSBmcm9tICcuL3R5cGVzJztcblxuY29uc3QgbG9nID0gbG9nNEZpbGUoX19maWxlbmFtZSk7XG5jb25zdCBodHRwUHJveHlMb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKGxvZy5jYXRlZ29yeSArICcjaHR0cFByb3h5Jyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVQcm94eVdpdGhDYWNoZShwcm94eVBhdGg6IHN0cmluZywgdGFyZ2V0VXJsOiBzdHJpbmcsIGNhY2hlUm9vdERpcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICBvcHRzOiB7bWFudWFsOiBib29sZWFuOyBwYXRoUmV3cml0ZT86IEhwbU9wdGlvbnNbJ3BhdGhSZXdyaXRlJ119ID0ge21hbnVhbDogZmFsc2V9KSB7XG4gIGNvbnN0IGluaXRpYWxTdGF0ZTogUHJveHlDYWNoZVN0YXRlID0ge1xuICAgIC8vIHByb3h5T3B0aW9uczogZGVmYXVsdFByb3h5T3B0aW9ucyhwcm94eVBhdGgsIHRhcmdldFVybCksXG4gICAgY2FjaGVEaXI6IGNhY2hlUm9vdERpcixcbiAgICBjYWNoZUJ5VXJpOiBuZXcgTWFwKCksXG4gICAgcmVzcG9uc2VUcmFuc2Zvcm1lcjogW11cbiAgfTtcblxuICBpZiAoIW9wdHMubWFudWFsKSB7XG4gICAgYXBpLmV4cHJlc3NBcHBTZXQoYXBwID0+IHtcbiAgICAgIGFwcC51c2UocHJveHlQYXRoLCAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgICAgY29uc3Qga2V5ID0ga2V5T2ZVcmkocmVxLm1ldGhvZCwgcmVxLnVybCk7XG4gICAgICAgIGNhY2hlQ29udHJvbGxlci5hY3Rpb25EaXNwYXRjaGVyLmhpdENhY2hlKHtrZXksIHJlcSwgcmVzLCBuZXh0fSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICBjb25zdCBjYWNoZUNvbnRyb2xsZXIgPSBjcmVhdGVTbGljZSh7XG4gICAgaW5pdGlhbFN0YXRlLFxuICAgIG5hbWU6IGBIVFRQLXByb3h5LWNhY2hlLSR7cHJveHlQYXRofWAgLFxuICAgIGRlYnVnOiBjb25maWcoKS5jbGlPcHRpb25zPy52ZXJib3NlLFxuICAgIHJlZHVjZXJzOiB7XG4gICAgICBjb25maWd1cmVQcm94eShzOiBQcm94eUNhY2hlU3RhdGUsIHBheWxvYWQ6IEhwbU9wdGlvbnMpIHtcbiAgICAgIH0sXG4gICAgICBjb25maWdUcmFuc2Zvcm1lcihzOiBQcm94eUNhY2hlU3RhdGUsIHBheWxvYWQ6IFByb3h5Q2FjaGVTdGF0ZVsncmVzcG9uc2VUcmFuc2Zvcm1lciddKSB7XG4gICAgICAgIHMucmVzcG9uc2VUcmFuc2Zvcm1lciA9IHBheWxvYWQ7XG4gICAgICB9LFxuICAgICAgaGl0Q2FjaGUoczogUHJveHlDYWNoZVN0YXRlLCBwYXlsb2FkOiB7a2V5OiBzdHJpbmc7IHJlcTogUmVxdWVzdDsgcmVzOiBSZXNwb25zZTsgbmV4dDogTmV4dEZ1bmN0aW9ufSkge30sXG5cbiAgICAgIF9hZGRUb0NhY2hlKHM6IFByb3h5Q2FjaGVTdGF0ZSwgcGF5bG9hZDoge1xuICAgICAgICBrZXk6IHN0cmluZztcbiAgICAgICAgZGF0YToge2hlYWRlcnM6IENhY2hlRGF0YVsnaGVhZGVycyddOyByZWFkYWJsZTogSW5jb21pbmdNZXNzYWdlfTtcbiAgICAgIH0pIHt9LFxuXG4gICAgICBfbG9hZEZyb21TdG9yYWdlKHM6IFByb3h5Q2FjaGVTdGF0ZSwgcGF5bG9hZDoge2tleTogc3RyaW5nOyByZXE6IFJlcXVlc3Q7IHJlczogUmVzcG9uc2U7IG5leHQ6IE5leHRGdW5jdGlvbn0pIHtcbiAgICAgICAgcy5jYWNoZUJ5VXJpLnNldChwYXlsb2FkLmtleSwgJ2xvYWRpbmcnKTtcbiAgICAgIH0sXG5cbiAgICAgIF9yZXF1ZXN0UmVtb3RlKHM6IFByb3h5Q2FjaGVTdGF0ZSwgcGF5bG9hZDoge2tleTogc3RyaW5nOyByZXE6IFJlcXVlc3Q7IHJlczogUmVzcG9uc2U7IG5leHQ6IE5leHRGdW5jdGlvbn0pIHtcbiAgICAgICAgcy5jYWNoZUJ5VXJpLnNldChwYXlsb2FkLmtleSwgJ3JlcXVlc3RpbmcnKTtcbiAgICAgIH0sXG4gICAgICBfZ290Q2FjaGUoczogUHJveHlDYWNoZVN0YXRlLCBwYXlsb2FkOiB7XG4gICAgICAgIGtleTogc3RyaW5nO1xuICAgICAgICBkYXRhOiBDYWNoZURhdGE7XG4gICAgICB9KSB7XG4gICAgICAgIGxvZy5pbmZvKCdnb3QgY2FjaGUnLCBwYXlsb2FkLmtleSk7XG4gICAgICAgIHMuY2FjaGVCeVVyaS5zZXQocGF5bG9hZC5rZXksIHBheWxvYWQuZGF0YSk7XG4gICAgICAgIC8vIHMuY2FjaGVCeVVyaS5kZWxldGUocGF5bG9hZC5rZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgY2FjaGVDb250cm9sbGVyLmVwaWMoYWN0aW9uJCA9PiB7XG4gICAgY29uc3QgZGVmYXVsdFByb3h5T3B0ID0gZGVmYXVsdFByb3h5T3B0aW9ucyhwcm94eVBhdGgsIHRhcmdldFVybCk7XG4gICAgaWYgKG9wdHMucGF0aFJld3JpdGUpXG4gICAgICBkZWZhdWx0UHJveHlPcHQucGF0aFJld3JpdGUgPSBvcHRzLnBhdGhSZXdyaXRlO1xuXG4gICAgY29uc3QgcHJveHlFcnJvciQgPSBuZXcgcnguU3ViamVjdDxQYXJhbWV0ZXJzPCh0eXBlb2YgZGVmYXVsdFByb3h5T3B0KVsnb25FcnJvciddPj4oKTtcbiAgICBjb25zdCBwcm94eVJlcyQgPSBuZXcgcnguU3ViamVjdDxQYXJhbWV0ZXJzPCh0eXBlb2YgZGVmYXVsdFByb3h5T3B0KVsnb25Qcm94eVJlcyddPj4oKTtcblxuICAgIGxldCBwcm94eU1pZGRsZXdhcmUkID0gbmV3IHJ4LlJlcGxheVN1YmplY3Q8UmV0dXJuVHlwZTx0eXBlb2YgcHJveHk+PigxKTtcbiAgICBjb25zdCBhY3Rpb25zID0gY2FzdEJ5QWN0aW9uVHlwZShjYWNoZUNvbnRyb2xsZXIuYWN0aW9ucywgYWN0aW9uJCk7XG5cbiAgICByZXR1cm4gcngubWVyZ2UoXG4gICAgICBhY3Rpb25zLmNvbmZpZ3VyZVByb3h5LnBpcGUoXG4gICAgICAgIG9wLm1hcCgoe3BheWxvYWQ6IGV4dHJhT3B0fSkgPT4ge1xuICAgICAgICAgIHByb3h5TWlkZGxld2FyZSQubmV4dChwcm94eSh7XG4gICAgICAgICAgICAuLi5kZWZhdWx0UHJveHlPcHQsXG4gICAgICAgICAgICAuLi5leHRyYU9wdCxcbiAgICAgICAgICAgIG9uUHJveHlSZXMoLi4uYXJncykge1xuICAgICAgICAgICAgICBwcm94eVJlcyQubmV4dChhcmdzKTtcbiAgICAgICAgICAgICAgZGVmYXVsdFByb3h5T3B0Lm9uUHJveHlSZXMoLi4uYXJncyk7XG4gICAgICAgICAgICAgIGlmIChleHRyYU9wdC5vblByb3h5UmVzKVxuICAgICAgICAgICAgICAgIGV4dHJhT3B0Lm9uUHJveHlSZXMoLi4uYXJncyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25FcnJvciguLi5hcmdzKSB7XG4gICAgICAgICAgICAgIGRlZmF1bHRQcm94eU9wdC5vbkVycm9yKC4uLmFyZ3MpO1xuICAgICAgICAgICAgICBwcm94eUVycm9yJC5uZXh0KGFyZ3MpO1xuICAgICAgICAgICAgICBpZiAoZXh0cmFPcHQub25FcnJvcilcbiAgICAgICAgICAgICAgICBleHRyYU9wdC5vbkVycm9yKC4uLmFyZ3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBhY3Rpb25zLmhpdENhY2hlLnBpcGUoXG4gICAgICAgIG9wLm1lcmdlTWFwKCAoe3BheWxvYWR9KSA9PiB7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IGNhY2hlQ29udHJvbGxlci5nZXRTdGF0ZSgpLmNhY2hlQnlVcmkuZ2V0KHBheWxvYWQua2V5KTtcbiAgICAgICAgICBpZiAoaXRlbSA9PSBudWxsKSB7XG4gICAgICAgICAgICBjYWNoZUNvbnRyb2xsZXIuYWN0aW9uRGlzcGF0Y2hlci5fbG9hZEZyb21TdG9yYWdlKHBheWxvYWQpO1xuICAgICAgICAgICAgcmV0dXJuIHJ4LkVNUFRZO1xuICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbSA9PT0gJ2xvYWRpbmcnIHx8IGl0ZW0gPT09ICdyZXF1ZXN0aW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIGFjdGlvbnMuX2dvdENhY2hlLnBpcGUoXG4gICAgICAgICAgICAgIG9wLmZpbHRlcihhY3Rpb24gPT4gYWN0aW9uLnBheWxvYWQua2V5ID09PSBwYXlsb2FkLmtleSksXG4gICAgICAgICAgICAgIG9wLnRha2UoMSksXG4gICAgICAgICAgICAgIG9wLm1hcCgoe3BheWxvYWQ6IHtkYXRhfX0pID0+IHtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGRhdGEuaGVhZGVycykge1xuICAgICAgICAgICAgICAgICAgcGF5bG9hZC5yZXMuc2V0SGVhZGVyKGVudHJ5WzBdLCBlbnRyeVsxXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBheWxvYWQucmVzLmVuZChkYXRhLmJvZHkpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaHR0cFByb3h5TG9nLmluZm8oJ2hpdCBjYWNoZWQnLCBwYXlsb2FkLmtleSk7XG4gICAgICAgICAgICBzZW5kUmVzKHBheWxvYWQucmVzLCBpdGVtLnN0YXR1c0NvZGUsIGl0ZW0uaGVhZGVycywgaXRlbS5ib2R5KTtcbiAgICAgICAgICAgIHJldHVybiByeC5FTVBUWTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgYWN0aW9ucy5fbG9hZEZyb21TdG9yYWdlLnBpcGUoXG4gICAgICAgIG9wLm1hcChhc3luYyAoe3BheWxvYWR9KSA9PiB7XG4gICAgICAgICAgY29uc3QgZGlyID0gUGF0aC5qb2luKGNhY2hlQ29udHJvbGxlci5nZXRTdGF0ZSgpLmNhY2hlRGlyLCBwYXlsb2FkLmtleSk7XG4gICAgICAgICAgY29uc3QgaEZpbGUgPSBQYXRoLmpvaW4oZGlyLCAnaGVhZGVyLmpzb24nKTtcbiAgICAgICAgICBjb25zdCBiRmlsZSA9IFBhdGguam9pbihkaXIsICdib2R5Jyk7XG4gICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoaEZpbGUpKSB7XG4gICAgICAgICAgICBodHRwUHJveHlMb2cuaW5mbygnbG9hZCcsIHBheWxvYWQua2V5KTtcbiAgICAgICAgICAgIGNvbnN0IFtoZWFkZXJzU3RyLCBib2R5XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgZnMucHJvbWlzZXMucmVhZEZpbGUoaEZpbGUsICd1dGYtOCcpLFxuICAgICAgICAgICAgICBmcy5wcm9taXNlcy5yZWFkRmlsZShiRmlsZSlcbiAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgY29uc3Qge3N0YXR1c0NvZGUsIGhlYWRlcnN9ID0gSlNPTi5wYXJzZShoZWFkZXJzU3RyKSBhcyB7c3RhdHVzQ29kZTogbnVtYmVyOyBoZWFkZXJzOiBbc3RyaW5nLCBzdHJpbmcgfCBzdHJpbmdbXV1bXX07XG4gICAgICAgICAgICBjYWNoZUNvbnRyb2xsZXIuYWN0aW9uRGlzcGF0Y2hlci5fZ290Q2FjaGUoe2tleTogcGF5bG9hZC5rZXksIGRhdGE6IHtcbiAgICAgICAgICAgICAgc3RhdHVzQ29kZSxcbiAgICAgICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICAgICAgYm9keVxuICAgICAgICAgICAgfX0pO1xuICAgICAgICAgICAgc2VuZFJlcyhwYXlsb2FkLnJlcywgc3RhdHVzQ29kZSwgaGVhZGVycywgYm9keSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKCdObyBleGlzdGluZyBmaWxlIGZvcicsIHBheWxvYWQua2V5KTtcbiAgICAgICAgICAgIGNhY2hlQ29udHJvbGxlci5hY3Rpb25EaXNwYXRjaGVyLl9yZXF1ZXN0UmVtb3RlKHBheWxvYWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgICBhY3Rpb25zLl9yZXF1ZXN0UmVtb3RlLnBpcGUoXG4gICAgICAgIG9wLm1lcmdlTWFwKCh7cGF5bG9hZH0pID0+IHJ4Lm1lcmdlKFxuICAgICAgICAgIHJ4LnJhY2UoXG4gICAgICAgICAgICBwcm94eVJlcyQucGlwZShcbiAgICAgICAgICAgICAgb3AuZmlsdGVyKChbcHJveHlSZXMsIG9yaWdSZXFdKSA9PiBvcmlnUmVxID09PSBwYXlsb2FkLnJlcSksXG4gICAgICAgICAgICAgIG9wLnRha2UoMSksXG4gICAgICAgICAgICAgIG9wLm1hcCgoW3Byb3h5UmVzXSkgPT4ge1xuICAgICAgICAgICAgICAgIGh0dHBQcm94eUxvZy53YXJuKCdJbmNvbWluZyByZXNwb25zZSByZWFkIGNvbXBsZXRlZCA/JywgcHJveHlSZXMuY29tcGxldGUpO1xuICAgICAgICAgICAgICAgIGNhY2hlQ29udHJvbGxlci5hY3Rpb25EaXNwYXRjaGVyLl9hZGRUb0NhY2hlKHtcbiAgICAgICAgICAgICAgICAgIGtleTogcGF5bG9hZC5rZXksXG4gICAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IE9iamVjdC5lbnRyaWVzKHByb3h5UmVzLmhlYWRlcnMpLmZpbHRlcihlbnRyeSA9PiBlbnRyeVsxXSAhPSBudWxsKSBhcyBbc3RyaW5nLCBzdHJpbmcgfCBzdHJpbmdbXV1bXSxcbiAgICAgICAgICAgICAgICAgICAgcmVhZGFibGU6IHByb3h5UmVzXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgcHJveHlFcnJvciQucGlwZShcbiAgICAgICAgICAgICAgb3AuZmlsdGVyKChbZXJyLCBvcmlnUmVxXSkgPT4gb3JpZ1JlcSA9PT0gcGF5bG9hZC5yZXEpLFxuICAgICAgICAgICAgICBvcC50YWtlKDEpLFxuICAgICAgICAgICAgICBvcC5tYXAoKCkgPT4ge30pXG4gICAgICAgICAgICApXG4gICAgICAgICAgKSxcbiAgICAgICAgICBwcm94eU1pZGRsZXdhcmUkLnBpcGUoXG4gICAgICAgICAgICBvcC50YWtlKDEpLFxuICAgICAgICAgICAgb3AubWFwKHByb3h5ID0+IHByb3h5KHBheWxvYWQucmVxLCBwYXlsb2FkLnJlcywgcGF5bG9hZC5uZXh0KSlcbiAgICAgICAgICApXG4gICAgICAgICkpXG4gICAgICApLFxuICAgICAgYWN0aW9ucy5fYWRkVG9DYWNoZS5waXBlKFxuICAgICAgICBvcC5tZXJnZU1hcCgoe3BheWxvYWQ6IHtrZXksIGRhdGF9fSkgPT4ge1xuICAgICAgICAgIGh0dHBQcm94eUxvZy5pbmZvKCdjYWNoZSBzaXplOicsIGNhY2hlQ29udHJvbGxlci5nZXRTdGF0ZSgpLmNhY2hlQnlVcmkuc2l6ZSk7XG4gICAgICAgICAgY29uc3QgZGlyID0gUGF0aC5qb2luKGNhY2hlQ29udHJvbGxlci5nZXRTdGF0ZSgpLmNhY2hlRGlyLCBrZXkpO1xuICAgICAgICAgIGNvbnN0IGZpbGUgPSBQYXRoLmpvaW4oZGlyLCAnYm9keScpO1xuICAgICAgICAgIGNvbnN0IHN0YXR1c0NvZGUgPSBkYXRhLnJlYWRhYmxlLnN0YXR1c0NvZGUgfHwgMjAwO1xuICAgICAgICAgIGNvbnN0IHtyZXNwb25zZVRyYW5zZm9ybWVyfSA9IGNhY2hlQ29udHJvbGxlci5nZXRTdGF0ZSgpO1xuICAgICAgICAgIHJldHVybiBwaXBlVG9CdWZmZXIoZGF0YS5yZWFkYWJsZSxcbiAgICAgICAgICAgIC4uLihyZXNwb25zZVRyYW5zZm9ybWVyID8gXy5mbGF0dGVuKHJlc3BvbnNlVHJhbnNmb3JtZXIubWFwKGVudHJ5ID0+IGVudHJ5KGRhdGEuaGVhZGVycykpKSA6XG4gICAgICAgICAgICAgICAgW10pIGFzIE5vZGVKUy5SZWFkV3JpdGVTdHJlYW1bXVxuICAgICAgICAgICkucGlwZShcbiAgICAgICAgICAgIG9wLm1lcmdlTWFwKGFzeW5jIGJ1ZiA9PiB7XG4gICAgICAgICAgICAgIGNhY2hlQ29udHJvbGxlci5hY3Rpb25EaXNwYXRjaGVyLl9nb3RDYWNoZSh7a2V5LCBkYXRhOiB7XG4gICAgICAgICAgICAgICAgc3RhdHVzQ29kZSxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiBkYXRhLmhlYWRlcnMsXG4gICAgICAgICAgICAgICAgYm9keTogYnVmXG4gICAgICAgICAgICAgIH19KTtcbiAgICAgICAgICAgICAgYXdhaXQgZnMubWtkaXJwKFBhdGguZGlybmFtZShmaWxlKSk7XG5cbiAgICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgIGZzLnByb21pc2VzLndyaXRlRmlsZShmaWxlLCBidWYpLFxuICAgICAgICAgICAgICAgIGZzLnByb21pc2VzLndyaXRlRmlsZShcbiAgICAgICAgICAgICAgICAgIFBhdGguam9pbihkaXIsICdoZWFkZXIuanNvbicpLFxuICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7c3RhdHVzQ29kZSwgaGVhZGVyczogZGF0YS5oZWFkZXJzfSwgbnVsbCwgJyAgJyksXG4gICAgICAgICAgICAgICAgICAndXRmLTgnKVxuICAgICAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgICBodHRwUHJveHlMb2cuaW5mbygnd3JpdGUgcmVzcG9uc2UgdG8gZmlsZScsIFBhdGgucG9zaXgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgZmlsZSkpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBvcC5jYXRjaEVycm9yKChlcnIsIHNyYykgPT4ge1xuICAgICAgICAgICAgICBodHRwUHJveHlMb2cuZXJyb3IoJ0hUVFAgcHJveHkgY2FjaGUgZXJyb3I6IGZhaWxlZCB0byBjYWNoZSByZXNwb25zZScsIGVycik7XG4gICAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGRpcikpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcnguZGVmZXIoKCkgPT4gZnMucmVtb3ZlKGRpcikpLnBpcGUob3AudGFrZSgxKSxcbiAgICAgICAgICAgICAgICAgIG9wLmlnbm9yZUVsZW1lbnRzKCkgLy8gZm9yIGJldHRlciBUUyB0eXBlIGluZmVyZW5jZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIHJ4LkVNUFRZO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICkucGlwZShcbiAgICAgIG9wLmlnbm9yZUVsZW1lbnRzKCksXG4gICAgICBvcC5jYXRjaEVycm9yKChlcnIsIHNyYykgPT4ge1xuICAgICAgICBodHRwUHJveHlMb2cuZXJyb3IoJ0hUVFAgcHJveHkgY2FjaGUgZXJyb3InLCBlcnIpO1xuICAgICAgICByZXR1cm4gc3JjO1xuICAgICAgfSlcbiAgICApO1xuICB9KTtcblxuICByZXR1cm4gY2FjaGVDb250cm9sbGVyO1xufVxuXG5mdW5jdGlvbiBwaXBlVG9CdWZmZXIoc291cmNlOiBJbmNvbWluZ01lc3NhZ2UsIC4uLnRyYW5zZm9ybWVyczogTm9kZUpTLlJlYWRXcml0ZVN0cmVhbVtdKSB7XG4gIHJldHVybiBuZXcgcnguT2JzZXJ2YWJsZTxCdWZmZXI+KHN1YiA9PiB7XG4gICAgY29uc3QgYm9keUJ1ZnM6IEJ1ZmZlcltdID0gW107XG4gICAgbGV0IGNvbXBsZXRlQm9keTogQnVmZmVyO1xuICAgIGlmIChzb3VyY2UuY29tcGxldGUpIHtcbiAgICAgIHN1Yi5lcnJvcihuZXcgRXJyb3IoJ3Jlc3BvbnNlIGlzIGNvbXBsZXRlZCBlYXJsaWVyJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzdHJlYW1zOiBBcnJheTxzdHJlYW0uUmVhZGFibGUgfCBOb2RlSlMuV3JpdGFibGVTdHJlYW0gfCBOb2RlSlMuUmVhZFdyaXRlU3RyZWFtPiA9IFtcbiAgICAgICAgc291cmNlLFxuICAgICAgICAuLi50cmFuc2Zvcm1lcnMsXG4gICAgICAgIG5ldyBzdHJlYW0uV3JpdGFibGUoe1xuICAgICAgICAgIHdyaXRlKGNodW5rLCBlbmMsIGNiKSB7XG4gICAgICAgICAgICBib2R5QnVmcy5wdXNoKGNodW5rKTtcbiAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KV07XG4gICAgICBzdHJlYW0ucGlwZWxpbmUoc3RyZWFtcyxcbiAgICAgICAgKGVycjogTm9kZUpTLkVycm5vRXhjZXB0aW9uIHwgbnVsbCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHJldHVybiBzdWIuZXJyb3IoZXJyKTtcbiAgICAgICAgICBjb21wbGV0ZUJvZHkgPSBCdWZmZXIuY29uY2F0KGJvZHlCdWZzKTtcbiAgICAgICAgICBzdWIubmV4dChjb21wbGV0ZUJvZHkpO1xuICAgICAgICAgIHN1Yi5jb21wbGV0ZSgpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgLy8gSSBhbSBub3Qgc3VyZSBpZiB0aGlzIGlzIHByb3BlciBjYW5jZWxsaW5nIG9mIGEgc3RyZWFtIHBpcGVsaW5lXG4gICAgICBzb3VyY2UucGF1c2UoKTtcbiAgICAgIHNvdXJjZS5kZXN0cm95KCk7XG4gICAgfTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHNlbmRSZXMocmVzOiBSZXNwb25zZSwgc3RhdHVzQ29kZTogbnVtYmVyLCBoZWFkZXJzOiBbc3RyaW5nLCBzdHJpbmcgfCBzdHJpbmdbXV1bXSwgYm9keTogQnVmZmVyIHwgc3RyZWFtLlJlYWRhYmxlKSB7XG4gIHJlcy5zdGF0dXMoc3RhdHVzQ29kZSk7XG4gIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBoZWFkZXJzKSB7XG4gICAgcmVzLnNldEhlYWRlcihuYW1lLCB2YWx1ZSk7XG4gIH1cbiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihib2R5KSlcbiAgICByZXMuZW5kKGJvZHkpO1xuICBlbHNlXG4gICAgc3RyZWFtLnBpcGVsaW5lKGJvZHksIHJlcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBrZXlPZlVyaShtZXRob2Q6IHN0cmluZywgdXJpOiBzdHJpbmcpIHtcbiAgY29uc3QgdXJsID0gbmV3IFVSTCgnaHR0cDovL2YuY29tJyArIHVyaSk7XG4gIGNvbnN0IGtleSA9IG1ldGhvZCArIHVybC5wYXRobmFtZSArICh1cmwuc2VhcmNoID8gJy8nICsgXy50cmltU3RhcnQodXJsLnNlYXJjaCwgJz8nKSA6ICcnKTtcbiAgcmV0dXJuIGtleTtcbn1cbiJdfQ==