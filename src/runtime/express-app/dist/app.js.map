{"version":3,"file":"app.js","sourceRoot":"","sources":["app.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Path from 'path';\nimport * as fs from 'fs';\nimport * as rx from 'rxjs';\nimport express, {Request, Response, Application} from 'express';\n// var favicon = require('serve-favicon');\nimport {logger, ExtensionContext, config} from '@wfh/plink';\nimport bodyParser from 'body-parser';\nimport {setupApi, applyPackageDefinedAppSetting, createPackageDefinedRouters} from './routes';\n\nconst cookieParser = require('cookie-parser');\nconst engines = require('consolidate');\nconst log = logger.getLogger('@wfh/express-app');\nconst compression = require('compression');\n// var swigInjectLoader = require('swig-package-tmpl-loader');\n\nconst VIEW_PATH = Path.relative(config().rootPath,\n  Path.resolve(__dirname, '..', 'views'));\nvar app: express.Express;\n\nconst expressAppReady$ = new rx.ReplaySubject<Application>(1);\n\nexport = {\n  activate(api: ExtensionContext) {\n    app = express();\n    setupApi(api, app);\n    api.eventBus!.on('packagesActivated', function() {\n      log.info('packagesActivated');\n      process.nextTick(() => {\n        create(app, config());\n        expressAppReady$.next(app);\n        expressAppReady$.complete();\n        api.eventBus!.emit('appCreated', app);\n      });\n    });\n  },\n  expressAppReady$,\n\n  set app(expressApp: express.Express) {\n    app = expressApp;\n  },\n  get app() {\n    return app;\n  }\n};\n\nfunction create(app: express.Express, setting: ReturnType<typeof config>) {\n  // view engine setup\n  // swig.setDefaults({\n  //   varControls: ['{=', '=}'],\n  //   cache: setting.devMode ? false : 'memory'\n  // });\n  // var injector = require('__injector');\n  // var translateHtml = require('@dr/translate-generator').htmlReplacer();\n  // swigInjectLoader.swigSetup(swig, {\n  // \tinjector: injector\n  // \t// fileContentHandler: function(file, source) {\n  // \t// \treturn translateHtml(source, file, api.config.get('locales[0]'));\n  // \t// }\n  // });\n\n  // engines.requires.swig = swig;\n  app.engine('html', engines.lodash);\n  // app.set('view cache', false);\n  // app.engine('jade', engines.jade);\n  app.set('trust proxy', true);\n  app.set('views', [setting.rootPath]);\n  app.set('view engine', 'html');\n  app.set('x-powered-by', false);\n  app.set('env', config().devMode ? 'development' : 'production');\n  applyPackageDefinedAppSetting(app);\n  // uncomment after placing your favicon in /public\n  // app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')));\n  // app.use(logger('dev'));\n  app.use(logger.connectLogger(log, {\n    level: 'DEBUG'\n  }));\n  app.use(bodyParser.json({\n    limit: '50mb'\n  }));\n  app.use(bodyParser.urlencoded({\n    extended: false,\n    limit: '50mb'\n  }));\n  app.use(bodyParser.raw({\n    limit: '50mb'\n  }));\n  app.use(bodyParser.text({\n    limit: '50mb'\n  }));\n  app.use(cookieParser());\n  app.use(compression());\n  // app.use((req, res, next) => {\n  //   if (req.url.startsWith('http://') || req.url.startsWith('https://')) {\n  //     // in case request HOST is a unknown name, most likely is proxied\n  //     req.url = new URL(req.url).pathname;\n  //     req.originalUrl = req.url;\n  //     log.warn('rewrite url to', req.url);\n  //   }\n  //   next();\n  // });\n\n  const nodeVer = process.version;\n  app.use((req, res, next) => {\n    res.setHeader('X-Nodejs', nodeVer);\n    next();\n  });\n  const hashFile = Path.join(config().rootPath, 'githash-server.txt');\n  if (fs.existsSync(hashFile)) {\n    const githash = fs.readFileSync(hashFile, 'utf8');\n    app.get('/githash-server', (req: Request, res: Response) => {\n      res.set('Content-Type', 'text/plain');\n      res.send(githash);\n    });\n    app.get('/githash-server.txt', (req: Request, res: Response) => {\n      res.set('Content-Type', 'text/plain');\n      res.send(githash);\n    });\n  }\n  createPackageDefinedRouters(app);\n  // error handlers\n  // catch 404 and forward to error handler\n  app.use(function(req, res) {\n    // log.info('Not Found: ' + req.originalUrl);\n    if (req.url.indexOf('/favicon/') >= 0) {\n      return res.status(404);\n    }\n    // const err = new Error('Not Found');\n    res.status(404);\n    // next(err);\n    log.info(`Not found: ${req.originalUrl}, ${req.url}, UA: \"${req.header('user-agent') as string}\"`);\n    res.render(Path.join(VIEW_PATH, '_drcp-express-error.html'), {\n      message: 'Sorry, page is not found',\n      error: null\n    });\n  });\n\n  // development error handler\n  // will print stacktrace\n  if (setting.devMode || app.get('env') === 'development') {\n    app.use(function(err: any, req: Request, res: Response) {\n      res.status((err ).status || 500);\n      log.error(req.originalUrl, ',', req.url, req.header('user-agent'), err.inspect ? err.inspect() : err);\n      res.render(Path.join(VIEW_PATH, '_drcp-express-error.html'), {\n        message: err.message,\n        error: err\n      });\n    });\n  }\n\n  // production error handler\n  // no stacktraces leaked to user\n  app.use(function(err: Error, req: Request, res: Response) {\n    res.status((err as any).status || 500);\n    log.error(req.originalUrl, err);\n    res.render(Path.join(VIEW_PATH, '_drcp-express-error.html'), {\n      message: err.message,\n      error: {}\n    });\n  });\n  return app;\n}\n"]}