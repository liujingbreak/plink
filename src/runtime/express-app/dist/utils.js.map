{"version":3,"file":"utils.js","sourceRoot":"","sources":["utils.ts"],"names":[],"mappings":"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","sourcesContent":["import {Writable} from 'stream';\nimport {Response} from 'express';\n\nexport function createBufferResponse(originRes: Response,\n  onFinish: (data: Buffer | string | any, send: () => void) => void): Response {\n\n  const bufs: (Buffer | string | any)[] = [];\n  const bufStream = new Writable({\n    write(chunk, encoding, cb) {\n      bufs.push(chunk);\n      cb();\n    },\n    final(cb) {\n      if (bufs.length > 0) {\n        let data = Buffer.isBuffer(bufs[0]) ? Buffer.concat(bufs as Buffer[]) :\n          typeof bufs[0] === 'string' ? (bufs as string[]).join('') : bufs;\n        if (Array.isArray(data) && data.length === 1) {\n          data = data[0];\n        }\n        onFinish(data, () => {\n          origEnd(data);\n        });\n      }\n    }\n  });\n\n  // const origWrite = originRes.write;\n  const origEnd: Response['end'] = originRes.end.bind(originRes);\n  const origOn = originRes.on;\n  const origOnce = originRes.once;\n  const origOff = originRes.off;\n\n  originRes.write = function(...args: any[]) {\n    return bufStream.write.apply(bufStream, args);\n  };\n\n  originRes.end = function(...args: any[]) {\n    return bufStream.end.apply(bufStream, args);\n  };\n\n  originRes.on = function(evt: string, ...args: any[]) {\n    if (evt === 'drain' || evt === 'finish') {\n      return bufStream.on.call(bufStream, evt, ...args);\n    } else {\n      return origOn.call(bufStream, evt, ...args);\n    }\n  };\n  originRes.once = function(evt: string, ...args: any[]) {\n    if (evt === 'drain' || evt === 'finish') {\n      return bufStream.once.call(bufStream, evt, ...args);\n    } else {\n      return origOnce.call(bufStream, evt, ...args);\n    }\n  };\n\n  originRes.once = function(evt: string, ...args: any[]) {\n    if (evt === 'drain' || evt === 'finish') {\n      return bufStream.off.call(bufStream, evt, ...args);\n    } else {\n      return origOff.call(bufStream, evt, ...args);\n    }\n  };\n\n  return originRes;\n}\n"]}