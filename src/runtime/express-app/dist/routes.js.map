{"version":3,"file":"routes.js","sourceRoot":"","sources":["routes.ts"],"names":[],"mappings":"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","sourcesContent":["import express, {Application} from 'express';\nimport {ExtensionContext, log4File} from '@wfh/plink';\nimport _ from 'lodash';\nimport Path from 'path';\nimport _cors from 'cors';\n\nlet log = log4File(__filename);\n// let swig = require('swig-templates');\n\ninterface RouterDefCallback {\n  (app: Application, exp: typeof express): void;\n  packageName?: string;\n  stack?: string;\n}\n\nlet routerSetupFuncs: RouterDefCallback[] = [];\n// let middlewares = [];\nlet appSets: RouterDefCallback[] = [];\n\n\nexport function createPackageDefinedRouters(app: Application) {\n  log.debug('createPackageDefinedRouters');\n  routerSetupFuncs.forEach(function(routerDef) {\n    try {\n      if (routerDef.packageName)\n        log.debug(routerDef.packageName, 'defines router/middleware');\n      else\n        log.debug(routerDef.stack);\n      routerDef(app, express);\n    } catch (er) {\n      log.error('package ' + routerDef.packageName + ' router', er);\n      throw er;\n    }\n  });\n}\n\nexport function applyPackageDefinedAppSetting(app: Application) {\n  log.debug('applyPackageDefinedAppSetting');\n  appSets.forEach(callback => {\n    log.debug(callback.stack);\n    callback(app, express);\n  });\n}\n\nexport function setupApi(api: ExtensionContext, app: Application) {\n  let apiPrototype = Object.getPrototypeOf(api) as ExtensionContext;\n  apiPrototype.express = express;\n  apiPrototype.expressApp = app;\n  // apiPrototype.swig = swig;\n\n  /**\n\t * setup a router under package context path\n\t * same as app.use('/<package-path>', router);\n\t * @return {[type]} [description]\n\t */\n  apiPrototype.router = function(this: typeof api) {\n    const self = this;\n    let calleePackageName = this.packageName;\n    if (self._router) {\n      return self._router;\n    }\n    let router = self._router = express.Router();\n    let contextPath = self.contextPath;\n\n    let packageRelPath = self.packageInstance.realPath;\n    if (Path.sep === '\\\\') {\n      packageRelPath = packageRelPath.replace(/\\\\/g, '/');\n    }\n    log.debug('package relative path: ' + packageRelPath);\n    packageRelPath += '/';\n    let oldRender: express.Response['render'];\n    function setupRouter(app: Application) {\n      app.use(contextPath, function(req, res, next) {\n        log.debug('In package', calleePackageName, self.packageName, 'middleware customized res.render');\n        if (!oldRender)\n          oldRender = Object.getPrototypeOf(res).render;\n        res.render = customizedRender;\n        next();\n      });\n      // log.debug(self.packageName + ': app.use context path = ' + contextPath);\n      app.use(contextPath, router);\n      app.use(contextPath, function(req, res, next) {\n        delete (res as any).render;\n        log.debug('Out package', calleePackageName, self.packageName, 'cleanup customized res.render');\n        next();\n      });\n      // If an error encountered in previous middlewares, we still need to cleanup render method\n      app.use(contextPath, function(err, req, res, next) {\n        log.warn('cleanup render() when encountering error in ', contextPath);\n        delete (res as any).render;\n        next(err);\n      } as express.ErrorRequestHandler);\n    }\n    setupRouter.packageName = self.packageName;\n    // this function will be\n    // cached in array and executed later.\n    // Thus save current stack for later debug.\n    setupRouter.stack = new Error().stack;\n    routerSetupFuncs.push(setupRouter);\n\n    function customizedRender(this: express.Response, ...args: [string, ...any[]]) {\n      // let args = ([] as any).slice.call(arguments);\n      if (args[0].endsWith('_drcp-express-error.html'))\n        return oldRender.apply(this, args);\n      else if (_.startsWith(args[0], '/')) {\n        args[0] = args[0].substring(1);\n      } else {\n        args[0] = packageRelPath + arguments[0];\n      }\n\n      return oldRender.apply(this, args);\n    }\n\n    return router;\n  };\n\n  /**\n\t * set an express middleware\n\t * same as calling `app.use('/optional-path', middleware)`\n\t * Middleware is always registered before routers getting registered, so each\n\t * request will pass through middleware prior to routers.\n\t */\n  ['use',\n  /**\n\t * same as calling `app.param('/optional-path', middleware)`\n\t */\n    'param'].forEach(function(method) {\n    apiPrototype[method] = function(_x: any) {\n      let args = [].slice.apply(arguments);\n      function setupMiddleware(app: Application) {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-call\n        app[method](...args);\n      }\n      setupMiddleware.packageName = this.packageName;\n      // this function will be\n      // cached in array and executed later, the current stack information\n      // won't be shown if there is error in later execution progress.\n      // Thus save current stack for later debug.\n      setupMiddleware.stack = new Error().stack;\n      routerSetupFuncs.push(setupMiddleware);\n    };\n  });\n\n  /**\n\t * Callback functions will be called after express app being created\n\t * @param  callback function(app, express)\n\t * e.g.\n\t * \tapi.expressAppSet((app, express) => {\n \t * \t\tapp.set('trust proxy', true);\n \t * \t\tapp.set('views', Path.resolve(api.config().rootPath, '../web/views/'));\n \t * \t});\n\t * @return void\n\t */\n  apiPrototype.expressAppSet = (callback) => {\n    appSets.push(callback);\n    (callback as RouterDefCallback).stack = new Error('info').stack;\n  };\n  apiPrototype.expressAppUse = (callback) => {\n    routerSetupFuncs.push(callback);\n    (callback as RouterDefCallback).stack = new Error('info').stack;\n  };\n  /**\n\t * e.g.\n\t * \tapi.router().options('/api', api.cors());\n\t * \tapi.router().get('/api', api.cors());\n\t * Or\n\t *  api.router().use('/api', api.cors());\n\t * @return void\n\t */\n  apiPrototype.cors = function(allowedOrigins?: string[]) {\n    const setting = api.config()['@wfh/express-app'];\n    let corsOpt = setting?.enableCORS;\n    const cors = require('cors') as typeof _cors;\n    const whiteOriginSet = new Set<string>();\n    if (_.isArray(corsOpt)) {\n      corsOpt.forEach(domain => whiteOriginSet.add(domain));\n    }\n    let corsOptions: _cors.CorsOptions;\n    if (allowedOrigins) {\n      corsOptions = {\n        origin: allowedOrigins,\n        credentials: true\n      };\n    } else {\n      corsOptions = {\n        // origin: ['http://localhost:14333'],\n        origin(origin: string, callback: (_arg: any, pass: boolean) => void) {\n          let pass = origin == null || corsOpt === true || whiteOriginSet.has(origin);\n          callback(pass ? null : {status: 400, message: 'Bad Request (CORS) for origin: ' + origin},\n            pass);\n          if (!pass)\n            log.info('CORS request blocked for origin: ' + origin);\n        },\n        credentials: true\n      };\n    }\n    return cors(corsOptions);\n  };\n}\n"]}