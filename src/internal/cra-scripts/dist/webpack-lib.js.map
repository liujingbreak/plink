{"version":3,"file":"webpack-lib.js","sourceRoot":"","sources":["webpack-lib.ts"],"names":[],"mappings":"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","sourcesContent":["// import {findPackage} from './build-target-helper';\n// import childProc from 'child_process';\nimport Path from 'path';\nimport {Worker} from 'worker_threads';\nimport {logger as log4js, findPackagesByNames, plinkEnv} from '@wfh/plink';\nimport chalk from 'chalk';\nimport {Configuration, Compiler, RuleSetRule, RuleSetUseItem, EntryObject} from 'webpack';\nimport _ from 'lodash';\nimport {getCmdOptions} from './utils';\nconst log = log4js.getLogger('@wfh/cra-scripts.webpack-lib');\n\n// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\nconst MiniCssExtractPlugin = require(Path.resolve('node_modules/mini-css-extract-plugin'));\n\nconst MODULE_NAME_PAT = /^((?:@[^\\\\/]+[\\\\/])?[^\\\\/]+)/;\n\nexport default function change(buildPackage: string, config: Configuration, nodePath: string[]) {\n  const foundPkg = [...findPackagesByNames([buildPackage])][0];\n  if (foundPkg == null) {\n    throw new Error(`Can not find package for name like ${buildPackage}`);\n  }\n  const {realPath: pkDir} = foundPkg;\n\n  if (Array.isArray(config.entry))\n    config.entry = config.entry.filter(item => !/[\\\\/]react-dev-utils[\\\\/]webpackHotDevClient/.test(item));\n\n  config.output!.path = Path.resolve(pkDir, 'build'); // Have to override it cuz' react-scripts assign `undefined` in non-production env\n  config.output!.filename = 'lib-bundle.js';\n  config.output!.libraryTarget = 'umd';\n  config.optimization!.runtimeChunk = false;\n  if (config.optimization && config.optimization.splitChunks) {\n    config.optimization.splitChunks = {\n      cacheGroups: {default: false}\n    };\n  }\n\n  // ---- Plugins filter ----\n\n  const InlineChunkHtmlPlugin = require(Path.resolve('node_modules/react-dev-utils/InlineChunkHtmlPlugin'));\n  // const InterpolateHtmlPlugin = require(Path.resolve('node_modules/react-dev-utils/InterpolateHtmlPlugin'));\n  const ForkTsCheckerWebpackPlugin = require(Path.resolve('node_modules/react-dev-utils/ForkTsCheckerWebpackPlugin'));\n  // const HtmlWebpackPlugin = require(Path.resolve('node_modules/html-webpack-plugin'));\n  const {HotModuleReplacementPlugin} = require(Path.resolve('node_modules/webpack'));\n\n  config.plugins = config.plugins!.filter(plugin => {\n\n    return [\n      MiniCssExtractPlugin,\n      ForkTsCheckerWebpackPlugin,\n      InlineChunkHtmlPlugin,\n      HotModuleReplacementPlugin\n      // HtmlWebpackPlugin,\n      // InterpolateHtmlPlugin\n    ].every(cls => !(plugin instanceof cls));\n  });\n\n  findAndChangeRule(config.module!.rules!);\n\n  const cmdOpts = getCmdOptions();\n  const externalRequestSet = new Set<string>();\n  const includeModuleRe = (cmdOpts.includes || [])\n    .map(mod => new RegExp(mod));\n  includeModuleRe.push(new RegExp(_.escapeRegExp(cmdOpts.buildTarget)));\n\n  if (config.externals == null) {\n    config.externals = [];\n  }\n\n  let entrySet: Set<string>;\n\n  (config.externals as Extract<Configuration['externals'], Array<any>>)\n    .push(\n      async ({context, request}, callback: (error?: any, result?: any) => void ) => {\n        if (request && includeModuleRe.some(rg => rg.test(request))) {\n          return callback();\n        }\n        if (entrySet == null && config.entry)\n          entrySet = await createEntrySet(config.entry);\n\n        if (request && (!request.startsWith('.') && !entrySet.has(request) &&\n          !/[?!]/.test(request)) // && (!/(?:^|[\\\\/])@babel[\\\\/]runtime[\\\\/]/.test(request))\n        ) {\n          if (Path.isAbsolute(request)) {\n            log.info('request absolute path:', request);\n            return callback();\n          } else {\n            log.debug('external request:', request, `(${context ?? ''})`);\n            externalRequestSet.add(request);\n            return callback(null, request);\n          }\n        }\n        callback();\n      }\n    );\n\n  config.plugins.push(\n    // new EsmWebpackPlugin(),\n    new (class {\n      forkDone: Promise<any> = Promise.resolve();\n\n      apply(compiler: Compiler) {\n        compiler.hooks.done.tap('cra-scripts', stats => {\n          this.forkDone = this.forkDone.then(() => forkTsc());\n          const externalDeps: Set<string> = new Set<string>();\n          const workspaceNodeDir = plinkEnv.workDir + Path.sep + 'node_modules' + Path.sep;\n          for (const req of externalRequestSet.values()) {\n            if (Path.isAbsolute(req) && Path.resolve(req).startsWith(workspaceNodeDir)) {\n              const m = MODULE_NAME_PAT.exec(req.slice(workspaceNodeDir.length));\n              externalDeps.add(m ? m[1] : req.slice(workspaceNodeDir.length));\n            } else {\n              const m = MODULE_NAME_PAT.exec(req);\n              externalDeps.add(m ? m[1] : req);\n            }\n          }\n          log.warn(chalk.red('external dependencies:\\n  ' + [...externalDeps.values()].join(', ')));\n        });\n      }\n    })()\n  );\n}\n\ntype EntryDescription = EntryObject extends {[index: string]: infer V} ? Exclude<V, string | string[]> : unknown;\n\nasync function createEntrySet(configEntry: NonNullable<Configuration['entry'] | EntryDescription>, entrySet?: Set<string>) {\n  if (entrySet == null)\n    entrySet = new Set<string>();\n\n  if (Array.isArray(configEntry)) {\n    for (const entry of configEntry) {\n      entrySet.add(entry);\n    }\n  } else if (typeof configEntry === 'string') {\n    entrySet.add(configEntry);\n  } else if (typeof configEntry === 'function') {\n    await Promise.resolve(configEntry()).then(entries => createEntrySet(entries));\n  } else if (typeof configEntry === 'object') {\n    if (configEntry.import) {\n      await createEntrySet(configEntry.import);\n    } else {\n      await Promise.all(Object.entries(configEntry).map(([_key, value]) => {\n        return createEntrySet(value);\n      }));\n    }\n  }\n  return entrySet;\n}\n\ntype RuleSetUseItemObj = Exclude<RuleSetUseItem, string | ((...a: any[]) => any)>;\n\nfunction findAndChangeRule(rules: NonNullable<NonNullable<Configuration['module']>['rules']> | RuleSetUseItem[]): void {\n  // TODO: check in case CRA will use Rule.use instead of \"loader\"\n  if (!Array.isArray(rules))\n    return;\n  checkSet(rules);\n  for (const rule of rules) {\n    if (typeof rule === 'string')\n      continue;\n    if (Array.isArray((rule as RuleSetRule).use)) {\n      checkSet((rule as RuleSetRule).use as RuleSetUseItem[]);\n    } else if ((rule as RuleSetRule).oneOf) {\n      return findAndChangeRule((rule as RuleSetRule).oneOf!);\n    }\n  }\n\n  function checkSet(set: RuleSetUseItem[]) {\n    const found = set.findIndex(\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access,@typescript-eslint/no-unsafe-call\n      use => (use as RuleSetUseItemObj).loader && (use as RuleSetUseItemObj).loader!.indexOf(MiniCssExtractPlugin.loader) >= 0);\n    // const found = rule.use.findIndex(use => (use as any).loader && (use as any).loader.indexOf('mini-css-extract-plugin') >= 0);\n    if (found >= 0) {\n      set.splice(found, 1);\n      set.unshift(require.resolve('style-loader'));\n    }\n  }\n  return;\n}\n\nasync function forkTsc() {\n  const worker = new Worker(require.resolve('./tsd-generate-thread'), {execArgv: ['--preserve-symlinks-main', '--preserve-symlinks']});\n  log.warn('forkTsc, threadId:', worker.threadId);\n  await new Promise<void>((resolve, rej) => {\n    worker.on('exit', code => {\n      if (code !== 0) {\n        rej(new Error(`Worker stopped with exit code ${code}`));\n      } else {\n        resolve();\n      }\n      worker.off('message', rej);\n      worker.off('error', rej);\n    });\n    worker.on('message', rej);\n    worker.on('error', rej);\n  });\n}\n"]}