"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.changeTsConfigFile = void 0;
const misc_1 = require("@wfh/plink/wfh/dist/utils/misc");
const package_mgr_1 = require("@wfh/plink/wfh/dist/package-mgr");
const plink_1 = require("@wfh/plink");
const typescript_1 = __importDefault(require("typescript"));
const utils_1 = require("./utils");
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
// const log = log4File(__filename);
function changeTsConfigFile() {
    // const craOptions = getCmdOptions();
    const plinkRoot = (0, plink_1.getRootDir)();
    const rootDir = (0, misc_1.closestCommonParentDir)(Array.from((0, package_mgr_1.getState)().project2Packages.keys()).map(prjDir => path_1.default.resolve(plinkRoot, prjDir))).replace(/\\/g, '/');
    const tsconfigJson = typescript_1.default.readConfigFile(process.env._plink_cra_scripts_tsConfig, (file) => fs_1.default.readFileSync(file, 'utf-8')).config;
    // JSON.parse(fs.readFileSync(process.env._plink_cra_scripts_tsConfig!, 'utf8'));
    const tsconfigDir = path_1.default.dirname(process.env._plink_cra_scripts_tsConfig);
    // CRA does not allow we configure "compilerOptions.paths" in _plink_cra_scripts_tsConfig
    // (see create-react-app/packages/react-scripts/scripts/utils/verifyTypeScriptSetup.js)
    // therefore, initial paths is always empty.
    const pathMapping = tsconfigJson.compilerOptions.paths = {};
    // if (tsconfigJson.compilerOptions && tsconfigJson.compilerOptions.paths) {
    //   Object.assign(pathMapping, tsconfigJson.compilerOptions.paths);
    // }
    if (tsconfigJson.compilerOptions.baseUrl == null) {
        tsconfigJson.compilerOptions.baseUrl = './';
    }
    for (const [name, { realPath }] of (0, package_mgr_1.getState)().srcPackages.entries() || []) {
        const realDir = path_1.default.relative(tsconfigDir, realPath).replace(/\\/g, '/');
        pathMapping[name] = [realDir];
        pathMapping[name + '/*'] = [realDir + '/*'];
    }
    if ((0, package_mgr_1.getState)().linkedDrcp) {
        const drcpDir = path_1.default.relative(tsconfigDir, (0, package_mgr_1.getState)().linkedDrcp.realPath).replace(/\\/g, '/');
        pathMapping['@wfh/plink'] = [drcpDir];
        pathMapping['@wfh/plink/*'] = [drcpDir + '/*'];
    }
    tsconfigJson.compilerOptions.paths = pathMapping;
    (0, plink_1.setTsCompilerOptForNodePath)(tsconfigDir, './', tsconfigJson.compilerOptions, {
        workspaceDir: plink_1.plinkEnv.workDir || process.cwd()
    });
    (0, utils_1.runTsConfigHandlers)(tsconfigJson.compilerOptions);
    tsconfigJson.include = [path_1.default.relative(plink_1.plinkEnv.workDir || process.cwd(), process.env._plink_cra_scripts_indexJs)];
    tsconfigJson.compilerOptions.rootDir = rootDir;
    const co = typescript_1.default.parseJsonConfigFileContent(tsconfigJson, typescript_1.default.sys, plink_1.plinkEnv.workDir.replace(/\\/g, '/'), undefined, process.env._plink_cra_scripts_tsConfig).options;
    void fs_1.default.promises.writeFile(path_1.default.resolve((0, utils_1.getReportDir)(), 'tsconfig.json'), JSON.stringify(tsconfigJson, null, '  '));
    return co;
}
exports.changeTsConfigFile = changeTsConfigFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlLXRzY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hhbmdlLXRzY29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHlEQUFzRTtBQUN0RSxpRUFBeUQ7QUFDekQsc0NBQTJGO0FBQzNGLDREQUE0QjtBQUM1QixtQ0FBMEQ7QUFDMUQsZ0RBQXdCO0FBQ3hCLDRDQUFvQjtBQUNwQixvQ0FBb0M7QUFFcEMsU0FBZ0Isa0JBQWtCO0lBQ2hDLHNDQUFzQztJQUN0QyxNQUFNLFNBQVMsR0FBRyxJQUFBLGtCQUFVLEdBQUUsQ0FBQztJQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFBLDZCQUFzQixFQUFDLEtBQUssQ0FBQyxJQUFJLENBQy9DLElBQUEsc0JBQVEsR0FBRSxDQUFDLGdCQUFnQixDQUFpekcsSUFBSSxFQUFFLENBQ2oxRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLGNBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBRXhFLE1BQU0sWUFBWSxHQUNoQixvQkFBRSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUE0QixFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxZQUFFLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUM3RyxpRkFBaUY7SUFDbkYsTUFBTSxXQUFXLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUE0QixDQUFDLENBQUM7SUFFM0UseUZBQXlGO0lBQ3pGLHVGQUF1RjtJQUN2Riw0Q0FBNEM7SUFDNUMsTUFBTSxXQUFXLEdBQThCLFlBQVksQ0FBQyxlQUFlLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUN2Riw0RUFBNEU7SUFDNUUsb0VBQW9FO0lBQ3BFLElBQUk7SUFFSixJQUFJLFlBQVksQ0FBQyxlQUFlLENBQUMsT0FBTyxJQUFJLElBQUksRUFBRTtRQUNoRCxZQUFZLENBQUMsZUFBZSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7S0FDN0M7SUFDRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBQyxRQUFRLEVBQUMsQ0FBQyxJQUFJLElBQUEsc0JBQVEsR0FBRSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUU7UUFDdkUsTUFBTSxPQUFPLEdBQUcsY0FBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUN6RSxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QixXQUFXLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDO0tBQzdDO0lBRUQsSUFBSSxJQUFBLHNCQUFRLEdBQUUsQ0FBQyxVQUFVLEVBQUU7UUFDekIsTUFBTSxPQUFPLEdBQUcsY0FBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsSUFBQSxzQkFBUSxHQUFFLENBQUMsVUFBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDaEcsV0FBVyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDO0tBQ2hEO0lBQ0QsWUFBWSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDO0lBRWpELElBQUEsbUNBQTJCLEVBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxZQUFZLENBQUMsZUFBZSxFQUFFO1FBQzNFLFlBQVksRUFBRSxnQkFBUSxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFO0tBQ2hELENBQUMsQ0FBQztJQUNILElBQUEsMkJBQW1CLEVBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBRWxELFlBQVksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxjQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFRLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEyQixDQUFDLENBQUMsQ0FBQztJQUNuSCxZQUFZLENBQUMsZUFBZSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDL0MsTUFBTSxFQUFFLEdBQUcsb0JBQUUsQ0FBQywwQkFBMEIsQ0FBQyxZQUFZLEVBQUUsb0JBQUUsQ0FBQyxHQUFHLEVBQUUsZ0JBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFDakcsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxPQUFPLENBQUM7SUFFOUQsS0FBSyxZQUFFLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFJLENBQUMsT0FBTyxDQUFDLElBQUEsb0JBQVksR0FBRSxFQUFFLGVBQWUsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3BILE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQztBQWhERCxnREFnREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2Nsb3Nlc3RDb21tb25QYXJlbnREaXJ9IGZyb20gJ0B3ZmgvcGxpbmsvd2ZoL2Rpc3QvdXRpbHMvbWlzYyc7XG5pbXBvcnQge2dldFN0YXRlfSBmcm9tICdAd2ZoL3BsaW5rL3dmaC9kaXN0L3BhY2thZ2UtbWdyJztcbmltcG9ydCB7Z2V0Um9vdERpciwgc2V0VHNDb21waWxlck9wdEZvck5vZGVQYXRoLCBwbGlua0Vudi8qLCBsb2c0RmlsZSovfSBmcm9tICdAd2ZoL3BsaW5rJztcbmltcG9ydCB0cyBmcm9tICd0eXBlc2NyaXB0JztcbmltcG9ydCB7cnVuVHNDb25maWdIYW5kbGVycywgZ2V0UmVwb3J0RGlyfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbi8vIGNvbnN0IGxvZyA9IGxvZzRGaWxlKF9fZmlsZW5hbWUpO1xuXG5leHBvcnQgZnVuY3Rpb24gY2hhbmdlVHNDb25maWdGaWxlKCkge1xuICAvLyBjb25zdCBjcmFPcHRpb25zID0gZ2V0Q21kT3B0aW9ucygpO1xuICBjb25zdCBwbGlua1Jvb3QgPSBnZXRSb290RGlyKCk7XG4gIGNvbnN0IHJvb3REaXIgPSBjbG9zZXN0Q29tbW9uUGFyZW50RGlyKEFycmF5LmZyb20oXG4gICAgZ2V0U3RhdGUoKS5wcm9qZWN0MlBhY2thZ2VzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5rZXlzKClcbiAgICApLm1hcChwcmpEaXIgPT4gUGF0aC5yZXNvbHZlKHBsaW5rUm9vdCwgcHJqRGlyKSkpLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcblxuICBjb25zdCB0c2NvbmZpZ0pzb246IHtjb21waWxlck9wdGlvbnM6IGFueSwgaW5jbHVkZT86IHN0cmluZ1tdfSA9XG4gICAgdHMucmVhZENvbmZpZ0ZpbGUocHJvY2Vzcy5lbnYuX3BsaW5rX2NyYV9zY3JpcHRzX3RzQ29uZmlnISwgKGZpbGUpID0+IGZzLnJlYWRGaWxlU3luYyhmaWxlLCAndXRmLTgnKSkuY29uZmlnO1xuICAgIC8vIEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHByb2Nlc3MuZW52Ll9wbGlua19jcmFfc2NyaXB0c190c0NvbmZpZyEsICd1dGY4JykpO1xuICBjb25zdCB0c2NvbmZpZ0RpciA9IFBhdGguZGlybmFtZShwcm9jZXNzLmVudi5fcGxpbmtfY3JhX3NjcmlwdHNfdHNDb25maWchKTtcblxuICAvLyBDUkEgZG9lcyBub3QgYWxsb3cgd2UgY29uZmlndXJlIFwiY29tcGlsZXJPcHRpb25zLnBhdGhzXCIgaW4gX3BsaW5rX2NyYV9zY3JpcHRzX3RzQ29uZmlnXG4gIC8vIChzZWUgY3JlYXRlLXJlYWN0LWFwcC9wYWNrYWdlcy9yZWFjdC1zY3JpcHRzL3NjcmlwdHMvdXRpbHMvdmVyaWZ5VHlwZVNjcmlwdFNldHVwLmpzKVxuICAvLyB0aGVyZWZvcmUsIGluaXRpYWwgcGF0aHMgaXMgYWx3YXlzIGVtcHR5LlxuICBjb25zdCBwYXRoTWFwcGluZzoge1trZXk6IHN0cmluZ106IHN0cmluZ1tdfSA9IHRzY29uZmlnSnNvbi5jb21waWxlck9wdGlvbnMucGF0aHMgPSB7fTtcbiAgLy8gaWYgKHRzY29uZmlnSnNvbi5jb21waWxlck9wdGlvbnMgJiYgdHNjb25maWdKc29uLmNvbXBpbGVyT3B0aW9ucy5wYXRocykge1xuICAvLyAgIE9iamVjdC5hc3NpZ24ocGF0aE1hcHBpbmcsIHRzY29uZmlnSnNvbi5jb21waWxlck9wdGlvbnMucGF0aHMpO1xuICAvLyB9XG5cbiAgaWYgKHRzY29uZmlnSnNvbi5jb21waWxlck9wdGlvbnMuYmFzZVVybCA9PSBudWxsKSB7XG4gICAgdHNjb25maWdKc29uLmNvbXBpbGVyT3B0aW9ucy5iYXNlVXJsID0gJy4vJztcbiAgfVxuICBmb3IgKGNvbnN0IFtuYW1lLCB7cmVhbFBhdGh9XSBvZiBnZXRTdGF0ZSgpLnNyY1BhY2thZ2VzLmVudHJpZXMoKSB8fCBbXSkge1xuICAgIGNvbnN0IHJlYWxEaXIgPSBQYXRoLnJlbGF0aXZlKHRzY29uZmlnRGlyLCByZWFsUGF0aCkucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuICAgIHBhdGhNYXBwaW5nW25hbWVdID0gW3JlYWxEaXJdO1xuICAgIHBhdGhNYXBwaW5nW25hbWUgKyAnLyonXSA9IFtyZWFsRGlyICsgJy8qJ107XG4gIH1cblxuICBpZiAoZ2V0U3RhdGUoKS5saW5rZWREcmNwKSB7XG4gICAgY29uc3QgZHJjcERpciA9IFBhdGgucmVsYXRpdmUodHNjb25maWdEaXIsIGdldFN0YXRlKCkubGlua2VkRHJjcCEucmVhbFBhdGgpLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcbiAgICBwYXRoTWFwcGluZ1snQHdmaC9wbGluayddID0gW2RyY3BEaXJdO1xuICAgIHBhdGhNYXBwaW5nWydAd2ZoL3BsaW5rLyonXSA9IFtkcmNwRGlyICsgJy8qJ107XG4gIH1cbiAgdHNjb25maWdKc29uLmNvbXBpbGVyT3B0aW9ucy5wYXRocyA9IHBhdGhNYXBwaW5nO1xuXG4gIHNldFRzQ29tcGlsZXJPcHRGb3JOb2RlUGF0aCh0c2NvbmZpZ0RpciwgJy4vJywgdHNjb25maWdKc29uLmNvbXBpbGVyT3B0aW9ucywge1xuICAgIHdvcmtzcGFjZURpcjogcGxpbmtFbnYud29ya0RpciB8fCBwcm9jZXNzLmN3ZCgpXG4gIH0pO1xuICBydW5Uc0NvbmZpZ0hhbmRsZXJzKHRzY29uZmlnSnNvbi5jb21waWxlck9wdGlvbnMpO1xuXG4gIHRzY29uZmlnSnNvbi5pbmNsdWRlID0gW1BhdGgucmVsYXRpdmUocGxpbmtFbnYud29ya0RpciB8fCBwcm9jZXNzLmN3ZCgpLCBwcm9jZXNzLmVudi5fcGxpbmtfY3JhX3NjcmlwdHNfaW5kZXhKcyEpXTtcbiAgdHNjb25maWdKc29uLmNvbXBpbGVyT3B0aW9ucy5yb290RGlyID0gcm9vdERpcjtcbiAgY29uc3QgY28gPSB0cy5wYXJzZUpzb25Db25maWdGaWxlQ29udGVudCh0c2NvbmZpZ0pzb24sIHRzLnN5cywgcGxpbmtFbnYud29ya0Rpci5yZXBsYWNlKC9cXFxcL2csICcvJyksXG4gICAgdW5kZWZpbmVkLCBwcm9jZXNzLmVudi5fcGxpbmtfY3JhX3NjcmlwdHNfdHNDb25maWcpLm9wdGlvbnM7XG5cbiAgdm9pZCBmcy5wcm9taXNlcy53cml0ZUZpbGUoUGF0aC5yZXNvbHZlKGdldFJlcG9ydERpcigpLCAndHNjb25maWcuanNvbicpLCBKU09OLnN0cmluZ2lmeSh0c2NvbmZpZ0pzb24sIG51bGwsICcgICcpKTtcbiAgcmV0dXJuIGNvO1xufVxuIl19