<<<<<<< HEAD
{"version":3,"file":"test-func.js","sourceRoot":"","sources":["test-func.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable no-console */\nimport {fork} from 'node:child_process';\nimport Path from 'node:path';\nimport * as op from 'rxjs/operators';\nimport {plinkEnv} from '@wfh/plink';\nimport {createClient} from '@wfh/tool-misc/dist/http-cache-server/cache-service-client';\n\nexport async function testStore() {\n  const mainProc = fork(Path.join(plinkEnv.workDir, 'node_modules/@wfh/tool-misc/dist/__tests__/http-cache-server/service-main-process'));\n\n  const mainProcExited = new Promise<number | null>(resolve => {\n    mainProc.once('exit', (code, sig) => {\n      resolve(code);\n    });\n  });\n\n  const client = createClient();\n\n  client.dispatcher.ping('test');\n  await client.serverReplied('ping', payload => payload === 'test');\n  const keyChanged = client.actionOfType('onChange').pipe(\n    op.filter(({payload: [key]}) => key === 'test-key'),\n    op.map(({payload: [key, value]}) => {\n      // eslint-disable-next-line no-console\n      console.log(`key ${key} is changed: ${value as string}`);\n      return value as unknown;\n    }),\n    op.takeWhile(value => value !== 1)\n  ).toPromise();\n\n  client.dispatcher.subscribeKey('test-key');\n  client.dispatcher.subscribeKey('test-key2');\n\n  await new Promise(resolve => setTimeout(resolve, 500));\n\n  client.dispatcher.setForNonexist('test-key', 1);\n  await client.serverReplied('setForNonexist', ([key, value]) => key === 'test-key' && value === 1);\n  await keyChanged;\n  console.log('test-key is changed for sure');\n\n  await new Promise(resolve => setTimeout(resolve, 2500));\n\n  const keyChangedAgain = client.actionOfType('onChange').pipe(\n    op.filter(({payload: [key, value]}) => key === 'test-key2'),\n    // op.skip(1),\n    op.map(({payload: [key, value]}) => {\n      // eslint-disable-next-line no-console\n      console.log(`2nd key ${key} is changed: ${value as string}`);\n      return value as unknown;\n    }),\n    op.takeWhile(value => value !== 2)\n  ).toPromise();\n\n  client.dispatcher.setForNonexist('test-key2', 2);\n  await keyChangedAgain;\n\n  client.dispatcher.shutdownServer();\n  await client.serverReplied('shutdownServer', () => true);\n  // childProcess.kill('SIGINT');\n  await mainProcExited;\n  console.log('Store server process exits');\n}\n"]}
=======
{"version":3,"file":"test-func.js","sourceRoot":"","sources":["test-func.ts"],"names":[],"mappings":"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","sourcesContent":["import {fork} from 'node:child_process';\nimport Path from 'node:path';\nimport * as op from 'rxjs/operators';\nimport {plinkEnv} from '@wfh/plink';\nimport {createClient} from '@wfh/tool-misc/dist/http-cache-server/cache-service-client';\n\nexport async function testStore() {\n  const mainProc = fork(Path.join(plinkEnv.workDir, 'node_modules/@wfh/tool-misc/dist/__tests__/http-cache-server/service-main-process'));\n\n  const mainProcExited = new Promise<number | null>(resolve => {\n    mainProc.once('exit', (code, sig) => {\n      resolve(code);\n    });\n  });\n\n  const client = createClient();\n  const cp2 = fork(Path.resolve(__dirname, 'service-client-2.js'));\n  const clientProcess2Exited = new Promise<number | null>(resolve => {\n    cp2.on('exit', (code, sig) => {\n      console.log('2nd CLIENT EXITED');\n      resolve(code);\n    });\n  });\n\n  client.dispatcher.ping('test');\n  await client.serverReplied('ping', payload => payload === 'test');\n  const keyChanged = client.actionOfType('onChange').pipe(\n    op.map(({payload: [key, value]}) => {\n      // eslint-disable-next-line no-console\n      console.log(`key ${key} is changed: ${value as string}`);\n    }),\n    op.take(1)\n  ).toPromise();\n\n  client.dispatcher.subscribeKey('test-key');\n  client.dispatcher.subscribeKey('test-key2');\n\n  await new Promise(resolve => setTimeout(resolve, 500));\n\n  client.dispatcher.setForNonexist('test-key', 1);\n  await client.serverReplied('setForNonexist', ([key, value]) => key === 'test-key' && value === 1);\n  await keyChanged;\n\n  await new Promise(resolve => setTimeout(resolve, 2500));\n\n  const keyChangedAgain = client.actionOfType('onChange').pipe(\n    op.filter(({payload: [key, value]}) => key === 'test-key2'),\n    op.map(({payload: [key, value]}) => {\n      // eslint-disable-next-line no-console\n      console.log(`key ${key} is changed: ${value as string}`);\n    }),\n    op.take(1)\n  ).toPromise();\n\n  client.dispatcher.setForNonexist('test-key2', 2);\n  await keyChangedAgain;\n\n  client.dispatcher.shutdownServer();\n  await client.serverReplied('shutdownServer', () => true);\n  // childProcess.kill('SIGINT');\n  return Promise.all([clientProcess2Exited, mainProcExited]);\n}\n"]}
>>>>>>> f8c1fbeb... wip
