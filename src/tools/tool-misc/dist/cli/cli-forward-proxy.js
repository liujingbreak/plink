"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.start = void 0;
/* eslint-disable no-console */
const net_1 = __importDefault(require("net"));
const rx = __importStar(require("rxjs"));
const op = __importStar(require("rxjs/operators"));
const plink_1 = require("@wfh/plink");
// import inspector from 'inspector';
// inspector.open(9222, 'localhost', true);
const log = (0, plink_1.log4File)(__filename);
function start(port, hostMap = new Map(), opts) {
    const server = net_1.default.createServer();
    const actions = {
        proxyToProxy(_remoteHost, _remotePort, _socket, _firstPacket) { },
        proxyToRemote(_remoteHost, _remotePort, _socket, _firstPacket, _isTsl, httpProtocal) { },
        remoteSocketConnected(_socket, msg) { }
    };
    const dispatch = {};
    const action$ = new rx.Subject();
    const ofType = (type) => {
        return (input) => {
            return input.pipe(op.filter(action => action.type === type));
        };
    };
    for (const [key] of Object.entries(actions)) {
        dispatch[key] = (...params) => {
            const action = {
                type: key,
                // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
                payload: params.length === 0 ? params[0] : params
            };
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            action$.next(action);
        };
    }
    rx.merge(rx.fromEvent(server, 'connection').pipe(op.mergeMap((clientToProxySocket) => {
        log.debug('Client Connected To Proxy', clientToProxySocket.remoteAddress +
            ':' + clientToProxySocket.remotePort);
        return rx.fromEvent(clientToProxySocket, 'data').pipe(op.map(data => ({ clientToProxySocket, data })), op.take(1));
    }), op.map(({ clientToProxySocket, data }) => {
        const greeting = data.toString();
        log.info(greeting);
        let isTLSConnection = greeting.indexOf('CONNECT') !== -1;
        // Considering Port as 80 by default 
        let serverPort = 80;
        let serverAddress = '';
        let protocal = 'HTTP/1.1';
        if (isTLSConnection) {
            const match = /CONNECT +([^\s:]+)(?::(\S+))?(?: +(\S+))?/.exec(greeting);
            // Port changed to 443, parsing the host from CONNECT 
            serverPort = match[2] ? parseInt(match[2], 10) : 443;
            serverAddress = match[1];
            if (match[3])
                protocal = match[3];
        }
        else {
            // Parsing HOST from HTTP
            const match = /Host: +([^\s:]+)(?::(\S+))?/.exec(greeting);
            if (match != null) {
                serverAddress = match[1];
                serverPort = match[2] ? parseInt(match[2], 10) : 80;
            }
        }
        // log.info('proxy to:', serverAddress + ':' + serverPort);
        if (serverAddress && hostMap.has(serverAddress)) {
            let splitted = hostMap.get(serverAddress).split(':');
            serverAddress = splitted[0];
            if (splitted[1])
                serverPort = parseInt(splitted[1], 10);
            dispatch.proxyToRemote(serverAddress, serverPort, clientToProxySocket, data, isTLSConnection, protocal);
        }
        else if (opts === null || opts === void 0 ? void 0 : opts.fallbackProxyHost) {
            dispatch.proxyToProxy(opts.fallbackProxyHost, opts.fallbackproxyPort, clientToProxySocket, data);
        }
        else if (serverAddress) {
            dispatch.proxyToRemote(serverAddress, serverPort, clientToProxySocket, data, isTLSConnection, protocal);
        }
        else {
            throw new Error(`unknown server address for ${greeting}`);
        }
    })), action$.pipe(ofType('proxyToProxy'), op.map(({ payload: [host, port, clientToProxySocket, data] }) => {
        let proxyToServerSocket = net_1.default.connect({
            host, port
        }, () => {
            log.info('PROXY TO FORBACK proxy connection created', host, ':', port);
            const connected = proxyToServerSocket.pipe(clientToProxySocket);
            dispatch.remoteSocketConnected(connected, 'Remote proxy reading');
            proxyToServerSocket.write(data);
            // Piping the sockets
            clientToProxySocket.pipe(proxyToServerSocket);
        });
        dispatch.remoteSocketConnected(proxyToServerSocket, 'remote proxy server connection');
    })), action$.pipe(ofType('proxyToRemote'), op.map(({ payload: [host, port, clientToProxySocket, data, isTLSConnection, protocal] }) => {
        let proxyToServerSocket = net_1.default.connect({ host, port }, () => {
            log.info('PROXY TO SERVER connection created', host, ':', port);
            const socket = proxyToServerSocket.pipe(clientToProxySocket);
            dispatch.remoteSocketConnected(socket, 'remote server reading');
            // .on('error', err => {
            //   log.error('proxy to remote server read error', err);
            // });
            if (isTLSConnection) {
                // Send Back OK to HTTPS CONNECT Request
                clientToProxySocket.write(protocal + ' 200 OK\r\n\n');
            }
            else {
                proxyToServerSocket.write(data);
            }
            // Piping the sockets
            clientToProxySocket.pipe(proxyToServerSocket);
        });
        dispatch.remoteSocketConnected(proxyToServerSocket, 'remote server connection');
    })), action$.pipe(ofType('remoteSocketConnected'), op.map(({ payload: [proxyToServerSocket, msg] }) => {
        proxyToServerSocket.on('error', (err) => {
            log.error('PROXY TO SERVER ERROR', msg, proxyToServerSocket.remoteAddress, ':', proxyToServerSocket.remotePort, err);
        });
        proxyToServerSocket.on('lookup', (err, addr, _fam, host) => {
            if (err)
                log.warn('lookup error', err);
        });
        proxyToServerSocket.on('timeout', () => {
            log.warn('PROXY TO SERVER timeout', proxyToServerSocket.remoteAddress, ':', proxyToServerSocket.remotePort);
        });
    }))).pipe(op.catchError((err, src) => {
        log.error('Fatal error', err);
        return src;
    })).subscribe();
    server.on('error', (err) => {
        log.info('SERVER ERROR');
        log.info(err);
    });
    server.on('close', () => {
        log.info('Client Disconnected');
    });
    server.listen(port, () => {
        log.info(`Server runnig at http://${(0, plink_1.config)().localIP}:` + port);
    });
    return () => {
        server.close();
    };
}
exports.start = start;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLWZvcndhcmQtcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjbGktZm9yd2FyZC1wcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBQy9CLDhDQUFnQztBQUNoQyx5Q0FBMkI7QUFDM0IsbURBQXFDO0FBQ3JDLHNDQUE0QztBQUM1QyxxQ0FBcUM7QUFFckMsMkNBQTJDO0FBQzNDLE1BQU0sR0FBRyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxVQUFVLENBQUMsQ0FBQztBQUVqQyxTQUFnQixLQUFLLENBQUMsSUFBWSxFQUFFLFVBQStCLElBQUksR0FBRyxFQUFFLEVBQzFFLElBSUM7SUFDRCxNQUFNLE1BQU0sR0FBRyxhQUFHLENBQUMsWUFBWSxFQUFFLENBQUM7SUFFbEMsTUFBTSxPQUFPLEdBQUc7UUFDZCxZQUFZLENBQUMsV0FBbUIsRUFBRSxXQUFtQixFQUFFLE9BQWUsRUFBRSxZQUFvQixJQUFHLENBQUM7UUFDaEcsYUFBYSxDQUFDLFdBQW1CLEVBQUUsV0FBbUIsRUFDcEQsT0FBZSxFQUFFLFlBQW9CLEVBQUUsTUFBZSxFQUFFLFlBQW9CLElBQUcsQ0FBQztRQUNsRixxQkFBcUIsQ0FBQyxPQUFlLEVBQUUsR0FBVyxJQUFHLENBQUM7S0FDdkQsQ0FBQztJQVFGLE1BQU0sUUFBUSxHQUFHLEVBR2hCLENBQUM7SUFFRixNQUFNLE9BQU8sR0FBRyxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQW9DLENBQUM7SUFDbkUsTUFBTSxNQUFNLEdBQUcsQ0FBaUMsSUFBTyxFQUFFLEVBQUU7UUFDekQsT0FBTyxDQUFDLEtBQXNELEVBQWdDLEVBQUU7WUFDOUYsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUNmLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxDQUNWLENBQUM7UUFDcEMsQ0FBQyxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUYsS0FBSyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUMzQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQWEsRUFBRSxFQUFFO1lBQ25DLE1BQU0sTUFBTSxHQUFHO2dCQUNiLElBQUksRUFBRSxHQUEyQjtnQkFDakMsbUVBQW1FO2dCQUNuRSxPQUFPLEVBQUUsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTTthQUNsRCxDQUFDO1lBQ0YsaUVBQWlFO1lBQ2pFLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBYSxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDO0tBQ0g7SUFFRCxFQUFFLENBQUMsS0FBSyxDQUNOLEVBQUUsQ0FBQyxTQUFTLENBQVMsTUFBTSxFQUFFLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDN0MsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLEVBQUU7UUFDbEMsR0FBRyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsRUFBRSxtQkFBbUIsQ0FBQyxhQUFhO1lBQ3RFLEdBQUcsR0FBRyxtQkFBbUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN4QyxPQUFPLEVBQUUsQ0FBQyxTQUFTLENBQVMsbUJBQW1CLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUMzRCxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFDLG1CQUFtQixFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsRUFDN0MsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDWCxDQUFDO0lBQ0osQ0FBQyxDQUFDLEVBQ0YsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUMsbUJBQW1CLEVBQUUsSUFBSSxFQUFDLEVBQUUsRUFBRTtRQUNyQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQixJQUFJLGVBQWUsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXpELHFDQUFxQztRQUNyQyxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQUksUUFBUSxHQUFHLFVBQVUsQ0FBQztRQUMxQixJQUFJLGVBQWUsRUFBRTtZQUNuQixNQUFNLEtBQUssR0FBRywyQ0FBMkMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFFLENBQUM7WUFDMUUsc0RBQXNEO1lBQ3RELFVBQVUsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNyRCxhQUFhLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDVixRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3ZCO2FBQU07WUFDTCx5QkFBeUI7WUFDekIsTUFBTSxLQUFLLEdBQUcsNkJBQTZCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNELElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtnQkFDakIsYUFBYSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsVUFBVSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2FBQ3JEO1NBQ0Y7UUFDRCwyREFBMkQ7UUFDM0QsSUFBSSxhQUFhLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUMvQyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0RCxhQUFhLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVCLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDYixVQUFVLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUV6QyxRQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN6RzthQUFNLElBQUksSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLGlCQUFpQixFQUFFO1lBQ2xDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFDbEUsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUI7YUFBTSxJQUFJLGFBQWEsRUFBRTtZQUN4QixRQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN6RzthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUMzRDtJQUNILENBQUMsQ0FBQyxDQUNILEVBQ0QsT0FBTyxDQUFDLElBQUksQ0FDVixNQUFNLENBQUMsY0FBYyxDQUFDLEVBQ3RCLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEVBQUMsRUFBRSxFQUFFO1FBQzVELElBQUksbUJBQW1CLEdBQUcsYUFBRyxDQUFDLE9BQU8sQ0FBQztZQUNwQyxJQUFJLEVBQUUsSUFBSTtTQUNYLEVBQUUsR0FBRyxFQUFFO1lBQ04sR0FBRyxDQUFDLElBQUksQ0FBQywyQ0FBMkMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3ZFLE1BQU0sU0FBUyxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ2hFLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztZQUNsRSxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMscUJBQXFCO1lBQ3JCLG1CQUFtQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2hELENBQUMsQ0FBQyxDQUFDO1FBQ0gsUUFBUSxDQUFDLHFCQUFxQixDQUFDLG1CQUFtQixFQUFFLGdDQUFnQyxDQUFDLENBQUM7SUFDeEYsQ0FBQyxDQUFDLENBQ0gsRUFDRCxPQUFPLENBQUMsSUFBSSxDQUNWLE1BQU0sQ0FBQyxlQUFlLENBQUMsRUFDdkIsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxtQkFBbUIsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLFFBQVEsQ0FBQyxFQUFDLEVBQUUsRUFBRTtRQUN2RixJQUFJLG1CQUFtQixHQUFHLGFBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsR0FBRyxFQUFFO1lBQ3pELEdBQUcsQ0FBQyxJQUFJLENBQUMsb0NBQW9DLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUVoRSxNQUFNLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUM3RCxRQUFRLENBQUMscUJBQXFCLENBQUMsTUFBTSxFQUFFLHVCQUF1QixDQUFDLENBQUM7WUFDaEUsd0JBQXdCO1lBQ3hCLHlEQUF5RDtZQUN6RCxNQUFNO1lBQ04sSUFBSSxlQUFlLEVBQUU7Z0JBQ25CLHdDQUF3QztnQkFDeEMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxlQUFlLENBQUMsQ0FBQzthQUN2RDtpQkFBTTtnQkFDTCxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakM7WUFDRCxxQkFBcUI7WUFDckIsbUJBQW1CLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7UUFDSCxRQUFRLENBQUMscUJBQXFCLENBQUMsbUJBQW1CLEVBQUUsMEJBQTBCLENBQUMsQ0FBQztJQUNsRixDQUFDLENBQUMsQ0FDSCxFQUNELE9BQU8sQ0FBQyxJQUFJLENBQ1YsTUFBTSxDQUFDLHVCQUF1QixDQUFDLEVBQy9CLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFDLE9BQU8sRUFBRSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxFQUFDLEVBQUUsRUFBRTtRQUMvQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDdEMsR0FBRyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsbUJBQW1CLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRSxtQkFBbUIsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdkgsQ0FBQyxDQUFDLENBQUM7UUFDSCxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDekQsSUFBSSxHQUFHO2dCQUNMLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsbUJBQW1CLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7WUFDckMsR0FBRyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxtQkFBbUIsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlHLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQ0gsQ0FDRixDQUFDLElBQUksQ0FDSixFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQ3pCLEdBQUcsQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUVkLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDekIsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6QixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1FBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUNsQyxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUN2QixHQUFHLENBQUMsSUFBSSxDQUFDLDJCQUEyQixJQUFBLGNBQU0sR0FBRSxDQUFDLE9BQU8sR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ2xFLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxHQUFHLEVBQUU7UUFDVixNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDakIsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQWhMRCxzQkFnTEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXG5pbXBvcnQgbmV0LCB7U29ja2V0fSBmcm9tICduZXQnO1xuaW1wb3J0ICogYXMgcnggZnJvbSAncnhqcyc7XG5pbXBvcnQgKiBhcyBvcCBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge2xvZzRGaWxlLCBjb25maWd9IGZyb20gJ0B3ZmgvcGxpbmsnO1xuLy8gaW1wb3J0IGluc3BlY3RvciBmcm9tICdpbnNwZWN0b3InO1xuXG4vLyBpbnNwZWN0b3Iub3Blbig5MjIyLCAnbG9jYWxob3N0JywgdHJ1ZSk7XG5jb25zdCBsb2cgPSBsb2c0RmlsZShfX2ZpbGVuYW1lKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHN0YXJ0KHBvcnQ6IG51bWJlciwgaG9zdE1hcDogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoKSxcbiAgb3B0cz86IHtcbiAgICAvKiogaWYgaG9zdCBpcyBub3QgaW4gaG9zdE1hcCwgZm9yd2FyZCB0byB0aGlzIHByb3h5ICovXG4gICAgZmFsbGJhY2tQcm94eUhvc3Q6IHN0cmluZztcbiAgICBmYWxsYmFja3Byb3h5UG9ydDogbnVtYmVyO1xuICB9KSB7XG4gIGNvbnN0IHNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoKTtcblxuICBjb25zdCBhY3Rpb25zID0ge1xuICAgIHByb3h5VG9Qcm94eShfcmVtb3RlSG9zdDogc3RyaW5nLCBfcmVtb3RlUG9ydDogbnVtYmVyLCBfc29ja2V0OiBTb2NrZXQsIF9maXJzdFBhY2tldDogQnVmZmVyKSB7fSxcbiAgICBwcm94eVRvUmVtb3RlKF9yZW1vdGVIb3N0OiBzdHJpbmcsIF9yZW1vdGVQb3J0OiBudW1iZXIsXG4gICAgICBfc29ja2V0OiBTb2NrZXQsIF9maXJzdFBhY2tldDogQnVmZmVyLCBfaXNUc2w6IGJvb2xlYW4sIGh0dHBQcm90b2NhbDogc3RyaW5nKSB7fSxcbiAgICByZW1vdGVTb2NrZXRDb25uZWN0ZWQoX3NvY2tldDogU29ja2V0LCBtc2c6IHN0cmluZykge31cbiAgfTtcblxuICB0eXBlIEFjdGlvblR5cGU8SyBleHRlbmRzIGtleW9mIHR5cGVvZiBhY3Rpb25zPiA9IHtcbiAgICB0eXBlOiBLO1xuICAgIHBheWxvYWQ6ICh0eXBlb2YgYWN0aW9ucylbS10gZXh0ZW5kcyAoYXJnOiBpbmZlciBQKSA9PiBhbnkgPyBQIDpcbiAgICAgICh0eXBlb2YgYWN0aW9ucylbS10gZXh0ZW5kcyAoLi4uYXJnczogaW5mZXIgQSkgPT4gYW55ID8gQSA6IHVua25vd247XG4gIH07XG5cbiAgY29uc3QgZGlzcGF0Y2ggPSB7fSBhcyB7XG4gICAgW0sgaW4ga2V5b2YgdHlwZW9mIGFjdGlvbnNdOlxuICAgICguLi5wYXJhbXM6IFBhcmFtZXRlcnM8dHlwZW9mIGFjdGlvbnNbS10+KSA9PiBBY3Rpb25UeXBlPEs+XG4gIH07XG5cbiAgY29uc3QgYWN0aW9uJCA9IG5ldyByeC5TdWJqZWN0PEFjdGlvblR5cGU8a2V5b2YgdHlwZW9mIGFjdGlvbnM+PigpO1xuICBjb25zdCBvZlR5cGUgPSA8VCBleHRlbmRzIGtleW9mIHR5cGVvZiBhY3Rpb25zPih0eXBlOiBUKSA9PiB7XG4gICAgcmV0dXJuIChpbnB1dDogcnguT2JzZXJ2YWJsZTxBY3Rpb25UeXBlPGtleW9mIHR5cGVvZiBhY3Rpb25zPj4pOiByeC5PYnNlcnZhYmxlPEFjdGlvblR5cGU8VD4+ID0+IHtcbiAgICAgIHJldHVybiBpbnB1dC5waXBlKFxuICAgICAgICBvcC5maWx0ZXIoYWN0aW9uID0+IGFjdGlvbi50eXBlID09PSB0eXBlKVxuICAgICAgKSBhcyByeC5PYnNlcnZhYmxlPEFjdGlvblR5cGU8VD4+O1xuICAgIH07XG4gIH07XG5cbiAgZm9yIChjb25zdCBba2V5XSBvZiBPYmplY3QuZW50cmllcyhhY3Rpb25zKSkge1xuICAgIGRpc3BhdGNoW2tleV0gPSAoLi4ucGFyYW1zOiBhbnlbXSkgPT4ge1xuICAgICAgY29uc3QgYWN0aW9uID0ge1xuICAgICAgICB0eXBlOiBrZXkgYXMga2V5b2YgdHlwZW9mIGFjdGlvbnMsXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFzc2lnbm1lbnRcbiAgICAgICAgcGF5bG9hZDogcGFyYW1zLmxlbmd0aCA9PT0gMCA/IHBhcmFtc1swXSA6IHBhcmFtc1xuICAgICAgfTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFyZ3VtZW50XG4gICAgICBhY3Rpb24kLm5leHQoYWN0aW9uIGFzIGFueSk7XG4gICAgfTtcbiAgfVxuXG4gIHJ4Lm1lcmdlKFxuICAgIHJ4LmZyb21FdmVudDxTb2NrZXQ+KHNlcnZlciwgJ2Nvbm5lY3Rpb24nKS5waXBlKFxuICAgICAgb3AubWVyZ2VNYXAoKGNsaWVudFRvUHJveHlTb2NrZXQpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKCdDbGllbnQgQ29ubmVjdGVkIFRvIFByb3h5JywgY2xpZW50VG9Qcm94eVNvY2tldC5yZW1vdGVBZGRyZXNzICtcbiAgICAgICAgICAnOicgKyBjbGllbnRUb1Byb3h5U29ja2V0LnJlbW90ZVBvcnQpO1xuICAgICAgICByZXR1cm4gcnguZnJvbUV2ZW50PEJ1ZmZlcj4oY2xpZW50VG9Qcm94eVNvY2tldCwgJ2RhdGEnKS5waXBlKFxuICAgICAgICAgIG9wLm1hcChkYXRhID0+ICh7Y2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YX0pKSxcbiAgICAgICAgICBvcC50YWtlKDEpXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICAgIG9wLm1hcCgoe2NsaWVudFRvUHJveHlTb2NrZXQsIGRhdGF9KSA9PiB7XG4gICAgICAgIGNvbnN0IGdyZWV0aW5nID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgICBsb2cuaW5mbyhncmVldGluZyk7XG4gICAgICAgIGxldCBpc1RMU0Nvbm5lY3Rpb24gPSBncmVldGluZy5pbmRleE9mKCdDT05ORUNUJykgIT09IC0xO1xuXG4gICAgICAgIC8vIENvbnNpZGVyaW5nIFBvcnQgYXMgODAgYnkgZGVmYXVsdCBcbiAgICAgICAgbGV0IHNlcnZlclBvcnQgPSA4MDtcbiAgICAgICAgbGV0IHNlcnZlckFkZHJlc3MgPSAnJztcbiAgICAgICAgbGV0IHByb3RvY2FsID0gJ0hUVFAvMS4xJztcbiAgICAgICAgaWYgKGlzVExTQ29ubmVjdGlvbikge1xuICAgICAgICAgIGNvbnN0IG1hdGNoID0gL0NPTk5FQ1QgKyhbXlxcczpdKykoPzo6KFxcUyspKT8oPzogKyhcXFMrKSk/Ly5leGVjKGdyZWV0aW5nKSE7XG4gICAgICAgICAgLy8gUG9ydCBjaGFuZ2VkIHRvIDQ0MywgcGFyc2luZyB0aGUgaG9zdCBmcm9tIENPTk5FQ1QgXG4gICAgICAgICAgc2VydmVyUG9ydCA9IG1hdGNoWzJdID8gcGFyc2VJbnQobWF0Y2hbMl0sIDEwKSA6IDQ0MztcbiAgICAgICAgICBzZXJ2ZXJBZGRyZXNzID0gbWF0Y2hbMV07XG4gICAgICAgICAgaWYgKG1hdGNoWzNdKVxuICAgICAgICAgICAgcHJvdG9jYWwgPSBtYXRjaFszXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBQYXJzaW5nIEhPU1QgZnJvbSBIVFRQXG4gICAgICAgICAgY29uc3QgbWF0Y2ggPSAvSG9zdDogKyhbXlxcczpdKykoPzo6KFxcUyspKT8vLmV4ZWMoZ3JlZXRpbmcpO1xuICAgICAgICAgIGlmIChtYXRjaCAhPSBudWxsKSB7XG4gICAgICAgICAgICBzZXJ2ZXJBZGRyZXNzID0gbWF0Y2hbMV07XG4gICAgICAgICAgICBzZXJ2ZXJQb3J0ID0gbWF0Y2hbMl0gPyBwYXJzZUludChtYXRjaFsyXSwgMTApIDogODA7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIGxvZy5pbmZvKCdwcm94eSB0bzonLCBzZXJ2ZXJBZGRyZXNzICsgJzonICsgc2VydmVyUG9ydCk7XG4gICAgICAgIGlmIChzZXJ2ZXJBZGRyZXNzICYmIGhvc3RNYXAuaGFzKHNlcnZlckFkZHJlc3MpKSB7XG4gICAgICAgICAgbGV0IHNwbGl0dGVkID0gaG9zdE1hcC5nZXQoc2VydmVyQWRkcmVzcykhLnNwbGl0KCc6Jyk7XG4gICAgICAgICAgc2VydmVyQWRkcmVzcyA9IHNwbGl0dGVkWzBdO1xuICAgICAgICAgIGlmIChzcGxpdHRlZFsxXSlcbiAgICAgICAgICAgIHNlcnZlclBvcnQgPSBwYXJzZUludChzcGxpdHRlZFsxXSwgMTApO1xuXG4gICAgICAgICAgZGlzcGF0Y2gucHJveHlUb1JlbW90ZShzZXJ2ZXJBZGRyZXNzLCBzZXJ2ZXJQb3J0LCBjbGllbnRUb1Byb3h5U29ja2V0LCBkYXRhLCBpc1RMU0Nvbm5lY3Rpb24sIHByb3RvY2FsKTtcbiAgICAgICAgfSBlbHNlIGlmIChvcHRzPy5mYWxsYmFja1Byb3h5SG9zdCkge1xuICAgICAgICAgIGRpc3BhdGNoLnByb3h5VG9Qcm94eShvcHRzLmZhbGxiYWNrUHJveHlIb3N0LCBvcHRzLmZhbGxiYWNrcHJveHlQb3J0LFxuICAgICAgICAgICAgY2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc2VydmVyQWRkcmVzcykge1xuICAgICAgICAgIGRpc3BhdGNoLnByb3h5VG9SZW1vdGUoc2VydmVyQWRkcmVzcywgc2VydmVyUG9ydCwgY2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YSwgaXNUTFNDb25uZWN0aW9uLCBwcm90b2NhbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIHNlcnZlciBhZGRyZXNzIGZvciAke2dyZWV0aW5nfWApO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICksXG4gICAgYWN0aW9uJC5waXBlKFxuICAgICAgb2ZUeXBlKCdwcm94eVRvUHJveHknKSxcbiAgICAgIG9wLm1hcCgoe3BheWxvYWQ6IFtob3N0LCBwb3J0LCBjbGllbnRUb1Byb3h5U29ja2V0LCBkYXRhXX0pID0+IHtcbiAgICAgICAgbGV0IHByb3h5VG9TZXJ2ZXJTb2NrZXQgPSBuZXQuY29ubmVjdCh7XG4gICAgICAgICAgaG9zdCwgcG9ydFxuICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmluZm8oJ1BST1hZIFRPIEZPUkJBQ0sgcHJveHkgY29ubmVjdGlvbiBjcmVhdGVkJywgaG9zdCwgJzonLCBwb3J0KTtcbiAgICAgICAgICBjb25zdCBjb25uZWN0ZWQgPSBwcm94eVRvU2VydmVyU29ja2V0LnBpcGUoY2xpZW50VG9Qcm94eVNvY2tldCk7XG4gICAgICAgICAgZGlzcGF0Y2gucmVtb3RlU29ja2V0Q29ubmVjdGVkKGNvbm5lY3RlZCwgJ1JlbW90ZSBwcm94eSByZWFkaW5nJyk7XG4gICAgICAgICAgcHJveHlUb1NlcnZlclNvY2tldC53cml0ZShkYXRhKTtcbiAgICAgICAgICAvLyBQaXBpbmcgdGhlIHNvY2tldHNcbiAgICAgICAgICBjbGllbnRUb1Byb3h5U29ja2V0LnBpcGUocHJveHlUb1NlcnZlclNvY2tldCk7XG4gICAgICAgIH0pO1xuICAgICAgICBkaXNwYXRjaC5yZW1vdGVTb2NrZXRDb25uZWN0ZWQocHJveHlUb1NlcnZlclNvY2tldCwgJ3JlbW90ZSBwcm94eSBzZXJ2ZXIgY29ubmVjdGlvbicpO1xuICAgICAgfSlcbiAgICApLFxuICAgIGFjdGlvbiQucGlwZShcbiAgICAgIG9mVHlwZSgncHJveHlUb1JlbW90ZScpLFxuICAgICAgb3AubWFwKCh7cGF5bG9hZDogW2hvc3QsIHBvcnQsIGNsaWVudFRvUHJveHlTb2NrZXQsIGRhdGEsIGlzVExTQ29ubmVjdGlvbiwgcHJvdG9jYWxdfSkgPT4ge1xuICAgICAgICBsZXQgcHJveHlUb1NlcnZlclNvY2tldCA9IG5ldC5jb25uZWN0KHsgaG9zdCwgcG9ydCB9LCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmluZm8oJ1BST1hZIFRPIFNFUlZFUiBjb25uZWN0aW9uIGNyZWF0ZWQnLCBob3N0LCAnOicsIHBvcnQpO1xuXG4gICAgICAgICAgY29uc3Qgc29ja2V0ID0gcHJveHlUb1NlcnZlclNvY2tldC5waXBlKGNsaWVudFRvUHJveHlTb2NrZXQpO1xuICAgICAgICAgIGRpc3BhdGNoLnJlbW90ZVNvY2tldENvbm5lY3RlZChzb2NrZXQsICdyZW1vdGUgc2VydmVyIHJlYWRpbmcnKTtcbiAgICAgICAgICAvLyAub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgICAvLyAgIGxvZy5lcnJvcigncHJveHkgdG8gcmVtb3RlIHNlcnZlciByZWFkIGVycm9yJywgZXJyKTtcbiAgICAgICAgICAvLyB9KTtcbiAgICAgICAgICBpZiAoaXNUTFNDb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAvLyBTZW5kIEJhY2sgT0sgdG8gSFRUUFMgQ09OTkVDVCBSZXF1ZXN0XG4gICAgICAgICAgICBjbGllbnRUb1Byb3h5U29ja2V0LndyaXRlKHByb3RvY2FsICsgJyAyMDAgT0tcXHJcXG5cXG4nKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJveHlUb1NlcnZlclNvY2tldC53cml0ZShkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gUGlwaW5nIHRoZSBzb2NrZXRzXG4gICAgICAgICAgY2xpZW50VG9Qcm94eVNvY2tldC5waXBlKHByb3h5VG9TZXJ2ZXJTb2NrZXQpO1xuICAgICAgICB9KTtcbiAgICAgICAgZGlzcGF0Y2gucmVtb3RlU29ja2V0Q29ubmVjdGVkKHByb3h5VG9TZXJ2ZXJTb2NrZXQsICdyZW1vdGUgc2VydmVyIGNvbm5lY3Rpb24nKTtcbiAgICAgIH0pXG4gICAgKSxcbiAgICBhY3Rpb24kLnBpcGUoXG4gICAgICBvZlR5cGUoJ3JlbW90ZVNvY2tldENvbm5lY3RlZCcpLFxuICAgICAgb3AubWFwKCh7cGF5bG9hZDogW3Byb3h5VG9TZXJ2ZXJTb2NrZXQsIG1zZ119KSA9PiB7XG4gICAgICAgIHByb3h5VG9TZXJ2ZXJTb2NrZXQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICAgIGxvZy5lcnJvcignUFJPWFkgVE8gU0VSVkVSIEVSUk9SJywgbXNnLCBwcm94eVRvU2VydmVyU29ja2V0LnJlbW90ZUFkZHJlc3MsICc6JywgcHJveHlUb1NlcnZlclNvY2tldC5yZW1vdGVQb3J0LCBlcnIpO1xuICAgICAgICB9KTtcbiAgICAgICAgcHJveHlUb1NlcnZlclNvY2tldC5vbignbG9va3VwJywgKGVyciwgYWRkciwgX2ZhbSwgaG9zdCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICBsb2cud2FybignbG9va3VwIGVycm9yJywgZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHByb3h5VG9TZXJ2ZXJTb2NrZXQub24oJ3RpbWVvdXQnLCAoKSA9PiB7XG4gICAgICAgICAgbG9nLndhcm4oJ1BST1hZIFRPIFNFUlZFUiB0aW1lb3V0JywgcHJveHlUb1NlcnZlclNvY2tldC5yZW1vdGVBZGRyZXNzLCAnOicsIHByb3h5VG9TZXJ2ZXJTb2NrZXQucmVtb3RlUG9ydCk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICApXG4gICkucGlwZShcbiAgICBvcC5jYXRjaEVycm9yKChlcnIsIHNyYykgPT4ge1xuICAgICAgbG9nLmVycm9yKCdGYXRhbCBlcnJvcicsIGVycik7XG4gICAgICByZXR1cm4gc3JjO1xuICAgIH0pXG4gICkuc3Vic2NyaWJlKCk7XG5cbiAgc2VydmVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICBsb2cuaW5mbygnU0VSVkVSIEVSUk9SJyk7XG4gICAgbG9nLmluZm8oZXJyKTtcbiAgfSk7XG5cbiAgc2VydmVyLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICBsb2cuaW5mbygnQ2xpZW50IERpc2Nvbm5lY3RlZCcpO1xuICB9KTtcblxuICBzZXJ2ZXIubGlzdGVuKHBvcnQsICgpID0+IHtcbiAgICBsb2cuaW5mbyhgU2VydmVyIHJ1bm5pZyBhdCBodHRwOi8vJHtjb25maWcoKS5sb2NhbElQfTpgICsgcG9ydCk7XG4gIH0pO1xuXG4gIHJldHVybiAoKSA9PiB7XG4gICAgc2VydmVyLmNsb3NlKCk7XG4gIH07XG59XG5cbiJdfQ==