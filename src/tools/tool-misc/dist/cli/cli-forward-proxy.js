"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.start = void 0;
const tslib_1 = require("tslib");
/* eslint-disable no-console */
const net_1 = tslib_1.__importDefault(require("net"));
const rx = tslib_1.__importStar(require("rxjs"));
const op = tslib_1.__importStar(require("rxjs/operators"));
const plink_1 = require("@wfh/plink");
// import inspector from 'inspector';
// inspector.open(9222, 'localhost', true);
const log = (0, plink_1.log4File)(__filename);
function start(port, hostMap = new Map(), opts) {
    const server = net_1.default.createServer();
    const actions = {
        proxyToProxy(_remoteHost, _remotePort, _socket, _firstPacket) { },
        proxyToRemote(_remoteHost, _remotePort, _socket, _firstPacket, _isTsl, httpProtocal) { },
        socketCreated(_socket, msg) { }
    };
    const dispatch = {};
    const action$ = new rx.Subject();
    const ofType = (type) => {
        return (input) => {
            return input.pipe(op.filter(action => action.type === type));
        };
    };
    for (const [key] of Object.entries(actions)) {
        dispatch[key] = (...params) => {
            const action = {
                type: key,
                // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
                payload: params.length === 0 ? params[0] : params
            };
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            action$.next(action);
        };
    }
    rx.merge(rx.fromEvent(server, 'connection').pipe(op.mergeMap((clientToProxySocket) => {
        log.debug('Client Connected To Proxy', clientToProxySocket.remoteAddress +
            ':' + clientToProxySocket.remotePort);
        return rx.fromEvent(clientToProxySocket, 'data').pipe(op.map(data => ({ clientToProxySocket, data })), op.take(1));
    }), op.map(({ clientToProxySocket, data }) => {
        const greeting = data.toString();
        log.info(greeting);
        let isTLSConnection = greeting.indexOf('CONNECT') !== -1;
        // Considering Port as 80 by default 
        let serverPort = 80;
        let serverAddress = '';
        let protocal = 'HTTP/1.1';
        if (isTLSConnection) {
            const match = /CONNECT +([^\s:]+)(?::(\S+))?(?: +(\S+))?/.exec(greeting);
            // Port changed to 443, parsing the host from CONNECT 
            serverPort = match[2] ? parseInt(match[2], 10) : 443;
            serverAddress = match[1];
            if (match[3])
                protocal = match[3];
        }
        else {
            // Parsing HOST from HTTP
            const match = /Host: +([^\s:]+)(?::(\S+))?/.exec(greeting);
            if (match != null) {
                serverAddress = match[1];
                serverPort = match[2] ? parseInt(match[2], 10) : 80;
            }
        }
        // log.info('proxy to:', serverAddress + ':' + serverPort);
        if (serverAddress && hostMap.has(serverAddress)) {
            let splitted = hostMap.get(serverAddress).split(':');
            serverAddress = splitted[0];
            if (splitted[1])
                serverPort = parseInt(splitted[1], 10);
            dispatch.proxyToRemote(serverAddress, serverPort, clientToProxySocket, data, isTLSConnection, protocal);
        }
        else if (opts === null || opts === void 0 ? void 0 : opts.fallbackProxyHost) {
            dispatch.proxyToProxy(opts.fallbackProxyHost, opts.fallbackproxyPort, clientToProxySocket, data);
        }
        else if (serverAddress) {
            dispatch.proxyToRemote(serverAddress, serverPort, clientToProxySocket, data, isTLSConnection, protocal);
        }
        else {
            throw new Error(`unknown server address for ${greeting}`);
        }
    })), action$.pipe(ofType('proxyToProxy'), op.map(({ payload: [host, port, clientToProxySocket, data] }) => {
        let proxyToServerSocket = net_1.default.connect({
            host, port
        }, () => {
            log.info('PROXY TO FORBACK proxy connection created', host, ':', port);
            const connected = proxyToServerSocket.pipe(clientToProxySocket);
            dispatch.socketCreated(connected, 'Remote proxy reading');
            proxyToServerSocket.write(data);
            // Piping the sockets
            clientToProxySocket.pipe(proxyToServerSocket);
        });
        dispatch.socketCreated(proxyToServerSocket, 'remote proxy server connection');
    })), action$.pipe(ofType('proxyToRemote'), op.map(({ payload: [host, port, clientToProxySocket, data, isTLSConnection, protocal] }) => {
        let proxyToServerSocket = net_1.default.connect({ host, port }, () => {
            log.info('PROXY TO SERVER connection created', host, ':', port);
            const socket = proxyToServerSocket.pipe(clientToProxySocket);
            dispatch.socketCreated(socket, 'remote server reading');
            if (isTLSConnection) {
                // Send Back OK to HTTPS CONNECT Request
                clientToProxySocket.write(protocal + ' 200 OK\r\n\n');
            }
            else {
                proxyToServerSocket.write(data);
            }
            // Piping the sockets
            clientToProxySocket.pipe(proxyToServerSocket);
        });
        dispatch.socketCreated(proxyToServerSocket, 'remote server connection');
    })), action$.pipe(ofType('socketCreated'), op.map(({ payload: [proxyToServerSocket, msg] }) => {
        proxyToServerSocket.on('error', (err) => {
            log.error('PROXY TO SERVER ERROR', msg, proxyToServerSocket.remoteAddress, ':', proxyToServerSocket.remotePort, err);
        });
        proxyToServerSocket.on('lookup', (err, addr, _fam, host) => {
            if (err)
                log.warn('lookup error', err);
        });
        proxyToServerSocket.on('timeout', () => {
            log.warn('PROXY TO SERVER timeout', proxyToServerSocket.remoteAddress, ':', proxyToServerSocket.remotePort);
        });
    }))).pipe(op.catchError((err, src) => {
        log.error('Fatal error', err);
        return src;
    })).subscribe();
    server.on('error', (err) => {
        log.info('SERVER ERROR');
        log.info(err);
    });
    server.on('close', () => {
        log.info('Client Disconnected');
    });
    server.listen(port, () => {
        log.info(`Server runnig at http://${(0, plink_1.config)().localIP}:` + port);
    });
    return () => {
        server.close();
    };
}
exports.start = start;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLWZvcndhcmQtcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjbGktZm9yd2FyZC1wcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsK0JBQStCO0FBQy9CLHNEQUFnQztBQUNoQyxpREFBMkI7QUFDM0IsMkRBQXFDO0FBQ3JDLHNDQUE0QztBQUM1QyxxQ0FBcUM7QUFFckMsMkNBQTJDO0FBQzNDLE1BQU0sR0FBRyxHQUFHLElBQUEsZ0JBQVEsRUFBQyxVQUFVLENBQUMsQ0FBQztBQUVqQyxTQUFnQixLQUFLLENBQUMsSUFBWSxFQUFFLFVBQStCLElBQUksR0FBRyxFQUFFLEVBQzFFLElBSUM7SUFDRCxNQUFNLE1BQU0sR0FBRyxhQUFHLENBQUMsWUFBWSxFQUFFLENBQUM7SUFFbEMsTUFBTSxPQUFPLEdBQUc7UUFDZCxZQUFZLENBQUMsV0FBbUIsRUFBRSxXQUFtQixFQUFFLE9BQWUsRUFBRSxZQUFvQixJQUFHLENBQUM7UUFDaEcsYUFBYSxDQUFDLFdBQW1CLEVBQUUsV0FBbUIsRUFDcEQsT0FBZSxFQUFFLFlBQW9CLEVBQUUsTUFBZSxFQUFFLFlBQW9CLElBQUcsQ0FBQztRQUNsRixhQUFhLENBQUMsT0FBZSxFQUFFLEdBQVcsSUFBRyxDQUFDO0tBQy9DLENBQUM7SUFRRixNQUFNLFFBQVEsR0FBRyxFQUdoQixDQUFDO0lBRUYsTUFBTSxPQUFPLEdBQUcsSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFvQyxDQUFDO0lBQ25FLE1BQU0sTUFBTSxHQUFHLENBQWlDLElBQU8sRUFBRSxFQUFFO1FBQ3pELE9BQU8sQ0FBQyxLQUFzRCxFQUFnQyxFQUFFO1lBQzlGLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FDZixFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FDVixDQUFDO1FBQ3BDLENBQUMsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLEtB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QUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQ0gsQ0FDRixDQUFDLElBQUksQ0FDSixFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQ3pCLEdBQUcsQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUVkLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDekIsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6QixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1FBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUNsQyxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUN2QixHQUFHLENBQUMsSUFBSSxDQUFDLDJCQUEyQixJQUFBLGNBQU0sR0FBRSxDQUFDLE9BQU8sR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ2xFLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxHQUFHLEVBQUU7UUFDVixNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDakIsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQTdLRCxzQkE2S0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXG5pbXBvcnQgbmV0LCB7U29ja2V0fSBmcm9tICduZXQnO1xuaW1wb3J0ICogYXMgcnggZnJvbSAncnhqcyc7XG5pbXBvcnQgKiBhcyBvcCBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge2xvZzRGaWxlLCBjb25maWd9IGZyb20gJ0B3ZmgvcGxpbmsnO1xuLy8gaW1wb3J0IGluc3BlY3RvciBmcm9tICdpbnNwZWN0b3InO1xuXG4vLyBpbnNwZWN0b3Iub3Blbig5MjIyLCAnbG9jYWxob3N0JywgdHJ1ZSk7XG5jb25zdCBsb2cgPSBsb2c0RmlsZShfX2ZpbGVuYW1lKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHN0YXJ0KHBvcnQ6IG51bWJlciwgaG9zdE1hcDogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoKSxcbiAgb3B0cz86IHtcbiAgICAvKiogaWYgaG9zdCBpcyBub3QgaW4gaG9zdE1hcCwgZm9yd2FyZCB0byB0aGlzIHByb3h5ICovXG4gICAgZmFsbGJhY2tQcm94eUhvc3Q6IHN0cmluZztcbiAgICBmYWxsYmFja3Byb3h5UG9ydDogbnVtYmVyO1xuICB9KSB7XG4gIGNvbnN0IHNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoKTtcblxuICBjb25zdCBhY3Rpb25zID0ge1xuICAgIHByb3h5VG9Qcm94eShfcmVtb3RlSG9zdDogc3RyaW5nLCBfcmVtb3RlUG9ydDogbnVtYmVyLCBfc29ja2V0OiBTb2NrZXQsIF9maXJzdFBhY2tldDogQnVmZmVyKSB7fSxcbiAgICBwcm94eVRvUmVtb3RlKF9yZW1vdGVIb3N0OiBzdHJpbmcsIF9yZW1vdGVQb3J0OiBudW1iZXIsXG4gICAgICBfc29ja2V0OiBTb2NrZXQsIF9maXJzdFBhY2tldDogQnVmZmVyLCBfaXNUc2w6IGJvb2xlYW4sIGh0dHBQcm90b2NhbDogc3RyaW5nKSB7fSxcbiAgICBzb2NrZXRDcmVhdGVkKF9zb2NrZXQ6IFNvY2tldCwgbXNnOiBzdHJpbmcpIHt9XG4gIH07XG5cbiAgdHlwZSBBY3Rpb25UeXBlPEsgZXh0ZW5kcyBrZXlvZiB0eXBlb2YgYWN0aW9ucz4gPSB7XG4gICAgdHlwZTogSztcbiAgICBwYXlsb2FkOiAodHlwZW9mIGFjdGlvbnMpW0tdIGV4dGVuZHMgKGFyZzogaW5mZXIgUCkgPT4gYW55ID8gUCA6XG4gICAgICAodHlwZW9mIGFjdGlvbnMpW0tdIGV4dGVuZHMgKC4uLmFyZ3M6IGluZmVyIEEpID0+IGFueSA/IEEgOiB1bmtub3duO1xuICB9O1xuXG4gIGNvbnN0IGRpc3BhdGNoID0ge30gYXMge1xuICAgIFtLIGluIGtleW9mIHR5cGVvZiBhY3Rpb25zXTpcbiAgICAoLi4ucGFyYW1zOiBQYXJhbWV0ZXJzPHR5cGVvZiBhY3Rpb25zW0tdPikgPT4gQWN0aW9uVHlwZTxLPlxuICB9O1xuXG4gIGNvbnN0IGFjdGlvbiQgPSBuZXcgcnguU3ViamVjdDxBY3Rpb25UeXBlPGtleW9mIHR5cGVvZiBhY3Rpb25zPj4oKTtcbiAgY29uc3Qgb2ZUeXBlID0gPFQgZXh0ZW5kcyBrZXlvZiB0eXBlb2YgYWN0aW9ucz4odHlwZTogVCkgPT4ge1xuICAgIHJldHVybiAoaW5wdXQ6IHJ4Lk9ic2VydmFibGU8QWN0aW9uVHlwZTxrZXlvZiB0eXBlb2YgYWN0aW9ucz4+KTogcnguT2JzZXJ2YWJsZTxBY3Rpb25UeXBlPFQ+PiA9PiB7XG4gICAgICByZXR1cm4gaW5wdXQucGlwZShcbiAgICAgICAgb3AuZmlsdGVyKGFjdGlvbiA9PiBhY3Rpb24udHlwZSA9PT0gdHlwZSlcbiAgICAgICkgYXMgcnguT2JzZXJ2YWJsZTxBY3Rpb25UeXBlPFQ+PjtcbiAgICB9O1xuICB9O1xuXG4gIGZvciAoY29uc3QgW2tleV0gb2YgT2JqZWN0LmVudHJpZXMoYWN0aW9ucykpIHtcbiAgICBkaXNwYXRjaFtrZXldID0gKC4uLnBhcmFtczogYW55W10pID0+IHtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IHtcbiAgICAgICAgdHlwZToga2V5IGFzIGtleW9mIHR5cGVvZiBhY3Rpb25zLFxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1hc3NpZ25tZW50XG4gICAgICAgIHBheWxvYWQ6IHBhcmFtcy5sZW5ndGggPT09IDAgPyBwYXJhbXNbMF0gOiBwYXJhbXNcbiAgICAgIH07XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1hcmd1bWVudFxuICAgICAgYWN0aW9uJC5uZXh0KGFjdGlvbiBhcyBhbnkpO1xuICAgIH07XG4gIH1cblxuICByeC5tZXJnZShcbiAgICByeC5mcm9tRXZlbnQ8U29ja2V0PihzZXJ2ZXIsICdjb25uZWN0aW9uJykucGlwZShcbiAgICAgIG9wLm1lcmdlTWFwKChjbGllbnRUb1Byb3h5U29ja2V0KSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZygnQ2xpZW50IENvbm5lY3RlZCBUbyBQcm94eScsIGNsaWVudFRvUHJveHlTb2NrZXQucmVtb3RlQWRkcmVzcyArXG4gICAgICAgICAgJzonICsgY2xpZW50VG9Qcm94eVNvY2tldC5yZW1vdGVQb3J0KTtcbiAgICAgICAgcmV0dXJuIHJ4LmZyb21FdmVudDxCdWZmZXI+KGNsaWVudFRvUHJveHlTb2NrZXQsICdkYXRhJykucGlwZShcbiAgICAgICAgICBvcC5tYXAoZGF0YSA9PiAoe2NsaWVudFRvUHJveHlTb2NrZXQsIGRhdGF9KSksXG4gICAgICAgICAgb3AudGFrZSgxKVxuICAgICAgICApO1xuICAgICAgfSksXG4gICAgICBvcC5tYXAoKHtjbGllbnRUb1Byb3h5U29ja2V0LCBkYXRhfSkgPT4ge1xuICAgICAgICBjb25zdCBncmVldGluZyA9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgbG9nLmluZm8oZ3JlZXRpbmcpO1xuICAgICAgICBsZXQgaXNUTFNDb25uZWN0aW9uID0gZ3JlZXRpbmcuaW5kZXhPZignQ09OTkVDVCcpICE9PSAtMTtcblxuICAgICAgICAvLyBDb25zaWRlcmluZyBQb3J0IGFzIDgwIGJ5IGRlZmF1bHQgXG4gICAgICAgIGxldCBzZXJ2ZXJQb3J0ID0gODA7XG4gICAgICAgIGxldCBzZXJ2ZXJBZGRyZXNzID0gJyc7XG4gICAgICAgIGxldCBwcm90b2NhbCA9ICdIVFRQLzEuMSc7XG4gICAgICAgIGlmIChpc1RMU0Nvbm5lY3Rpb24pIHtcbiAgICAgICAgICBjb25zdCBtYXRjaCA9IC9DT05ORUNUICsoW15cXHM6XSspKD86OihcXFMrKSk/KD86ICsoXFxTKykpPy8uZXhlYyhncmVldGluZykhO1xuICAgICAgICAgIC8vIFBvcnQgY2hhbmdlZCB0byA0NDMsIHBhcnNpbmcgdGhlIGhvc3QgZnJvbSBDT05ORUNUIFxuICAgICAgICAgIHNlcnZlclBvcnQgPSBtYXRjaFsyXSA/IHBhcnNlSW50KG1hdGNoWzJdLCAxMCkgOiA0NDM7XG4gICAgICAgICAgc2VydmVyQWRkcmVzcyA9IG1hdGNoWzFdO1xuICAgICAgICAgIGlmIChtYXRjaFszXSlcbiAgICAgICAgICAgIHByb3RvY2FsID0gbWF0Y2hbM107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gUGFyc2luZyBIT1NUIGZyb20gSFRUUFxuICAgICAgICAgIGNvbnN0IG1hdGNoID0gL0hvc3Q6ICsoW15cXHM6XSspKD86OihcXFMrKSk/Ly5leGVjKGdyZWV0aW5nKTtcbiAgICAgICAgICBpZiAobWF0Y2ggIT0gbnVsbCkge1xuICAgICAgICAgICAgc2VydmVyQWRkcmVzcyA9IG1hdGNoWzFdO1xuICAgICAgICAgICAgc2VydmVyUG9ydCA9IG1hdGNoWzJdID8gcGFyc2VJbnQobWF0Y2hbMl0sIDEwKSA6IDgwO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBsb2cuaW5mbygncHJveHkgdG86Jywgc2VydmVyQWRkcmVzcyArICc6JyArIHNlcnZlclBvcnQpO1xuICAgICAgICBpZiAoc2VydmVyQWRkcmVzcyAmJiBob3N0TWFwLmhhcyhzZXJ2ZXJBZGRyZXNzKSkge1xuICAgICAgICAgIGxldCBzcGxpdHRlZCA9IGhvc3RNYXAuZ2V0KHNlcnZlckFkZHJlc3MpIS5zcGxpdCgnOicpO1xuICAgICAgICAgIHNlcnZlckFkZHJlc3MgPSBzcGxpdHRlZFswXTtcbiAgICAgICAgICBpZiAoc3BsaXR0ZWRbMV0pXG4gICAgICAgICAgICBzZXJ2ZXJQb3J0ID0gcGFyc2VJbnQoc3BsaXR0ZWRbMV0sIDEwKTtcblxuICAgICAgICAgIGRpc3BhdGNoLnByb3h5VG9SZW1vdGUoc2VydmVyQWRkcmVzcywgc2VydmVyUG9ydCwgY2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YSwgaXNUTFNDb25uZWN0aW9uLCBwcm90b2NhbCk7XG4gICAgICAgIH0gZWxzZSBpZiAob3B0cz8uZmFsbGJhY2tQcm94eUhvc3QpIHtcbiAgICAgICAgICBkaXNwYXRjaC5wcm94eVRvUHJveHkob3B0cy5mYWxsYmFja1Byb3h5SG9zdCwgb3B0cy5mYWxsYmFja3Byb3h5UG9ydCxcbiAgICAgICAgICAgIGNsaWVudFRvUHJveHlTb2NrZXQsIGRhdGEpO1xuICAgICAgICB9IGVsc2UgaWYgKHNlcnZlckFkZHJlc3MpIHtcbiAgICAgICAgICBkaXNwYXRjaC5wcm94eVRvUmVtb3RlKHNlcnZlckFkZHJlc3MsIHNlcnZlclBvcnQsIGNsaWVudFRvUHJveHlTb2NrZXQsIGRhdGEsIGlzVExTQ29ubmVjdGlvbiwgcHJvdG9jYWwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biBzZXJ2ZXIgYWRkcmVzcyBmb3IgJHtncmVldGluZ31gKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApLFxuICAgIGFjdGlvbiQucGlwZShcbiAgICAgIG9mVHlwZSgncHJveHlUb1Byb3h5JyksXG4gICAgICBvcC5tYXAoKHtwYXlsb2FkOiBbaG9zdCwgcG9ydCwgY2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YV19KSA9PiB7XG4gICAgICAgIGxldCBwcm94eVRvU2VydmVyU29ja2V0ID0gbmV0LmNvbm5lY3Qoe1xuICAgICAgICAgIGhvc3QsIHBvcnRcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgIGxvZy5pbmZvKCdQUk9YWSBUTyBGT1JCQUNLIHByb3h5IGNvbm5lY3Rpb24gY3JlYXRlZCcsIGhvc3QsICc6JywgcG9ydCk7XG4gICAgICAgICAgY29uc3QgY29ubmVjdGVkID0gcHJveHlUb1NlcnZlclNvY2tldC5waXBlKGNsaWVudFRvUHJveHlTb2NrZXQpO1xuICAgICAgICAgIGRpc3BhdGNoLnNvY2tldENyZWF0ZWQoY29ubmVjdGVkLCAnUmVtb3RlIHByb3h5IHJlYWRpbmcnKTtcbiAgICAgICAgICBwcm94eVRvU2VydmVyU29ja2V0LndyaXRlKGRhdGEpO1xuICAgICAgICAgIC8vIFBpcGluZyB0aGUgc29ja2V0c1xuICAgICAgICAgIGNsaWVudFRvUHJveHlTb2NrZXQucGlwZShwcm94eVRvU2VydmVyU29ja2V0KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRpc3BhdGNoLnNvY2tldENyZWF0ZWQocHJveHlUb1NlcnZlclNvY2tldCwgJ3JlbW90ZSBwcm94eSBzZXJ2ZXIgY29ubmVjdGlvbicpO1xuICAgICAgfSlcbiAgICApLFxuICAgIGFjdGlvbiQucGlwZShcbiAgICAgIG9mVHlwZSgncHJveHlUb1JlbW90ZScpLFxuICAgICAgb3AubWFwKCh7cGF5bG9hZDogW2hvc3QsIHBvcnQsIGNsaWVudFRvUHJveHlTb2NrZXQsIGRhdGEsIGlzVExTQ29ubmVjdGlvbiwgcHJvdG9jYWxdfSkgPT4ge1xuICAgICAgICBsZXQgcHJveHlUb1NlcnZlclNvY2tldCA9IG5ldC5jb25uZWN0KHsgaG9zdCwgcG9ydCB9LCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmluZm8oJ1BST1hZIFRPIFNFUlZFUiBjb25uZWN0aW9uIGNyZWF0ZWQnLCBob3N0LCAnOicsIHBvcnQpO1xuXG4gICAgICAgICAgY29uc3Qgc29ja2V0ID0gcHJveHlUb1NlcnZlclNvY2tldC5waXBlKGNsaWVudFRvUHJveHlTb2NrZXQpO1xuICAgICAgICAgIGRpc3BhdGNoLnNvY2tldENyZWF0ZWQoc29ja2V0LCAncmVtb3RlIHNlcnZlciByZWFkaW5nJyk7XG4gICAgICAgICAgaWYgKGlzVExTQ29ubmVjdGlvbikge1xuICAgICAgICAgICAgLy8gU2VuZCBCYWNrIE9LIHRvIEhUVFBTIENPTk5FQ1QgUmVxdWVzdFxuICAgICAgICAgICAgY2xpZW50VG9Qcm94eVNvY2tldC53cml0ZShwcm90b2NhbCArICcgMjAwIE9LXFxyXFxuXFxuJyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHByb3h5VG9TZXJ2ZXJTb2NrZXQud3JpdGUoZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIFBpcGluZyB0aGUgc29ja2V0c1xuICAgICAgICAgIGNsaWVudFRvUHJveHlTb2NrZXQucGlwZShwcm94eVRvU2VydmVyU29ja2V0KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRpc3BhdGNoLnNvY2tldENyZWF0ZWQocHJveHlUb1NlcnZlclNvY2tldCwgJ3JlbW90ZSBzZXJ2ZXIgY29ubmVjdGlvbicpO1xuICAgICAgfSlcbiAgICApLFxuICAgIGFjdGlvbiQucGlwZShcbiAgICAgIG9mVHlwZSgnc29ja2V0Q3JlYXRlZCcpLFxuICAgICAgb3AubWFwKCh7cGF5bG9hZDogW3Byb3h5VG9TZXJ2ZXJTb2NrZXQsIG1zZ119KSA9PiB7XG4gICAgICAgIHByb3h5VG9TZXJ2ZXJTb2NrZXQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICAgIGxvZy5lcnJvcignUFJPWFkgVE8gU0VSVkVSIEVSUk9SJywgbXNnLCBwcm94eVRvU2VydmVyU29ja2V0LnJlbW90ZUFkZHJlc3MsICc6JywgcHJveHlUb1NlcnZlclNvY2tldC5yZW1vdGVQb3J0LCBlcnIpO1xuICAgICAgICB9KTtcbiAgICAgICAgcHJveHlUb1NlcnZlclNvY2tldC5vbignbG9va3VwJywgKGVyciwgYWRkciwgX2ZhbSwgaG9zdCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICBsb2cud2FybignbG9va3VwIGVycm9yJywgZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHByb3h5VG9TZXJ2ZXJTb2NrZXQub24oJ3RpbWVvdXQnLCAoKSA9PiB7XG4gICAgICAgICAgbG9nLndhcm4oJ1BST1hZIFRPIFNFUlZFUiB0aW1lb3V0JywgcHJveHlUb1NlcnZlclNvY2tldC5yZW1vdGVBZGRyZXNzLCAnOicsIHByb3h5VG9TZXJ2ZXJTb2NrZXQucmVtb3RlUG9ydCk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICApXG4gICkucGlwZShcbiAgICBvcC5jYXRjaEVycm9yKChlcnIsIHNyYykgPT4ge1xuICAgICAgbG9nLmVycm9yKCdGYXRhbCBlcnJvcicsIGVycik7XG4gICAgICByZXR1cm4gc3JjO1xuICAgIH0pXG4gICkuc3Vic2NyaWJlKCk7XG5cbiAgc2VydmVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICBsb2cuaW5mbygnU0VSVkVSIEVSUk9SJyk7XG4gICAgbG9nLmluZm8oZXJyKTtcbiAgfSk7XG5cbiAgc2VydmVyLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICBsb2cuaW5mbygnQ2xpZW50IERpc2Nvbm5lY3RlZCcpO1xuICB9KTtcblxuICBzZXJ2ZXIubGlzdGVuKHBvcnQsICgpID0+IHtcbiAgICBsb2cuaW5mbyhgU2VydmVyIHJ1bm5pZyBhdCBodHRwOi8vJHtjb25maWcoKS5sb2NhbElQfTpgICsgcG9ydCk7XG4gIH0pO1xuXG4gIHJldHVybiAoKSA9PiB7XG4gICAgc2VydmVyLmNsb3NlKCk7XG4gIH07XG59XG5cbiJdfQ==