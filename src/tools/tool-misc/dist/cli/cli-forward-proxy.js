"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.start = void 0;
/* eslint-disable no-console */
const net_1 = __importDefault(require("net"));
const rx = __importStar(require("rxjs"));
const op = __importStar(require("rxjs/operators"));
const plink_1 = require("@wfh/plink");
const log = (0, plink_1.log4File)(__filename);
function start(port, hostMap = new Map(), opts) {
    const server = net_1.default.createServer();
    const actions = {
        proxyToProxy(_remoteHost, _remotePort, _socket, _firstPacket) { },
        proxyToRemote(_remoteHost, _remotePort, _socket, _firstPacket, _isTsl, httpProtocal) { },
        remoteSocketCreated(_socket, msg) { }
    };
    const dispatch = {};
    const action$ = new rx.Subject();
    const ofType = (type) => {
        return (input) => {
            return input.pipe(op.filter(action => action.type === type));
        };
    };
    for (const [key] of Object.entries(actions)) {
        dispatch[key] = (...params) => {
            const action = {
                type: key,
                // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
                payload: params.length === 0 ? params[0] : params
            };
            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
            action$.next(action);
        };
    }
    rx.merge(rx.fromEvent(server, 'connection').pipe(op.mergeMap((clientToProxySocket) => {
        log.debug('Client Connected To Proxy', clientToProxySocket.remoteAddress +
            ':' + clientToProxySocket.remotePort);
        return rx.fromEvent(clientToProxySocket, 'data').pipe(op.map(data => ({ clientToProxySocket, data })), op.take(1));
    }), op.map(({ clientToProxySocket, data }) => {
        const greeting = data.toString();
        log.info(greeting);
        let isTLSConnection = greeting.indexOf('CONNECT') !== -1;
        // Considering Port as 80 by default 
        let serverPort = 80;
        let serverAddress = '';
        let protocal = 'HTTP/1.1';
        if (isTLSConnection) {
            const match = /CONNECT +([^\s:]+)(?::(\S+))?(?: +(\S+))?/.exec(greeting);
            // Port changed to 443, parsing the host from CONNECT 
            serverPort = match[2] ? parseInt(match[2], 10) : 443;
            serverAddress = match[1];
            if (match[3])
                protocal = match[3];
        }
        else {
            // Parsing HOST from HTTP
            const match = /Host: +([^\s:]+)(?::(\S+))?/.exec(greeting);
            if (match != null) {
                serverAddress = match[1];
                serverPort = match[2] ? parseInt(match[2], 10) : 80;
            }
        }
        // log.info('proxy to:', serverAddress + ':' + serverPort);
        if (serverAddress && hostMap.has(serverAddress)) {
            let splitted = hostMap.get(serverAddress).split(':');
            serverAddress = splitted[0];
            if (splitted[1])
                serverPort = parseInt(splitted[1], 10);
            dispatch.proxyToRemote(serverAddress, serverPort, clientToProxySocket, data, isTLSConnection, protocal);
        }
        else if (opts === null || opts === void 0 ? void 0 : opts.fallbackProxyHost) {
            dispatch.proxyToProxy(opts.fallbackProxyHost, opts.fallbackproxyPort, clientToProxySocket, data);
        }
        else if (serverAddress) {
            dispatch.proxyToRemote(serverAddress, serverPort, clientToProxySocket, data, isTLSConnection, protocal);
        }
        else {
            throw new Error(`unknown server address for ${greeting}`);
        }
    })), action$.pipe(ofType('proxyToProxy'), op.map(({ payload: [host, port, clientToProxySocket, data] }) => {
        let proxyToServerSocket = net_1.default.connect({
            host, port
        }, () => {
            log.warn('PROXY TO FORBACK proxy connection created', host, ':', port);
            proxyToServerSocket = proxyToServerSocket.pipe(clientToProxySocket);
            proxyToServerSocket.write(data);
            // Piping the sockets
            clientToProxySocket.pipe(proxyToServerSocket);
        });
        dispatch.remoteSocketCreated(proxyToServerSocket, 'Remote proxy');
    })), action$.pipe(ofType('proxyToRemote'), op.map(({ payload: [host, port, clientToProxySocket, data, isTLSConnection, protocal] }) => {
        let proxyToServerSocket = net_1.default.connect({
            host,
            port
        }, () => {
            log.info('PROXY TO SERVER connection created', host, ':', port);
            if (isTLSConnection) {
                // Send Back OK to HTTPS CONNECT Request
                clientToProxySocket.write(protocal + ' 200 OK\r\n\n');
            }
            else {
                proxyToServerSocket.write(data);
            }
            // Piping the sockets
            clientToProxySocket.pipe(proxyToServerSocket);
            proxyToServerSocket = proxyToServerSocket.pipe(clientToProxySocket);
        });
        dispatch.remoteSocketCreated(proxyToServerSocket, 'remote server');
    })), action$.pipe(ofType('remoteSocketCreated'), op.map(({ payload: [proxyToServerSocket] }) => {
        log.info('Register error event handler to socket');
        proxyToServerSocket.on('error', (err) => {
            log.warn('PROXY TO SERVER ERROR', proxyToServerSocket.remoteAddress, ':', proxyToServerSocket.remotePort, err);
        });
        proxyToServerSocket.on('lookup', (err, addr, _fam, host) => {
            if (err)
                log.warn('lookup error', err);
            log.info('lookup', addr, host);
        });
        proxyToServerSocket.on('timeout', () => {
            log.info('PROXY TO SERVER timeout', proxyToServerSocket.remoteAddress, ':', proxyToServerSocket.remotePort);
        });
    }))).pipe(op.catchError((err, src) => {
        log.error('Fatal error', err);
        return src;
    })).subscribe();
    server.on('error', (err) => {
        log.info('SERVER ERROR');
        log.info(err);
    });
    server.on('close', () => {
        log.info('Client Disconnected');
    });
    server.listen(port, () => {
        log.info(`Server runnig at http://${(0, plink_1.config)().localIP}:` + port);
    });
    return () => {
        server.close();
    };
}
exports.start = start;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLWZvcndhcmQtcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjbGktZm9yd2FyZC1wcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBQy9CLDhDQUFnQztBQUNoQyx5Q0FBMkI7QUFDM0IsbURBQXFDO0FBQ3JDLHNDQUE0QztBQUM1QyxNQUFNLEdBQUcsR0FBRyxJQUFBLGdCQUFRLEVBQUMsVUFBVSxDQUFDLENBQUM7QUFFakMsU0FBZ0IsS0FBSyxDQUFDLElBQVksRUFBRSxVQUErQixJQUFJLEdBQUcsRUFBRSxFQUMxRSxJQUlDO0lBQ0QsTUFBTSxNQUFNLEdBQUcsYUFBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBRWxDLE1BQU0sT0FBTyxHQUFHO1FBQ2QsWUFBWSxDQUFDLFdBQW1CLEVBQUUsV0FBbUIsRUFBRSxPQUFlLEVBQUUsWUFBb0IsSUFBRyxDQUFDO1FBQ2hHLGFBQWEsQ0FBQyxXQUFtQixFQUFFLFdBQW1CLEVBQ3BELE9BQWUsRUFBRSxZQUFvQixFQUFFLE1BQWUsRUFBRSxZQUFvQixJQUFHLENBQUM7UUFDbEYsbUJBQW1CLENBQUMsT0FBZSxFQUFFLEdBQVcsSUFBRyxDQUFDO0tBQ3JELENBQUM7SUFRRixNQUFNLFFBQVEsR0FBRyxFQUdoQixDQUFDO0lBRUYsTUFBTSxPQUFPLEdBQUcsSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFvQyxDQUFDO0lBQ25FLE1BQU0sTUFBTSxHQUFHLENBQWlDLElBQU8sRUFBRSxFQUFFO1FBQ3pELE9BQU8sQ0FBQyxLQUFzRCxFQUFnQyxFQUFFO1lBQzlGLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FDZixFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FDVixDQUFDO1FBQ3BDLENBQUMsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGLEtBQUss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QUNILENBQ0YsQ0FBQyxJQUFJLENBQ0osRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtRQUN6QixHQUFHLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM5QixPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUMsQ0FBQyxDQUNILENBQUMsU0FBUyxFQUFFLENBQUM7SUFFZCxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQ3pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDekIsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoQixDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtRQUN0QixHQUFHLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUU7UUFDdkIsR0FBRyxDQUFDLElBQUksQ0FBQywyQkFBMkIsSUFBQSxjQUFNLEdBQUUsQ0FBQyxPQUFPLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNsRSxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sR0FBRyxFQUFFO1FBQ1YsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2pCLENBQUMsQ0FBQztBQUNKLENBQUM7QUFoTEQsc0JBZ0xDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuaW1wb3J0IG5ldCwge1NvY2tldH0gZnJvbSAnbmV0JztcbmltcG9ydCAqIGFzIHJ4IGZyb20gJ3J4anMnO1xuaW1wb3J0ICogYXMgb3AgZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtsb2c0RmlsZSwgY29uZmlnfSBmcm9tICdAd2ZoL3BsaW5rJztcbmNvbnN0IGxvZyA9IGxvZzRGaWxlKF9fZmlsZW5hbWUpO1xuXG5leHBvcnQgZnVuY3Rpb24gc3RhcnQocG9ydDogbnVtYmVyLCBob3N0TWFwOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpLFxuICBvcHRzPzoge1xuICAgIC8qKiBpZiBob3N0IGlzIG5vdCBpbiBob3N0TWFwLCBmb3J3YXJkIHRvIHRoaXMgcHJveHkgKi9cbiAgICBmYWxsYmFja1Byb3h5SG9zdDogc3RyaW5nO1xuICAgIGZhbGxiYWNrcHJveHlQb3J0OiBudW1iZXI7XG4gIH0pIHtcbiAgY29uc3Qgc2VydmVyID0gbmV0LmNyZWF0ZVNlcnZlcigpO1xuXG4gIGNvbnN0IGFjdGlvbnMgPSB7XG4gICAgcHJveHlUb1Byb3h5KF9yZW1vdGVIb3N0OiBzdHJpbmcsIF9yZW1vdGVQb3J0OiBudW1iZXIsIF9zb2NrZXQ6IFNvY2tldCwgX2ZpcnN0UGFja2V0OiBCdWZmZXIpIHt9LFxuICAgIHByb3h5VG9SZW1vdGUoX3JlbW90ZUhvc3Q6IHN0cmluZywgX3JlbW90ZVBvcnQ6IG51bWJlcixcbiAgICAgIF9zb2NrZXQ6IFNvY2tldCwgX2ZpcnN0UGFja2V0OiBCdWZmZXIsIF9pc1RzbDogYm9vbGVhbiwgaHR0cFByb3RvY2FsOiBzdHJpbmcpIHt9LFxuICAgIHJlbW90ZVNvY2tldENyZWF0ZWQoX3NvY2tldDogU29ja2V0LCBtc2c6IHN0cmluZykge31cbiAgfTtcblxuICB0eXBlIEFjdGlvblR5cGU8SyBleHRlbmRzIGtleW9mIHR5cGVvZiBhY3Rpb25zPiA9IHtcbiAgICB0eXBlOiBLO1xuICAgIHBheWxvYWQ6ICh0eXBlb2YgYWN0aW9ucylbS10gZXh0ZW5kcyAoYXJnOiBpbmZlciBQKSA9PiBhbnkgPyBQIDpcbiAgICAgICh0eXBlb2YgYWN0aW9ucylbS10gZXh0ZW5kcyAoLi4uYXJnczogaW5mZXIgQSkgPT4gYW55ID8gQSA6IHVua25vd247XG4gIH07XG5cbiAgY29uc3QgZGlzcGF0Y2ggPSB7fSBhcyB7XG4gICAgW0sgaW4ga2V5b2YgdHlwZW9mIGFjdGlvbnNdOlxuICAgICguLi5wYXJhbXM6IFBhcmFtZXRlcnM8dHlwZW9mIGFjdGlvbnNbS10+KSA9PiBBY3Rpb25UeXBlPEs+XG4gIH07XG5cbiAgY29uc3QgYWN0aW9uJCA9IG5ldyByeC5TdWJqZWN0PEFjdGlvblR5cGU8a2V5b2YgdHlwZW9mIGFjdGlvbnM+PigpO1xuICBjb25zdCBvZlR5cGUgPSA8VCBleHRlbmRzIGtleW9mIHR5cGVvZiBhY3Rpb25zPih0eXBlOiBUKSA9PiB7XG4gICAgcmV0dXJuIChpbnB1dDogcnguT2JzZXJ2YWJsZTxBY3Rpb25UeXBlPGtleW9mIHR5cGVvZiBhY3Rpb25zPj4pOiByeC5PYnNlcnZhYmxlPEFjdGlvblR5cGU8VD4+ID0+IHtcbiAgICAgIHJldHVybiBpbnB1dC5waXBlKFxuICAgICAgICBvcC5maWx0ZXIoYWN0aW9uID0+IGFjdGlvbi50eXBlID09PSB0eXBlKVxuICAgICAgKSBhcyByeC5PYnNlcnZhYmxlPEFjdGlvblR5cGU8VD4+O1xuICAgIH07XG4gIH07XG5cbiAgZm9yIChjb25zdCBba2V5XSBvZiBPYmplY3QuZW50cmllcyhhY3Rpb25zKSkge1xuICAgIGRpc3BhdGNoW2tleV0gPSAoLi4ucGFyYW1zOiBhbnlbXSkgPT4ge1xuICAgICAgY29uc3QgYWN0aW9uID0ge1xuICAgICAgICB0eXBlOiBrZXkgYXMga2V5b2YgdHlwZW9mIGFjdGlvbnMsXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFzc2lnbm1lbnRcbiAgICAgICAgcGF5bG9hZDogcGFyYW1zLmxlbmd0aCA9PT0gMCA/IHBhcmFtc1swXSA6IHBhcmFtc1xuICAgICAgfTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFyZ3VtZW50XG4gICAgICBhY3Rpb24kLm5leHQoYWN0aW9uIGFzIGFueSk7XG4gICAgfTtcbiAgfVxuXG4gIHJ4Lm1lcmdlKFxuICAgIHJ4LmZyb21FdmVudDxTb2NrZXQ+KHNlcnZlciwgJ2Nvbm5lY3Rpb24nKS5waXBlKFxuICAgICAgb3AubWVyZ2VNYXAoKGNsaWVudFRvUHJveHlTb2NrZXQpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKCdDbGllbnQgQ29ubmVjdGVkIFRvIFByb3h5JywgY2xpZW50VG9Qcm94eVNvY2tldC5yZW1vdGVBZGRyZXNzICtcbiAgICAgICAgICAnOicgKyBjbGllbnRUb1Byb3h5U29ja2V0LnJlbW90ZVBvcnQpO1xuICAgICAgICByZXR1cm4gcnguZnJvbUV2ZW50PEJ1ZmZlcj4oY2xpZW50VG9Qcm94eVNvY2tldCwgJ2RhdGEnKS5waXBlKFxuICAgICAgICAgIG9wLm1hcChkYXRhID0+ICh7Y2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YX0pKSxcbiAgICAgICAgICBvcC50YWtlKDEpXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICAgIG9wLm1hcCgoe2NsaWVudFRvUHJveHlTb2NrZXQsIGRhdGF9KSA9PiB7XG4gICAgICAgIGNvbnN0IGdyZWV0aW5nID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgICBsb2cuaW5mbyhncmVldGluZyk7XG4gICAgICAgIGxldCBpc1RMU0Nvbm5lY3Rpb24gPSBncmVldGluZy5pbmRleE9mKCdDT05ORUNUJykgIT09IC0xO1xuXG4gICAgICAgIC8vIENvbnNpZGVyaW5nIFBvcnQgYXMgODAgYnkgZGVmYXVsdCBcbiAgICAgICAgbGV0IHNlcnZlclBvcnQgPSA4MDtcbiAgICAgICAgbGV0IHNlcnZlckFkZHJlc3MgPSAnJztcbiAgICAgICAgbGV0IHByb3RvY2FsID0gJ0hUVFAvMS4xJztcbiAgICAgICAgaWYgKGlzVExTQ29ubmVjdGlvbikge1xuICAgICAgICAgIGNvbnN0IG1hdGNoID0gL0NPTk5FQ1QgKyhbXlxcczpdKykoPzo6KFxcUyspKT8oPzogKyhcXFMrKSk/Ly5leGVjKGdyZWV0aW5nKSE7XG4gICAgICAgICAgLy8gUG9ydCBjaGFuZ2VkIHRvIDQ0MywgcGFyc2luZyB0aGUgaG9zdCBmcm9tIENPTk5FQ1QgXG4gICAgICAgICAgc2VydmVyUG9ydCA9IG1hdGNoWzJdID8gcGFyc2VJbnQobWF0Y2hbMl0sIDEwKSA6IDQ0MztcbiAgICAgICAgICBzZXJ2ZXJBZGRyZXNzID0gbWF0Y2hbMV07XG4gICAgICAgICAgaWYgKG1hdGNoWzNdKVxuICAgICAgICAgICAgcHJvdG9jYWwgPSBtYXRjaFszXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBQYXJzaW5nIEhPU1QgZnJvbSBIVFRQXG4gICAgICAgICAgY29uc3QgbWF0Y2ggPSAvSG9zdDogKyhbXlxcczpdKykoPzo6KFxcUyspKT8vLmV4ZWMoZ3JlZXRpbmcpO1xuICAgICAgICAgIGlmIChtYXRjaCAhPSBudWxsKSB7XG4gICAgICAgICAgICBzZXJ2ZXJBZGRyZXNzID0gbWF0Y2hbMV07XG4gICAgICAgICAgICBzZXJ2ZXJQb3J0ID0gbWF0Y2hbMl0gPyBwYXJzZUludChtYXRjaFsyXSwgMTApIDogODA7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIGxvZy5pbmZvKCdwcm94eSB0bzonLCBzZXJ2ZXJBZGRyZXNzICsgJzonICsgc2VydmVyUG9ydCk7XG4gICAgICAgIGlmIChzZXJ2ZXJBZGRyZXNzICYmIGhvc3RNYXAuaGFzKHNlcnZlckFkZHJlc3MpKSB7XG4gICAgICAgICAgbGV0IHNwbGl0dGVkID0gaG9zdE1hcC5nZXQoc2VydmVyQWRkcmVzcykhLnNwbGl0KCc6Jyk7XG4gICAgICAgICAgc2VydmVyQWRkcmVzcyA9IHNwbGl0dGVkWzBdO1xuICAgICAgICAgIGlmIChzcGxpdHRlZFsxXSlcbiAgICAgICAgICAgIHNlcnZlclBvcnQgPSBwYXJzZUludChzcGxpdHRlZFsxXSwgMTApO1xuXG4gICAgICAgICAgZGlzcGF0Y2gucHJveHlUb1JlbW90ZShzZXJ2ZXJBZGRyZXNzLCBzZXJ2ZXJQb3J0LCBjbGllbnRUb1Byb3h5U29ja2V0LCBkYXRhLCBpc1RMU0Nvbm5lY3Rpb24sIHByb3RvY2FsKTtcbiAgICAgICAgfSBlbHNlIGlmIChvcHRzPy5mYWxsYmFja1Byb3h5SG9zdCkge1xuICAgICAgICAgIGRpc3BhdGNoLnByb3h5VG9Qcm94eShvcHRzLmZhbGxiYWNrUHJveHlIb3N0LCBvcHRzLmZhbGxiYWNrcHJveHlQb3J0LFxuICAgICAgICAgICAgY2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc2VydmVyQWRkcmVzcykge1xuICAgICAgICAgIGRpc3BhdGNoLnByb3h5VG9SZW1vdGUoc2VydmVyQWRkcmVzcywgc2VydmVyUG9ydCwgY2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YSwgaXNUTFNDb25uZWN0aW9uLCBwcm90b2NhbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIHNlcnZlciBhZGRyZXNzIGZvciAke2dyZWV0aW5nfWApO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICksXG4gICAgYWN0aW9uJC5waXBlKFxuICAgICAgb2ZUeXBlKCdwcm94eVRvUHJveHknKSxcbiAgICAgIG9wLm1hcCgoe3BheWxvYWQ6IFtob3N0LCBwb3J0LCBjbGllbnRUb1Byb3h5U29ja2V0LCBkYXRhXX0pID0+IHtcbiAgICAgICAgbGV0IHByb3h5VG9TZXJ2ZXJTb2NrZXQgPSBuZXQuY29ubmVjdCh7XG4gICAgICAgICAgaG9zdCwgcG9ydFxuICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgbG9nLndhcm4oJ1BST1hZIFRPIEZPUkJBQ0sgcHJveHkgY29ubmVjdGlvbiBjcmVhdGVkJywgaG9zdCwgJzonLCBwb3J0KTtcbiAgICAgICAgICBwcm94eVRvU2VydmVyU29ja2V0ID0gcHJveHlUb1NlcnZlclNvY2tldC5waXBlKGNsaWVudFRvUHJveHlTb2NrZXQpO1xuICAgICAgICAgIHByb3h5VG9TZXJ2ZXJTb2NrZXQud3JpdGUoZGF0YSk7XG4gICAgICAgICAgLy8gUGlwaW5nIHRoZSBzb2NrZXRzXG4gICAgICAgICAgY2xpZW50VG9Qcm94eVNvY2tldC5waXBlKHByb3h5VG9TZXJ2ZXJTb2NrZXQpO1xuICAgICAgICB9KTtcbiAgICAgICAgZGlzcGF0Y2gucmVtb3RlU29ja2V0Q3JlYXRlZChwcm94eVRvU2VydmVyU29ja2V0LCAnUmVtb3RlIHByb3h5Jyk7XG4gICAgICB9KVxuICAgICksXG4gICAgYWN0aW9uJC5waXBlKFxuICAgICAgb2ZUeXBlKCdwcm94eVRvUmVtb3RlJyksXG4gICAgICBvcC5tYXAoKHtwYXlsb2FkOiBbaG9zdCwgcG9ydCwgY2xpZW50VG9Qcm94eVNvY2tldCwgZGF0YSwgaXNUTFNDb25uZWN0aW9uLCBwcm90b2NhbF19KSA9PiB7XG4gICAgICAgIGxldCBwcm94eVRvU2VydmVyU29ja2V0ID0gbmV0LmNvbm5lY3Qoe1xuICAgICAgICAgIGhvc3QsXG4gICAgICAgICAgcG9ydFxuICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmluZm8oJ1BST1hZIFRPIFNFUlZFUiBjb25uZWN0aW9uIGNyZWF0ZWQnLCBob3N0LCAnOicsIHBvcnQpO1xuXG4gICAgICAgICAgaWYgKGlzVExTQ29ubmVjdGlvbikge1xuICAgICAgICAgICAgLy8gU2VuZCBCYWNrIE9LIHRvIEhUVFBTIENPTk5FQ1QgUmVxdWVzdFxuICAgICAgICAgICAgY2xpZW50VG9Qcm94eVNvY2tldC53cml0ZShwcm90b2NhbCArICcgMjAwIE9LXFxyXFxuXFxuJyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHByb3h5VG9TZXJ2ZXJTb2NrZXQud3JpdGUoZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIFBpcGluZyB0aGUgc29ja2V0c1xuICAgICAgICAgIGNsaWVudFRvUHJveHlTb2NrZXQucGlwZShwcm94eVRvU2VydmVyU29ja2V0KTtcbiAgICAgICAgICBwcm94eVRvU2VydmVyU29ja2V0ID0gcHJveHlUb1NlcnZlclNvY2tldC5waXBlKGNsaWVudFRvUHJveHlTb2NrZXQpO1xuICAgICAgICB9KTtcbiAgICAgICAgZGlzcGF0Y2gucmVtb3RlU29ja2V0Q3JlYXRlZChwcm94eVRvU2VydmVyU29ja2V0LCAncmVtb3RlIHNlcnZlcicpO1xuICAgICAgfSlcbiAgICApLFxuICAgIGFjdGlvbiQucGlwZShcbiAgICAgIG9mVHlwZSgncmVtb3RlU29ja2V0Q3JlYXRlZCcpLFxuICAgICAgb3AubWFwKCh7cGF5bG9hZDogW3Byb3h5VG9TZXJ2ZXJTb2NrZXRdfSkgPT4ge1xuICAgICAgICBsb2cuaW5mbygnUmVnaXN0ZXIgZXJyb3IgZXZlbnQgaGFuZGxlciB0byBzb2NrZXQnKTtcbiAgICAgICAgcHJveHlUb1NlcnZlclNvY2tldC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgIGxvZy53YXJuKCdQUk9YWSBUTyBTRVJWRVIgRVJST1InLCBwcm94eVRvU2VydmVyU29ja2V0LnJlbW90ZUFkZHJlc3MsICc6JywgcHJveHlUb1NlcnZlclNvY2tldC5yZW1vdGVQb3J0LCBlcnIpO1xuICAgICAgICB9KTtcbiAgICAgICAgcHJveHlUb1NlcnZlclNvY2tldC5vbignbG9va3VwJywgKGVyciwgYWRkciwgX2ZhbSwgaG9zdCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICBsb2cud2FybignbG9va3VwIGVycm9yJywgZXJyKTtcbiAgICAgICAgICBsb2cuaW5mbygnbG9va3VwJywgYWRkciwgaG9zdCk7XG4gICAgICAgIH0pO1xuICAgICAgICBwcm94eVRvU2VydmVyU29ja2V0Lm9uKCd0aW1lb3V0JywgKCkgPT4ge1xuICAgICAgICAgIGxvZy5pbmZvKCdQUk9YWSBUTyBTRVJWRVIgdGltZW91dCcsIHByb3h5VG9TZXJ2ZXJTb2NrZXQucmVtb3RlQWRkcmVzcywgJzonLCBwcm94eVRvU2VydmVyU29ja2V0LnJlbW90ZVBvcnQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgKVxuICApLnBpcGUoXG4gICAgb3AuY2F0Y2hFcnJvcigoZXJyLCBzcmMpID0+IHtcbiAgICAgIGxvZy5lcnJvcignRmF0YWwgZXJyb3InLCBlcnIpO1xuICAgICAgcmV0dXJuIHNyYztcbiAgICB9KVxuICApLnN1YnNjcmliZSgpO1xuXG4gIHNlcnZlci5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgbG9nLmluZm8oJ1NFUlZFUiBFUlJPUicpO1xuICAgIGxvZy5pbmZvKGVycik7XG4gIH0pO1xuXG4gIHNlcnZlci5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgbG9nLmluZm8oJ0NsaWVudCBEaXNjb25uZWN0ZWQnKTtcbiAgfSk7XG5cbiAgc2VydmVyLmxpc3Rlbihwb3J0LCAoKSA9PiB7XG4gICAgbG9nLmluZm8oYFNlcnZlciBydW5uaWcgYXQgaHR0cDovLyR7Y29uZmlnKCkubG9jYWxJUH06YCArIHBvcnQpO1xuICB9KTtcblxuICByZXR1cm4gKCkgPT4ge1xuICAgIHNlcnZlci5jbG9zZSgpO1xuICB9O1xufVxuXG4iXX0=